

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>getscipapers_hoanganhduc.getpapers &mdash; getscipapers 0.1.4 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=9edc463e" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=fd825880"></script>
      <script src="../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            getscipapers
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Usage Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cli_reference.html">CLI Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_reference.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project_documentation.html">Project Architecture and Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project_documentation.html#getscipapers-project-documentation">getscipapers Project Documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">getscipapers</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">getscipapers_hoanganhduc.getpapers</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for getscipapers_hoanganhduc.getpapers</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Core search and retrieval workflow for ``getpapers`` CLI invocations.</span>

<span class="sd">This module coordinates searches across Nexus, CrossRef, Unpaywall, and</span>
<span class="sd">publisher APIs, while handling caching, configuration, and output formatting.</span>
<span class="sd">Functions here are designed for reuse by other modules (for example</span>
<span class="sd">``request.py``) and are intentionally asynchronous-aware so they can run in</span>
<span class="sd">concurrent contexts.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">libstc_geck.advices</span><span class="w"> </span><span class="kn">import</span> <span class="n">format_document</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">libstc_geck.client</span><span class="w"> </span><span class="kn">import</span> <span class="n">StcGeck</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">aiohttp</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">platform</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">functools</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">quote_plus</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">unpywall</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unpywall</span><span class="w"> </span><span class="kn">import</span> <span class="n">Unpywall</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unpywall.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">UnpywallCredentials</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unpywall.cache</span><span class="w"> </span><span class="kn">import</span> <span class="n">UnpywallCache</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">urljoin</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">crossref.restful</span><span class="w"> </span><span class="kn">import</span> <span class="n">Works</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">PyPDF2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">signal</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">queue</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">nexus</span>  <span class="c1"># Import Nexus bot functions from .nexus module</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">libgen</span>  <span class="c1"># Import LibGen functions from .libgen module</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">configuration</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">proxy_config</span>

<span class="n">DEFAULT_LIMIT</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="n">DEFAULT_LIMIT</span>

<span class="n">VERBOSE</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Global verbose flag</span>
<span class="n">ACTIVE_PROXY</span> <span class="o">=</span> <span class="n">proxy_config</span><span class="o">.</span><span class="n">ProxySettings</span><span class="p">()</span>


<div class="viewcode-block" id="vprint">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.getpapers.vprint">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">vprint</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_requests_kwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">if</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="p">{}</span>
    <span class="n">proxies</span> <span class="o">=</span> <span class="n">ACTIVE_PROXY</span><span class="o">.</span><span class="n">requests_proxies</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">proxies</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;proxies&quot;</span><span class="p">,</span> <span class="n">proxies</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">kwargs</span>

<span class="c1"># Global variable for default config file location</span>
<span class="n">GETPAPERS_CONFIG_FILE</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">configuration</span><span class="o">.</span><span class="n">GETPAPERS_CONFIG_FILE</span><span class="p">)</span>

<span class="c1"># Set Unpywall cache directory to the same folder as the config file</span>
<span class="n">UNPYWALL_CACHE_DIR</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">configuration</span><span class="o">.</span><span class="n">UNPYWALL_CACHE_DIR</span><span class="p">)</span>
<span class="n">UNPYWALL_CACHE_FILE</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">configuration</span><span class="o">.</span><span class="n">UNPYWALL_CACHE_FILE</span><span class="p">)</span>
<span class="n">ANNA_MIRROR_CACHE_FILE</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">UNPYWALL_CACHE_DIR</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;anna_mirrors.json&quot;</span><span class="p">)</span>
<span class="n">SCIHUB_MIRROR_CACHE_FILE</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">UNPYWALL_CACHE_DIR</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;scihub_mirrors.json&quot;</span><span class="p">)</span>
<span class="n">SCINET_MIRROR_CACHE_FILE</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">UNPYWALL_CACHE_DIR</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;scinet_mirrors.json&quot;</span><span class="p">)</span>

<span class="n">DEFAULT_DOWNLOAD_FOLDER</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="n">DEFAULT_DOWNLOAD_FOLDER</span>
<span class="c1"># Shared proxy configuration location for CLI/GUI callers.</span>
<span class="n">DEFAULT_PROXY_FILE</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">proxy_config</span><span class="o">.</span><span class="n">DEFAULT_PROXY_FILE</span><span class="p">)</span>
<span class="c1"># Increase the tolerance for slow networks when downloading PDFs.</span>
<span class="n">DOWNLOAD_TIMEOUT</span> <span class="o">=</span> <span class="mi">120</span>
<span class="n">DB_CHOICES</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;nexus&quot;</span><span class="p">,</span> <span class="s2">&quot;scihub&quot;</span><span class="p">,</span> <span class="s2">&quot;anna&quot;</span><span class="p">,</span> <span class="s2">&quot;unpaywall&quot;</span><span class="p">,</span> <span class="s2">&quot;libgen&quot;</span><span class="p">,</span> <span class="s2">&quot;ezproxy&quot;</span><span class="p">)</span>

<span class="n">ANNA_MIRROR_DEFAULTS</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;https://annas-archive.li&quot;</span><span class="p">,</span>
    <span class="s2">&quot;https://annas-archive.pm&quot;</span><span class="p">,</span>
    <span class="s2">&quot;https://annas-archive.in&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">ANNA_MIRROR_CACHE_TTL_SECONDS</span> <span class="o">=</span> <span class="mi">7</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span>
<span class="n">SCIHUB_MIRROR_DEFAULTS</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;https://sci-hub.su&quot;</span><span class="p">,</span>
    <span class="s2">&quot;https://sci-hub.st&quot;</span><span class="p">,</span>
    <span class="s2">&quot;https://sci-hub.red&quot;</span><span class="p">,</span>
    <span class="s2">&quot;https://sci-hub.box&quot;</span><span class="p">,</span>
    <span class="s2">&quot;https://sci-hub.ru&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">SCINET_MIRROR_DEFAULTS</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;https://sci-net.xyz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;https://sci-net.ru&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">SCIHUB_MIRROR_CACHE_TTL_SECONDS</span> <span class="o">=</span> <span class="mi">7</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_parse_anna_mirror_domains</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_domains</span><span class="p">(</span><span class="n">blob</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">domains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;annas-archive\.[a-z]{2,}&quot;</span><span class="p">,</span> <span class="n">blob</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span>
            <span class="n">domain</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://</span><span class="si">{</span><span class="n">match</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">domain</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">domains</span><span class="p">:</span>
                <span class="n">domains</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">domains</span>

    <span class="n">current_domains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;currently.{0,200}&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">):</span>
        <span class="n">current_domains</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_extract_domains</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">current_domains</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">current_domains</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">_extract_domains</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_parse_scihub_mirror_domains</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">domains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(?:sci-hub|scihub)\.[a-z0-9.-]+&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://</span><span class="si">{</span><span class="n">match</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">domain</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">domains</span><span class="p">:</span>
            <span class="n">domains</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">domains</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_parse_scinet_mirror_domains</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">domains</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;sci-net\.[a-z0-9.-]+&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://</span><span class="si">{</span><span class="n">match</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">domain</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">domains</span><span class="p">:</span>
            <span class="n">domains</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">domains</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_load_anna_mirror_cache</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cache_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">ANNA_MIRROR_CACHE_FILE</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cache_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">cache_path</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">mirrors</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mirrors&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">fetched_at</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fetched_at&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mirrors</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fetched_at</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;mirrors&quot;</span><span class="p">:</span> <span class="n">mirrors</span><span class="p">,</span> <span class="s2">&quot;fetched_at&quot;</span><span class="p">:</span> <span class="n">fetched_at</span><span class="p">}</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load Anna mirror cache: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_load_scihub_mirror_cache</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cache_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">SCIHUB_MIRROR_CACHE_FILE</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cache_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">cache_path</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">mirrors</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mirrors&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">fetched_at</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fetched_at&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mirrors</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fetched_at</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;mirrors&quot;</span><span class="p">:</span> <span class="n">mirrors</span><span class="p">,</span> <span class="s2">&quot;fetched_at&quot;</span><span class="p">:</span> <span class="n">fetched_at</span><span class="p">}</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load Sci-Hub mirror cache: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_load_scinet_mirror_cache</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cache_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">SCINET_MIRROR_CACHE_FILE</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cache_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">cache_path</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">mirrors</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mirrors&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">fetched_at</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fetched_at&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mirrors</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fetched_at</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;mirrors&quot;</span><span class="p">:</span> <span class="n">mirrors</span><span class="p">,</span> <span class="s2">&quot;fetched_at&quot;</span><span class="p">:</span> <span class="n">fetched_at</span><span class="p">}</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load Sci-Net mirror cache: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_save_anna_mirror_cache</span><span class="p">(</span><span class="n">mirrors</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">configuration</span><span class="o">.</span><span class="n">ensure_directory_exists</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">UNPYWALL_CACHE_DIR</span><span class="p">))</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;mirrors&quot;</span><span class="p">:</span> <span class="n">mirrors</span><span class="p">,</span> <span class="s2">&quot;fetched_at&quot;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()}</span>
        <span class="n">Path</span><span class="p">(</span><span class="n">ANNA_MIRROR_CACHE_FILE</span><span class="p">)</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to save Anna mirror cache: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_save_scihub_mirror_cache</span><span class="p">(</span><span class="n">mirrors</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">configuration</span><span class="o">.</span><span class="n">ensure_directory_exists</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">UNPYWALL_CACHE_DIR</span><span class="p">))</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;mirrors&quot;</span><span class="p">:</span> <span class="n">mirrors</span><span class="p">,</span> <span class="s2">&quot;fetched_at&quot;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()}</span>
        <span class="n">Path</span><span class="p">(</span><span class="n">SCIHUB_MIRROR_CACHE_FILE</span><span class="p">)</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to save Sci-Hub mirror cache: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_save_scinet_mirror_cache</span><span class="p">(</span><span class="n">mirrors</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">configuration</span><span class="o">.</span><span class="n">ensure_directory_exists</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">UNPYWALL_CACHE_DIR</span><span class="p">))</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;mirrors&quot;</span><span class="p">:</span> <span class="n">mirrors</span><span class="p">,</span> <span class="s2">&quot;fetched_at&quot;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()}</span>
        <span class="n">Path</span><span class="p">(</span><span class="n">SCINET_MIRROR_CACHE_FILE</span><span class="p">)</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to save Sci-Net mirror cache: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="get_anna_mirrors">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.getpapers.get_anna_mirrors">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_anna_mirrors</span><span class="p">(</span><span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">source_url</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">configuration</span><span class="p">,</span> <span class="s2">&quot;ANNA_MIRROR_SOURCE_URL&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">source_url</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">ANNA_MIRROR_DEFAULTS</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="n">_load_anna_mirror_cache</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">cache</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_refresh</span><span class="p">:</span>
        <span class="n">age</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">cache</span><span class="p">[</span><span class="s2">&quot;fetched_at&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">age</span> <span class="o">&lt;=</span> <span class="n">ANNA_MIRROR_CACHE_TTL_SECONDS</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cache</span><span class="p">[</span><span class="s2">&quot;mirrors&quot;</span><span class="p">]</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="s2">&quot;Mozilla/5.0&quot;</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">source_url</span><span class="p">,</span> <span class="o">**</span><span class="n">_requests_kwargs</span><span class="p">({</span><span class="s2">&quot;headers&quot;</span><span class="p">:</span> <span class="n">headers</span><span class="p">,</span> <span class="s2">&quot;timeout&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}))</span>
        <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">mirrors</span> <span class="o">=</span> <span class="n">_parse_anna_mirror_domains</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mirrors</span><span class="p">:</span>
                <span class="n">_save_anna_mirror_cache</span><span class="p">(</span><span class="n">mirrors</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">mirrors</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to refresh Anna mirrors from </span><span class="si">{</span><span class="n">source_url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ANNA_MIRROR_DEFAULTS</span></div>



<div class="viewcode-block" id="get_scihub_mirrors">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.getpapers.get_scihub_mirrors">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_scihub_mirrors</span><span class="p">(</span><span class="n">force_refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
    <span class="n">source_url</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">configuration</span><span class="p">,</span> <span class="s2">&quot;SCIHUB_MIRROR_SOURCE_URL&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">source_url</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;scihub&quot;</span><span class="p">:</span> <span class="n">SCIHUB_MIRROR_DEFAULTS</span><span class="p">,</span>
            <span class="s2">&quot;scinet&quot;</span><span class="p">:</span> <span class="n">SCINET_MIRROR_DEFAULTS</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="n">scihub_cache</span> <span class="o">=</span> <span class="n">_load_scihub_mirror_cache</span><span class="p">()</span>
    <span class="n">scinet_cache</span> <span class="o">=</span> <span class="n">_load_scinet_mirror_cache</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">scihub_cache</span> <span class="ow">and</span> <span class="n">scinet_cache</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_refresh</span><span class="p">:</span>
        <span class="n">scihub_age</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">scihub_cache</span><span class="p">[</span><span class="s2">&quot;fetched_at&quot;</span><span class="p">]</span>
        <span class="n">scinet_age</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">scinet_cache</span><span class="p">[</span><span class="s2">&quot;fetched_at&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">scihub_age</span> <span class="o">&lt;=</span> <span class="n">SCIHUB_MIRROR_CACHE_TTL_SECONDS</span> <span class="ow">and</span> <span class="n">scinet_age</span> <span class="o">&lt;=</span> <span class="n">SCIHUB_MIRROR_CACHE_TTL_SECONDS</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;scihub&quot;</span><span class="p">:</span> <span class="n">scihub_cache</span><span class="p">[</span><span class="s2">&quot;mirrors&quot;</span><span class="p">],</span> <span class="s2">&quot;scinet&quot;</span><span class="p">:</span> <span class="n">scinet_cache</span><span class="p">[</span><span class="s2">&quot;mirrors&quot;</span><span class="p">]}</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="s2">&quot;Mozilla/5.0&quot;</span><span class="p">}</span>
    <span class="n">scihub_mirrors</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">scinet_mirrors</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">source_url</span><span class="p">,</span> <span class="o">**</span><span class="n">_requests_kwargs</span><span class="p">({</span><span class="s2">&quot;headers&quot;</span><span class="p">:</span> <span class="n">headers</span><span class="p">,</span> <span class="s2">&quot;timeout&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}))</span>
        <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">scihub_mirrors</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_parse_scihub_mirror_domains</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">))</span>
            <span class="n">scinet_mirrors</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_parse_scinet_mirror_domains</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to refresh Sci-Hub mirrors from </span><span class="si">{</span><span class="n">source_url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">scihub_mirrors</span><span class="p">:</span>
        <span class="n">scihub_mirrors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">scihub_mirrors</span><span class="p">))</span>
        <span class="n">_save_scihub_mirror_cache</span><span class="p">(</span><span class="n">scihub_mirrors</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">scinet_mirrors</span><span class="p">:</span>
        <span class="n">scinet_mirrors</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">scinet_mirrors</span><span class="p">))</span>
        <span class="n">_save_scinet_mirror_cache</span><span class="p">(</span><span class="n">scinet_mirrors</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;scihub&quot;</span><span class="p">:</span> <span class="n">scihub_mirrors</span> <span class="ow">or</span> <span class="n">SCIHUB_MIRROR_DEFAULTS</span><span class="p">,</span>
        <span class="s2">&quot;scinet&quot;</span><span class="p">:</span> <span class="n">scinet_mirrors</span> <span class="ow">or</span> <span class="n">SCINET_MIRROR_DEFAULTS</span><span class="p">,</span>
    <span class="p">}</span></div>


<div class="viewcode-block" id="ensure_directory_exists">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.getpapers.ensure_directory_exists">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">ensure_directory_exists</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">configuration</span><span class="o">.</span><span class="n">ensure_directory_exists</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">))</span></div>



<div class="viewcode-block" id="save_credentials">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.getpapers.save_credentials">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">save_credentials</span><span class="p">(</span>
    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">elsevier_api_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">wiley_tdm_token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ieee_api_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">config_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">return</span> <span class="n">configuration</span><span class="o">.</span><span class="n">save_credentials</span><span class="p">(</span>
        <span class="n">email</span><span class="o">=</span><span class="n">email</span><span class="p">,</span>
        <span class="n">elsevier_api_key</span><span class="o">=</span><span class="n">elsevier_api_key</span><span class="p">,</span>
        <span class="n">wiley_tdm_token</span><span class="o">=</span><span class="n">wiley_tdm_token</span><span class="p">,</span>
        <span class="n">ieee_api_key</span><span class="o">=</span><span class="n">ieee_api_key</span><span class="p">,</span>
        <span class="n">config_file</span><span class="o">=</span><span class="n">config_file</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="normalize_db_selection">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.getpapers.normalize_db_selection">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">normalize_db_selection</span><span class="p">(</span><span class="n">db</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Normalize the ``--db`` selection to a concrete list of services.</span>

<span class="sd">    The CLI accepts comma-delimited strings or multiple ``--db`` flags. Any</span>
<span class="sd">    request containing ``&quot;all&quot;`` or no explicit services resolves to the full</span>
<span class="sd">    list defined in :data:`DB_CHOICES`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">DB_CHOICES</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># Support comma-separated values from older invocations or GUI input</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">part</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">db</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">part</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">part</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">db</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">part</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">parts</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">part</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">DB_CHOICES</span><span class="p">)</span>

    <span class="n">filtered</span> <span class="o">=</span> <span class="p">[</span><span class="n">part</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span> <span class="k">if</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">DB_CHOICES</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">filtered</span> <span class="ow">or</span> <span class="nb">list</span><span class="p">(</span><span class="n">DB_CHOICES</span><span class="p">)</span></div>



<div class="viewcode-block" id="load_credentials">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.getpapers.load_credentials">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">load_credentials</span><span class="p">(</span>
    <span class="n">config_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">interactive</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">env_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;GETSCIPAPERS_&quot;</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">return</span> <span class="n">configuration</span><span class="o">.</span><span class="n">load_credentials</span><span class="p">(</span>
        <span class="n">config_file</span><span class="o">=</span><span class="n">config_file</span><span class="p">,</span>
        <span class="n">interactive</span><span class="o">=</span><span class="n">interactive</span><span class="p">,</span>
        <span class="n">env_prefix</span><span class="o">=</span><span class="n">env_prefix</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">,</span>
    <span class="p">)</span></div>



<span class="n">require_email</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="n">require_email</span>
<span class="c1"># def is_paper_doi(doi: str) -&gt; bool:</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     Check if a DOI corresponds to a scholarly paper (article, preprint, or book) using the Crossref API.</span>
<span class="c1">#     Returns True if the DOI is for a journal article, proceeding, preprint, or book, False otherwise.</span>
<span class="c1">#     Falls back to direct HTTP request if the python API returns None.</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     try:</span>
<span class="c1">#         works = Works()</span>
<span class="c1">#         result = works.doi(doi)</span>
<span class="c1">#         if not result:</span>
<span class="c1">#             # Fallback: try direct HTTP request to Crossref API</span>
<span class="c1">#             result = fetch_crossref_data(doi)</span>
<span class="c1">#             if not result:</span>
<span class="c1">#                 return False</span>
        
<span class="c1">#         # Accept common scholarly types</span>
<span class="c1">#         valid_types = [</span>
<span class="c1">#             &#39;journal-article&#39;,</span>
<span class="c1">#             &#39;proceedings-article&#39;,</span>
<span class="c1">#             &#39;book&#39;,</span>
<span class="c1">#             &#39;book-chapter&#39;,</span>
<span class="c1">#             &#39;monograph&#39;,</span>
<span class="c1">#             &#39;reference-book&#39;,</span>
<span class="c1">#             &#39;posted-content&#39;,  # preprints</span>
<span class="c1">#             &#39;report&#39;</span>
<span class="c1">#         ]</span>
<span class="c1">#         return result.get(&#39;type&#39;) in valid_types</span>
<span class="c1">#     except Exception:</span>
<span class="c1">#         return False</span>

<div class="viewcode-block" id="fetch_crossref_data">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.getpapers.fetch_crossref_data">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">fetch_crossref_data</span><span class="p">(</span><span class="n">doi</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fetch data from Crossref API for a given DOI.</span>
<span class="sd">    Returns the message part of the response if successful, None otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://api.crossref.org/works/</span><span class="si">{</span><span class="n">requests</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">doi</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">active_email</span> <span class="o">=</span> <span class="n">require_email</span><span class="p">()</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;PythonScript/1.0 (mailto:</span><span class="si">{</span><span class="n">active_email</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Accept&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json, text/plain, */*&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Connection&quot;</span><span class="p">:</span> <span class="s2">&quot;keep-alive&quot;</span><span class="p">,</span>
        <span class="s2">&quot;DNT&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Accept-Language&quot;</span><span class="p">:</span> <span class="s2">&quot;en-US,en;q=0.9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Referer&quot;</span><span class="p">:</span> <span class="s2">&quot;https://doi.org/&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Cache-Control&quot;</span><span class="p">:</span> <span class="s2">&quot;no-cache&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Pragma&quot;</span><span class="p">:</span> <span class="s2">&quot;no-cache&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">session</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>  <span class="c1"># Raise an error for bad status codes</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            
            <span class="c1"># Extract and return the message part if status is ok</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;ok&quot;</span><span class="p">:</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Crossref data fetched for DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
                <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Title: </span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;N/A&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Authors: </span><span class="si">{</span><span class="p">[</span><span class="n">author</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;given&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">author</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;family&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">author</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;author&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[])]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Published: </span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;published&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;date-parts&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[[</span><span class="s1">&#39;N/A&#39;</span><span class="p">]])[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Journal: </span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;container-title&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;N/A&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">item</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Crossref API returned non-ok status for DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
                
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error fetching Crossref data for DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error decoding JSON response for DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error fetching Crossref data for DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="is_open_access_unpaywall">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.getpapers.is_open_access_unpaywall">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">is_open_access_unpaywall</span><span class="p">(</span><span class="n">doi</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if a DOI is open access using the Unpaywall API.</span>
<span class="sd">    Returns True if open access, False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">active_email</span> <span class="o">=</span> <span class="n">email</span> <span class="ow">or</span> <span class="n">require_email</span><span class="p">()</span>
    <span class="n">api_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://api.unpaywall.org/v2/</span><span class="si">{</span><span class="n">quote_plus</span><span class="p">(</span><span class="n">doi</span><span class="p">)</span><span class="si">}</span><span class="s2">?email=</span><span class="si">{</span><span class="n">quote_plus</span><span class="p">(</span><span class="n">active_email</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">(</span><span class="n">trust_env</span><span class="o">=</span><span class="n">ACTIVE_PROXY</span><span class="o">.</span><span class="n">enabled</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;is_oa&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unpaywall API returned status </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2"> for DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error checking OA status for DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> via Unpaywall API: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="resolve_pii_to_doi">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.getpapers.resolve_pii_to_doi">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">resolve_pii_to_doi</span><span class="p">(</span><span class="n">pii</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Try to resolve a ScienceDirect PII to a DOI using Elsevier&#39;s API.</span>
<span class="sd">    Returns DOI string if found, else None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Clean PII by removing hyphens and brackets</span>
    <span class="n">clean_pii</span> <span class="o">=</span> <span class="n">pii</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cleaned PII from </span><span class="si">{</span><span class="n">pii</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">clean_pii</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="n">api_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://api.elsevier.com/content/article/pii/</span><span class="si">{</span><span class="n">clean_pii</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span> <span class="s1">&#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36 Edg/124.0.2478.67&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Accept&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json,text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Accept-Language&#39;</span><span class="p">:</span> <span class="s1">&#39;en-US,en;q=0.9&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Accept-Encoding&#39;</span><span class="p">:</span> <span class="s1">&#39;gzip, deflate, br&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Connection&#39;</span><span class="p">:</span> <span class="s1">&#39;keep-alive&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Upgrade-Insecure-Requests&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Sec-Fetch-Dest&#39;</span><span class="p">:</span> <span class="s1">&#39;document&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Sec-Fetch-Mode&#39;</span><span class="p">:</span> <span class="s1">&#39;navigate&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Sec-Fetch-Site&#39;</span><span class="p">:</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Sec-Fetch-User&#39;</span><span class="p">:</span> <span class="s1">&#39;?1&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Pragma&#39;</span><span class="p">:</span> <span class="s1">&#39;no-cache&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Cache-Control&#39;</span><span class="p">:</span> <span class="s1">&#39;no-cache&#39;</span><span class="p">,</span>
        <span class="s1">&#39;DNT&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span>
        <span class="s1">&#39;X-ELS-APIKey&#39;</span><span class="p">:</span> <span class="n">configuration</span><span class="o">.</span><span class="n">ELSEVIER_API_KEY</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="o">**</span><span class="n">_requests_kwargs</span><span class="p">({</span><span class="s2">&quot;headers&quot;</span><span class="p">:</span> <span class="n">headers</span><span class="p">,</span> <span class="s2">&quot;timeout&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}))</span>
        <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">content_type</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;content-type&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="s1">&#39;application/json&#39;</span> <span class="ow">in</span> <span class="n">content_type</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                    <span class="n">doi</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;full-text-retrieval-response&quot;</span><span class="p">,</span> <span class="p">{})</span>
                            <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;coredata&quot;</span><span class="p">,</span> <span class="p">{})</span>
                            <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prism:doi&quot;</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">doi</span><span class="p">:</span>
                        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resolved PII </span><span class="si">{</span><span class="n">clean_pii</span><span class="si">}</span><span class="s2"> to DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> via Elsevier API&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">doi</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PII </span><span class="si">{</span><span class="n">clean_pii</span><span class="si">}</span><span class="s2"> found but no DOI in Elsevier API response&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
                    <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Elsevier API returned invalid JSON for PII </span><span class="si">{</span><span class="n">clean_pii</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Response content: </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;xml&#39;</span> <span class="ow">in</span> <span class="n">content_type</span><span class="p">:</span>
                <span class="c1"># Handle XML response</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">xml.etree.ElementTree</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ET</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">root</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
                    <span class="c1"># Look for DOI in XML namespaces</span>
                    <span class="n">namespaces</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;ns&#39;</span><span class="p">:</span> <span class="s1">&#39;http://www.elsevier.com/xml/svapi/article/dtd&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;prism&#39;</span><span class="p">:</span> <span class="s1">&#39;http://prismstandard.org/namespaces/basic/2.0/&#39;</span>
                    <span class="p">}</span>
                    <span class="n">doi_element</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.//prism:doi&#39;</span><span class="p">,</span> <span class="n">namespaces</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">doi_element</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">doi_element</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
                        <span class="n">doi</span> <span class="o">=</span> <span class="n">doi_element</span><span class="o">.</span><span class="n">text</span>
                        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resolved PII </span><span class="si">{</span><span class="n">clean_pii</span><span class="si">}</span><span class="s2"> to DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> via Elsevier API (XML)&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">doi</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PII </span><span class="si">{</span><span class="n">clean_pii</span><span class="si">}</span><span class="s2"> found but no DOI in Elsevier API XML response&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">ET</span><span class="o">.</span><span class="n">ParseError</span><span class="p">:</span>
                    <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Elsevier API returned invalid XML for PII </span><span class="si">{</span><span class="n">clean_pii</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Response content: </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Elsevier API returned unexpected content type &#39;</span><span class="si">{</span><span class="n">content_type</span><span class="si">}</span><span class="s2">&#39; for PII </span><span class="si">{</span><span class="n">clean_pii</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Response content: </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Elsevier API returned status </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> for PII </span><span class="si">{</span><span class="n">clean_pii</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error resolving PII </span><span class="si">{</span><span class="n">clean_pii</span><span class="si">}</span><span class="s2"> to DOI: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="extract_mdpi_doi_from_url">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.getpapers.extract_mdpi_doi_from_url">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_mdpi_doi_from_url</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Try to extract an MDPI DOI from a URL.</span>
<span class="sd">    Returns DOI string if found, else None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mdpi_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;mdpi\.com/([^/]+)/([^/]+)/([^/]+)/([^/?#]+)&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mdpi_match</span><span class="p">:</span>
        <span class="n">issn</span> <span class="o">=</span> <span class="n">mdpi_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">volume</span> <span class="o">=</span> <span class="n">mdpi_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">issue</span> <span class="o">=</span> <span class="n">mdpi_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">article</span> <span class="o">=</span> <span class="n">mdpi_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">mdpi_issn_to_journal</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;2071-1050&quot;</span><span class="p">:</span> <span class="s2">&quot;su&quot;</span><span class="p">,</span>
            <span class="s2">&quot;1424-8220&quot;</span><span class="p">:</span> <span class="s2">&quot;sensors&quot;</span><span class="p">,</span>
            <span class="s2">&quot;1996-1944&quot;</span><span class="p">:</span> <span class="s2">&quot;ma&quot;</span><span class="p">,</span>
            <span class="s2">&quot;2073-4441&quot;</span><span class="p">:</span> <span class="s2">&quot;water&quot;</span><span class="p">,</span>
            <span class="s2">&quot;1660-4601&quot;</span><span class="p">:</span> <span class="s2">&quot;ijerph&quot;</span><span class="p">,</span>
            <span class="s2">&quot;2072-6643&quot;</span><span class="p">:</span> <span class="s2">&quot;nu&quot;</span><span class="p">,</span>
            <span class="s2">&quot;2079-4991&quot;</span><span class="p">:</span> <span class="s2">&quot;nanomaterials&quot;</span><span class="p">,</span>
            <span class="s2">&quot;2073-4360&quot;</span><span class="p">:</span> <span class="s2">&quot;polymers&quot;</span><span class="p">,</span>
            <span class="s2">&quot;1999-4915&quot;</span><span class="p">:</span> <span class="s2">&quot;viruses&quot;</span><span class="p">,</span>
            <span class="s2">&quot;2075-163X&quot;</span><span class="p">:</span> <span class="s2">&quot;minerals&quot;</span><span class="p">,</span>
            <span class="s2">&quot;2227-9717&quot;</span><span class="p">:</span> <span class="s2">&quot;processes&quot;</span><span class="p">,</span>
            <span class="s2">&quot;2227-9040&quot;</span><span class="p">:</span> <span class="s2">&quot;chemosensors&quot;</span><span class="p">,</span>
            <span class="s2">&quot;2076-3417&quot;</span><span class="p">:</span> <span class="s2">&quot;app&quot;</span><span class="p">,</span>
            <span class="s2">&quot;2220-9964&quot;</span><span class="p">:</span> <span class="s2">&quot;ijgi&quot;</span><span class="p">,</span>
            <span class="s2">&quot;2076-2615&quot;</span><span class="p">:</span> <span class="s2">&quot;animals&quot;</span><span class="p">,</span>
            <span class="s2">&quot;2072-4292&quot;</span><span class="p">:</span> <span class="s2">&quot;remotesensing&quot;</span><span class="p">,</span>
            <span class="s2">&quot;2079-6382&quot;</span><span class="p">:</span> <span class="s2">&quot;antibiotics&quot;</span><span class="p">,</span>
            <span class="s2">&quot;2076-3921&quot;</span><span class="p">:</span> <span class="s2">&quot;antioxidants&quot;</span><span class="p">,</span>
            <span class="s2">&quot;2077-0383&quot;</span><span class="p">:</span> <span class="s2">&quot;jcm&quot;</span><span class="p">,</span>
            <span class="s2">&quot;2079-7737&quot;</span><span class="p">:</span> <span class="s2">&quot;biology&quot;</span><span class="p">,</span>
            <span class="s2">&quot;2223-7747&quot;</span><span class="p">:</span> <span class="s2">&quot;plants&quot;</span><span class="p">,</span>
            <span class="s2">&quot;2072-6651&quot;</span><span class="p">:</span> <span class="s2">&quot;toxins&quot;</span><span class="p">,</span>
            <span class="s2">&quot;2073-8994&quot;</span><span class="p">:</span> <span class="s2">&quot;symmetry&quot;</span><span class="p">,</span>
            <span class="s2">&quot;2075-5309&quot;</span><span class="p">:</span> <span class="s2">&quot;buildings&quot;</span><span class="p">,</span>
            <span class="s2">&quot;2079-9284&quot;</span><span class="p">:</span> <span class="s2">&quot;cosmetics&quot;</span><span class="p">,</span>
            <span class="s2">&quot;2073-4433&quot;</span><span class="p">:</span> <span class="s2">&quot;atmosphere&quot;</span><span class="p">,</span>
            <span class="s2">&quot;2079-6374&quot;</span><span class="p">:</span> <span class="s2">&quot;biosensors&quot;</span><span class="p">,</span>
            <span class="s2">&quot;2072-6694&quot;</span><span class="p">:</span> <span class="s2">&quot;cancers&quot;</span><span class="p">,</span>
            <span class="s2">&quot;2073-4344&quot;</span><span class="p">:</span> <span class="s2">&quot;catalysts&quot;</span><span class="p">,</span>
            <span class="s2">&quot;2079-9292&quot;</span><span class="p">:</span> <span class="s2">&quot;electronics&quot;</span><span class="p">,</span>
            <span class="s2">&quot;2075-4450&quot;</span><span class="p">:</span> <span class="s2">&quot;insects&quot;</span><span class="p">,</span>
            <span class="s2">&quot;2073-4352&quot;</span><span class="p">:</span> <span class="s2">&quot;crystals&quot;</span><span class="p">,</span>
            <span class="s2">&quot;2079-6412&quot;</span><span class="p">:</span> <span class="s2">&quot;coatings&quot;</span><span class="p">,</span>
            <span class="s2">&quot;2072-6643&quot;</span><span class="p">:</span> <span class="s2">&quot;nutrients&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">journal_code</span> <span class="o">=</span> <span class="n">mdpi_issn_to_journal</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">issn</span><span class="p">,</span> <span class="n">issn</span><span class="p">)</span>
        <span class="c1"># The correct DOI format is: 10.3390/{journal_code}{volume}{issue_padded}{article_padded}</span>
        <span class="c1"># Issue is always 2 digits, article is always at least 4 digits</span>
        <span class="n">issue_padded</span> <span class="o">=</span> <span class="n">issue</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">article_padded</span> <span class="o">=</span> <span class="n">article</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">mdpi_doi</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;10.3390/</span><span class="si">{</span><span class="n">journal_code</span><span class="si">}{</span><span class="n">volume</span><span class="si">}{</span><span class="n">issue_padded</span><span class="si">}{</span><span class="n">article_padded</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracted MDPI DOI from URL: </span><span class="si">{</span><span class="n">mdpi_doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mdpi_doi</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not extract MDPI DOI from URL: </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="fetch_dois_from_url">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.getpapers.fetch_dois_from_url">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">fetch_dois_from_url</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">doi_pattern</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fetch a URL and extract DOIs from its content.</span>
<span class="sd">    Returns a list with up to 3 valid DOIs found, or an empty list if none.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span> <span class="s1">&#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36 Edg/124.0.2478.67&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Accept&#39;</span><span class="p">:</span> <span class="s1">&#39;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Accept-Language&#39;</span><span class="p">:</span> <span class="s1">&#39;en-US,en;q=0.9&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Accept-Encoding&#39;</span><span class="p">:</span> <span class="s1">&#39;gzip, deflate, br&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Connection&#39;</span><span class="p">:</span> <span class="s1">&#39;keep-alive&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Upgrade-Insecure-Requests&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Sec-Fetch-Dest&#39;</span><span class="p">:</span> <span class="s1">&#39;document&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Sec-Fetch-Mode&#39;</span><span class="p">:</span> <span class="s1">&#39;navigate&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Sec-Fetch-Site&#39;</span><span class="p">:</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Sec-Fetch-User&#39;</span><span class="p">:</span> <span class="s1">&#39;?1&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Pragma&#39;</span><span class="p">:</span> <span class="s1">&#39;no-cache&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Cache-Control&#39;</span><span class="p">:</span> <span class="s1">&#39;no-cache&#39;</span><span class="p">,</span>
        <span class="s1">&#39;DNT&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
        <span class="n">session</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;unsupported_browser&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">url</span> <span class="ow">or</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">403</span><span class="p">:</span>
            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Access denied or unsupported browser page for </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">url</span> <span class="o">!=</span> <span class="n">url</span><span class="p">:</span>
            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;URL redirected from </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">vprint</span><span class="p">(</span><span class="s2">&quot;Waited 2 seconds after redirect&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">page_dois</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">doi_pattern</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">page_dois</span><span class="p">:</span>
                <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found DOIs in </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">page_dois</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># Return up to the first 3 valid DOIs found</span>
                <span class="k">return</span> <span class="n">page_dois</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No DOIs found in </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to fetch </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">: HTTP </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">TooManyRedirects</span><span class="p">:</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Too many redirects for </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error fetching </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[]</span></div>


<span class="c1"># def filter_paper_dois(dois: list) -&gt; list:</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     Filter a list of DOIs, keeping only those that are scholarly papers.</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     filtered = []</span>
<span class="c1">#     for doi in dois:</span>
<span class="c1">#         if is_paper_doi(doi):</span>
<span class="c1">#             filtered.append(doi)</span>
<span class="c1">#         else:</span>
<span class="c1">#             vprint(f&quot;Ignored non-paper DOI: {doi}&quot;)</span>
<span class="c1">#     return filtered</span>

<div class="viewcode-block" id="is_valid_doi">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.getpapers.is_valid_doi">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">is_valid_doi</span><span class="p">(</span><span class="n">doi</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if a single DOI is valid using the DOI System Proxy Server REST API.</span>
<span class="sd">    Returns True if the DOI exists and resolves properly.</span>
<span class="sd">    Falls back to Crossref if the API doesn&#39;t work.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Checking validity of DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># First, try using the DOI System Proxy Server REST API with comprehensive headers</span>
    <span class="n">api_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://doi.org/api/handles/</span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="s2">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36 Edg/124.0.2478.67&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Accept&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json, text/plain, */*&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Accept-Language&quot;</span><span class="p">:</span> <span class="s2">&quot;en-US,en;q=0.9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Accept-Encoding&quot;</span><span class="p">:</span> <span class="s2">&quot;gzip, deflate, br&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Referer&quot;</span><span class="p">:</span> <span class="s2">&quot;https://doi.org/&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Connection&quot;</span><span class="p">:</span> <span class="s2">&quot;keep-alive&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Upgrade-Insecure-Requests&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Sec-Fetch-Dest&quot;</span><span class="p">:</span> <span class="s2">&quot;document&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Sec-Fetch-Mode&quot;</span><span class="p">:</span> <span class="s2">&quot;navigate&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Sec-Fetch-Site&quot;</span><span class="p">:</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Sec-Fetch-User&quot;</span><span class="p">:</span> <span class="s2">&quot;?1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Cache-Control&quot;</span><span class="p">:</span> <span class="s2">&quot;no-cache&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Pragma&quot;</span><span class="p">:</span> <span class="s2">&quot;no-cache&quot;</span><span class="p">,</span>
        <span class="s2">&quot;DNT&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span>
    <span class="p">}</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="o">**</span><span class="n">_requests_kwargs</span><span class="p">({</span><span class="s2">&quot;headers&quot;</span><span class="p">:</span> <span class="n">headers</span><span class="p">,</span> <span class="s2">&quot;timeout&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">}))</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="n">response_code</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;responseCode&quot;</span><span class="p">)</span>
            
            <span class="c1"># Response code 1 means success (DOI exists)</span>
            <span class="k">if</span> <span class="n">response_code</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> is valid (responseCode=1)&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
                
            <span class="c1"># Response code 100 means handle not found (DOI doesn&#39;t exist)</span>
            <span class="k">elif</span> <span class="n">response_code</span> <span class="o">==</span> <span class="mi">100</span><span class="p">:</span>
                <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> is invalid (responseCode=100, handle not found)&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
                
            <span class="c1"># Response code 200 means values not found (handle exists but has no values)</span>
            <span class="k">elif</span> <span class="n">response_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> exists but has no values (responseCode=200)&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
                
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> check returned unexpected responseCode: </span><span class="si">{</span><span class="n">response_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DOI API returned status code </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error checking DOI via REST API: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Fallback: Try using Crossref API</span>
    <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using Crossref as fallback for DOI validation: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">works</span> <span class="o">=</span> <span class="n">Works</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">works</span><span class="o">.</span><span class="n">doi</span><span class="p">(</span><span class="n">doi</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> found in Crossref, treating as valid&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> not found in Crossref&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error checking DOI in Crossref: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Last resort: try a HEAD request to see if doi.org redirects properly</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">browser_headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="s2">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36 Edg/124.0.2478.67&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Accept&quot;</span><span class="p">:</span> <span class="s2">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Accept-Language&quot;</span><span class="p">:</span> <span class="s2">&quot;en-US,en;q=0.9&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Accept-Encoding&quot;</span><span class="p">:</span> <span class="s2">&quot;gzip, deflate, br&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Connection&quot;</span><span class="p">:</span> <span class="s2">&quot;keep-alive&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Upgrade-Insecure-Requests&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Sec-Fetch-Dest&quot;</span><span class="p">:</span> <span class="s2">&quot;document&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Sec-Fetch-Mode&quot;</span><span class="p">:</span> <span class="s2">&quot;navigate&quot;</span><span class="p">,</span> 
            <span class="s2">&quot;Sec-Fetch-Site&quot;</span><span class="p">:</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Cache-Control&quot;</span><span class="p">:</span> <span class="s2">&quot;no-cache&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Pragma&quot;</span><span class="p">:</span> <span class="s2">&quot;no-cache&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DNT&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span>
        <span class="p">}</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://doi.org/</span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">browser_headers</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">301</span><span class="p">,</span> <span class="mi">302</span><span class="p">):</span>
            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> resolves via HEAD request (status=</span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error on HEAD request for DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="validate_dois">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.getpapers.validate_dois">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_dois</span><span class="p">(</span><span class="n">dois</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a list of DOIs, return only those that are valid (resolve at doi.org or found in Crossref).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">valid_dois</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">doi</span> <span class="ow">in</span> <span class="n">dois</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">is_valid_doi</span><span class="p">(</span><span class="n">doi</span><span class="p">):</span>
            <span class="n">valid_dois</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">doi</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">valid_dois</span></div>


<div class="viewcode-block" id="extract_isbns_from_text">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.getpapers.extract_isbns_from_text">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_isbns_from_text</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract ISBN-13 (preferred) and ISBN-10 numbers from text content.</span>
<span class="sd">    Returns a list of (isbn, doi) tuples, preferring ISBN-13 if found, otherwise ISBN-10.</span>
<span class="sd">    Only includes valid ISBNs (according to Crossref) and their associated DOI(s) if available.</span>
<span class="sd">    If multiple DOIs are found for an ISBN, tries to extract the common DOI prefix (e.g., &lt;common doi&gt;.ch001, &lt;common doi&gt;.ch002).</span>
<span class="sd">    If the common prefix is not a valid DOI, returns None for DOI.</span>
<span class="sd">    Prints details with vprint.</span>
<span class="sd">    Only extracts ISBN-10 if no ISBN-13 is found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># ISBN-10: 10 digits, last digit can be X, may have hyphens or spaces</span>
    <span class="n">isbn10_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;\b(?:ISBN(?:-10)?:?\s*)?((?:\d[\s-]*)</span><span class="si">{9}</span><span class="s1">[\dXx])\b&#39;</span>
    <span class="c1"># ISBN-13: 13 digits, may have hyphens or spaces, starts with 978 or 979</span>
    <span class="n">isbn13_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;\b(?:ISBN(?:-13)?:?\s*)?((97[89][\s-]*)</span><span class="si">{1}</span><span class="s1">([\d][\s-]*)</span><span class="si">{10}</span><span class="s1">)\b&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">normalize_isbn</span><span class="p">(</span><span class="n">isbn</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[\s-]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">isbn</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">extract_common_doi_prefix</span><span class="p">(</span><span class="n">dois</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given a list of DOIs, extract the longest common prefix before a chapter/article suffix.</span>
<span class="sd">        E.g., for [&#39;10.1007/978-3-030-12345-6.ch001&#39;, &#39;10.1007/978-3-030-12345-6.ch002&#39;],</span>
<span class="sd">        returns &#39;10.1007/978-3-030-12345-6&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dois</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">split_dois</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\.ch\d+|\.\d+)$&#39;</span><span class="p">,</span> <span class="n">d</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dois</span><span class="p">]</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">commonprefix</span><span class="p">(</span><span class="n">split_dois</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prefix</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">prefix</span> <span class="k">if</span> <span class="n">prefix</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="c1"># Extract ISBN-13s</span>
    <span class="n">isbn13s</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">isbn13_pattern</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">isbn</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">match</span> <span class="k">if</span> <span class="n">m</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="nb">str</span><span class="p">)),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">isbn</span> <span class="o">=</span> <span class="n">match</span>
        <span class="k">if</span> <span class="n">isbn</span><span class="p">:</span>
            <span class="n">norm_isbn</span> <span class="o">=</span> <span class="n">normalize_isbn</span><span class="p">(</span><span class="n">isbn</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">norm_isbn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">isbn13s</span><span class="p">:</span>
                <span class="n">isbn13s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm_isbn</span><span class="p">)</span>
    <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found ISBN-13s: </span><span class="si">{</span><span class="n">isbn13s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">works</span> <span class="o">=</span> <span class="n">Works</span><span class="p">()</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Prefer ISBN-13s</span>
    <span class="k">if</span> <span class="n">isbn13s</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">isbn</span> <span class="ow">in</span> <span class="n">isbn13s</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Querying Crossref for ISBN-13: </span><span class="si">{</span><span class="n">isbn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">works</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">isbn</span><span class="o">=</span><span class="n">isbn</span><span class="p">))</span>
                <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Crossref returned </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span><span class="si">}</span><span class="s2"> items for ISBN-13 </span><span class="si">{</span><span class="n">isbn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">items</span><span class="p">:</span>
                    <span class="n">dois</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                        <span class="n">doi</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;DOI&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">doi</span><span class="p">:</span>
                            <span class="n">dois</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">doi</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">dois</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dois</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found DOI </span><span class="si">{</span><span class="n">dois</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> for ISBN-13 </span><span class="si">{</span><span class="n">isbn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">isbn</span><span class="p">,</span> <span class="n">dois</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">common_prefix</span> <span class="o">=</span> <span class="n">extract_common_doi_prefix</span><span class="p">(</span><span class="n">dois</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">common_prefix</span><span class="p">:</span>
                                <span class="c1"># Check if common prefix is a valid DOI</span>
                                <span class="k">if</span> <span class="n">is_valid_doi</span><span class="p">(</span><span class="n">common_prefix</span><span class="p">):</span>
                                    <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Multiple DOIs found for ISBN-13 </span><span class="si">{</span><span class="n">isbn</span><span class="si">}</span><span class="s2">, common prefix is a valid DOI: </span><span class="si">{</span><span class="n">common_prefix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">isbn</span><span class="p">,</span> <span class="n">common_prefix</span><span class="p">))</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Common prefix </span><span class="si">{</span><span class="n">common_prefix</span><span class="si">}</span><span class="s2"> for ISBN-13 </span><span class="si">{</span><span class="n">isbn</span><span class="si">}</span><span class="s2"> is not a valid DOI. Trying to append ISBN to the prefix...&quot;</span><span class="p">)</span>
                                    <span class="c1"># Try appending the ISBN in a few plausible ways and test validity</span>
                                    <span class="n">tried_candidates</span> <span class="o">=</span> <span class="p">[]</span>
                                    <span class="n">candidates</span> <span class="o">=</span> <span class="p">[</span>
                                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">common_prefix</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">isbn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">common_prefix</span><span class="si">}{</span><span class="n">isbn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">common_prefix</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">isbn</span><span class="si">}</span><span class="s2">&quot;</span>
                                    <span class="p">]</span>
                                    <span class="n">found_candidate</span> <span class="o">=</span> <span class="kc">None</span>
                                    <span class="k">for</span> <span class="n">cand</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">cand</span> <span class="ow">in</span> <span class="n">tried_candidates</span><span class="p">:</span>
                                            <span class="k">continue</span>
                                        <span class="n">tried_candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cand</span><span class="p">)</span>
                                        <span class="k">try</span><span class="p">:</span>
                                            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Testing candidate DOI: </span><span class="si">{</span><span class="n">cand</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                            <span class="k">if</span> <span class="n">is_valid_doi</span><span class="p">(</span><span class="n">cand</span><span class="p">):</span>
                                                <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Appended ISBN produced a valid DOI: </span><span class="si">{</span><span class="n">cand</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                                <span class="n">found_candidate</span> <span class="o">=</span> <span class="n">cand</span>
                                                <span class="k">break</span>
                                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error validating candidate DOI </span><span class="si">{</span><span class="n">cand</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                            <span class="k">continue</span>
                                    <span class="k">if</span> <span class="n">found_candidate</span><span class="p">:</span>
                                        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">isbn</span><span class="p">,</span> <span class="n">found_candidate</span><span class="p">))</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No valid DOI found by appending ISBN </span><span class="si">{</span><span class="n">isbn</span><span class="si">}</span><span class="s2"> to prefix </span><span class="si">{</span><span class="n">common_prefix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">isbn</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Multiple DOIs found for ISBN-13 </span><span class="si">{</span><span class="n">isbn</span><span class="si">}</span><span class="s2">, no common prefix. Returning all DOIs.&quot;</span><span class="p">)</span>
                                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">isbn</span><span class="p">,</span> <span class="n">dois</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No DOI found for ISBN-13 </span><span class="si">{</span><span class="n">isbn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">isbn</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No Crossref entry found for ISBN-13 </span><span class="si">{</span><span class="n">isbn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error querying Crossref for ISBN-13 </span><span class="si">{</span><span class="n">isbn</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
        <span class="k">return</span> <span class="n">results</span>

    <span class="c1"># Only extract ISBN-10 if no ISBN-13 found</span>
    <span class="n">isbn10s</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">isbn10_pattern</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">isbn</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">match</span> <span class="k">if</span> <span class="n">m</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="nb">str</span><span class="p">)),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">isbn</span> <span class="o">=</span> <span class="n">match</span>
        <span class="k">if</span> <span class="n">isbn</span><span class="p">:</span>
            <span class="n">norm_isbn</span> <span class="o">=</span> <span class="n">normalize_isbn</span><span class="p">(</span><span class="n">isbn</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">norm_isbn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">isbn10s</span><span class="p">:</span>
                <span class="n">isbn10s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm_isbn</span><span class="p">)</span>
    <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found ISBN-10s: </span><span class="si">{</span><span class="n">isbn10s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">isbn</span> <span class="ow">in</span> <span class="n">isbn10s</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Querying Crossref for ISBN-10: </span><span class="si">{</span><span class="n">isbn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">works</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">isbn</span><span class="o">=</span><span class="n">isbn</span><span class="p">))</span>
            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Crossref returned </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span><span class="si">}</span><span class="s2"> items for ISBN-10 </span><span class="si">{</span><span class="n">isbn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">items</span><span class="p">:</span>
                <span class="n">dois</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                    <span class="n">doi</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;DOI&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">doi</span><span class="p">:</span>
                        <span class="n">dois</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">doi</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dois</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dois</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found DOI </span><span class="si">{</span><span class="n">dois</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> for ISBN-10 </span><span class="si">{</span><span class="n">isbn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">isbn</span><span class="p">,</span> <span class="n">dois</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">common_prefix</span> <span class="o">=</span> <span class="n">extract_common_doi_prefix</span><span class="p">(</span><span class="n">dois</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">common_prefix</span><span class="p">:</span>
                            <span class="c1"># If common prefix is already a valid DOI, use it</span>
                            <span class="k">if</span> <span class="n">is_valid_doi</span><span class="p">(</span><span class="n">common_prefix</span><span class="p">):</span>
                                <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Multiple DOIs found for ISBN-10 </span><span class="si">{</span><span class="n">isbn</span><span class="si">}</span><span class="s2">, common prefix is a valid DOI: </span><span class="si">{</span><span class="n">common_prefix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">isbn</span><span class="p">,</span> <span class="n">common_prefix</span><span class="p">))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Common prefix </span><span class="si">{</span><span class="n">common_prefix</span><span class="si">}</span><span class="s2"> for ISBN-10 </span><span class="si">{</span><span class="n">isbn</span><span class="si">}</span><span class="s2"> is not a valid DOI. Trying to append ISBN to the prefix...&quot;</span><span class="p">)</span>
                                <span class="c1"># Try appending the ISBN in a few plausible ways and test validity</span>
                                <span class="n">tried_candidates</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="n">candidates</span> <span class="o">=</span> <span class="p">[</span>
                                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">common_prefix</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">isbn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">common_prefix</span><span class="si">}{</span><span class="n">isbn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">common_prefix</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">isbn</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="p">]</span>
                                <span class="n">found_candidate</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="k">for</span> <span class="n">cand</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">cand</span> <span class="ow">in</span> <span class="n">tried_candidates</span><span class="p">:</span>
                                        <span class="k">continue</span>
                                    <span class="n">tried_candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cand</span><span class="p">)</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Testing candidate DOI: </span><span class="si">{</span><span class="n">cand</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="n">is_valid_doi</span><span class="p">(</span><span class="n">cand</span><span class="p">):</span>
                                            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Appended ISBN produced a valid DOI: </span><span class="si">{</span><span class="n">cand</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                            <span class="n">found_candidate</span> <span class="o">=</span> <span class="n">cand</span>
                                            <span class="k">break</span>
                                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error validating candidate DOI </span><span class="si">{</span><span class="n">cand</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                        <span class="k">continue</span>
                                <span class="k">if</span> <span class="n">found_candidate</span><span class="p">:</span>
                                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">isbn</span><span class="p">,</span> <span class="n">found_candidate</span><span class="p">))</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No valid DOI found by appending ISBN </span><span class="si">{</span><span class="n">isbn</span><span class="si">}</span><span class="s2"> to prefix </span><span class="si">{</span><span class="n">common_prefix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">isbn</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Multiple DOIs found for ISBN-10 </span><span class="si">{</span><span class="n">isbn</span><span class="si">}</span><span class="s2">, no common prefix. Returning all DOIs.&quot;</span><span class="p">)</span>
                            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">isbn</span><span class="p">,</span> <span class="n">dois</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No DOI found for ISBN-10 </span><span class="si">{</span><span class="n">isbn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">isbn</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No Crossref entry found for ISBN-10 </span><span class="si">{</span><span class="n">isbn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error querying Crossref for ISBN-10 </span><span class="si">{</span><span class="n">isbn</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
    <span class="k">return</span> <span class="n">results</span></div>


<div class="viewcode-block" id="extract_dois_from_text">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.getpapers.extract_dois_from_text">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_dois_from_text</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract DOI numbers from text content.</span>
<span class="sd">    Returns a list of unique, valid paper DOIs.</span>
<span class="sd">    Only keeps DOIs that resolve at https://doi.org/&lt;doi&gt; (HTTP 200, 301, 302).</span>
<span class="sd">    If no DOI is found, tries to extract ISBN and resolve to DOI.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracting DOIs from text </span><span class="si">{</span><span class="n">text</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span><span class="si">}</span><span class="s2">... (length: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="n">dois</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">doi_patterns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sa">r</span><span class="s1">&#39;\b10\.\d{4,9}/[A-Za-z0-9\-._;()/:]+&#39;</span><span class="p">,</span>
        <span class="sa">r</span><span class="s1">&#39;\b10\.\d{4,9}\s*/\s*[A-Za-z0-9\-._;()/:]+&#39;</span><span class="p">,</span>
        <span class="sa">r</span><span class="s1">&#39;\bdoi:\s*(10\.\d{4,9}/[A-Za-z0-9\-._;()/:]+)&#39;</span><span class="p">,</span>
        <span class="sa">r</span><span class="s1">&#39;\bhttps?://doi\.org/(10\.\d{4,9}/[A-Za-z0-9\-._;()/:]+)&#39;</span><span class="p">,</span>
        <span class="sa">r</span><span class="s1">&#39;\bhttps?://dx\.doi\.org/(10\.\d{4,9}/[A-Za-z0-9\-._;()/:]+)&#39;</span><span class="p">,</span>
        <span class="sa">r</span><span class="s1">&#39;\bdoi\s*=\s*[&quot;</span><span class="se">\&#39;</span><span class="s1">]?(10\.\d{4,9}/[A-Za-z0-9\-._;()/:]+)&#39;</span><span class="p">,</span>
        <span class="sa">r</span><span class="s1">&#39;\bDigital Object Identifier[:\s]*(10\.\d{4,9}/[A-Za-z0-9\-._;()/:]+)&#39;</span><span class="p">,</span>
        <span class="sa">r</span><span class="s1">&#39;\bDOI Identifier[:\s]*(10\.\d{4,9}/[A-Za-z0-9\-._;()/:]+)&#39;</span><span class="p">,</span>
        <span class="sa">r</span><span class="s1">&#39;\bDOI\s*(10\.\d{4,9}/[A-Za-z0-9\-._;()/:]+)&#39;</span><span class="p">,</span>  
        <span class="sa">r</span><span class="s1">&#39;\bDOI[:\s]+(10\.\d{4,9}/[A-Za-z0-9\-._;()/:]+)&#39;</span><span class="p">,</span> 
        <span class="sa">r</span><span class="s1">&#39;\b(10\.\d{4,9}/[A-Za-z0-9\-._;()/:]+)&#39;</span><span class="p">,</span>
        <span class="sa">r</span><span class="s1">&#39;\b10\.1109/[A-Z]+(?:\.[0-9]</span><span class="si">{4}</span><span class="s1">)+\.[0-9]+&#39;</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">doi_patterns</span><span class="p">:</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">matches</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                    <span class="n">doi_part</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">group</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">match</span> <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;10.&#39;</span><span class="p">)),</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">doi_part</span><span class="p">:</span>
                        <span class="n">dois</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">doi_part</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">doi_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(10\.\d{4,9}/[A-Za-z0-9\-._;()/:]+)&#39;</span><span class="p">,</span> <span class="n">match</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">doi_match</span><span class="p">:</span>
                        <span class="n">dois</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">doi_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dois</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">match</span><span class="p">)</span>

    <span class="c1"># Remove trailing dot from DOIs</span>
    <span class="n">dois</span> <span class="o">=</span> <span class="p">[</span><span class="n">doi</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">doi</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">doi</span> <span class="k">for</span> <span class="n">doi</span> <span class="ow">in</span> <span class="n">dois</span><span class="p">]</span>

    <span class="n">dois</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">dois</span><span class="p">))</span>

    <span class="n">url_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;https?://[^\s&lt;&gt;&quot;</span><span class="si">{}</span><span class="s1">|</span><span class="se">\\</span><span class="s1">^`\[\]]+[^\s&lt;&gt;&quot;</span><span class="si">{}</span><span class="s1">|</span><span class="se">\\</span><span class="s1">^`\[\].,;:!?]|https?://[^\s&lt;&gt;&quot;</span><span class="si">{}</span><span class="s1">|</span><span class="se">\\</span><span class="s1">^`\[\]]+\.\.\.[^\s&lt;&gt;&quot;</span><span class="si">{}</span><span class="s1">|</span><span class="se">\\</span><span class="s1">^`\[\]]+[^\s&lt;&gt;&quot;</span><span class="si">{}</span><span class="s1">|</span><span class="se">\\</span><span class="s1">^`\[\].,;:!?]&#39;</span>
    <span class="n">urls</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">url_pattern</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">urls</span><span class="p">)</span><span class="si">}</span><span class="s2"> URLs in text for DOI extraction: </span><span class="si">{</span><span class="n">urls</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">:</span>
        <span class="n">already_has_doi</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="sa">r</span><span class="s1">&#39;10\.\d{4,9}/[A-Za-z0-9\-._;()/:]+&#39;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s1">&#39;10\.\d{4,9}\s*/\s*[A-Za-z0-9\-._;()/:]+&#39;</span>
        <span class="p">]:</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
                <span class="n">already_has_doi</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">already_has_doi</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="s2">&quot;sciencedirect.com&quot;</span> <span class="ow">in</span> <span class="n">url</span> <span class="ow">or</span> <span class="s2">&quot;kidney-international.org&quot;</span> <span class="ow">in</span> <span class="n">url</span> <span class="ow">or</span> <span class="s2">&quot;journal.chestnet.org&quot;</span> <span class="ow">in</span> <span class="n">url</span><span class="p">:</span>
            <span class="n">pii_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;/(?:pii|article)/([S][A-Z0-9()-]+)&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pii_match</span><span class="p">:</span>
                <span class="n">pii</span> <span class="o">=</span> <span class="n">pii_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detected ScienceDirect PII in URL: </span><span class="si">{</span><span class="n">pii</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">doi</span> <span class="o">=</span> <span class="n">resolve_pii_to_doi</span><span class="p">(</span><span class="n">pii</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">doi</span><span class="p">:</span>
                    <span class="c1"># Remove trailing dot if present</span>
                    <span class="n">doi</span> <span class="o">=</span> <span class="n">doi</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">doi</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">doi</span>
                    <span class="n">dois</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">doi</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not resolve PII </span><span class="si">{</span><span class="n">pii</span><span class="si">}</span><span class="s2"> to DOI&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No PII found in ScienceDirect URL: </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="s2">&quot;mdpi.com&quot;</span> <span class="ow">in</span> <span class="n">url</span><span class="p">:</span>
            <span class="n">mdpi_doi</span> <span class="o">=</span> <span class="n">extract_mdpi_doi_from_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mdpi_doi</span><span class="p">:</span>
                <span class="n">mdpi_doi</span> <span class="o">=</span> <span class="n">mdpi_doi</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">mdpi_doi</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">mdpi_doi</span>
                <span class="n">dois</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mdpi_doi</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Checking URL for DOI: </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">doi_pattern</span> <span class="ow">in</span> <span class="n">doi_patterns</span><span class="p">:</span>
            <span class="n">page_dois</span> <span class="o">=</span> <span class="n">fetch_dois_from_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">doi_pattern</span><span class="p">)</span>
            <span class="c1"># Remove trailing dot from DOIs found in page</span>
            <span class="n">page_dois</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">page_dois</span><span class="p">]</span>
            <span class="n">dois</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">page_dois</span><span class="p">)</span>

    <span class="n">unique_dois</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">dois</span><span class="p">))</span>
    <span class="n">valid_dois</span> <span class="o">=</span> <span class="n">validate_dois</span><span class="p">(</span><span class="n">unique_dois</span><span class="p">)</span>

    <span class="c1"># If no DOI found, try to extract ISBN and resolve to DOI</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_dois</span><span class="p">:</span>
        <span class="n">vprint</span><span class="p">(</span><span class="s2">&quot;No DOI found, trying to extract ISBN and resolve to DOI...&quot;</span><span class="p">)</span>
        <span class="n">isbn_results</span> <span class="o">=</span> <span class="n">extract_isbns_from_text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">isbn_results</span><span class="p">:</span>
            <span class="c1"># isbn_results is a list of (isbn, doi) tuples</span>
            <span class="k">for</span> <span class="n">isbn</span><span class="p">,</span> <span class="n">doi</span> <span class="ow">in</span> <span class="n">isbn_results</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">doi</span><span class="p">:</span>
                    <span class="n">doi</span> <span class="o">=</span> <span class="n">doi</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">doi</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">doi</span>
                    <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resolved ISBN </span><span class="si">{</span><span class="n">isbn</span><span class="si">}</span><span class="s2"> to DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">valid_dois</span> <span class="o">=</span> <span class="p">[</span><span class="n">doi</span><span class="p">]</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ISBN </span><span class="si">{</span><span class="n">isbn</span><span class="si">}</span><span class="s2"> did not resolve to a DOI&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">valid_dois</span></div>


<div class="viewcode-block" id="extract_doi_from_title">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.getpapers.extract_doi_from_title">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_doi_from_title</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Search Crossref for a given paper title and return the DOI if there is a unique match.</span>
<span class="sd">    If Crossref returns more than one matching item, return None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">title</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">title</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
        <span class="n">vprint</span><span class="p">(</span><span class="s2">&quot;extract_doi_from_title: empty title provided&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">works</span> <span class="o">=</span> <span class="n">Works</span><span class="p">()</span>
        <span class="c1"># Query Crossref for the title. Limit scanning to two results:</span>
        <span class="c1"># if more than one result is found we will bail out.</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">works</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">title</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s1">&#39;DOI&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s1">&#39;relevance&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="s1">&#39;desc&#39;</span><span class="p">)</span>

        <span class="n">found</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">doi</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DOI&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">doi</span><span class="p">:</span>
                <span class="n">found</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="c1"># Stop early if more than one match</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">found</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extract_doi_from_title: more than one Crossref result for title &#39;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&#39; -&gt; giving up&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">found</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">doi</span> <span class="o">=</span> <span class="n">found</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DOI&#39;</span><span class="p">)</span>
            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extract_doi_from_title: unique DOI found for title &#39;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">doi</span>

        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extract_doi_from_title: no Crossref results for title &#39;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extract_doi_from_title: Crossref query failed for title &#39;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="extract_dois_from_file">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.getpapers.extract_dois_from_file">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_dois_from_file</span><span class="p">(</span><span class="n">input_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract DOI numbers from a text file and write them to a new file.</span>
<span class="sd">    Also tries to extract Elsevier PII numbers from the file name and resolve them to DOIs.</span>
<span class="sd">    Additionally attempts to extract ISBN numbers from the file name and resolve them to DOIs via Crossref.</span>
<span class="sd">    As a final fallback, use the file name (cleaned) as a title and try to extract a DOI via Crossref title search.</span>
<span class="sd">    Returns the list of extracted DOIs.</span>
<span class="sd">    Prints status messages with icons for better readability.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ICON_START</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">ICON_FILE</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">ICON_SUCCESS</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">ICON_FAIL</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">ICON_DOI</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">ICON_OUTPUT</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">ICON_WARN</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">ICON_ISBN</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">ICON_TITLE</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_START</span><span class="si">}</span><span class="s2"> Extracting DOIs from file: </span><span class="si">{</span><span class="n">input_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_FILE</span><span class="si">}</span><span class="s2"> Read input file: </span><span class="si">{</span><span class="n">input_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_FAIL</span><span class="si">}</span><span class="s2"> Failed to read input file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="c1"># Use the new extract_dois_from_text function</span>
    <span class="n">filtered_dois</span> <span class="o">=</span> <span class="n">extract_dois_from_text</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

    <span class="c1"># Try to extract PII numbers from the file name and resolve to DOI</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">input_file</span><span class="p">)</span>
    <span class="n">pii_patterns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sa">r</span><span class="s1">&#39;PII([A-Z0-9\-()]+)&#39;</span><span class="p">,</span>  <span class="c1"># e.g., PIIS235246422200092X.pdf</span>
        <span class="sa">r</span><span class="s1">&#39;1-s2\.0-([A-Z0-9\-()]+)-main&#39;</span><span class="p">,</span>  <span class="c1"># e.g., 1-s2.0-S2949813924000843-main.pdf</span>
        <span class="sa">r</span><span class="s1">&#39;([S][A-Z0-9\-()]{15,})&#39;</span>  <span class="c1"># generic S-prefixed PII, at least 15 chars</span>
    <span class="p">]</span>
    <span class="n">found_pii</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">pii_patterns</span><span class="p">:</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
            <span class="n">found_pii</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PII numbers found in filename: </span><span class="si">{</span><span class="n">found_pii</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">pii</span> <span class="ow">in</span> <span class="n">found_pii</span><span class="p">:</span>
        <span class="n">doi</span> <span class="o">=</span> <span class="n">resolve_pii_to_doi</span><span class="p">(</span><span class="n">pii</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">doi</span> <span class="ow">and</span> <span class="n">doi</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filtered_dois</span><span class="p">:</span>
            <span class="n">filtered_dois</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">doi</span><span class="p">)</span>
            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resolved PII </span><span class="si">{</span><span class="n">pii</span><span class="si">}</span><span class="s2"> to DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Additionally, try to extract ISBN from the file name and resolve to DOI(s)</span>
    <span class="c1"># This uses extract_isbns_from_text which queries Crossref for ISBN -&gt; DOI mapping.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_ISBN</span><span class="si">}</span><span class="s2"> Attempting to extract ISBN(s) from filename: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">isbn_results</span> <span class="o">=</span> <span class="n">extract_isbns_from_text</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_ISBN</span><span class="si">}</span><span class="s2"> ISBN resolution results: </span><span class="si">{</span><span class="n">isbn_results</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">isbn</span><span class="p">,</span> <span class="n">doi_info</span> <span class="ow">in</span> <span class="n">isbn_results</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">doi_info</span><span class="p">:</span>
                <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_ISBN</span><span class="si">}</span><span class="s2"> ISBN </span><span class="si">{</span><span class="n">isbn</span><span class="si">}</span><span class="s2"> did not resolve to a DOI&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="c1"># doi_info can be a string DOI, None, or a list of DOIs</span>
            <span class="n">doi_candidates</span> <span class="o">=</span> <span class="n">doi_info</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">doi_info</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">doi_info</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">doi_candidates</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">candidate</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c1"># Normalize candidate and validate</span>
                <span class="n">candidate</span> <span class="o">=</span> <span class="n">candidate</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">is_valid_doi</span><span class="p">(</span><span class="n">candidate</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">candidate</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filtered_dois</span><span class="p">:</span>
                            <span class="n">filtered_dois</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">candidate</span><span class="p">)</span>
                            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_ISBN</span><span class="si">}</span><span class="s2"> Resolved ISBN </span><span class="si">{</span><span class="n">isbn</span><span class="si">}</span><span class="s2"> -&gt; DOI </span><span class="si">{</span><span class="n">candidate</span><span class="si">}</span><span class="s2"> (added)&quot;</span><span class="p">)</span>
                        <span class="k">break</span>  <span class="c1"># stop after first valid DOI for this ISBN</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_ISBN</span><span class="si">}</span><span class="s2"> Candidate DOI </span><span class="si">{</span><span class="n">candidate</span><span class="si">}</span><span class="s2"> for ISBN </span><span class="si">{</span><span class="n">isbn</span><span class="si">}</span><span class="s2"> is not valid&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_ISBN</span><span class="si">}</span><span class="s2"> Error validating DOI </span><span class="si">{</span><span class="n">candidate</span><span class="si">}</span><span class="s2"> for ISBN </span><span class="si">{</span><span class="n">isbn</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_ISBN</span><span class="si">}</span><span class="s2"> Error while extracting ISBN from filename: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Final fallback: use filename (without extension) as a title and try Crossref title search</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">filtered_dois</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">base_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># Clean the base name to make a reasonable title: replace underscores/dashes/dots with spaces</span>
            <span class="n">title_candidate</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[_\-\.\s]+&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">base_name</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_TITLE</span><span class="si">}</span><span class="s2"> No DOIs found yet. Trying to use filename as title: &#39;</span><span class="si">{</span><span class="n">title_candidate</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">title_candidate</span><span class="p">:</span>
                <span class="n">doi_from_title</span> <span class="o">=</span> <span class="n">extract_doi_from_title</span><span class="p">(</span><span class="n">title_candidate</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">doi_from_title</span><span class="p">:</span>
                    <span class="n">doi_from_title</span> <span class="o">=</span> <span class="n">doi_from_title</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                    <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_TITLE</span><span class="si">}</span><span class="s2"> Crossref returned DOI &#39;</span><span class="si">{</span><span class="n">doi_from_title</span><span class="si">}</span><span class="s2">&#39; for title candidate&quot;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">is_valid_doi</span><span class="p">(</span><span class="n">doi_from_title</span><span class="p">):</span>
                            <span class="n">filtered_dois</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">doi_from_title</span><span class="p">)</span>
                            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_TITLE</span><span class="si">}</span><span class="s2"> Added DOI from title fallback: </span><span class="si">{</span><span class="n">doi_from_title</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_TITLE</span><span class="si">}</span><span class="s2"> DOI from title &#39;</span><span class="si">{</span><span class="n">doi_from_title</span><span class="si">}</span><span class="s2">&#39; did not validate as a resolvable DOI&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_TITLE</span><span class="si">}</span><span class="s2"> Error validating DOI from title &#39;</span><span class="si">{</span><span class="n">doi_from_title</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_TITLE</span><span class="si">}</span><span class="s2"> No unique DOI found for title candidate via Crossref&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_TITLE</span><span class="si">}</span><span class="s2"> Error during title-fallback DOI extraction: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">filtered_dois</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_WARN</span><span class="si">}</span><span class="s2"> No valid paper DOIs found in </span><span class="si">{</span><span class="n">input_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="n">base_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">input_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">.dois.txt&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">doi</span> <span class="ow">in</span> <span class="n">filtered_dois</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_SUCCESS</span><span class="si">}</span><span class="s2"> Extracted </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filtered_dois</span><span class="p">)</span><span class="si">}</span><span class="s2"> paper DOIs&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_DOI</span><span class="si">}</span><span class="s2"> DOIs found: </span><span class="si">{</span><span class="n">filtered_dois</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_OUTPUT</span><span class="si">}</span><span class="s2"> Written DOIs to: </span><span class="si">{</span><span class="n">output_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_FAIL</span><span class="si">}</span><span class="s2"> Failed to write DOIs to output file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">return</span> <span class="n">filtered_dois</span></div>


<div class="viewcode-block" id="extract_text_from_pdf">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.getpapers.extract_text_from_pdf">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_text_from_pdf</span><span class="p">(</span><span class="n">pdf_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_pages</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract text from a PDF file using PyMuPDF (pymupdf) if available,</span>
<span class="sd">    otherwise fall back to PyPDF2. Uses text blocks to intelligently</span>
<span class="sd">    preserve document structure including paragraphs and headings.</span>
<span class="sd">    Returns the extracted text as a string.</span>
<span class="sd">    If max_pages is specified, only extract up to the first N pages.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extract_text_from_pdf: Starting extraction for </span><span class="si">{</span><span class="n">pdf_file</span><span class="si">}</span><span class="s2"> (max_pages=</span><span class="si">{</span><span class="n">max_pages</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">pymupdf</span>  <span class="c1"># PyMuPDF package</span>
        <span class="n">vprint</span><span class="p">(</span><span class="s2">&quot;extract_text_from_pdf: Using PyMuPDF for extraction.&quot;</span><span class="p">)</span>
        <span class="n">text_chunks</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Use context manager to ensure document is properly closed</span>
        <span class="k">with</span> <span class="n">pymupdf</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">pdf_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">doc</span><span class="p">:</span>
            <span class="n">num_pages</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extract_text_from_pdf: PDF has </span><span class="si">{</span><span class="n">num_pages</span><span class="si">}</span><span class="s2"> pages.&quot;</span><span class="p">)</span>
            <span class="n">page_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_pages</span><span class="p">)</span> <span class="k">if</span> <span class="n">max_pages</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">num_pages</span><span class="p">,</span> <span class="n">max_pages</span><span class="p">))</span>
            
            <span class="k">for</span> <span class="n">page_num</span> <span class="ow">in</span> <span class="n">page_range</span><span class="p">:</span>
                <span class="n">page</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="n">page_num</span><span class="p">]</span>
                <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extract_text_from_pdf: Processing page </span><span class="si">{</span><span class="n">page_num</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">num_pages</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="c1"># Try first with the &#39;text&#39; option which preserves some layout</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">page_text</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">page_text</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">page_text</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>  <span class="c1"># Reasonable text found</span>
                        <span class="n">text_chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">page_text</span><span class="p">)</span>
                        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extract_text_from_pdf: Extracted </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">page_text</span><span class="p">)</span><span class="si">}</span><span class="s2"> chars with &#39;text&#39; mode from page </span><span class="si">{</span><span class="n">page_num</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extract_text_from_pdf: Error with &#39;text&#39; mode: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="c1"># If &#39;text&#39; mode didn&#39;t provide good results, use more detailed extraction</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Get all blocks with their bounding boxes using &#39;dict&#39; mode</span>
                    <span class="n">page_dict</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="s2">&quot;dict&quot;</span><span class="p">)</span>
                    <span class="n">blocks</span> <span class="o">=</span> <span class="n">page_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;blocks&quot;</span><span class="p">,</span> <span class="p">[])</span>
                    <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extract_text_from_pdf: Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">blocks</span><span class="p">)</span><span class="si">}</span><span class="s2"> blocks on page </span><span class="si">{</span><span class="n">page_num</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="n">paragraphs</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">block</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Text block</span>
                            <span class="n">block_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">block</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span> <span class="p">[]):</span>
                                <span class="n">line_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">span</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">span</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;spans&quot;</span><span class="p">,</span> <span class="p">[]))</span>
                                <span class="k">if</span> <span class="n">line_text</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                                    <span class="k">if</span> <span class="n">block_text</span><span class="p">:</span>
                                        <span class="n">block_text</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span>  <span class="c1"># Space between lines within same block</span>
                                    <span class="n">block_text</span> <span class="o">+=</span> <span class="n">line_text</span>
                            <span class="k">if</span> <span class="n">block_text</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                                <span class="n">paragraphs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">block_text</span><span class="p">)</span>
                    
                    <span class="c1"># Join paragraphs with double newlines to preserve structure</span>
                    <span class="n">page_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">paragraphs</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">page_text</span><span class="p">:</span>
                        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extract_text_from_pdf: Extracted </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">page_text</span><span class="p">)</span><span class="si">}</span><span class="s2"> chars with &#39;dict&#39; mode from page </span><span class="si">{</span><span class="n">page_num</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">text_chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">page_text</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extract_text_from_pdf: No text extracted with &#39;dict&#39; mode from page </span><span class="si">{</span><span class="n">page_num</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extract_text_from_pdf: Error with &#39;dict&#39; mode: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="c1"># Last resort: try &#39;blocks&#39; mode which is simpler</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">blocks_text</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="s2">&quot;blocks&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">blocks_text</span><span class="p">:</span>
                            <span class="n">text_chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">blocks_text</span> <span class="k">if</span> <span class="n">b</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>
                            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extract_text_from_pdf: Extracted text with &#39;blocks&#39; mode from page </span><span class="si">{</span><span class="n">page_num</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e2</span><span class="p">:</span>
                        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extract_text_from_pdf: Error with &#39;blocks&#39; mode: </span><span class="si">{</span><span class="n">e2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">text_chunks</span><span class="p">:</span>
            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extract_text_from_pdf: Extraction complete using PyMuPDF. Total text length: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">text_chunks</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text_chunks</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vprint</span><span class="p">(</span><span class="s2">&quot;extract_text_from_pdf: No text extracted with PyMuPDF, falling back to PyPDF2.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">vprint</span><span class="p">(</span><span class="s2">&quot;extract_text_from_pdf: PyMuPDF not installed, falling back to PyPDF2.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extract_text_from_pdf: PyMuPDF failed to extract text: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Falling back to PyPDF2.&quot;</span><span class="p">)</span>

    <span class="c1"># Fallback: PyPDF2</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">vprint</span><span class="p">(</span><span class="s2">&quot;extract_text_from_pdf: Using PyPDF2 for extraction.&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pdf_file</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">PyPDF2</span><span class="o">.</span><span class="n">PdfReader</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">num_pages</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">reader</span><span class="o">.</span><span class="n">pages</span><span class="p">)</span>
            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extract_text_from_pdf: PDF has </span><span class="si">{</span><span class="n">num_pages</span><span class="si">}</span><span class="s2"> pages (PyPDF2).&quot;</span><span class="p">)</span>
            <span class="n">page_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_pages</span><span class="p">)</span> <span class="k">if</span> <span class="n">max_pages</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">num_pages</span><span class="p">,</span> <span class="n">max_pages</span><span class="p">))</span>
            <span class="n">text_chunks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">page_range</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">page</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">page_text</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">extract_text</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">page_text</span><span class="p">:</span>
                        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extract_text_from_pdf: Extracted </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">page_text</span><span class="p">)</span><span class="si">}</span><span class="s2"> characters from page </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> (PyPDF2)&quot;</span><span class="p">)</span>
                        <span class="n">text_chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">page_text</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extract_text_from_pdf: No text extracted from page </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> (PyPDF2)&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extract_text_from_pdf: Exception extracting page </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> (PyPDF2): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
        <span class="n">total_len</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">text_chunks</span><span class="p">)</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extract_text_from_pdf: Extraction complete using PyPDF2. Total text length: </span><span class="si">{</span><span class="n">total_len</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text_chunks</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extract_text_from_pdf: PyPDF2 failed to extract text: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span></div>


<div class="viewcode-block" id="extract_doi_from_pdf">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.getpapers.extract_doi_from_pdf">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_doi_from_pdf</span><span class="p">(</span><span class="n">pdf_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract the most likely DOI found in a PDF file.</span>
<span class="sd">    If multiple DOIs are found, fetch the paper title from Crossref for each DOI,</span>
<span class="sd">    and check if a similar title exists in the first page of the PDF.</span>
<span class="sd">    Select the DOI whose title matches; if none match, select the first found.</span>
<span class="sd">    Also tries to extract Elsevier PII numbers from the file name and resolve them to DOIs.</span>
<span class="sd">    Only considers the first five pages of the PDF.</span>
<span class="sd">    Keeps newlines intact when extracting text from PDF pages.</span>
<span class="sd">    Prints more details for debug in verbose mode.</span>

<span class="sd">    Fallback: if no DOI can be extracted from text or PII, try to extract ISBN(s)</span>
<span class="sd">    from the file name and resolve them to DOI(s) via Crossref (using extract_isbns_from_text).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extract_doi_from_pdf: Extracting text from PDF (first 5 pages): </span><span class="si">{</span><span class="n">pdf_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">extract_text_from_pdf</span><span class="p">(</span><span class="n">pdf_file</span><span class="p">,</span> <span class="n">max_pages</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extract_doi_from_pdf: No text could be extracted from PDF: </span><span class="si">{</span><span class="n">pdf_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extract_doi_from_pdf: Extracting text from PDF (first page only): </span><span class="si">{</span><span class="n">pdf_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">first_page_text</span> <span class="o">=</span> <span class="n">extract_text_from_pdf</span><span class="p">(</span><span class="n">pdf_file</span><span class="p">,</span> <span class="n">max_pages</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extract_doi_from_pdf: First page text length: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">first_page_text</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extract_doi_from_pdf: Failed to extract text from PDF file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extract_doi_from_pdf: Extracting DOIs from PDF text...&quot;</span><span class="p">)</span>
    <span class="n">dois</span> <span class="o">=</span> <span class="n">extract_dois_from_text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="k">if</span> <span class="n">text</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extract_doi_from_pdf: DOIs found in PDF: </span><span class="si">{</span><span class="n">dois</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Try to extract PII numbers from the file name and resolve to DOI</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">pdf_file</span><span class="p">)</span>
    <span class="n">pii_patterns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sa">r</span><span class="s1">&#39;PII([A-Z0-9\-()]+)&#39;</span><span class="p">,</span>  <span class="c1"># e.g., PIIS235246422200092X.pdf</span>
        <span class="sa">r</span><span class="s1">&#39;1-s2\.0-([A-Z0-9\-()]+)-main&#39;</span><span class="p">,</span>  <span class="c1"># e.g., 1-s2.0-S2949813924000843-main.pdf</span>
        <span class="sa">r</span><span class="s1">&#39;([S][A-Z0-9\-()]{15,})&#39;</span>  <span class="c1"># generic S-prefixed PII, at least 15 chars</span>
    <span class="p">]</span>
    <span class="n">found_pii</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">pii_patterns</span><span class="p">:</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
            <span class="n">found_pii</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extract_doi_from_pdf: PII numbers found in filename: </span><span class="si">{</span><span class="n">found_pii</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">pii</span> <span class="ow">in</span> <span class="n">found_pii</span><span class="p">:</span>
        <span class="n">doi_from_pii</span> <span class="o">=</span> <span class="n">resolve_pii_to_doi</span><span class="p">(</span><span class="n">pii</span><span class="p">)</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extract_doi_from_pdf: resolve_pii_to_doi(</span><span class="si">{</span><span class="n">pii</span><span class="si">}</span><span class="s2">) -&gt; </span><span class="si">{</span><span class="n">doi_from_pii</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">doi_from_pii</span> <span class="ow">and</span> <span class="n">doi_from_pii</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dois</span><span class="p">:</span>
            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extract_doi_from_pdf: Resolved PII </span><span class="si">{</span><span class="n">pii</span><span class="si">}</span><span class="s2"> to DOI </span><span class="si">{</span><span class="n">doi_from_pii</span><span class="si">}</span><span class="s2">, inserting at front of DOI list&quot;</span><span class="p">)</span>
            <span class="n">dois</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">doi_from_pii</span><span class="p">)</span>  <span class="c1"># Prefer DOI from PII</span>

    <span class="c1"># If no DOIs found from text or PII, try ISBN extraction from filename as a fallback</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dois</span><span class="p">:</span>
        <span class="n">vprint</span><span class="p">(</span><span class="s2">&quot;extract_doi_from_pdf: No DOIs found in text or via PII, attempting ISBN extraction from filename...&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">isbn_results</span> <span class="o">=</span> <span class="n">extract_isbns_from_text</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extract_doi_from_pdf: ISBN extraction results: </span><span class="si">{</span><span class="n">isbn_results</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">isbn_results</span><span class="p">:</span>
                <span class="c1"># isbn_results is a list of (isbn, doi_info) tuples</span>
                <span class="k">for</span> <span class="n">isbn</span><span class="p">,</span> <span class="n">doi_info</span> <span class="ow">in</span> <span class="n">isbn_results</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">doi_info</span><span class="p">:</span>
                        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extract_doi_from_pdf: ISBN </span><span class="si">{</span><span class="n">isbn</span><span class="si">}</span><span class="s2"> did not resolve to a DOI&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="n">candidates</span> <span class="o">=</span> <span class="n">doi_info</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">doi_info</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">doi_info</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">candidate</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">candidate</span> <span class="o">=</span> <span class="n">candidate</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extract_doi_from_pdf: Validating candidate DOI from ISBN </span><span class="si">{</span><span class="n">isbn</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">candidate</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">is_valid_doi</span><span class="p">(</span><span class="n">candidate</span><span class="p">):</span>
                                <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extract_doi_from_pdf: Candidate DOI </span><span class="si">{</span><span class="n">candidate</span><span class="si">}</span><span class="s2"> validated, returning it.&quot;</span><span class="p">)</span>
                                <span class="k">return</span> <span class="n">candidate</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extract_doi_from_pdf: Candidate DOI </span><span class="si">{</span><span class="n">candidate</span><span class="si">}</span><span class="s2"> is not valid.&quot;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extract_doi_from_pdf: Error validating DOI </span><span class="si">{</span><span class="n">candidate</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">vprint</span><span class="p">(</span><span class="s2">&quot;extract_doi_from_pdf: No valid DOI found from ISBN extraction.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vprint</span><span class="p">(</span><span class="s2">&quot;extract_doi_from_pdf: No ISBNs found in filename.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extract_doi_from_pdf: Error during ISBN extraction from filename: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">dois</span><span class="p">:</span>
        <span class="n">vprint</span><span class="p">(</span><span class="s2">&quot;extract_doi_from_pdf: No DOIs found after all fallbacks.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dois</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extract_doi_from_pdf: Only one DOI found, returning: </span><span class="si">{</span><span class="n">dois</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dois</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># If multiple DOIs, try to match Crossref title with first page text</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">normalize</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\W+&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">s</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">doi</span> <span class="ow">in</span> <span class="n">dois</span><span class="p">:</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extract_doi_from_pdf: Fetching Crossref data for DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">crossref_data</span> <span class="o">=</span> <span class="n">fetch_crossref_data</span><span class="p">(</span><span class="n">doi</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extract_doi_from_pdf: Skipping Crossref lookup for </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> due to missing email: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">crossref_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">title</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">crossref_data</span><span class="p">:</span>
            <span class="n">title_list</span> <span class="o">=</span> <span class="n">crossref_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">title_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">title_list</span><span class="p">:</span>
                <span class="n">title</span> <span class="o">=</span> <span class="n">title_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">title_list</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">title</span> <span class="o">=</span> <span class="n">title_list</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extract_doi_from_pdf: Crossref title for DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
            <span class="n">norm_title</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
            <span class="n">norm_first_page</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">first_page_text</span><span class="p">)</span>
            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extract_doi_from_pdf: Normalized Crossref title: </span><span class="si">{</span><span class="n">norm_title</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extract_doi_from_pdf: Normalized first page text (first 100 chars): </span><span class="si">{</span><span class="n">norm_first_page</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">norm_title</span> <span class="ow">and</span> <span class="n">norm_title</span> <span class="ow">in</span> <span class="n">norm_first_page</span><span class="p">:</span>
                <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extract_doi_from_pdf: Title match found for DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">, returning this DOI.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">doi</span>

    <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;extract_doi_from_pdf: No title match found, returning first DOI: </span><span class="si">{</span><span class="n">dois</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dois</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="search_documents">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.getpapers.search_documents">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">search_documents</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Search for documents using StcGeck, Nexus bot, Crossref, and DOI REST API in order.</span>
<span class="sd">    Build a StcGeck-style document with all fields empty, and iteratively fill fields</span>
<span class="sd">    by searching each source in order. Return up to the requested limit of results.</span>
<span class="sd">    Always tries all sources before returning results.</span>
<span class="sd">    Prints important search steps with icons for better readability.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ICON_SEARCH</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">ICON_SUCCESS</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">ICON_WARNING</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">ICON_ERROR</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">ICON_STEP</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">ICON_SOURCE</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;stcgeck&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;nexus&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;crossref&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;doi_rest&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
    <span class="p">}</span>

    <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_SEARCH</span><span class="si">}</span><span class="s2"> Searching for: </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2"> (limit=</span><span class="si">{</span><span class="n">limit</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="c1"># Helper: create empty stcgeck-style doc</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">empty_doc</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;authors&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;metadata&#39;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s1">&#39;uris&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s1">&#39;issued_at&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;oa_status&#39;</span><span class="p">:</span> <span class="kc">None</span>
        <span class="p">}</span>

    <span class="c1"># Helper: merge fields from src into dst (only fill empty fields)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">merge_doc</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">src</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">dst</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">src</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">):</span>
            <span class="n">dst</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">dst</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">dst</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">src</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">):</span>
            <span class="n">dst</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dst</span><span class="p">[</span><span class="s1">&#39;authors&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">src</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;authors&#39;</span><span class="p">):</span>
            <span class="n">dst</span><span class="p">[</span><span class="s1">&#39;authors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;authors&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">src</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metadata&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">src</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dst</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">dst</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]:</span>
                    <span class="n">dst</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dst</span><span class="p">[</span><span class="s1">&#39;uris&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">src</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;uris&#39;</span><span class="p">):</span>
            <span class="n">dst</span><span class="p">[</span><span class="s1">&#39;uris&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;uris&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dst</span><span class="p">[</span><span class="s1">&#39;issued_at&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">src</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;issued_at&#39;</span><span class="p">):</span>
            <span class="n">dst</span><span class="p">[</span><span class="s1">&#39;issued_at&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;issued_at&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dst</span><span class="p">[</span><span class="s1">&#39;oa_status&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">src</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;oa_status&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dst</span><span class="p">[</span><span class="s1">&#39;oa_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;oa_status&#39;</span><span class="p">)</span>

    <span class="c1"># Try each source, collect up to limit unique DOIs</span>
    <span class="n">collected</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># 1. StcGeck</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_STEP</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">ICON_SOURCE</span><span class="p">[</span><span class="s1">&#39;stcgeck&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> Searching with StcGeck...&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">vprint</span><span class="p">(</span><span class="s2">&quot;Trying StcGeck search...&quot;</span><span class="p">)</span>
        <span class="n">geck</span> <span class="o">=</span> <span class="n">StcGeck</span><span class="p">(</span>
            <span class="n">ipfs_http_base_url</span><span class="o">=</span><span class="s2">&quot;http://127.0.0.1:8080&quot;</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">geck</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="n">summa_client</span> <span class="o">=</span> <span class="n">geck</span><span class="o">.</span><span class="n">get_summa_client</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;10.&quot;</span><span class="p">):</span>
                <span class="n">search_query</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;term&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;uris&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;doi:</span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}}</span>
                <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;StcGeck: Searching by DOI: </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">search_query</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;match&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}}</span>
                <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;StcGeck: Searching by keyword: </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">search_response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">summa_client</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;index_alias&quot;</span><span class="p">:</span> <span class="s2">&quot;stc&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">search_query</span><span class="p">,</span>
                    <span class="s2">&quot;collectors&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;top_docs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;limit&quot;</span><span class="p">:</span> <span class="n">limit</span><span class="p">}}],</span>
                    <span class="s2">&quot;is_fieldnorms_scoring_enabled&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="n">stc_results</span> <span class="o">=</span> <span class="n">search_response</span><span class="o">.</span><span class="n">collector_outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">documents</span><span class="o">.</span><span class="n">scored_documents</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_SUCCESS</span><span class="si">}</span><span class="s2"> StcGeck returned </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">stc_results</span><span class="p">)</span><span class="si">}</span><span class="s2"> results.&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">scored</span> <span class="ow">in</span> <span class="n">stc_results</span><span class="p">:</span>
                <span class="n">doc</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">scored</span><span class="o">.</span><span class="n">document</span><span class="p">)</span>
                <span class="n">doi</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">uri</span> <span class="ow">in</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;uris&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                    <span class="k">if</span> <span class="n">uri</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;doi:&#39;</span><span class="p">):</span>
                        <span class="n">doi</span> <span class="o">=</span> <span class="n">uri</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>
                        <span class="k">break</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">doi</span> <span class="ow">or</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">collected</span><span class="p">:</span>
                    <span class="n">base</span> <span class="o">=</span> <span class="n">empty_doc</span><span class="p">()</span>
                    <span class="n">merge_doc</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span>
                    <span class="n">collected</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">base</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">geck</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_ERROR</span><span class="si">}</span><span class="s2"> StcGeck failed&quot;</span><span class="p">)</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;StcGeck failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># 2. Nexus bot</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_STEP</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">ICON_SOURCE</span><span class="p">[</span><span class="s1">&#39;nexus&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> Searching with Nexus bot...&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">vprint</span><span class="p">(</span><span class="s2">&quot;Trying Nexus bot search...&quot;</span><span class="p">)</span>
        <span class="n">nexus_results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">search_with_nexus_bot</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_SUCCESS</span><span class="si">}</span><span class="s2"> Nexus bot returned </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">nexus_results</span><span class="p">)</span><span class="si">}</span><span class="s2"> results.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">scored</span> <span class="ow">in</span> <span class="n">nexus_results</span><span class="p">:</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">scored</span><span class="o">.</span><span class="n">document</span><span class="p">)</span>
            <span class="n">doi</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">uri</span> <span class="ow">in</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;uris&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="k">if</span> <span class="n">uri</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;doi:&#39;</span><span class="p">):</span>
                    <span class="n">doi</span> <span class="o">=</span> <span class="n">uri</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>
                    <span class="k">break</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">doi</span> <span class="ow">or</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">collected</span><span class="p">:</span>
                <span class="n">merge_doc</span><span class="p">(</span><span class="n">collected</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">doc</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">key</span><span class="p">:</span>
                <span class="n">base</span> <span class="o">=</span> <span class="n">empty_doc</span><span class="p">()</span>
                <span class="n">merge_doc</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span>
                <span class="n">collected</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">base</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_ERROR</span><span class="si">}</span><span class="s2"> Nexus bot failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Nexus bot failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># 3. Crossref</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_STEP</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">ICON_SOURCE</span><span class="p">[</span><span class="s1">&#39;crossref&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> Searching with Crossref...&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">vprint</span><span class="p">(</span><span class="s2">&quot;Trying Crossref search...&quot;</span><span class="p">)</span>
        <span class="n">crossref_results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">search_with_crossref</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_SUCCESS</span><span class="si">}</span><span class="s2"> Crossref returned </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">crossref_results</span><span class="p">)</span><span class="si">}</span><span class="s2"> results.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">scored</span> <span class="ow">in</span> <span class="n">crossref_results</span><span class="p">:</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">scored</span><span class="o">.</span><span class="n">document</span><span class="p">)</span>
            <span class="n">doi</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">uri</span> <span class="ow">in</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;uris&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="k">if</span> <span class="n">uri</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;doi:&#39;</span><span class="p">):</span>
                    <span class="n">doi</span> <span class="o">=</span> <span class="n">uri</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>
                    <span class="k">break</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">doi</span> <span class="ow">or</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">collected</span><span class="p">:</span>
                <span class="n">merge_doc</span><span class="p">(</span><span class="n">collected</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">doc</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">key</span><span class="p">:</span>
                <span class="n">base</span> <span class="o">=</span> <span class="n">empty_doc</span><span class="p">()</span>
                <span class="n">merge_doc</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span>
                <span class="n">collected</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">base</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_ERROR</span><span class="si">}</span><span class="s2"> Crossref failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Crossref failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># 4. DOI REST API</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_STEP</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">ICON_SOURCE</span><span class="p">[</span><span class="s1">&#39;doi_rest&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> Searching with DOI REST API...&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">vprint</span><span class="p">(</span><span class="s2">&quot;Trying DOI REST API search...&quot;</span><span class="p">)</span>
        <span class="n">doi_rest_results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">search_with_doi_rest_api</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_SUCCESS</span><span class="si">}</span><span class="s2"> DOI REST API returned </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">doi_rest_results</span><span class="p">)</span><span class="si">}</span><span class="s2"> results.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">scored</span> <span class="ow">in</span> <span class="n">doi_rest_results</span><span class="p">:</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">scored</span><span class="o">.</span><span class="n">document</span><span class="p">)</span>
            <span class="n">doi</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">uri</span> <span class="ow">in</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;uris&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="k">if</span> <span class="n">uri</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;doi:&#39;</span><span class="p">):</span>
                    <span class="n">doi</span> <span class="o">=</span> <span class="n">uri</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span>
                    <span class="k">break</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">doi</span> <span class="ow">or</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">collected</span><span class="p">:</span>
                <span class="n">merge_doc</span><span class="p">(</span><span class="n">collected</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">doc</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">key</span><span class="p">:</span>
                <span class="n">base</span> <span class="o">=</span> <span class="n">empty_doc</span><span class="p">()</span>
                <span class="n">merge_doc</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span>
                <span class="n">collected</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">base</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_ERROR</span><span class="si">}</span><span class="s2"> DOI REST API failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DOI REST API failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">collected</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_WARNING</span><span class="si">}</span><span class="s2"> No results found from any source.&quot;</span><span class="p">)</span>
        <span class="n">vprint</span><span class="p">(</span><span class="s2">&quot;No results found from any source.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_SUCCESS</span><span class="si">}</span><span class="s2"> Search complete. Returning </span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">collected</span><span class="p">),</span><span class="w"> </span><span class="n">limit</span><span class="p">)</span><span class="si">}</span><span class="s2"> result(s).&quot;</span><span class="p">)</span>
    <span class="c1"># Wrap as ScoredDocument-like objects</span>
    <span class="k">return</span> <span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="s1">&#39;ScoredDocument&#39;</span><span class="p">,</span> <span class="p">(),</span> <span class="p">{</span><span class="s1">&#39;document&#39;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">doc</span><span class="p">)})()</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">collected</span><span class="o">.</span><span class="n">values</span><span class="p">())[:</span><span class="n">limit</span><span class="p">]]</span></div>


<div class="viewcode-block" id="search_with_nexus_bot">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.getpapers.search_with_nexus_bot">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">search_with_nexus_bot</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Search for documents using the Nexus bot (functions imported from .nexus).</span>
<span class="sd">    Returns a list of ScoredDocument-like objects with a .document JSON string.</span>
<span class="sd">    Tries first without proxy, then with proxy if it fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">TG_API_ID</span><span class="p">,</span> <span class="n">TG_API_HASH</span><span class="p">,</span> <span class="n">PHONE</span><span class="p">,</span> <span class="n">BOT_USERNAME</span> <span class="o">=</span> <span class="k">await</span> <span class="n">nexus</span><span class="o">.</span><span class="n">load_credentials_from_file</span><span class="p">(</span><span class="n">nexus</span><span class="o">.</span><span class="n">CREDENTIALS_FILE</span><span class="p">,</span> <span class="n">print_result</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">proxies</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">nexus</span><span class="o">.</span><span class="n">DEFAULT_PROXY_FILE</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">proxy</span> <span class="ow">in</span> <span class="n">proxies</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">nexus</span><span class="o">.</span><span class="n">send_message_to_bot</span><span class="p">(</span>
                    <span class="n">api_id</span><span class="o">=</span><span class="n">TG_API_ID</span><span class="p">,</span>
                    <span class="n">api_hash</span><span class="o">=</span><span class="n">TG_API_HASH</span><span class="p">,</span>
                    <span class="n">phone_number</span><span class="o">=</span><span class="n">PHONE</span><span class="p">,</span>
                    <span class="n">bot_username</span><span class="o">=</span><span class="n">BOT_USERNAME</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
                    <span class="n">session_file</span><span class="o">=</span><span class="n">nexus</span><span class="o">.</span><span class="n">SESSION_FILE</span><span class="p">,</span>
                    <span class="n">proxy</span><span class="o">=</span><span class="n">proxy</span><span class="p">,</span>
                    <span class="n">limit</span><span class="o">=</span><span class="n">limit</span>
                <span class="p">)</span>
                <span class="c1"># If results is a list of dicts, convert each to stc format</span>
                <span class="n">docs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                        <span class="n">docs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">convert_nexus_to_stc_format</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">docs</span> <span class="o">=</span> <span class="n">convert_nexus_to_stc_format</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">docs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1"># Wrap as ScoredDocument-like objects</span>
                <span class="k">return</span> <span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="s1">&#39;ScoredDocument&#39;</span><span class="p">,</span> <span class="p">(),</span> <span class="p">{</span><span class="s1">&#39;document&#39;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">doc</span><span class="p">)})()</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Nexus bot search failed with proxy=</span><span class="si">{</span><span class="n">proxy</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># Try next proxy if available</span>
                <span class="k">continue</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Nexus bot search failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="convert_nexus_to_stc_format">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.getpapers.convert_nexus_to_stc_format">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">convert_nexus_to_stc_format</span><span class="p">(</span><span class="n">nexus_item</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a Nexus bot result (raw dict) to a list of StcGeck compatible documents.</span>
<span class="sd">    Handles both search (multiple results) and DOI (single result) formats.</span>
<span class="sd">    Returns a list of dicts (one per result).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If this is a raw result, extract the &#39;bot_reply&#39;-&gt;&#39;text&#39;</span>
    <span class="k">if</span> <span class="s2">&quot;bot_reply&quot;</span> <span class="ow">in</span> <span class="n">nexus_item</span> <span class="ow">and</span> <span class="s2">&quot;text&quot;</span> <span class="ow">in</span> <span class="n">nexus_item</span><span class="p">[</span><span class="s2">&quot;bot_reply&quot;</span><span class="p">]:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">nexus_item</span><span class="p">[</span><span class="s2">&quot;bot_reply&quot;</span><span class="p">][</span><span class="s2">&quot;text&quot;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="s2">&quot;text&quot;</span> <span class="ow">in</span> <span class="n">nexus_item</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">nexus_item</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="c1"># If this is a DOI query, the text starts with a marker emoji and contains &quot;**DOI:**&quot; or &quot;**DOI:** [doi](...)&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;**DOI:**&quot;</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
        <span class="c1"># Try to extract fields</span>
        <span class="n">title</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">authors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">journal</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">volume</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">issue</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">first_page</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">last_page</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">doi</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">year</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">issued_at</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">nexus_id</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Title: after marker emoji + &quot;**&quot;, before &quot;**&quot;</span>
        <span class="n">title_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(?:\[\d+\]\s*)?([])\s*\*\*(.*?)\*\*&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">title_match</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">title_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="c1"># Authors: after title, before &quot;in __&quot; or &quot;\n&quot;</span>
        <span class="n">authors_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\*\*.*\*\*\s*\n([^\n_]+)&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">authors_match</span><span class="p">:</span>
            <span class="n">authors_str</span> <span class="o">=</span> <span class="n">authors_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="c1"># Remove &quot;et al&quot;</span>
            <span class="n">authors_str</span> <span class="o">=</span> <span class="n">authors_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;et al&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="c1"># Remove &quot;in ...&quot; if present</span>
            <span class="n">authors_str</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+in\s+.*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">authors_str</span><span class="p">)</span>
            <span class="c1"># Split by &quot;;&quot; or &quot;,&quot; or &quot; and &quot;</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;;|,| and &quot;</span><span class="p">,</span> <span class="n">authors_str</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
                    <span class="n">names</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">authors</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;given&#39;</span><span class="p">:</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">names</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="s1">&#39;family&#39;</span><span class="p">:</span> <span class="n">names</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">authors</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;given&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;family&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">})</span>
        <span class="c1"># Journal: in __...__</span>
        <span class="n">journal_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;in __([^_]+)__&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">journal_match</span><span class="p">:</span>
            <span class="n">journal</span> <span class="o">=</span> <span class="n">journal_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="c1"># DOI: after &quot;**DOI:** [&quot; or &quot;**DOI:** &quot;</span>
        <span class="n">doi_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\*\*DOI:\*\*\s*(?:\[)?([^\s\]\n]+)&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">doi_match</span><span class="p">:</span>
            <span class="n">doi</span> <span class="o">=</span> <span class="n">doi_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="c1"># Year: look for (YYYY-MM) or (YYYY) after title, or at end after &quot;|&quot;</span>
        <span class="n">year_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\((\d</span><span class="si">{4}</span><span class="s2">)(?:-\d</span><span class="si">{2}</span><span class="s2">)?\)&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">year_match</span><span class="p">:</span>
            <span class="n">year_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\|\s*(\d</span><span class="si">{4}</span><span class="s2">)(?:-\d</span><span class="si">{2}</span><span class="s2">)?\s*$&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">year_match</span><span class="p">:</span>
            <span class="n">year_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\b(19|20)\d</span><span class="si">{2}</span><span class="s2">\b&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">year_match</span><span class="p">:</span>
            <span class="n">year</span> <span class="o">=</span> <span class="n">year_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">issued_at</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">issued_at</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Compose metadata</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">journal</span><span class="p">:</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;container_title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">journal</span>
        <span class="c1"># Publisher: after &quot;**Publisher:** [name]&quot;</span>
        <span class="n">publisher_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\*\*Publisher:\*\*\s*\[([^\]]+)\]&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">publisher_match</span><span class="p">:</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;publisher&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">publisher_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="c1"># Extract Nexus ID from LibSTC.cc link: after nid: and before )</span>
        <span class="n">nexus_id_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;LibSTC\.cc\]\([^)]+nid:([a-z0-9]+)\)&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nexus_id_match</span><span class="p">:</span>
            <span class="n">nexus_id</span> <span class="o">=</span> <span class="n">nexus_id_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Compose doc</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">nexus_id</span><span class="p">,</span>
            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">title</span> <span class="ow">or</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span>
            <span class="s1">&#39;authors&#39;</span><span class="p">:</span> <span class="n">authors</span><span class="p">,</span>
            <span class="s1">&#39;metadata&#39;</span><span class="p">:</span> <span class="n">metadata</span><span class="p">,</span>
            <span class="s1">&#39;uris&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;doi:</span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">doi</span> <span class="k">else</span> <span class="p">[],</span>
            <span class="s1">&#39;issued_at&#39;</span><span class="p">:</span> <span class="n">issued_at</span><span class="p">,</span>
            <span class="s1">&#39;oa_status&#39;</span><span class="p">:</span> <span class="kc">None</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">doc</span><span class="p">]</span>

    <span class="c1"># Otherwise, treat as search results (multiple entries)</span>
    <span class="c1"># Split into entries by the marker emojis, possibly preceded by [number]</span>
    <span class="n">marker_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;(?:\[\d+\]\s*)?[]&quot;</span>
    <span class="c1"># Find all marker positions</span>
    <span class="n">marker_matches</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">marker_pattern</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>
    <span class="n">docs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">marker_matches</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">docs</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">match</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">marker_matches</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">marker_matches</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="k">if</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">marker_matches</span><span class="p">)</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">entry</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># Title: after &quot;**&lt;P&gt;&quot; or &quot;**&quot;, before &quot;**&quot;</span>
        <span class="n">title_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\*\*(?:&lt;P&gt;)?\s*(.*?)\*\*&quot;</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">title_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="n">title_match</span> <span class="k">else</span> <span class="s2">&quot;N/A&quot;</span>

        <span class="c1"># Authors: after title, before &quot;__&quot; or &quot;\n&quot;</span>
        <span class="n">authors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">authors_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\*\*.*\*\*\s*\n([^\n_]+)&quot;</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">authors_match</span><span class="p">:</span>
            <span class="c1"># Try to split by &quot;et al&quot;, &quot;and&quot;, or comma</span>
            <span class="n">authors_str</span> <span class="o">=</span> <span class="n">authors_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="c1"># Remove &quot;in ...&quot; if present</span>
            <span class="n">authors_str</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\s+in\s+.*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">authors_str</span><span class="p">)</span>
            <span class="c1"># Remove &quot;et al&quot;</span>
            <span class="n">authors_str</span> <span class="o">=</span> <span class="n">authors_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;et al&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="c1"># Split by &quot;and&quot; or &quot;,&quot;</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;,| and &quot;</span><span class="p">,</span> <span class="n">authors_str</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
                    <span class="n">names</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">authors</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;given&#39;</span><span class="p">:</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">names</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="s1">&#39;family&#39;</span><span class="p">:</span> <span class="n">names</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">authors</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;given&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;family&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">})</span>

        <span class="c1"># Journal/metadata: look for &quot;in __...__&quot;</span>
        <span class="n">journal</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">journal_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;in __([^_]+)__&quot;</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">journal_match</span><span class="p">:</span>
            <span class="n">journal</span> <span class="o">=</span> <span class="n">journal_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="c1"># Volume/issue/pages: look for &quot;__vol. X__ __(Y)__ pp. Z&quot;</span>
        <span class="n">volume</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">issue</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">first_page</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">last_page</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">volume_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;__vol\. ([^_]+)__&quot;</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">volume_match</span><span class="p">:</span>
            <span class="n">volume</span> <span class="o">=</span> <span class="n">volume_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">issue_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;__\(([^)]+)\)__&quot;</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">issue_match</span><span class="p">:</span>
            <span class="n">issue</span> <span class="o">=</span> <span class="n">issue_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">pages_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;pp\. ([\d\-]+)&quot;</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pages_match</span><span class="p">:</span>
            <span class="n">pages</span> <span class="o">=</span> <span class="n">pages_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">pages</span><span class="p">:</span>
                <span class="n">first_page</span><span class="p">,</span> <span class="n">last_page</span> <span class="o">=</span> <span class="n">pages</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">first_page</span> <span class="o">=</span> <span class="n">pages</span>

        <span class="c1"># DOI: look for &quot;doi.org&quot; link</span>
        <span class="n">doi</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">doi_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;https?://doi\.org/([^\s|)]+)&quot;</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">doi_match</span><span class="p">:</span>
            <span class="n">doi</span> <span class="o">=</span> <span class="n">doi_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="c1"># Year: look for 4-digit year at end or after &quot;|&quot;</span>
        <span class="n">year</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">year_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\|\s*(\d</span><span class="si">{4}</span><span class="s2">)(?:-\d</span><span class="si">{2}</span><span class="s2">)?\s*$&quot;</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">year_match</span><span class="p">:</span>
            <span class="n">year_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\b(19|20)\d</span><span class="si">{2}</span><span class="s2">\b&quot;</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">year_match</span><span class="p">:</span>
            <span class="n">year</span> <span class="o">=</span> <span class="n">year_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Compose metadata</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">journal</span><span class="p">:</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;container_title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">journal</span>
        <span class="k">if</span> <span class="n">volume</span><span class="p">:</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">volume</span>
        <span class="k">if</span> <span class="n">issue</span><span class="p">:</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;issue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">issue</span>
        <span class="k">if</span> <span class="n">first_page</span><span class="p">:</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;first_page&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">first_page</span>
        <span class="k">if</span> <span class="n">last_page</span><span class="p">:</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;last_page&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_page</span>

        <span class="c1"># issued_at: try to build from year</span>
        <span class="n">issued_at</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">year</span><span class="p">:</span>
                <span class="n">issued_at</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># OA status: not available from Nexus, set None</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
            <span class="s1">&#39;authors&#39;</span><span class="p">:</span> <span class="n">authors</span><span class="p">,</span>
            <span class="s1">&#39;metadata&#39;</span><span class="p">:</span> <span class="n">metadata</span><span class="p">,</span>
            <span class="s1">&#39;uris&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;doi:</span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">doi</span> <span class="k">else</span> <span class="p">[],</span>
            <span class="s1">&#39;issued_at&#39;</span><span class="p">:</span> <span class="n">issued_at</span><span class="p">,</span>
            <span class="s1">&#39;oa_status&#39;</span><span class="p">:</span> <span class="kc">None</span>
        <span class="p">}</span>
        <span class="n">docs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">docs</span></div>


<div class="viewcode-block" id="search_with_crossref">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.getpapers.search_with_crossref">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">search_with_crossref</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">works</span> <span class="o">=</span> <span class="n">Works</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;10.&quot;</span><span class="p">):</span>
            <span class="c1"># Search by DOI</span>
            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Searching Crossref by DOI: </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">works</span><span class="o">.</span><span class="n">doi</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                <span class="c1"># Convert Crossref result to compatible format</span>
                <span class="n">crossref_doc</span> <span class="o">=</span> <span class="n">convert_crossref_to_stc_format</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                <span class="c1"># Check OA status using Unpaywall</span>
                <span class="n">doi</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DOI&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">doi</span><span class="p">:</span>
                    <span class="n">crossref_doc</span><span class="p">[</span><span class="s1">&#39;oa_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">is_open_access_unpaywall</span><span class="p">(</span><span class="n">doi</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="s1">&#39;ScoredDocument&#39;</span><span class="p">,</span> <span class="p">(),</span> <span class="p">{</span><span class="s1">&#39;document&#39;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">crossref_doc</span><span class="p">)})()]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Search by keyword</span>
            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Searching Crossref by keyword: </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">works</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s1">&#39;DOI&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;author&#39;</span><span class="p">,</span> <span class="s1">&#39;published-print&#39;</span><span class="p">,</span> 
                                                <span class="s1">&#39;container-title&#39;</span><span class="p">,</span> <span class="s1">&#39;volume&#39;</span><span class="p">,</span> <span class="s1">&#39;issue&#39;</span><span class="p">,</span> <span class="s1">&#39;page&#39;</span><span class="p">,</span> 
                                                <span class="s1">&#39;publisher&#39;</span><span class="p">,</span> <span class="s1">&#39;ISSN&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s1">&#39;relevance&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="s1">&#39;desc&#39;</span><span class="p">)</span>
            
            <span class="n">crossref_results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;=</span> <span class="n">limit</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">crossref_doc</span> <span class="o">=</span> <span class="n">convert_crossref_to_stc_format</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="c1"># Check OA status using Unpaywall</span>
                <span class="n">doi</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DOI&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">doi</span><span class="p">:</span>
                    <span class="n">crossref_doc</span><span class="p">[</span><span class="s1">&#39;oa_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">is_open_access_unpaywall</span><span class="p">(</span><span class="n">doi</span><span class="p">)</span>
                <span class="n">crossref_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="s1">&#39;ScoredDocument&#39;</span><span class="p">,</span> <span class="p">(),</span> <span class="p">{</span><span class="s1">&#39;document&#39;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">crossref_doc</span><span class="p">)})())</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            
            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">crossref_results</span><span class="p">)</span><span class="si">}</span><span class="s2"> results from Crossref for query: </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">crossref_results</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;crossref-commons package not installed. Please install with: pip install crossref-commons&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Crossref search failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="convert_crossref_to_stc_format">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.getpapers.convert_crossref_to_stc_format">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">convert_crossref_to_stc_format</span><span class="p">(</span><span class="n">crossref_item</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert Crossref API result to StcGeck compatible format&quot;&quot;&quot;</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># Crossref doesn&#39;t provide StcGeck ID</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">crossref_item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;N/A&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">crossref_item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;N/A&#39;</span><span class="p">,</span>
        <span class="s1">&#39;authors&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;metadata&#39;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s1">&#39;uris&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;issued_at&#39;</span><span class="p">:</span> <span class="kc">None</span>
    <span class="p">}</span>

    <span class="c1"># Convert authors</span>
    <span class="k">if</span> <span class="s1">&#39;author&#39;</span> <span class="ow">in</span> <span class="n">crossref_item</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">author</span> <span class="ow">in</span> <span class="n">crossref_item</span><span class="p">[</span><span class="s1">&#39;author&#39;</span><span class="p">]:</span>
            <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;authors&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;given&#39;</span><span class="p">:</span> <span class="n">author</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;given&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                <span class="s1">&#39;family&#39;</span><span class="p">:</span> <span class="n">author</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;family&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="p">})</span>

    <span class="c1"># Add DOI URI</span>
    <span class="n">doi</span> <span class="o">=</span> <span class="n">crossref_item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DOI&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">doi</span><span class="p">:</span>
        <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;uris&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;doi:</span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Convert metadata</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;container-title&#39;</span> <span class="ow">in</span> <span class="n">crossref_item</span> <span class="ow">and</span> <span class="n">crossref_item</span><span class="p">[</span><span class="s1">&#39;container-title&#39;</span><span class="p">]:</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;container_title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">crossref_item</span><span class="p">[</span><span class="s1">&#39;container-title&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;volume&#39;</span> <span class="ow">in</span> <span class="n">crossref_item</span><span class="p">:</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">crossref_item</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;issue&#39;</span> <span class="ow">in</span> <span class="n">crossref_item</span><span class="p">:</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;issue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">crossref_item</span><span class="p">[</span><span class="s1">&#39;issue&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;page&#39;</span> <span class="ow">in</span> <span class="n">crossref_item</span><span class="p">:</span>
        <span class="n">pages</span> <span class="o">=</span> <span class="n">crossref_item</span><span class="p">[</span><span class="s1">&#39;page&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;first_page&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pages</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;last_page&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pages</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;publisher&#39;</span> <span class="ow">in</span> <span class="n">crossref_item</span><span class="p">:</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;publisher&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">crossref_item</span><span class="p">[</span><span class="s1">&#39;publisher&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;ISSN&#39;</span> <span class="ow">in</span> <span class="n">crossref_item</span><span class="p">:</span>
        <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;issns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">crossref_item</span><span class="p">[</span><span class="s1">&#39;ISSN&#39;</span><span class="p">]</span>

    <span class="c1"># Convert issued date</span>
    <span class="k">if</span> <span class="s1">&#39;published-print&#39;</span> <span class="ow">in</span> <span class="n">crossref_item</span> <span class="ow">or</span> <span class="s1">&#39;published-online&#39;</span> <span class="ow">in</span> <span class="n">crossref_item</span><span class="p">:</span>
        <span class="n">date_parts</span> <span class="o">=</span> <span class="p">(</span><span class="n">crossref_item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;published-print&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">crossref_item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;published-online&#39;</span><span class="p">))[</span><span class="s1">&#39;date-parts&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">date_parts</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">year</span> <span class="o">=</span> <span class="n">date_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">date_parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1970</span>
                <span class="n">month</span> <span class="o">=</span> <span class="n">date_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">date_parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">1</span>
                <span class="n">day</span> <span class="o">=</span> <span class="n">date_parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">date_parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="mi">1</span>
                <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;issued_at&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">)</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="c1"># OA status is set in the search function, do not check here</span>
    <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;oa_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">crossref_item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;oa_status&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">doc</span></div>


<div class="viewcode-block" id="fetch_doi_rest_api">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.getpapers.fetch_doi_rest_api">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">fetch_doi_rest_api</span><span class="p">(</span><span class="n">doi</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fetch DOI metadata using the DOI Proxy REST API.</span>
<span class="sd">    Returns the parsed JSON response, or None if not found/error.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">base_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://doi.org/api/handles/</span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">params</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&amp;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">quote_plus</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_url</span><span class="si">}</span><span class="s2">?</span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">base_url</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="s2">&quot;Mozilla/5.0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Accept&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Referer&quot;</span><span class="p">:</span> <span class="s2">&quot;https://doi.org/&quot;</span><span class="p">,</span>
        <span class="s2">&quot;DNT&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">_requests_kwargs</span><span class="p">({</span><span class="s2">&quot;headers&quot;</span><span class="p">:</span> <span class="n">headers</span><span class="p">,</span> <span class="s2">&quot;timeout&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}))</span>
        <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error fetching DOI REST API for </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="convert_doi_rest_to_stc_format">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.getpapers.convert_doi_rest_to_stc_format">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">convert_doi_rest_to_stc_format</span><span class="p">(</span><span class="n">rest_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert DOI REST API response to StcGeck compatible document format.</span>
<span class="sd">    Only fills fields available in the REST API response.</span>
<span class="sd">    Handles cases where &#39;DESCRIPTION&#39;, &#39;EMAIL&#39;, etc. may not be present.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;authors&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;metadata&#39;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s1">&#39;uris&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;issued_at&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;oa_status&#39;</span><span class="p">:</span> <span class="kc">None</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">rest_data</span> <span class="ow">or</span> <span class="n">rest_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;responseCode&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">doc</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">rest_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;handle&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">handle</span><span class="p">:</span>
        <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">handle</span>
        <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;uris&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;doi:</span><span class="si">{</span><span class="n">handle</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">elements</span> <span class="o">=</span> <span class="n">rest_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;values&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">url</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">description</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">email</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">:</span>
        <span class="n">typ</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;format&quot;</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
        <span class="c1"># URL field</span>
        <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&quot;URL&quot;</span> <span class="ow">and</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">val</span>
        <span class="c1"># DESCRIPTION field</span>
        <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&quot;DESCRIPTION&quot;</span> <span class="ow">and</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">description</span> <span class="o">=</span> <span class="n">val</span>
        <span class="c1"># EMAIL field</span>
        <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&quot;EMAIL&quot;</span> <span class="ow">and</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s2">&quot;string&quot;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">email</span> <span class="o">=</span> <span class="n">val</span>
        <span class="c1"># Try to get timestamp from any element</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">timestamp</span> <span class="ow">and</span> <span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">):</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">url</span><span class="p">:</span>
        <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">][</span><span class="s1">&#39;url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">url</span>
    <span class="k">if</span> <span class="n">description</span><span class="p">:</span>
        <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">description</span>
    <span class="k">if</span> <span class="n">email</span><span class="p">:</span>
        <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">][</span><span class="s1">&#39;email&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">email</span>
    <span class="k">if</span> <span class="n">timestamp</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># DOI REST API timestamp is usually ISO format with Z</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">timestamp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;+00:00&quot;</span><span class="p">))</span>
            <span class="n">doc</span><span class="p">[</span><span class="s1">&#39;issued_at&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">return</span> <span class="n">doc</span></div>


<div class="viewcode-block" id="search_with_doi_rest_api">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.getpapers.search_with_doi_rest_api">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">search_with_doi_rest_api</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Search for a DOI using the DOI REST API and convert to StcGeck format.</span>
<span class="sd">    Returns a list of ScoredDocument-like objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">query</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;10.&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">rest_data</span> <span class="o">=</span> <span class="n">fetch_doi_rest_api</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pretty&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">})</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">convert_doi_rest_to_stc_format</span><span class="p">(</span><span class="n">rest_data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">doc</span> <span class="ow">and</span> <span class="n">doc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;uris&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="s1">&#39;ScoredDocument&#39;</span><span class="p">,</span> <span class="p">(),</span> <span class="p">{</span><span class="s1">&#39;document&#39;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">doc</span><span class="p">)})()]</span>
    <span class="k">return</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="format_reference">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.getpapers.format_reference">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">format_reference</span><span class="p">(</span><span class="n">document</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span>
    <span class="n">authors</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;authors&#39;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">if</span> <span class="n">authors</span><span class="p">:</span>
        <span class="n">formatted_authors</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;given&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;family&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">authors</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">formatted_authors</span> <span class="o">=</span> <span class="s1">&#39;N/A&#39;</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metadata&#39;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">journal</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;container_title&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span>
    <span class="n">volume</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;volume&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">issue</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;issue&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">first_page</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;first_page&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">last_page</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;last_page&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">issued_at</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;issued_at&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">issued_at</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">year</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcfromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">issued_at</span><span class="p">))</span><span class="o">.</span><span class="n">year</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">year</span> <span class="o">=</span> <span class="s1">&#39;N/A&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">year</span> <span class="o">=</span> <span class="s1">&#39;N/A&#39;</span>
    <span class="n">publisher</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;publisher&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span>
    <span class="n">issns</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;issns&#39;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">issn_str</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">issns</span><span class="p">)</span> <span class="k">if</span> <span class="n">issns</span> <span class="k">else</span> <span class="s1">&#39;N/A&#39;</span>
    <span class="n">doi_uri</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">uri</span> <span class="k">for</span> <span class="n">uri</span> <span class="ow">in</span> <span class="n">document</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;uris&quot;</span><span class="p">,</span> <span class="p">[])</span> <span class="k">if</span> <span class="n">uri</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;doi:&quot;</span><span class="p">)),</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">doi</span> <span class="o">=</span> <span class="n">doi_uri</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;doi:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">doi_uri</span> <span class="k">else</span> <span class="s1">&#39;N/A&#39;</span>
    <span class="n">oa_status</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;oa_status&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">oa_status</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">oa_str</span> <span class="o">=</span> <span class="s2">&quot;Open Access&quot;</span>
    <span class="k">elif</span> <span class="n">oa_status</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">oa_str</span> <span class="o">=</span> <span class="s2">&quot;Closed Access&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">oa_str</span> <span class="o">=</span> <span class="s2">&quot;OA status unknown&quot;</span>
    <span class="n">ref</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">formatted_authors</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">). </span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">journal</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">volume</span><span class="p">:</span>
        <span class="n">ref</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, </span><span class="si">{</span><span class="n">volume</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">issue</span><span class="p">:</span>
        <span class="n">ref</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">issue</span><span class="si">}</span><span class="s2">)&quot;</span>
    <span class="k">if</span> <span class="n">first_page</span> <span class="ow">and</span> <span class="n">last_page</span><span class="p">:</span>
        <span class="n">ref</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, </span><span class="si">{</span><span class="n">first_page</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">last_page</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">elif</span> <span class="n">first_page</span><span class="p">:</span>
        <span class="n">ref</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, </span><span class="si">{</span><span class="n">first_page</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">publisher</span> <span class="ow">and</span> <span class="n">publisher</span> <span class="o">!=</span> <span class="s1">&#39;N/A&#39;</span><span class="p">:</span>
        <span class="n">ref</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;. </span><span class="si">{</span><span class="n">publisher</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">issn_str</span> <span class="ow">and</span> <span class="n">issn_str</span> <span class="o">!=</span> <span class="s1">&#39;N/A&#39;</span><span class="p">:</span>
        <span class="n">ref</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;. ISSN: </span><span class="si">{</span><span class="n">issn_str</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">doi</span> <span class="ow">and</span> <span class="n">doi</span> <span class="o">!=</span> <span class="s1">&#39;N/A&#39;</span><span class="p">:</span>
        <span class="n">ref</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;. https://doi.org/</span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">ref</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;. [</span><span class="si">{</span><span class="n">oa_str</span><span class="si">}</span><span class="s2">]&quot;</span>
    <span class="k">return</span> <span class="n">ref</span></div>


<div class="viewcode-block" id="search_and_print">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.getpapers.search_and_print">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">search_and_print</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting search_and_print for query: </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">, limit: </span><span class="si">{</span><span class="n">limit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">search_documents</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">results</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No results found.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">scored_document</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">document</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">scored_document</span><span class="o">.</span><span class="n">document</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Result #</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">format_reference</span><span class="p">(</span><span class="n">document</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Full document JSON:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-----&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="is_elsevier_doi">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.getpapers.is_elsevier_doi">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">is_elsevier_doi</span><span class="p">(</span><span class="n">doi</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if a DOI is published by Elsevier.</span>
<span class="sd">    First, try to fetch metadata from DOI REST API and check if publisher is Elsevier.</span>
<span class="sd">    If not available, fallback to prefix/domain check.</span>
<span class="sd">    Returns True if the DOI is published by Elsevier.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Try DOI REST API first</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">rest_data</span> <span class="o">=</span> <span class="n">fetch_doi_rest_api</span><span class="p">(</span><span class="n">doi</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rest_data</span> <span class="ow">and</span> <span class="n">rest_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;responseCode&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">rest_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;values&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">publisher</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                <span class="n">typ</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&quot;PUBLISHER&quot;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">publisher</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">publisher</span> <span class="ow">and</span> <span class="s2">&quot;elsevier&quot;</span> <span class="ow">in</span> <span class="n">publisher</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="c1"># Fallback: prefix/domain check</span>
    <span class="n">elsevier_prefixes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;10.1016&quot;</span><span class="p">,</span>  <span class="c1"># Elsevier</span>
        <span class="s2">&quot;10.1017&quot;</span><span class="p">,</span>  <span class="c1"># Cambridge/Cell Press (sometimes)</span>
        <span class="s2">&quot;10.1018&quot;</span><span class="p">,</span>  <span class="c1"># Elsevier (rare)</span>
        <span class="s2">&quot;10.1019&quot;</span><span class="p">,</span>  <span class="c1"># Elsevier (rare)</span>
        <span class="s2">&quot;10.1010&quot;</span><span class="p">,</span>  <span class="c1"># Elsevier (rare)</span>
        <span class="s2">&quot;10.1015&quot;</span><span class="p">,</span>  <span class="c1"># Elsevier (rare)</span>
        <span class="s2">&quot;10.1012&quot;</span><span class="p">,</span>  <span class="c1"># Elsevier (rare)</span>
        <span class="s2">&quot;10.1013&quot;</span><span class="p">,</span>  <span class="c1"># Elsevier (rare)</span>
        <span class="s2">&quot;10.1014&quot;</span><span class="p">,</span>  <span class="c1"># Elsevier (rare)</span>
        <span class="s2">&quot;10.1011&quot;</span><span class="p">,</span>  <span class="c1"># Elsevier (rare)</span>
    <span class="p">]</span>
    <span class="n">doi</span> <span class="o">=</span> <span class="n">doi</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">doi</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">elsevier_prefixes</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://doi.org/</span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">final_url</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">elsevier_domains</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;elsevier.com&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sciencedirect.com&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cell.com&quot;</span><span class="p">,</span>
            <span class="s2">&quot;thelancet.com&quot;</span><span class="p">,</span>
            <span class="s2">&quot;journals.elsevierhealth.com&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">domain</span> <span class="ow">in</span> <span class="n">final_url</span> <span class="k">for</span> <span class="n">domain</span> <span class="ow">in</span> <span class="n">elsevier_domains</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="download_elsevier_pdf_by_doi">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.getpapers.download_elsevier_pdf_by_doi">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">download_elsevier_pdf_by_doi</span><span class="p">(</span>
    <span class="n">doi</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">download_folder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">DEFAULT_DOWNLOAD_FOLDER</span><span class="p">,</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Try to download a PDF from Elsevier Full-Text API using DOI.</span>
<span class="sd">    Returns the downloaded file path if successful, else None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">doi</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
        
    <span class="n">safe_doi</span> <span class="o">=</span> <span class="n">doi</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
    
    <span class="c1"># First get metadata to check page count</span>
    <span class="n">metadata_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://api.elsevier.com/content/article/doi/</span><span class="si">{</span><span class="n">quote_plus</span><span class="p">(</span><span class="n">doi</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">active_api_key</span> <span class="o">=</span> <span class="n">api_key</span> <span class="ow">or</span> <span class="n">configuration</span><span class="o">.</span><span class="n">ELSEVIER_API_KEY</span>

    <span class="n">metadata_headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Accept&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
        <span class="s2">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="s2">&quot;Mozilla/5.0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;X-ELS-APIKey&quot;</span><span class="p">:</span> <span class="n">active_api_key</span><span class="p">,</span>
    <span class="p">}</span>
    
    <span class="n">expected_pages</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">metadata_resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metadata_url</span><span class="p">,</span> <span class="o">**</span><span class="n">_requests_kwargs</span><span class="p">({</span><span class="s2">&quot;headers&quot;</span><span class="p">:</span> <span class="n">metadata_headers</span><span class="p">,</span> <span class="s2">&quot;timeout&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">}))</span>
        <span class="k">if</span> <span class="n">metadata_resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata_resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="c1"># Extract page count from various possible fields</span>
            <span class="n">full_text</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;full-text-retrieval-response&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">coredata</span> <span class="o">=</span> <span class="n">full_text</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;coredata&quot;</span><span class="p">,</span> <span class="p">{})</span>
            
            <span class="c1"># Try different page count fields</span>
            <span class="n">page_count</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">coredata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pageRange&quot;</span><span class="p">)</span> <span class="ow">or</span> 
                <span class="n">coredata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;page-count&quot;</span><span class="p">)</span> <span class="ow">or</span> 
                <span class="n">coredata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prism:pageRange&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            
            <span class="k">if</span> <span class="n">page_count</span><span class="p">:</span>
                <span class="c1"># Handle page ranges like &quot;123-145&quot; or just page counts</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">page_count</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">page_count</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">page_count</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
                        <span class="n">expected_pages</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">end</span><span class="p">)</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
                        <span class="k">pass</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">page_count</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">expected_pages</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">page_count</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="k">pass</span>
                        
            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected page count from Elsevier metadata: </span><span class="si">{</span><span class="n">expected_pages</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error fetching Elsevier metadata for DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Now download the PDF</span>
    <span class="n">api_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://api.elsevier.com/content/article/doi/</span><span class="si">{</span><span class="n">quote_plus</span><span class="p">(</span><span class="n">doi</span><span class="p">)</span><span class="si">}</span><span class="s2">?httpAccept=application/pdf&quot;</span>

    <span class="c1"># Check if DOI is open access</span>
    <span class="n">is_oa</span> <span class="o">=</span> <span class="k">await</span> <span class="n">is_open_access_unpaywall</span><span class="p">(</span><span class="n">doi</span><span class="p">)</span>
    
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Accept&quot;</span><span class="p">:</span> <span class="s2">&quot;application/pdf&quot;</span><span class="p">,</span>
        <span class="s2">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="s2">&quot;Mozilla/5.0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;X-ELS-APIKey&quot;</span><span class="p">:</span> <span class="n">active_api_key</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="o">**</span><span class="n">_requests_kwargs</span><span class="p">({</span><span class="s2">&quot;headers&quot;</span><span class="p">:</span> <span class="n">headers</span><span class="p">,</span> <span class="s2">&quot;timeout&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;allow_redirects&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}))</span>
        <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span> <span class="ow">and</span> <span class="n">resp</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;application/pdf&quot;</span><span class="p">):</span>
            <span class="c1"># Name file based on OA status</span>
            <span class="k">if</span> <span class="n">is_oa</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">safe_doi</span><span class="si">}</span><span class="s2">_unpaywall_elsevier.pdf&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">safe_doi</span><span class="si">}</span><span class="s2">_elsevier.pdf&quot;</span>
                
            <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">download_folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            
            <span class="c1"># Write PDF content to a temporary file first for verification</span>
            <span class="n">temp_filepath</span> <span class="o">=</span> <span class="n">filepath</span> <span class="o">+</span> <span class="s2">&quot;.tmp&quot;</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">temp_filepath</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            
            <span class="c1"># Verify PDF page count if we have expected pages</span>
            <span class="k">if</span> <span class="n">expected_pages</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">temp_filepath</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pdf_file</span><span class="p">:</span>
                        <span class="n">pdf_reader</span> <span class="o">=</span> <span class="n">PyPDF2</span><span class="o">.</span><span class="n">PdfReader</span><span class="p">(</span><span class="n">pdf_file</span><span class="p">)</span>
                        <span class="n">actual_pages</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pdf_reader</span><span class="o">.</span><span class="n">pages</span><span class="p">)</span>
                        
                    <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PDF verification - Expected: </span><span class="si">{</span><span class="n">expected_pages</span><span class="si">}</span><span class="s2">, Actual: </span><span class="si">{</span><span class="n">actual_pages</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">actual_pages</span> <span class="o">!=</span> <span class="n">expected_pages</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: Downloaded PDF has </span><span class="si">{</span><span class="n">actual_pages</span><span class="si">}</span><span class="s2"> pages but expected </span><span class="si">{</span><span class="n">expected_pages</span><span class="si">}</span><span class="s2"> pages&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;This indicates an incomplete or invalid PDF download&quot;</span><span class="p">)</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">temp_filepath</span><span class="p">)</span>  <span class="c1"># Remove invalid PDF</span>
                        <span class="k">return</span> <span class="kc">None</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PDF page count verified: </span><span class="si">{</span><span class="n">actual_pages</span><span class="si">}</span><span class="s2"> pages&quot;</span><span class="p">)</span>
                        
                <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                    <span class="n">vprint</span><span class="p">(</span><span class="s2">&quot;PyPDF2 not installed, cannot verify page count. Install with: pip install PyPDF2&quot;</span><span class="p">)</span>
                    <span class="c1"># Without verification, we&#39;ll assume the PDF is valid</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error verifying PDF: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: PDF verification failed, download considered invalid&quot;</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">temp_filepath</span><span class="p">)</span>  <span class="c1"># Remove potentially invalid PDF</span>
                    <span class="k">return</span> <span class="kc">None</span>
            
            <span class="c1"># If we reach here, PDF is valid - move temp file to final location</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">temp_filepath</span><span class="p">,</span> <span class="n">filepath</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloaded PDF from Elsevier Full-Text API: </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">filepath</span>
        <span class="k">elif</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">403</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Access to Elsevier Full-Text API is forbidden. You may need an API key. See https://dev.elsevier.com/&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Elsevier API did not return PDF for DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> (status </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error downloading PDF from Elsevier API for DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="is_wiley_doi">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.getpapers.is_wiley_doi">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">is_wiley_doi</span><span class="p">(</span><span class="n">doi</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if a DOI is published by Wiley.</span>
<span class="sd">    First, try to fetch metadata from DOI REST API and check if publisher is Wiley.</span>
<span class="sd">    If not available, fallback to prefix/domain check.</span>
<span class="sd">    Returns True if the DOI is published by Wiley.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Try DOI REST API first</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">rest_data</span> <span class="o">=</span> <span class="n">fetch_doi_rest_api</span><span class="p">(</span><span class="n">doi</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rest_data</span> <span class="ow">and</span> <span class="n">rest_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;responseCode&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">rest_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;values&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">publisher</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                <span class="n">typ</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">el</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s2">&quot;PUBLISHER&quot;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">publisher</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">publisher</span> <span class="ow">and</span> <span class="s2">&quot;wiley&quot;</span> <span class="ow">in</span> <span class="n">publisher</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="c1"># Fallback: prefix/domain check</span>
    <span class="n">wiley_prefixes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;10.1002&quot;</span><span class="p">,</span>  <span class="c1"># Wiley</span>
        <span class="s2">&quot;10.1111&quot;</span><span class="p">,</span>  <span class="c1"># Wiley</span>
        <span class="s2">&quot;10.1007&quot;</span><span class="p">,</span>  <span class="c1"># Springer, but some Wiley journals</span>
        <span class="s2">&quot;10.1046&quot;</span><span class="p">,</span>  <span class="c1"># Wiley (legacy)</span>
        <span class="s2">&quot;10.15252&quot;</span><span class="p">,</span> <span class="c1"># EMBO Press (Wiley)</span>
        <span class="s2">&quot;10.22541&quot;</span><span class="p">,</span> <span class="c1"># Authorea (Wiley)</span>
    <span class="p">]</span>
    <span class="n">doi</span> <span class="o">=</span> <span class="n">doi</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">doi</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">wiley_prefixes</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://doi.org/</span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">final_url</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">wiley_domains</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;wiley.com&quot;</span><span class="p">,</span>
            <span class="s2">&quot;onlinelibrary.wiley.com&quot;</span><span class="p">,</span>
            <span class="s2">&quot;emboj.embopress.org&quot;</span><span class="p">,</span>
            <span class="s2">&quot;authorea.com&quot;</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">domain</span> <span class="ow">in</span> <span class="n">final_url</span> <span class="k">for</span> <span class="n">domain</span> <span class="ow">in</span> <span class="n">wiley_domains</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="download_wiley_pdf_by_doi">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.getpapers.download_wiley_pdf_by_doi">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">download_wiley_pdf_by_doi</span><span class="p">(</span>
    <span class="n">doi</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">download_folder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">DEFAULT_DOWNLOAD_FOLDER</span><span class="p">,</span>
    <span class="n">tdm_token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Attempt to download a PDF from Wiley using the DOI and Wiley-TDM-Client-Token.</span>
<span class="sd">    Returns True if successful, else False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">active_token</span> <span class="o">=</span> <span class="n">tdm_token</span> <span class="ow">or</span> <span class="n">configuration</span><span class="o">.</span><span class="n">WILEY_TDM_TOKEN</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">active_token</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: Wiley-TDM-Client-Token is required to download from Wiley TDM API.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">safe_doi</span> <span class="o">=</span> <span class="n">doi</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">safe_doi</span><span class="si">}</span><span class="s2">_wiley.pdf&quot;</span>
    <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">download_folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="n">headers_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">download_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">safe_doi</span><span class="si">}</span><span class="s2">_wiley_headers.txt&quot;</span><span class="p">)</span>

    <span class="n">pdf_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://api.wiley.com/onlinelibrary/tdm/v1/articles/</span><span class="si">{</span><span class="n">quote_plus</span><span class="p">(</span><span class="n">doi</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="s2">&quot;Mozilla/5.0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Accept&quot;</span><span class="p">:</span> <span class="s2">&quot;application/pdf,application/octet-stream;q=0.9,*/*;q=0.8&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Referer&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;https://doi.org/</span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Wiley-TDM-Client-Token&quot;</span><span class="p">:</span> <span class="n">active_token</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">TCPConnector</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">(</span><span class="n">connector</span><span class="o">=</span><span class="n">conn</span><span class="p">,</span> <span class="n">trust_env</span><span class="o">=</span><span class="n">ACTIVE_PROXY</span><span class="o">.</span><span class="n">enabled</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
                <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">pdf_url</span><span class="p">,</span>
                    <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="n">DOWNLOAD_TIMEOUT</span><span class="p">,</span>
                    <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
                    <span class="c1"># Save headers for debugging</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">headers_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">hfile</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">resp</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="n">hfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span> <span class="ow">and</span> <span class="n">resp</span><span class="o">.</span><span class="n">content_type</span> <span class="o">==</span> <span class="s2">&quot;application/pdf&quot;</span><span class="p">:</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloaded PDF from Wiley: </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">filepath</span>
                    <span class="k">elif</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                        <span class="c1"># Sometimes content-type is not set correctly, try anyway</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloaded (possibly non-PDF) file from Wiley: </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">filepath</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wiley PDF not found at </span><span class="si">{</span><span class="n">pdf_url</span><span class="si">}</span><span class="s2"> (HTTP </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error downloading Wiley PDF for DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">pdf_url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PDF file is not available from Wiley for DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="is_pmc_doi">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.getpapers.is_pmc_doi">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">is_pmc_doi</span><span class="p">(</span><span class="n">doi</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if a DOI is associated with PubMed Central (PMC).</span>
<span class="sd">    Returns True if the DOI can be found in PMC via NCBI E-utilities.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">esearch_url</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;?db=pmc&amp;term=</span><span class="si">{</span><span class="n">quote_plus</span><span class="p">(</span><span class="n">doi</span><span class="p">)</span><span class="si">}</span><span class="s2">[DOI]&amp;retmode=json&quot;</span>
        <span class="p">)</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">esearch_url</span><span class="p">,</span> <span class="o">**</span><span class="n">_requests_kwargs</span><span class="p">({</span><span class="s2">&quot;timeout&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}))</span>
        <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="n">idlist</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;esearchresult&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;idlist&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">idlist</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="download_from_pmc">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.getpapers.download_from_pmc">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">download_from_pmc</span><span class="p">(</span><span class="n">doi</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">download_folder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">DEFAULT_DOWNLOAD_FOLDER</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download a PDF from PubMed Central (PMC) using the DOI.</span>
<span class="sd">    Returns the downloaded file path if successful, else None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">safe_doi</span> <span class="o">=</span> <span class="n">doi</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">safe_doi</span><span class="si">}</span><span class="s2">_pmc.pdf&quot;</span>
    <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">download_folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

    <span class="c1"># Step 1: Use NCBI E-utilities to get the PMC ID from the DOI</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># ESearch to get pmcid</span>
        <span class="n">esearch_url</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;?db=pmc&amp;term=</span><span class="si">{</span><span class="n">quote_plus</span><span class="p">(</span><span class="n">doi</span><span class="p">)</span><span class="si">}</span><span class="s2">[DOI]&amp;retmode=json&quot;</span>
        <span class="p">)</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">esearch_url</span><span class="p">,</span> <span class="o">**</span><span class="n">_requests_kwargs</span><span class="p">({</span><span class="s2">&quot;timeout&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}))</span>
        <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="n">idlist</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;esearchresult&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;idlist&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">idlist</span><span class="p">:</span>
            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No PMC ID found for DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">pmcid</span> <span class="o">=</span> <span class="n">idlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found PMC ID </span><span class="si">{</span><span class="n">pmcid</span><span class="si">}</span><span class="s2"> for DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error retrieving PMC ID for DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Step 2: Try to find direct PDF link for the PMC ID</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Use browser-like headers to avoid 403 errors</span>
        <span class="n">browser_headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="s2">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Accept&quot;</span><span class="p">:</span> <span class="s2">&quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Accept-Language&quot;</span><span class="p">:</span> <span class="s2">&quot;en-US,en;q=0.9&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Accept-Encoding&quot;</span><span class="p">:</span> <span class="s2">&quot;gzip, deflate, br&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Referer&quot;</span><span class="p">:</span> <span class="s2">&quot;https://www.ncbi.nlm.nih.gov/&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DNT&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Connection&quot;</span><span class="p">:</span> <span class="s2">&quot;keep-alive&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Upgrade-Insecure-Requests&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        
        <span class="c1"># Access the PMC article page</span>
        <span class="n">pmc_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://pmc.ncbi.nlm.nih.gov/articles/PMC</span><span class="si">{</span><span class="n">pmcid</span><span class="si">}</span><span class="s2">/&quot;</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accessing PMC article page: </span><span class="si">{</span><span class="n">pmc_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pmc_url</span><span class="p">,</span> <span class="o">**</span><span class="n">_requests_kwargs</span><span class="p">({</span><span class="s2">&quot;headers&quot;</span><span class="p">:</span> <span class="n">browser_headers</span><span class="p">,</span> <span class="s2">&quot;timeout&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">}))</span>
        <span class="n">resp</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        
        <span class="c1"># Look for PDF links using various patterns</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span>
        
        <span class="c1"># Pattern to find PDF links in the HTML</span>
        <span class="n">pdf_patterns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">rf</span><span class="s1">&#39;href=&quot;(/pmc/articles/PMC</span><span class="si">{</span><span class="n">pmcid</span><span class="si">}</span><span class="s1">/pdf/[^&quot;]+\.pdf)&quot;&#39;</span><span class="p">,</span>
            <span class="sa">rf</span><span class="s1">&#39;href=&quot;(https://www\.ncbi\.nlm\.nih\.gov/pmc/articles/PMC</span><span class="si">{</span><span class="n">pmcid</span><span class="si">}</span><span class="s1">/pdf/[^&quot;]+\.pdf)&quot;&#39;</span><span class="p">,</span>
            <span class="sa">rf</span><span class="s1">&#39;href=&quot;(https://pmc\.ncbi\.nlm\.nih\.gov/articles/PMC</span><span class="si">{</span><span class="n">pmcid</span><span class="si">}</span><span class="s1">/pdf/[^&quot;]+\.pdf)&quot;&#39;</span><span class="p">,</span>
            <span class="sa">r</span><span class="s1">&#39;href=&quot;([^&quot;]+\.pdf)&quot;&#39;</span><span class="p">,</span>  <span class="c1"># Any PDF link</span>
            <span class="sa">r</span><span class="s1">&#39;data-src=&quot;([^&quot;]+\.pdf)&quot;&#39;</span><span class="p">,</span>  <span class="c1"># Sometimes PDFs are in data-src attributes</span>
        <span class="p">]</span>
        
        <span class="n">pdf_url</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">pdf_patterns</span><span class="p">:</span>
            <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">html</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">matches</span><span class="p">:</span>
                <span class="n">pdf_url</span> <span class="o">=</span> <span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">break</span>
        
        <span class="k">if</span> <span class="n">pdf_url</span><span class="p">:</span>
            <span class="c1"># Make relative URLs absolute</span>
            <span class="k">if</span> <span class="n">pdf_url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
                <span class="n">pdf_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://pmc.ncbi.nlm.nih.gov/articles/PMC</span><span class="si">{</span><span class="n">pmcid</span><span class="si">}{</span><span class="n">pdf_url</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pdf_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://pmc.ncbi.nlm.nih.gov/articles/PMC</span><span class="si">{</span><span class="n">pmcid</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">pdf_url</span><span class="si">}</span><span class="s2">&quot;</span>
                
            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found PDF URL: </span><span class="si">{</span><span class="n">pdf_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No PDF link found on PMC page for PMCID </span><span class="si">{</span><span class="n">pmcid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error downloading from PMC for PMCID </span><span class="si">{</span><span class="n">pmcid</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PDF file is not available from PMC for DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span></div>


    
<div class="viewcode-block" id="download_from_unpaywall">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.getpapers.download_from_unpaywall">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">download_from_unpaywall</span><span class="p">(</span>
    <span class="n">doi</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">download_folder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">DEFAULT_DOWNLOAD_FOLDER</span><span class="p">,</span>
    <span class="n">email</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download all possible open access PDFs for a DOI via Unpaywall.</span>
<span class="sd">    Each PDF is saved as &lt;safe_doi&gt;_unpaywall_file1.pdf, &lt;safe_doi&gt;_unpaywall_file2.pdf, etc.</span>
<span class="sd">    Returns the first downloaded file path if successful, else None.</span>
<span class="sd">    Always uses custom headers to bypass HTTP 418.</span>
<span class="sd">    If the DOI is from PMC, Elsevier or Wiley, try their API first.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Try PMC first if DOI is PMC</span>
    <span class="k">if</span> <span class="n">is_pmc_doi</span><span class="p">(</span><span class="n">doi</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> appears to be a PMC article. Attempting PMC download before Unpaywall...&quot;</span><span class="p">)</span>
        <span class="n">pmc_path</span> <span class="o">=</span> <span class="k">await</span> <span class="n">download_from_pmc</span><span class="p">(</span><span class="n">doi</span><span class="p">,</span> <span class="n">download_folder</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pmc_path</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pmc_path</span>

    <span class="c1"># Try Elsevier API first if DOI is Elsevier</span>
    <span class="k">if</span> <span class="n">is_elsevier_doi</span><span class="p">(</span><span class="n">doi</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> appears to be an Elsevier article. Attempting Elsevier Full-Text API download before Unpaywall...&quot;</span><span class="p">)</span>
        <span class="n">elsevier_path</span> <span class="o">=</span> <span class="k">await</span> <span class="n">download_elsevier_pdf_by_doi</span><span class="p">(</span>
            <span class="n">doi</span><span class="o">=</span><span class="n">doi</span><span class="p">,</span>
            <span class="n">download_folder</span><span class="o">=</span><span class="n">download_folder</span><span class="p">,</span>
            <span class="n">api_key</span><span class="o">=</span><span class="n">configuration</span><span class="o">.</span><span class="n">ELSEVIER_API_KEY</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">elsevier_path</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">elsevier_path</span>

    <span class="c1"># Try Wiley API first if DOI is Wiley</span>
    <span class="k">if</span> <span class="n">is_wiley_doi</span><span class="p">(</span><span class="n">doi</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> appears to be a Wiley article. Attempting Wiley TDM API download before Unpaywall...&quot;</span><span class="p">)</span>
        <span class="n">wiley_path</span> <span class="o">=</span> <span class="k">await</span> <span class="n">download_wiley_pdf_by_doi</span><span class="p">(</span>
            <span class="n">doi</span><span class="p">,</span> <span class="n">download_folder</span><span class="p">,</span> <span class="n">tdm_token</span><span class="o">=</span><span class="n">configuration</span><span class="o">.</span><span class="n">WILEY_TDM_TOKEN</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">wiley_path</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">wiley_path</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">safe_doi</span> <span class="o">=</span> <span class="n">doi</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="n">active_email</span> <span class="o">=</span> <span class="n">email</span> <span class="ow">or</span> <span class="n">require_email</span><span class="p">()</span>
        <span class="n">UnpywallCredentials</span><span class="p">(</span><span class="n">active_email</span><span class="p">)</span>

        <span class="c1"># Get all OA links (should include all PDF URLs)</span>
        <span class="n">all_links</span> <span class="o">=</span> <span class="n">Unpywall</span><span class="o">.</span><span class="n">get_all_links</span><span class="p">(</span><span class="n">doi</span><span class="o">=</span><span class="n">doi</span><span class="p">)</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_links</span><span class="p">)</span><span class="si">}</span><span class="s2"> open access links on Unpaywall for DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;All links: </span><span class="si">{</span><span class="n">all_links</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">all_links</span><span class="p">:</span>
            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No open access links found on Unpaywall for DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Filter for PDF links (endswith .pdf or content-type check)</span>
        <span class="n">pdf_links</span> <span class="o">=</span> <span class="p">[</span><span class="n">url</span> <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">all_links</span> <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.pdf&#39;</span><span class="p">)]</span>

        <span class="n">downloaded</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">downloaded_paths</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="s2">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Accept&quot;</span><span class="p">:</span> <span class="s2">&quot;application/pdf,application/octet-stream;q=0.9,*/*;q=0.8&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Referer&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;https://doi.org/</span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DNT&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Connection&quot;</span><span class="p">:</span> <span class="s2">&quot;keep-alive&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Try direct PDF links first</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">pdf_url</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pdf_links</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">safe_doi</span><span class="si">}</span><span class="s2">_unpaywall_</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">.pdf&quot;</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">download_folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attempting to download Unpaywall PDF #</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">pdf_url</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">TCPConnector</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
                    <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">(</span><span class="n">connector</span><span class="o">=</span><span class="n">conn</span><span class="p">,</span> <span class="n">trust_env</span><span class="o">=</span><span class="n">ACTIVE_PROXY</span><span class="o">.</span><span class="n">enabled</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
                        <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pdf_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">DOWNLOAD_TIMEOUT</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
                            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unpaywall PDF HTTP status: </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span> <span class="ow">and</span> <span class="n">resp</span><span class="o">.</span><span class="n">content_type</span> <span class="o">==</span> <span class="s2">&quot;application/pdf&quot;</span><span class="p">:</span>
                                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloaded PDF from Unpaywall: </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="n">downloaded</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="n">downloaded_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
                                <span class="k">continue</span>
                            <span class="k">elif</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                                <span class="c1"># Sometimes content-type is not set correctly, try anyway</span>
                                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloaded (possibly non-PDF) file from Unpaywall: </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="n">downloaded</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="n">downloaded_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
                                <span class="k">continue</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to download PDF from Unpaywall for DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> (HTTP </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error downloading PDF from Unpaywall for DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">pdf_url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">downloaded</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">downloaded_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">downloaded_paths</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="c1"># If no direct PDF, try to download OA link directly as a PDF (browser-style request)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">url</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_links</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">pdf_links</span><span class="p">:</span>
                <span class="k">continue</span>  <span class="c1"># Already tried direct PDF links</span>
            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trying to download OA link directly as PDF: </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">TCPConnector</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
                    <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">(</span><span class="n">connector</span><span class="o">=</span><span class="n">conn</span><span class="p">,</span> <span class="n">trust_env</span><span class="o">=</span><span class="n">ACTIVE_PROXY</span><span class="o">.</span><span class="n">enabled</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
                        <span class="n">browser_headers</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s2">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="p">(</span>
                                <span class="s2">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) &quot;</span>
                                <span class="s2">&quot;AppleWebKit/537.36 (KHTML, like Gecko) &quot;</span>
                                <span class="s2">&quot;Chrome/124.0.0.0 Safari/537.36 Edg/124.0.2478.67&quot;</span>
                            <span class="p">),</span>
                            <span class="s2">&quot;Accept&quot;</span><span class="p">:</span> <span class="s2">&quot;application/pdf,application/octet-stream;q=0.9,*/*;q=0.8&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;Referer&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;https://doi.org/</span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;DNT&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;Connection&quot;</span><span class="p">:</span> <span class="s2">&quot;keep-alive&quot;</span><span class="p">,</span>
                        <span class="p">}</span>
                        <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">browser_headers</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">DOWNLOAD_TIMEOUT</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span> <span class="ow">and</span> <span class="n">resp</span><span class="o">.</span><span class="n">content_type</span> <span class="o">==</span> <span class="s2">&quot;application/pdf&quot;</span><span class="p">:</span>
                                <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">safe_doi</span><span class="si">}</span><span class="s2">_unpaywall_browser_</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">.pdf&quot;</span>
                                <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">download_folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloaded PDF by direct OA link (browser): </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="n">downloaded</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="n">downloaded_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
                                <span class="c1"># Don&#39;t break, try all links</span>
                            <span class="k">elif</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                                <span class="c1"># Sometimes content-type is not set correctly, try anyway</span>
                                <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">safe_doi</span><span class="si">}</span><span class="s2">_unpaywall_browser_</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">.pdf&quot;</span>
                                <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">download_folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloaded (possibly non-PDF) file by direct OA link (browser): </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="n">downloaded</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="n">downloaded_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error downloading OA link directly as PDF </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">downloaded</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">downloaded_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">downloaded_paths</span> <span class="k">else</span> <span class="kc">None</span>
        
        <span class="c1"># If no direct PDF, try to follow each OA link and look for PDF</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">url</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_links</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">pdf_links</span><span class="p">:</span>
                <span class="k">continue</span>  <span class="c1"># Already tried direct PDF links</span>
            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trying to follow OA link to find PDF: </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">TCPConnector</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
                    <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">(</span><span class="n">connector</span><span class="o">=</span><span class="n">conn</span><span class="p">,</span> <span class="n">trust_env</span><span class="o">=</span><span class="n">ACTIVE_PROXY</span><span class="o">.</span><span class="n">enabled</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
                        <span class="c1"># Use a more realistic browser header to avoid 403 errors</span>
                        <span class="n">oa_headers</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s2">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="p">(</span>
                                <span class="s2">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) &quot;</span>
                                <span class="s2">&quot;AppleWebKit/537.36 (KHTML, like Gecko) &quot;</span>
                                <span class="s2">&quot;Chrome/124.0.0.0 Safari/537.36 Edg/124.0.2478.67&quot;</span>
                            <span class="p">),</span>
                            <span class="s2">&quot;Accept&quot;</span><span class="p">:</span> <span class="p">(</span>
                                <span class="s2">&quot;text/html,application/xhtml+xml,application/xml;&quot;</span>
                                <span class="s2">&quot;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,&quot;</span>
                                <span class="s2">&quot;application/signed-exchange;v=b3;q=0.7&quot;</span>
                            <span class="p">),</span>
                            <span class="s2">&quot;Accept-Language&quot;</span><span class="p">:</span> <span class="s2">&quot;en-US,en;q=0.9&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;Accept-Encoding&quot;</span><span class="p">:</span> <span class="s2">&quot;gzip, deflate, br&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;Connection&quot;</span><span class="p">:</span> <span class="s2">&quot;keep-alive&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;Upgrade-Insecure-Requests&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;Sec-Fetch-Dest&quot;</span><span class="p">:</span> <span class="s2">&quot;document&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;Sec-Fetch-Mode&quot;</span><span class="p">:</span> <span class="s2">&quot;navigate&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;Sec-Fetch-Site&quot;</span><span class="p">:</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;Sec-Fetch-User&quot;</span><span class="p">:</span> <span class="s2">&quot;?1&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;Pragma&quot;</span><span class="p">:</span> <span class="s2">&quot;no-cache&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;Cache-Control&quot;</span><span class="p">:</span> <span class="s2">&quot;no-cache&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;DNT&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;Referer&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;https://doi.org/</span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="p">}</span>
                        <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">oa_headers</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">DOWNLOAD_TIMEOUT</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
                                <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to fetch OA link </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2"> (HTTP </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                                <span class="k">continue</span>
                            <span class="n">html</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
                            <span class="c1"># Try to find PDF links in the HTML</span>
                            <span class="n">found_pdf</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">pdf_candidates</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;href=[&quot;</span><span class="se">\&#39;</span><span class="s1">]([^&quot;</span><span class="se">\&#39;</span><span class="s1">]+\.pdf[^&quot;</span><span class="se">\&#39;</span><span class="s1">]*)[&quot;</span><span class="se">\&#39;</span><span class="s1">]&#39;</span><span class="p">,</span> <span class="n">html</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">pdf_candidate</span> <span class="ow">in</span> <span class="n">pdf_candidates</span><span class="p">:</span>
                                <span class="c1"># Make absolute URL if needed</span>
                                <span class="k">if</span> <span class="n">pdf_candidate</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;//&quot;</span><span class="p">):</span>
                                    <span class="n">pdf_candidate_url</span> <span class="o">=</span> <span class="s2">&quot;https:&quot;</span> <span class="o">+</span> <span class="n">pdf_candidate</span>
                                <span class="k">elif</span> <span class="n">pdf_candidate</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">):</span>
                                    <span class="n">pdf_candidate_url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">pdf_candidate</span><span class="p">)</span>
                                <span class="k">elif</span> <span class="n">pdf_candidate</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">):</span>
                                    <span class="n">pdf_candidate_url</span> <span class="o">=</span> <span class="n">pdf_candidate</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">pdf_candidate_url</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">pdf_candidate</span>
                                <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found candidate PDF link: </span><span class="si">{</span><span class="n">pdf_candidate_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                                        <span class="n">pdf_candidate_url</span><span class="p">,</span>
                                        <span class="n">headers</span><span class="o">=</span><span class="n">oa_headers</span><span class="p">,</span>
                                        <span class="n">timeout</span><span class="o">=</span><span class="n">DOWNLOAD_TIMEOUT</span><span class="p">,</span>
                                    <span class="p">)</span> <span class="k">as</span> <span class="n">pdf_resp</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">pdf_resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span> <span class="ow">and</span> <span class="n">pdf_resp</span><span class="o">.</span><span class="n">content_type</span> <span class="o">==</span> <span class="s2">&quot;application/pdf&quot;</span><span class="p">:</span>
                                            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">safe_doi</span><span class="si">}</span><span class="s2">_unpaywall_follow_</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">.pdf&quot;</span>
                                            <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">download_folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                                            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="k">await</span> <span class="n">pdf_resp</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloaded PDF by following OA link: </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                            <span class="n">downloaded</span> <span class="o">+=</span> <span class="mi">1</span>
                                            <span class="n">downloaded_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
                                            <span class="n">found_pdf</span> <span class="o">=</span> <span class="kc">True</span>
                                            <span class="k">break</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                    <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error downloading candidate PDF </span><span class="si">{</span><span class="n">pdf_candidate_url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">found_pdf</span><span class="p">:</span>
                                <span class="k">break</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error following OA link </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">downloaded</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">downloaded_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">downloaded_paths</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No direct PDF could be downloaded from Unpaywall for DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The following open access links are available from Unpaywall:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">all_links</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please try to download manually from one of these links.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;unpywall package not installed. Please install with: pip install unpywall&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error querying Unpaywall for DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="download_from_nexus">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.getpapers.download_from_nexus">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">download_from_nexus</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">doi</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">download_folder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">DEFAULT_DOWNLOAD_FOLDER</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">safe_doi</span> <span class="o">=</span> <span class="n">doi</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">safe_doi</span><span class="si">}</span><span class="s2">_nexus.pdf&quot;</span>
    <span class="n">filepath</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">download_folder</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span>
    
    <span class="c1"># Try both URL formats</span>
    <span class="n">file_urls</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sa">f</span><span class="s2">&quot;https://libstc-cc.ipns.dweb.link/repo/</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">.pdf&quot;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;https://libstc-cc.ipns.dweb.link/dois/</span><span class="si">{</span><span class="n">quote_plus</span><span class="p">(</span><span class="n">quote_plus</span><span class="p">(</span><span class="n">doi</span><span class="o">.</span><span class="n">lower</span><span class="p">()))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">.pdf&quot;</span>
    <span class="p">]</span>
    
    <span class="k">for</span> <span class="n">file_url</span> <span class="ow">in</span> <span class="n">file_urls</span><span class="p">:</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attempting to download from Nexus: </span><span class="si">{</span><span class="n">file_url</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">TCPConnector</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
                <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">(</span><span class="n">connector</span><span class="o">=</span><span class="n">conn</span><span class="p">,</span> <span class="n">trust_env</span><span class="o">=</span><span class="n">ACTIVE_PROXY</span><span class="o">.</span><span class="n">enabled</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
                    <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">file_url</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
                        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Nexus HTTP status: </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloaded PDF location: </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">return</span> <span class="n">filepath</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exception occurred while downloading file for DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> from Nexus URL </span><span class="si">{</span><span class="n">file_url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="download_from_nexus_bot">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.getpapers.download_from_nexus_bot">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">download_from_nexus_bot</span><span class="p">(</span><span class="n">doi</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">download_folder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">DEFAULT_DOWNLOAD_FOLDER</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download a PDF by DOI using the Nexus bot (via .nexus module).</span>
<span class="sd">    Returns True if successful, else False.</span>
<span class="sd">    Uses decide_proxy_usage function to determine whether to use proxy.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">safe_doi</span> <span class="o">=</span> <span class="n">doi</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">safe_doi</span><span class="si">}</span><span class="s2">_nexusbot.pdf&quot;</span>
    <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">download_folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">TG_API_ID</span><span class="p">,</span> <span class="n">TG_API_HASH</span><span class="p">,</span> <span class="n">PHONE</span><span class="p">,</span> <span class="n">BOT_USERNAME</span> <span class="o">=</span> <span class="k">await</span> <span class="n">nexus</span><span class="o">.</span><span class="n">load_credentials_from_file</span><span class="p">(</span><span class="n">nexus</span><span class="o">.</span><span class="n">CREDENTIALS_FILE</span><span class="p">)</span>
        
        <span class="c1"># Use decide_proxy_usage to determine if proxy should be used</span>
        <span class="n">proxy_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">nexus</span><span class="o">.</span><span class="n">decide_proxy_usage</span><span class="p">(</span><span class="n">TG_API_ID</span><span class="p">,</span> <span class="n">TG_API_HASH</span><span class="p">,</span> <span class="n">PHONE</span><span class="p">,</span> <span class="n">nexus</span><span class="o">.</span><span class="n">SESSION_FILE</span><span class="p">,</span> <span class="n">nexus</span><span class="o">.</span><span class="n">DEFAULT_PROXY_FILE</span><span class="p">,</span> <span class="n">print_result</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">proxy_result</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: Could not establish connection to Telegram (neither direct nor via proxy)&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">proxy</span> <span class="o">=</span> <span class="n">proxy_result</span> <span class="k">if</span> <span class="n">proxy_result</span> <span class="k">else</span> <span class="kc">None</span>
        
        <span class="n">pdf_bytes</span> <span class="o">=</span> <span class="k">await</span> <span class="n">nexus</span><span class="o">.</span><span class="n">check_doi_availability_on_nexus</span><span class="p">(</span>
            <span class="n">api_id</span><span class="o">=</span><span class="n">TG_API_ID</span><span class="p">,</span>
            <span class="n">api_hash</span><span class="o">=</span><span class="n">TG_API_HASH</span><span class="p">,</span>
            <span class="n">phone_number</span><span class="o">=</span><span class="n">PHONE</span><span class="p">,</span>
            <span class="n">bot_username</span><span class="o">=</span><span class="n">BOT_USERNAME</span><span class="p">,</span>
            <span class="n">doi</span><span class="o">=</span><span class="n">doi</span><span class="p">,</span>
            <span class="n">session_file</span><span class="o">=</span><span class="n">nexus</span><span class="o">.</span><span class="n">SESSION_FILE</span><span class="p">,</span>
            <span class="n">proxy</span><span class="o">=</span><span class="n">proxy</span><span class="p">,</span>
            <span class="n">download</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">download_result</span> <span class="o">=</span> <span class="n">pdf_bytes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;download_result&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">):</span>
            <span class="n">nexus_bot_download_file</span> <span class="o">=</span> <span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_path&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nexus_bot_download_file</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">nexus_bot_download_file</span><span class="p">):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">nexus_bot_download_file</span><span class="p">,</span> <span class="n">filepath</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloaded PDF from Nexus bot: </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">filepath</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloaded file not found at </span><span class="si">{</span><span class="n">nexus_bot_download_file</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># print(f&quot;PDF file is not available from Nexus bot for DOI: {doi}.&quot;)</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error downloading PDF from Nexus bot for DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="download_from_scihub">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.getpapers.download_from_scihub">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">download_from_scihub</span><span class="p">(</span>
    <span class="n">doi</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">download_folder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">DEFAULT_DOWNLOAD_FOLDER</span><span class="p">,</span>
    <span class="n">refresh_mirrors</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">safe_doi</span> <span class="o">=</span> <span class="n">doi</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">safe_doi</span><span class="si">}</span><span class="s2">_scihub.pdf&quot;</span>
    <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">download_folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="n">mirrors</span> <span class="o">=</span> <span class="n">get_scihub_mirrors</span><span class="p">(</span><span class="n">force_refresh</span><span class="o">=</span><span class="n">refresh_mirrors</span><span class="p">)</span>
    <span class="n">sci_hub_domains</span> <span class="o">=</span> <span class="n">mirrors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scihub&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">sci_net_domains</span> <span class="o">=</span> <span class="n">mirrors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scinet&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">combined_domains</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">([</span><span class="o">*</span><span class="n">sci_hub_domains</span><span class="p">,</span> <span class="o">*</span><span class="n">sci_net_domains</span><span class="p">]))</span>
    <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sci-Hub mirrors: </span><span class="si">{</span><span class="n">sci_hub_domains</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sci-Net mirrors: </span><span class="si">{</span><span class="n">sci_net_domains</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Combined mirrors: </span><span class="si">{</span><span class="n">combined_domains</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">attempt_reports</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">max_verbose_attempts</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">domain</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">combined_domains</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
        <span class="c1"># Use different filename for sci-net domains</span>
        <span class="k">if</span> <span class="s2">&quot;sci-net&quot;</span> <span class="ow">in</span> <span class="n">domain</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">safe_doi</span><span class="si">}</span><span class="s2">_scinet.pdf&quot;</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">download_folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">safe_doi</span><span class="si">}</span><span class="s2">_scihub.pdf&quot;</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">download_folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">sci_hub_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;=</span> <span class="n">max_verbose_attempts</span><span class="p">:</span>
            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trying Sci-Hub domain: </span><span class="si">{</span><span class="n">sci_hub_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">TCPConnector</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
                <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">(</span><span class="n">connector</span><span class="o">=</span><span class="n">conn</span><span class="p">,</span> <span class="n">trust_env</span><span class="o">=</span><span class="n">ACTIVE_PROXY</span><span class="o">.</span><span class="n">enabled</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
                    <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sci_hub_url</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;=</span> <span class="n">max_verbose_attempts</span><span class="p">:</span>
                            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sci-Hub HTTP status: </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">html</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
                        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;src\s*=\s*[&quot;</span><span class="se">\&#39;</span><span class="s1">](.*?\.pdf.*?)[&quot;</span><span class="se">\&#39;</span><span class="s1">]&#39;</span><span class="p">,</span> <span class="n">html</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                            <span class="n">pdf_url</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">pdf_url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;//&quot;</span><span class="p">):</span>
                                <span class="n">pdf_url</span> <span class="o">=</span> <span class="s2">&quot;https:&quot;</span> <span class="o">+</span> <span class="n">pdf_url</span>
                            <span class="k">elif</span> <span class="n">pdf_url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">):</span>
                                <span class="n">pdf_url</span> <span class="o">=</span> <span class="n">domain</span> <span class="o">+</span> <span class="n">pdf_url</span>
                            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found PDF URL on Sci-Hub: </span><span class="si">{</span><span class="n">pdf_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pdf_url</span><span class="p">)</span> <span class="k">as</span> <span class="n">pdf_resp</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;=</span> <span class="n">max_verbose_attempts</span><span class="p">:</span>
                                    <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sci-Hub PDF HTTP status: </span><span class="si">{</span><span class="n">pdf_resp</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">pdf_resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="k">await</span> <span class="n">pdf_resp</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloaded PDF from </span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                    <span class="k">return</span> <span class="n">filepath</span>
                        <span class="n">attempt_reports</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;no_pdf&quot;</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">attempt_reports</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">&lt;=</span> <span class="n">max_verbose_attempts</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error accessing Sci-Hub at </span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">attempt_reports</span><span class="p">:</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">kind</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">status</span> <span class="ow">in</span> <span class="n">attempt_reports</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">status</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">kind</span>
            <span class="n">summary</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sci-Hub attempts summary: </span><span class="si">{</span><span class="n">summary</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">combined_domains</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_verbose_attempts</span><span class="p">:</span>
            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sci-Hub attempts shown: </span><span class="si">{</span><span class="n">max_verbose_attempts</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">combined_domains</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="download_from_anna_archive">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.getpapers.download_from_anna_archive">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">download_from_anna_archive</span><span class="p">(</span>
    <span class="n">doi</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">download_folder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">DEFAULT_DOWNLOAD_FOLDER</span><span class="p">,</span>
    <span class="n">refresh_mirrors</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">safe_doi</span> <span class="o">=</span> <span class="n">doi</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">safe_doi</span><span class="si">}</span><span class="s2">_anna.pdf&quot;</span>
    <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">download_folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="n">anna_domains</span> <span class="o">=</span> <span class="n">get_anna_mirrors</span><span class="p">(</span><span class="n">force_refresh</span><span class="o">=</span><span class="n">refresh_mirrors</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">domain</span> <span class="ow">in</span> <span class="n">anna_domains</span><span class="p">:</span>
        <span class="n">anna_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">/scidb/</span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trying Anna&#39;s Archive domain: </span><span class="si">{</span><span class="n">anna_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">TCPConnector</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
                <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">(</span><span class="n">connector</span><span class="o">=</span><span class="n">conn</span><span class="p">,</span> <span class="n">trust_env</span><span class="o">=</span><span class="n">ACTIVE_PROXY</span><span class="o">.</span><span class="n">enabled</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
                    <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">anna_url</span><span class="p">)</span> <span class="k">as</span> <span class="n">resp</span><span class="p">:</span>
                        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Anna&#39;s Archive HTTP status: </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
                            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Anna&#39;s Archive page not found for DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">continue</span>
                        <span class="n">html</span> <span class="o">=</span> <span class="k">await</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
                        <span class="c1"># Find md5sum from the &quot;Record in Annas Archive&quot; link</span>
                        <span class="n">md5_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;a[^&gt;]+href=[&quot;</span><span class="se">\&#39;</span><span class="s1">]/md5/([a-fA-F0-9]</span><span class="si">{32}</span><span class="s1">)[&quot;</span><span class="se">\&#39;</span><span class="s1">]&#39;</span><span class="p">,</span> <span class="n">html</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">md5_match</span><span class="p">:</span>
                            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No md5sum found on Anna&#39;s Archive for DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">continue</span>
                        <span class="n">md5sum</span> <span class="o">=</span> <span class="n">md5_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found md5sum on Anna&#39;s Archive: </span><span class="si">{</span><span class="n">md5sum</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="c1"># Find all links ending with &lt;md5sum&gt;.pdf</span>
                        <span class="n">pdf_links</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;a[^&gt;]+href=[&quot;</span><span class="se">\&#39;</span><span class="s1">]([^&quot;</span><span class="se">\&#39;</span><span class="s1">]*&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">md5sum</span><span class="p">)</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;\.pdf[^&quot;</span><span class="se">\&#39;</span><span class="s1">]*)[&quot;</span><span class="se">\&#39;</span><span class="s1">]&#39;</span><span class="p">,</span> <span class="n">html</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">pdf_links</span><span class="p">:</span>
                            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No PDF links found for md5sum </span><span class="si">{</span><span class="n">md5sum</span><span class="si">}</span><span class="s2"> on Anna&#39;s Archive for DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">continue</span>
                        <span class="k">for</span> <span class="n">pdf_url</span> <span class="ow">in</span> <span class="n">pdf_links</span><span class="p">:</span>
                            <span class="c1"># Make absolute URL if needed</span>
                            <span class="k">if</span> <span class="n">pdf_url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">):</span>
                                <span class="n">pdf_url_full</span> <span class="o">=</span> <span class="n">domain</span> <span class="o">+</span> <span class="n">pdf_url</span>
                            <span class="k">elif</span> <span class="n">pdf_url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">):</span>
                                <span class="n">pdf_url_full</span> <span class="o">=</span> <span class="n">pdf_url</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">pdf_url_full</span> <span class="o">=</span> <span class="n">domain</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">pdf_url</span>
                            <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trying PDF link from Anna&#39;s Archive: </span><span class="si">{</span><span class="n">pdf_url_full</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pdf_url_full</span><span class="p">)</span> <span class="k">as</span> <span class="n">pdf_resp</span><span class="p">:</span>
                                    <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Anna&#39;s Archive PDF HTTP status: </span><span class="si">{</span><span class="n">pdf_resp</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">pdf_resp</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="k">await</span> <span class="n">pdf_resp</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloaded PDF from Anna&#39;s Archive: </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                        <span class="k">return</span> <span class="n">filepath</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PDF download failed from Anna&#39;s Archive for DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">pdf_url_full</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error downloading PDF from Anna&#39;s Archive for DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">pdf_url_full</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;All PDF links tried for md5sum </span><span class="si">{</span><span class="n">md5sum</span><span class="si">}</span><span class="s2"> but failed for DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error accessing Anna&#39;s Archive for DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="download_by_doi">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.getpapers.download_by_doi">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">download_by_doi</span><span class="p">(</span>
    <span class="n">doi</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">download_folder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">DEFAULT_DOWNLOAD_FOLDER</span><span class="p">,</span>
    <span class="n">db</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span>
    <span class="n">no_download</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">oa_status</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">assume_valid_doi</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">refresh_mirrors</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">suppress_summary</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">ezproxy_provider</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ezproxy_provider_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ezproxy_username</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ezproxy_password</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ezproxy_store_credentials</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">ezproxy_headless</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">ezproxy_wait_login_seconds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">180</span><span class="p">,</span>
    <span class="n">ezproxy_download_timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
<span class="p">):</span>
    <span class="c1"># Extract DOI from input if possible (handles cases where input is a URL or contains a DOI)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">assume_valid_doi</span><span class="p">:</span>
        <span class="n">dois</span> <span class="o">=</span> <span class="n">extract_dois_from_text</span><span class="p">(</span><span class="n">doi</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dois</span><span class="p">:</span>
            <span class="n">doi</span> <span class="o">=</span> <span class="n">dois</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Input does not appear to be a valid DOI or DOI-containing string: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting download_by_doi for DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">, folder: </span><span class="si">{</span><span class="n">download_folder</span><span class="si">}</span><span class="s2">, db: </span><span class="si">{</span><span class="n">db</span><span class="si">}</span><span class="s2">, no_download: </span><span class="si">{</span><span class="n">no_download</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">selected_dbs</span> <span class="o">=</span> <span class="n">normalize_db_selection</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s2">&quot;nexus&quot;</span> <span class="ow">in</span> <span class="n">selected_dbs</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">search_documents</span><span class="p">(</span><span class="n">doi</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">document</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">document</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Search result for DOI:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">format_reference</span><span class="p">(</span><span class="n">document</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Full document JSON:&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">document</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-----&#39;</span><span class="p">)</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; No document found for DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">no_download</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; --no-download specified, skipping download.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Attempting to download PDF for DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># Check if the DOI is open access via Unpaywall</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">is_oa</span> <span class="o">=</span> <span class="n">oa_status</span> <span class="k">if</span> <span class="n">oa_status</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="k">await</span> <span class="n">is_open_access_unpaywall</span><span class="p">(</span><span class="n">doi</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">oa_status_text</span> <span class="o">=</span> <span class="s2">&quot;Open Access&quot;</span> <span class="k">if</span> <span class="n">is_oa</span> <span class="k">else</span> <span class="s2">&quot;Closed Access&quot;</span>
    <span class="n">oa_icon</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">is_oa</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    
    <span class="n">unpaywall_attempted</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">is_oa</span><span class="p">:</span>
        <span class="n">unpaywall_attempted</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> is Open Access. Using Unpaywall for download...&quot;</span><span class="p">)</span>
        <span class="n">unpaywall_path</span> <span class="o">=</span> <span class="k">await</span> <span class="n">download_from_unpaywall</span><span class="p">(</span><span class="n">doi</span><span class="p">,</span> <span class="n">download_folder</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">unpaywall_path</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">suppress_summary</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Download Summary:&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Successfully downloaded: 1 PDF&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">oa_status_text</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">oa_icon</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">unpaywall_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">unpaywall_path</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Failed to download from Unpaywall for DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">. Trying other sources...&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">id</span> <span class="ow">and</span> <span class="s2">&quot;nexus&quot;</span> <span class="ow">in</span> <span class="n">selected_dbs</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; No ID available for Nexus download for DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="n">tried</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="s2">&quot;nexus&quot;</span> <span class="ow">in</span> <span class="n">selected_dbs</span> <span class="ow">and</span> <span class="nb">id</span><span class="p">:</span>
        <span class="n">tried</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trying Nexus download for id: </span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">, doi: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Trying Nexus for DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="n">nexus_path</span> <span class="o">=</span> <span class="k">await</span> <span class="n">download_from_nexus</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">doi</span><span class="p">,</span> <span class="n">download_folder</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nexus_path</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">suppress_summary</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Download Summary:&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Successfully downloaded: 1 PDF&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">oa_status_text</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">oa_icon</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">nexus_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">nexus_path</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; PDF file is not available on the Nexus server for DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="c1"># Try Nexus bot as fallback</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Trying Nexus bot for DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="n">nexus_bot_path</span> <span class="o">=</span> <span class="k">await</span> <span class="n">download_from_nexus_bot</span><span class="p">(</span><span class="n">doi</span><span class="p">,</span> <span class="n">download_folder</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nexus_bot_path</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">suppress_summary</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Download Summary:&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Successfully downloaded: 1 PDF&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">oa_status_text</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">oa_icon</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">nexus_bot_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">nexus_bot_path</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; PDF file is not available from Nexus bot for DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;scihub&quot;</span> <span class="ow">in</span> <span class="n">selected_dbs</span><span class="p">:</span>
        <span class="n">tried</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Trying Sci-Hub for DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="n">scihub_path</span> <span class="o">=</span> <span class="k">await</span> <span class="n">download_from_scihub</span><span class="p">(</span>
            <span class="n">doi</span><span class="p">,</span> <span class="n">download_folder</span><span class="p">,</span> <span class="n">refresh_mirrors</span><span class="o">=</span><span class="n">refresh_mirrors</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">scihub_path</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">suppress_summary</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Download Summary:&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Successfully downloaded: 1 PDF&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">oa_status_text</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">oa_icon</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">scihub_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">scihub_path</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; PDF file is not available on Sci-Hub for DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;anna&quot;</span> <span class="ow">in</span> <span class="n">selected_dbs</span><span class="p">:</span>
        <span class="n">tried</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Trying Anna&#39;s Archive for DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="n">anna_path</span> <span class="o">=</span> <span class="k">await</span> <span class="n">download_from_anna_archive</span><span class="p">(</span>
            <span class="n">doi</span><span class="p">,</span> <span class="n">download_folder</span><span class="p">,</span> <span class="n">refresh_mirrors</span><span class="o">=</span><span class="n">refresh_mirrors</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">anna_path</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">suppress_summary</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Download Summary:&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Successfully downloaded: 1 PDF&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">oa_status_text</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">oa_icon</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">anna_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">anna_path</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; PDF file is not available on Anna&#39;s Archive for DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;libgen&quot;</span> <span class="ow">in</span> <span class="n">selected_dbs</span><span class="p">:</span>
        <span class="n">tried</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Trying LibGen for DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Call the libgen module&#39;s download_by_doi function</span>
            <span class="n">result_path</span> <span class="o">=</span> <span class="n">libgen</span><span class="o">.</span><span class="n">download_libgen_paper_by_doi</span><span class="p">(</span><span class="n">doi</span><span class="p">,</span> <span class="n">dest_folder</span><span class="o">=</span><span class="n">download_folder</span><span class="p">,</span> <span class="n">print_result</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result_path</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">suppress_summary</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Download Summary:&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Successfully downloaded: 1 PDF&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">oa_status_text</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">oa_icon</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">result_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">result_path</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; PDF file is not available on LibGen for DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Error downloading from LibGen for DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;ezproxy&quot;</span> <span class="ow">in</span> <span class="n">selected_dbs</span><span class="p">:</span>
        <span class="n">tried</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Trying EZProxy for DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ezproxy_provider</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ezproxy_provider_url</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; EZProxy provider not specified. Use --ezproxy-provider or --ezproxy-provider-url.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">ezproxy</span> <span class="k">as</span> <span class="n">ezproxy_mod</span>

                <span class="n">ez_path</span> <span class="o">=</span> <span class="n">ezproxy_mod</span><span class="o">.</span><span class="n">download_doi_via_ezproxy</span><span class="p">(</span>
                    <span class="n">doi</span><span class="o">=</span><span class="n">doi</span><span class="p">,</span>
                    <span class="n">provider</span><span class="o">=</span><span class="n">ezproxy_provider</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                    <span class="n">download_dir</span><span class="o">=</span><span class="n">download_folder</span><span class="p">,</span>
                    <span class="n">provider_url</span><span class="o">=</span><span class="n">ezproxy_provider_url</span><span class="p">,</span>
                    <span class="n">username</span><span class="o">=</span><span class="n">ezproxy_username</span><span class="p">,</span>
                    <span class="n">password</span><span class="o">=</span><span class="n">ezproxy_password</span><span class="p">,</span>
                    <span class="n">headless</span><span class="o">=</span><span class="n">ezproxy_headless</span><span class="p">,</span>
                    <span class="n">store_credentials</span><span class="o">=</span><span class="n">ezproxy_store_credentials</span><span class="p">,</span>
                    <span class="n">wait_login_seconds</span><span class="o">=</span><span class="n">ezproxy_wait_login_seconds</span><span class="p">,</span>
                    <span class="n">download_timeout</span><span class="o">=</span><span class="n">ezproxy_download_timeout</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">ez_path</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">suppress_summary</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Download Summary:&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Successfully downloaded: 1 PDF&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">oa_status_text</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">oa_icon</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">ez_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">ez_path</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; PDF file is not available via EZProxy for DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Error downloading via EZProxy for DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;unpaywall&quot;</span> <span class="ow">in</span> <span class="n">selected_dbs</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">unpaywall_attempted</span><span class="p">:</span>
        <span class="n">tried</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Trying Unpaywall for DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="n">unpaywall_path</span> <span class="o">=</span> <span class="k">await</span> <span class="n">download_from_unpaywall</span><span class="p">(</span><span class="n">doi</span><span class="p">,</span> <span class="n">download_folder</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">unpaywall_path</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">suppress_summary</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Download Summary:&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Successfully downloaded: 1 PDF&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">oa_status_text</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">oa_icon</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">unpaywall_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">unpaywall_path</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; PDF file is not available on Unpaywall for DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="c1"># Special handling for Elsevier and Wiley DOIs</span>
    <span class="k">if</span> <span class="n">is_elsevier_doi</span><span class="p">(</span><span class="n">doi</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> appears to be an Elsevier article. Attempting Elsevier Full-Text API download...&quot;</span><span class="p">)</span>
        <span class="n">elsevier_path</span> <span class="o">=</span> <span class="k">await</span> <span class="n">download_elsevier_pdf_by_doi</span><span class="p">(</span>
            <span class="n">doi</span><span class="o">=</span><span class="n">doi</span><span class="p">,</span>
            <span class="n">download_folder</span><span class="o">=</span><span class="n">download_folder</span><span class="p">,</span>
            <span class="n">api_key</span><span class="o">=</span><span class="n">configuration</span><span class="o">.</span><span class="n">ELSEVIER_API_KEY</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">elsevier_path</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">suppress_summary</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Download Summary:&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Successfully downloaded: 1 PDF&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">oa_status_text</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">oa_icon</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">elsevier_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">elsevier_path</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; PDF file is not available from Elsevier Full-Text API for DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">is_wiley_doi</span><span class="p">(</span><span class="n">doi</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> appears to be a Wiley article. Attempting Wiley TDM API download...&quot;</span><span class="p">)</span>
        <span class="n">wiley_path</span> <span class="o">=</span> <span class="k">await</span> <span class="n">download_wiley_pdf_by_doi</span><span class="p">(</span>
            <span class="n">doi</span><span class="p">,</span> <span class="n">download_folder</span><span class="p">,</span> <span class="n">tdm_token</span><span class="o">=</span><span class="n">configuration</span><span class="o">.</span><span class="n">WILEY_TDM_TOKEN</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">wiley_path</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">suppress_summary</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Download Summary:&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Successfully downloaded: 1 PDF&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">oa_status_text</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">oa_icon</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">wiley_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">wiley_path</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; PDF file is not available from Wiley TDM API for DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">tried</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; No valid database specified for DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    
    <span class="c1"># print(f&quot;\nDownload Summary:&quot;)</span>
    <span class="c1"># print(f&quot;Failed to download: 1 PDF&quot;)</span>
    <span class="c1"># print(f&quot;   {doi} [{oa_status_text}]&quot;)</span>
    <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="download_by_doi_list">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.getpapers.download_by_doi_list">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">download_by_doi_list</span><span class="p">(</span>
    <span class="n">doi_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">download_folder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">DEFAULT_DOWNLOAD_FOLDER</span><span class="p">,</span>
    <span class="n">db</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span>
    <span class="n">no_download</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">refresh_mirrors</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">ezproxy_provider</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ezproxy_provider_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ezproxy_username</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ezproxy_password</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">ezproxy_store_credentials</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">ezproxy_headless</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">ezproxy_wait_login_seconds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">180</span><span class="p">,</span>
    <span class="n">ezproxy_download_timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">ICON_START</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">ICON_DOI</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">ICON_SUCCESS</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">ICON_FAIL</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">ICON_SKIP</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">ICON_OA</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">ICON_CLOSED</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">ICON_FILE</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">ICON_SUMMARY</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">ICON_STEP</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">ICON_WARN</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="n">vprint</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_START</span><span class="si">}</span><span class="s2"> Starting download_by_doi_list for file: </span><span class="si">{</span><span class="n">doi_file</span><span class="si">}</span><span class="s2">, folder: </span><span class="si">{</span><span class="n">download_folder</span><span class="si">}</span><span class="s2">, db: </span><span class="si">{</span><span class="n">normalize_db_selection</span><span class="p">(</span><span class="n">db</span><span class="p">)</span><span class="si">}</span><span class="s2">, no_download: </span><span class="si">{</span><span class="n">no_download</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    
    <span class="c1"># Always extract DOIs from the file using extract_dois_from_file</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_STEP</span><span class="si">}</span><span class="s2"> Extracting DOIs from file: </span><span class="si">{</span><span class="n">doi_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">dois</span> <span class="o">=</span> <span class="n">extract_dois_from_file</span><span class="p">(</span><span class="n">doi_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dois</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_FAIL</span><span class="si">}</span><span class="s2"> Error: No valid DOI numbers could be extracted from </span><span class="si">{</span><span class="n">doi_file</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="n">vprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_STEP</span><span class="si">}</span><span class="s2"> Using extracted DOIs from file: </span><span class="si">{</span><span class="n">doi_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_FAIL</span><span class="si">}</span><span class="s2"> Failed to extract DOIs from file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="n">download_results</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">successful_downloads</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">failed_downloads</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">doi</span> <span class="ow">in</span> <span class="n">dois</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_DOI</span><span class="si">}</span><span class="s2"> Processing DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Get open access status</span>
        <span class="n">oa_status</span> <span class="o">=</span> <span class="k">await</span> <span class="n">is_open_access_unpaywall</span><span class="p">(</span><span class="n">doi</span><span class="p">)</span>
        <span class="n">oa_status_text</span> <span class="o">=</span> <span class="s2">&quot;Open Access&quot;</span> <span class="k">if</span> <span class="n">oa_status</span> <span class="k">else</span> <span class="s2">&quot;Closed Access&quot;</span>
        <span class="n">oa_icon</span> <span class="o">=</span> <span class="n">ICON_OA</span> <span class="k">if</span> <span class="n">oa_status</span> <span class="k">else</span> <span class="n">ICON_CLOSED</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">download_by_doi</span><span class="p">(</span>
            <span class="n">doi</span><span class="p">,</span>
            <span class="n">download_folder</span><span class="o">=</span><span class="n">download_folder</span><span class="p">,</span>
            <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
            <span class="n">no_download</span><span class="o">=</span><span class="n">no_download</span><span class="p">,</span>
            <span class="n">oa_status</span><span class="o">=</span><span class="n">oa_status</span><span class="p">,</span>
            <span class="n">assume_valid_doi</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">refresh_mirrors</span><span class="o">=</span><span class="n">refresh_mirrors</span><span class="p">,</span>
            <span class="n">suppress_summary</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">ezproxy_provider</span><span class="o">=</span><span class="n">ezproxy_provider</span><span class="p">,</span>
            <span class="n">ezproxy_provider_url</span><span class="o">=</span><span class="n">ezproxy_provider_url</span><span class="p">,</span>
            <span class="n">ezproxy_username</span><span class="o">=</span><span class="n">ezproxy_username</span><span class="p">,</span>
            <span class="n">ezproxy_password</span><span class="o">=</span><span class="n">ezproxy_password</span><span class="p">,</span>
            <span class="n">ezproxy_store_credentials</span><span class="o">=</span><span class="n">ezproxy_store_credentials</span><span class="p">,</span>
            <span class="n">ezproxy_headless</span><span class="o">=</span><span class="n">ezproxy_headless</span><span class="p">,</span>
            <span class="n">ezproxy_wait_login_seconds</span><span class="o">=</span><span class="n">ezproxy_wait_login_seconds</span><span class="p">,</span>
            <span class="n">ezproxy_download_timeout</span><span class="o">=</span><span class="n">ezproxy_download_timeout</span><span class="p">,</span>
        <span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">downloaded_file</span> <span class="o">=</span> <span class="n">result</span>
            <span class="n">download_results</span><span class="p">[</span><span class="n">doi</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="n">downloaded_file</span><span class="p">]</span>
            <span class="n">successful_downloads</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">doi</span><span class="p">,</span> <span class="n">oa_status</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">downloaded_file</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_SUCCESS</span><span class="si">}</span><span class="s2"> Downloaded: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">oa_status_text</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">oa_icon</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">ICON_FILE</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">downloaded_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_SUCCESS</span><span class="si">}</span><span class="s2"> Downloaded: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">oa_status_text</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">oa_icon</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">ICON_FILE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># Compatibility fallback: find the downloaded file by known patterns.</span>
            <span class="n">safe_doi</span> <span class="o">=</span> <span class="n">doi</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="n">possible_files</span> <span class="o">=</span> <span class="p">[</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">safe_doi</span><span class="si">}</span><span class="s2">_unpaywall.pdf&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">safe_doi</span><span class="si">}</span><span class="s2">_unpaywall_1.pdf&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">safe_doi</span><span class="si">}</span><span class="s2">_unpaywall_elsevier.pdf&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">safe_doi</span><span class="si">}</span><span class="s2">_elsevier.pdf&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">safe_doi</span><span class="si">}</span><span class="s2">_wiley.pdf&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">safe_doi</span><span class="si">}</span><span class="s2">_nexus.pdf&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">safe_doi</span><span class="si">}</span><span class="s2">_nexusbot.pdf&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">safe_doi</span><span class="si">}</span><span class="s2">_scihub.pdf&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">safe_doi</span><span class="si">}</span><span class="s2">_scinet.pdf&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">safe_doi</span><span class="si">}</span><span class="s2">_anna.pdf&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">safe_doi</span><span class="si">}</span><span class="s2">_pmc.pdf&quot;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">safe_doi</span><span class="si">}</span><span class="s2">_libgen.pdf&quot;</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="n">downloaded_file</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">possible_files</span><span class="p">:</span>
                <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">download_folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
                    <span class="n">downloaded_file</span> <span class="o">=</span> <span class="n">filepath</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">downloaded_file</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>  <span class="c1"># Check up to 10 files</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">safe_doi</span><span class="si">}</span><span class="s2">_unpaywall_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.pdf&quot;</span>
                    <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">download_folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
                        <span class="n">downloaded_file</span> <span class="o">=</span> <span class="n">filepath</span>
                        <span class="k">break</span>
            <span class="n">download_results</span><span class="p">[</span><span class="n">doi</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="n">downloaded_file</span> <span class="k">if</span> <span class="n">downloaded_file</span> <span class="k">else</span> <span class="s2">&quot;file_not_found&quot;</span><span class="p">]</span>
            <span class="n">successful_downloads</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">doi</span><span class="p">,</span> <span class="n">oa_status</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">downloaded_file</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_SUCCESS</span><span class="si">}</span><span class="s2"> Downloaded: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">oa_status_text</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">oa_icon</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">ICON_FILE</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">downloaded_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_SUCCESS</span><span class="si">}</span><span class="s2"> Downloaded: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">oa_status_text</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">oa_icon</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">download_results</span><span class="p">[</span><span class="n">doi</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;failed&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="n">failed_downloads</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">doi</span><span class="p">,</span> <span class="n">oa_status</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_FAIL</span><span class="si">}</span><span class="s2"> Failed: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">oa_status_text</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">oa_icon</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># result is None when no_download is True or no document found</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;no_download&quot;</span> <span class="k">if</span> <span class="n">no_download</span> <span class="k">else</span> <span class="s2">&quot;not_found&quot;</span>
            <span class="n">download_results</span><span class="p">[</span><span class="n">doi</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">status</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">no_download</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_SKIP</span><span class="si">}</span><span class="s2"> Skipped download for: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">oa_status_text</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">oa_icon</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_FAIL</span><span class="si">}</span><span class="s2"> Not found: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">oa_status_text</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">oa_icon</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">no_download</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">ICON_SUMMARY</span><span class="si">}</span><span class="s2"> Download Summary:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_SUCCESS</span><span class="si">}</span><span class="s2"> Successfully downloaded: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">successful_downloads</span><span class="p">)</span><span class="si">}</span><span class="s2"> PDFs&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">successful_downloads</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">doi</span><span class="p">,</span> <span class="n">oa_status</span> <span class="ow">in</span> <span class="n">successful_downloads</span><span class="p">:</span>
                <span class="n">oa_status_text</span> <span class="o">=</span> <span class="s2">&quot;Open Access&quot;</span> <span class="k">if</span> <span class="n">oa_status</span> <span class="k">else</span> <span class="s2">&quot;Closed Access&quot;</span>
                <span class="n">oa_icon</span> <span class="o">=</span> <span class="n">ICON_OA</span> <span class="k">if</span> <span class="n">oa_status</span> <span class="k">else</span> <span class="n">ICON_CLOSED</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="n">download_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">doi</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">file_path</span> <span class="ow">and</span> <span class="n">file_path</span> <span class="o">!=</span> <span class="s2">&quot;file_not_found&quot;</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">ICON_SUCCESS</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">oa_status_text</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">oa_icon</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">ICON_SUCCESS</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">oa_status_text</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">oa_icon</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ICON_FAIL</span><span class="si">}</span><span class="s2"> Failed to download: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">failed_downloads</span><span class="p">)</span><span class="si">}</span><span class="s2"> PDFs&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">failed_downloads</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">doi</span><span class="p">,</span> <span class="n">oa_status</span> <span class="ow">in</span> <span class="n">failed_downloads</span><span class="p">:</span>
                <span class="n">oa_status_text</span> <span class="o">=</span> <span class="s2">&quot;Open Access&quot;</span> <span class="k">if</span> <span class="n">oa_status</span> <span class="k">else</span> <span class="s2">&quot;Closed Access&quot;</span>
                <span class="n">oa_icon</span> <span class="o">=</span> <span class="n">ICON_OA</span> <span class="k">if</span> <span class="n">oa_status</span> <span class="k">else</span> <span class="n">ICON_CLOSED</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">ICON_FAIL</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">oa_status_text</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">oa_icon</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">download_results</span></div>


<div class="viewcode-block" id="print_default_paths">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.getpapers.print_default_paths">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">print_default_paths</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Print all default paths and configuration file locations used by the script.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Default configuration and data paths:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  GETPAPERS_CONFIG_FILE: </span><span class="si">{</span><span class="n">GETPAPERS_CONFIG_FILE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Default proxy config file: </span><span class="si">{</span><span class="n">DEFAULT_PROXY_FILE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Default download folder: </span><span class="si">{</span><span class="n">DEFAULT_DOWNLOAD_FOLDER</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Unpywall cache file: </span><span class="si">{</span><span class="n">UNPYWALL_CACHE_FILE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Platform: </span><span class="si">{</span><span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="print_mirror_lists">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.getpapers.print_mirror_lists">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">print_mirror_lists</span><span class="p">(</span><span class="n">refresh</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">anna</span> <span class="o">=</span> <span class="n">get_anna_mirrors</span><span class="p">(</span><span class="n">force_refresh</span><span class="o">=</span><span class="n">refresh</span><span class="p">)</span>
    <span class="n">scihub_sets</span> <span class="o">=</span> <span class="n">get_scihub_mirrors</span><span class="p">(</span><span class="n">force_refresh</span><span class="o">=</span><span class="n">refresh</span><span class="p">)</span>
    <span class="n">scihub</span> <span class="o">=</span> <span class="n">scihub_sets</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scihub&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">scinet</span> <span class="o">=</span> <span class="n">scihub_sets</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scinet&quot;</span><span class="p">,</span> <span class="p">[])</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Active mirrors:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Anna&#39;s Archive:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">domain</span> <span class="ow">in</span> <span class="n">anna</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    - </span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Sci-Hub:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">domain</span> <span class="ow">in</span> <span class="n">scihub</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    - </span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Sci-Net:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">domain</span> <span class="ow">in</span> <span class="n">scinet</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    - </span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="main">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.getpapers.main">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">argv</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Windows&quot;</span><span class="p">:</span>
        <span class="c1"># Prefer the selector policy to avoid Proactor cleanup warnings on exit</span>
        <span class="n">asyncio</span><span class="o">.</span><span class="n">set_event_loop_policy</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">WindowsSelectorEventLoopPolicy</span><span class="p">())</span>

    <span class="c1"># Get the parent package name from the module&#39;s __name__</span>
    <span class="n">parent_package</span> <span class="o">=</span> <span class="vm">__name__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="vm">__name__</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">parent_package</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">program_name</span> <span class="o">=</span> <span class="s1">&#39;getpapers&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;_&#39;</span> <span class="ow">in</span> <span class="n">parent_package</span><span class="p">:</span>
        <span class="c1"># If the parent package has an underscore, strip it</span>
        <span class="n">parent_package</span> <span class="o">=</span> <span class="n">parent_package</span><span class="p">[:</span><span class="n">parent_package</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)]</span>
        <span class="n">program_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">parent_package</span><span class="si">}</span><span class="s2"> getpapers&quot;</span>

    <span class="n">argparser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Search for and download scientific papers by DOI or keyword. &quot;</span>
                   <span class="s2">&quot;Supports downloading from multiple sources including Unpaywall, Sci-Hub, Anna&#39;s Archive.&quot;</span><span class="p">,</span>
        <span class="n">epilog</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;Examples:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  </span><span class="si">%(prog)s</span><span class="s2"> --search </span><span class="se">\&quot;</span><span class="s2">machine learning</span><span class="se">\&quot;\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  </span><span class="si">%(prog)s</span><span class="s2"> --doi 10.1038/nature12373</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  </span><span class="si">%(prog)s</span><span class="s2"> --doi-file papers.txt</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  </span><span class="si">%(prog)s</span><span class="s2"> --doi 10.1016/j.cell.2019.05.031 --db unpaywall</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  </span><span class="si">%(prog)s</span><span class="s2"> --search </span><span class="se">\&quot;</span><span class="s2">deep learning</span><span class="se">\&quot;</span><span class="s2"> --limit 10</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  </span><span class="si">%(prog)s</span><span class="s2"> --doi 10.1016/j.cell.2019.05.031 --no-download</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  </span><span class="si">%(prog)s</span><span class="s2"> --doi 10.1016/j.cell.2019.05.031 --download-folder ./pdfs</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  </span><span class="si">%(prog)s</span><span class="s2"> --doi-file mylist.txt --db scihub</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  </span><span class="si">%(prog)s</span><span class="s2"> --search </span><span class="se">\&quot;</span><span class="s2">climate change</span><span class="se">\&quot;</span><span class="s2"> --verbose</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  </span><span class="si">%(prog)s</span><span class="s2"> --doi 10.1002/anie.201915678 --credentials mycredentials.json</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  </span><span class="si">%(prog)s</span><span class="s2"> --clear-credentials</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  </span><span class="si">%(prog)s</span><span class="s2"> --print-default</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  </span><span class="si">%(prog)s</span><span class="s2"> --print-mirrors</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  </span><span class="si">%(prog)s</span><span class="s2"> --extract-doi-from-pdf mypaper.pdf</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">),</span>
        <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">RawDescriptionHelpFormatter</span><span class="p">,</span>
        <span class="n">prog</span><span class="o">=</span><span class="n">program_name</span>
    <span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--search&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Search keyword or DOI&quot;</span><span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--limit&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_LIMIT</span><span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--doi&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Specify a DOI to download the paper&quot;</span><span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--doi-file&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to a text file containing DOIs (one per line)&quot;</span><span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--download-folder&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_DOWNLOAD_FOLDER</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Folder to save downloaded PDFs&quot;</span><span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--proxy&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Path to proxy configuration JSON file (default: </span><span class="si">{</span><span class="n">DEFAULT_PROXY_FILE</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--no-proxy&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable proxy usage even if a proxy configuration is present.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--refresh-mirrors&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Force refresh of Anna&#39;s Archive and Sci-Hub mirrors before attempting download.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--auto-proxy&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Automatically fetch a working proxy configuration when missing or invalid.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--db&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;append&quot;</span><span class="p">,</span>
        <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">DB_CHOICES</span><span class="p">],</span>
        <span class="n">help</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;Specify which database(s) to use for downloading PDFs: all, nexus, scihub, anna, unpaywall, libgen, ezproxy. &quot;</span>
            <span class="s2">&quot;Repeat the flag to target multiple services; defaults to all.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--ezproxy-provider&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;EZProxy provider name (e.g., NASATI, VNU-LIC)&quot;</span><span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--ezproxy-provider-url&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;EZProxy URL template containing $@&quot;</span><span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--ezproxy-username&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;EZProxy username&quot;</span><span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--ezproxy-password&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;EZProxy password&quot;</span><span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--ezproxy-store-credentials&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Cache EZProxy credentials on disk&quot;</span><span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--ezproxy-no-headless&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Show browser window for EZProxy login&quot;</span><span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--ezproxy-wait-login-seconds&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">180</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Seconds to wait for manual EZProxy login&quot;</span><span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--ezproxy-download-timeout&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Seconds to wait for EZProxy download&quot;</span><span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--no-download&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Only show metadata, do not download PDFs&quot;</span>
    <span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--verbose&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Print more details of how the script is running&quot;</span>
    <span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--credentials&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to custom JSON credentials file (format: {</span><span class="se">\&quot;</span><span class="s2">email</span><span class="se">\&quot;</span><span class="s2">: </span><span class="se">\&quot;</span><span class="s2">your@email.com</span><span class="se">\&quot;</span><span class="s2">, </span><span class="se">\&quot;</span><span class="s2">elsevier_api_key</span><span class="se">\&quot;</span><span class="s2">: </span><span class="se">\&quot;</span><span class="s2">key</span><span class="se">\&quot;</span><span class="s2">, </span><span class="se">\&quot;</span><span class="s2">wiley_tdm_token</span><span class="se">\&quot;</span><span class="s2">: </span><span class="se">\&quot;</span><span class="s2">token</span><span class="se">\&quot;</span><span class="s2">, </span><span class="se">\&quot;</span><span class="s2">ieee_api_key</span><span class="se">\&quot;</span><span class="s2">: </span><span class="se">\&quot;</span><span class="s2">key</span><span class="se">\&quot;</span><span class="s2">})&quot;</span>
    <span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--non-interactive&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Do not prompt for missing credentials; rely on config file or environment variables.&quot;</span>
    <span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--clear-credentials&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Delete the default configuration directory and all its contents&quot;</span>
    <span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--print-default&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Print all default paths and configuration file locations used by the script&quot;</span>
    <span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--print-mirrors&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Print active Anna&#39;s Archive, Sci-Hub, and Sci-Net mirrors, then exit&quot;</span>
    <span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--extract-doi-from-pdf&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Extract the first valid DOI from a PDF file&quot;</span>
    <span class="p">)</span>
    <span class="n">argparser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--extract-doi-from-txt&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Extract all valid DOIs from a text file and write them to &lt;file&gt;.dois.txt&quot;</span>
    <span class="p">)</span>
        
    <span class="n">args</span> <span class="o">=</span> <span class="n">argparser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span>
    <span class="n">args</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">db</span> <span class="ow">or</span> <span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span>

    <span class="c1"># Initialize Unpywall cache</span>
    <span class="n">ensure_directory_exists</span><span class="p">(</span><span class="n">UNPYWALL_CACHE_DIR</span><span class="p">)</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="n">UnpywallCache</span><span class="p">(</span><span class="n">UNPYWALL_CACHE_FILE</span><span class="p">)</span>
    <span class="n">Unpywall</span><span class="o">.</span><span class="n">init_cache</span><span class="p">(</span><span class="n">cache</span><span class="p">)</span>

    <span class="c1"># Handle --print-default / --print-mirrors before anything else</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">print_default</span><span class="p">:</span>
        <span class="n">print_default_paths</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">print_mirrors</span><span class="p">:</span>
        <span class="n">print_mirror_lists</span><span class="p">(</span><span class="n">refresh</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">refresh_mirrors</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Handle --clear-credentials before anything else</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">clear_credentials</span><span class="p">:</span>
        <span class="n">config_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">GETPAPERS_CONFIG_FILE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">config_dir</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">config_dir</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleted configuration directory: </span><span class="si">{</span><span class="n">config_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to delete configuration directory </span><span class="si">{</span><span class="n">config_dir</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Configuration directory does not exist: </span><span class="si">{</span><span class="n">config_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Check that mutually exclusive options are not specified together</span>
    <span class="n">exclusive_options</span> <span class="o">=</span> <span class="p">[</span><span class="n">args</span><span class="o">.</span><span class="n">doi</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">doi_file</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">search</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">extract_doi_from_pdf</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">extract_doi_from_txt</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span> <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">exclusive_options</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: Only one of --doi, --doi-file, --search, --extract-doi-from-pdf, or --extract-doi-from-txt can be specified at a time.&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Set global verbose flag</span>
    <span class="k">global</span> <span class="n">VERBOSE</span>
    <span class="n">VERBOSE</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">verbose</span>

    <span class="c1"># Configure proxy usage for all network clients</span>
    <span class="k">global</span> <span class="n">ACTIVE_PROXY</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ACTIVE_PROXY</span> <span class="o">=</span> <span class="n">proxy_config</span><span class="o">.</span><span class="n">load_proxy_settings</span><span class="p">(</span>
            <span class="n">args</span><span class="o">.</span><span class="n">proxy</span><span class="p">,</span> <span class="n">enabled</span><span class="o">=</span><span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">no_proxy</span><span class="p">,</span> <span class="n">auto_fetch</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">auto_proxy</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">VERBOSE</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="n">proxy_config</span><span class="o">.</span><span class="n">ProxyConfigError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">proxy</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ACTIVE_PROXY</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Proxy configuration file not found or unusable: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">proxy</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Ensure download folder exists before any file IO</span>
    <span class="n">args</span><span class="o">.</span><span class="n">download_folder</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">download_folder</span> <span class="ow">or</span> <span class="n">DEFAULT_DOWNLOAD_FOLDER</span>
    <span class="n">ensure_directory_exists</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">download_folder</span><span class="p">)</span>

    <span class="c1"># Credentials file</span>
    <span class="n">credentials_file</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">credentials</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">credentials</span> <span class="k">else</span> <span class="n">GETPAPERS_CONFIG_FILE</span>

    <span class="c1"># Load credentials from credentials file or environment</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">load_credentials</span><span class="p">(</span><span class="n">credentials_file</span><span class="p">,</span> <span class="n">interactive</span><span class="o">=</span><span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">non_interactive</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">isatty</span><span class="p">())</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># If only --credentials is specified, exit after loading credentials</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">credentials</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">doi</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">doi_file</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">search</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">extract_doi_from_pdf</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">extract_doi_from_txt</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded credentials from file: </span><span class="si">{</span><span class="n">credentials_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">extract_doi_from_pdf</span><span class="p">:</span>
        <span class="n">pdf_file</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">extract_doi_from_pdf</span>
        <span class="n">doi</span> <span class="o">=</span> <span class="n">extract_doi_from_pdf</span><span class="p">(</span><span class="n">pdf_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">doi</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracted DOI from PDF: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No valid DOI found in PDF: </span><span class="si">{</span><span class="n">pdf_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">extract_doi_from_txt</span><span class="p">:</span>
        <span class="n">txt_file</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">extract_doi_from_txt</span>
        <span class="n">extract_dois_from_file</span><span class="p">(</span><span class="n">txt_file</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">doi</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">download_by_doi</span><span class="p">(</span>
            <span class="n">args</span><span class="o">.</span><span class="n">doi</span><span class="p">,</span>
            <span class="n">download_folder</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">download_folder</span><span class="p">,</span>
            <span class="n">db</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">db</span><span class="p">,</span>
            <span class="n">no_download</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">no_download</span><span class="p">,</span>
            <span class="n">refresh_mirrors</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">refresh_mirrors</span><span class="p">,</span>
            <span class="n">ezproxy_provider</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">ezproxy_provider</span><span class="p">,</span>
            <span class="n">ezproxy_provider_url</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">ezproxy_provider_url</span><span class="p">,</span>
            <span class="n">ezproxy_username</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">ezproxy_username</span><span class="p">,</span>
            <span class="n">ezproxy_password</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">ezproxy_password</span><span class="p">,</span>
            <span class="n">ezproxy_store_credentials</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">ezproxy_store_credentials</span><span class="p">,</span>
            <span class="n">ezproxy_headless</span><span class="o">=</span><span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">ezproxy_no_headless</span><span class="p">,</span>
            <span class="n">ezproxy_wait_login_seconds</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">ezproxy_wait_login_seconds</span><span class="p">,</span>
            <span class="n">ezproxy_download_timeout</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">ezproxy_download_timeout</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">search</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">search_and_print</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">search</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">limit</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">doi_file</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">download_by_doi_list</span><span class="p">(</span>
            <span class="n">args</span><span class="o">.</span><span class="n">doi_file</span><span class="p">,</span>
            <span class="n">download_folder</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">download_folder</span><span class="p">,</span>
            <span class="n">db</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">db</span><span class="p">,</span>
            <span class="n">no_download</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">no_download</span><span class="p">,</span>
            <span class="n">refresh_mirrors</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">refresh_mirrors</span><span class="p">,</span>
            <span class="n">ezproxy_provider</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">ezproxy_provider</span><span class="p">,</span>
            <span class="n">ezproxy_provider_url</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">ezproxy_provider_url</span><span class="p">,</span>
            <span class="n">ezproxy_username</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">ezproxy_username</span><span class="p">,</span>
            <span class="n">ezproxy_password</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">ezproxy_password</span><span class="p">,</span>
            <span class="n">ezproxy_store_credentials</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">ezproxy_store_credentials</span><span class="p">,</span>
            <span class="n">ezproxy_headless</span><span class="o">=</span><span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">ezproxy_no_headless</span><span class="p">,</span>
            <span class="n">ezproxy_wait_login_seconds</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">ezproxy_wait_login_seconds</span><span class="p">,</span>
            <span class="n">ezproxy_download_timeout</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">ezproxy_download_timeout</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please specify --search &lt;keyword|doi&gt;, --doi &lt;doi&gt;, --doi-file &lt;file&gt;, --extract-doi-from-pdf &lt;pdf&gt;, or --extract-doi-from-txt &lt;txt&gt;.&quot;</span><span class="p">)</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># Use the recommended event loop policy for Windows</span>
    <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Windows&quot;</span><span class="p">:</span>
        <span class="n">asyncio</span><span class="o">.</span><span class="n">set_event_loop_policy</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">WindowsSelectorEventLoopPolicy</span><span class="p">())</span>
    
    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023-2026, Duc A. Hoang.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>