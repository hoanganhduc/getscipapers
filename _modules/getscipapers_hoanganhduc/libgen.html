

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>getscipapers_hoanganhduc.libgen &mdash; getscipapers 0.1.4 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=9edc463e" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=fd825880"></script>
      <script src="../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            getscipapers
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Usage Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cli_reference.html">CLI Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_reference.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project_documentation.html">Project Architecture and Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project_documentation.html#getscipapers-project-documentation">getscipapers Project Documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">getscipapers</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">getscipapers_hoanganhduc.libgen</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for getscipapers_hoanganhduc.libgen</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Utility functions for querying the Library Genesis catalog.</span>

<span class="sd">These helpers scrape search results and fetch download links so they can be</span>
<span class="sd">orchestrated by the higher-level request flows. Network and HTML parsing logic</span>
<span class="sd">live here to keep the CLI modules focused on argument handling.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bs4</span><span class="w"> </span><span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">quote_plus</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">platform</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ftplib</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">selenium</span><span class="w"> </span><span class="kn">import</span> <span class="n">webdriver</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">selenium.webdriver.common.by</span><span class="w"> </span><span class="kn">import</span> <span class="n">By</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">selenium.webdriver.common.keys</span><span class="w"> </span><span class="kn">import</span> <span class="n">Keys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">selenium.webdriver.support.ui</span><span class="w"> </span><span class="kn">import</span> <span class="n">WebDriverWait</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">selenium.webdriver.support</span><span class="w"> </span><span class="kn">import</span> <span class="n">expected_conditions</span> <span class="k">as</span> <span class="n">EC</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hashlib</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">getpapers</span><span class="p">,</span> <span class="n">proxy_config</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>

<span class="c1"># Provide generous timeouts so slow mirrors still succeed.</span>
<span class="n">DOWNLOAD_TIMEOUT</span> <span class="o">=</span> <span class="mi">120</span>

<span class="c1"># List of LibGen mirror domains (main alternatives)</span>
<span class="n">LIBGEN_MIRRORS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># &quot;libgen.gs&quot;,</span>
    <span class="s2">&quot;libgen.li&quot;</span><span class="p">,</span>
    <span class="s2">&quot;libgen.vg&quot;</span><span class="p">,</span>
    <span class="s2">&quot;libgen.la&quot;</span><span class="p">,</span>
    <span class="s2">&quot;libgen.bz&quot;</span><span class="p">,</span>
    <span class="s2">&quot;libgen.gl&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">ACTIVE_PROXY</span> <span class="o">=</span> <span class="n">proxy_config</span><span class="o">.</span><span class="n">ProxySettings</span><span class="p">()</span>

<div class="viewcode-block" id="select_active_libgen_domain">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.libgen.select_active_libgen_domain">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">select_active_libgen_domain</span><span class="p">(</span><span class="n">mirrors</span><span class="o">=</span><span class="n">LIBGEN_MIRRORS</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the first LibGen domain that responds to a simple GET request.</span>
<span class="sd">    Falls back to the default if none respond.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">test_path</span> <span class="o">=</span> <span class="s2">&quot;/json.php&quot;</span>
    <span class="k">for</span> <span class="n">domain</span> <span class="ow">in</span> <span class="n">mirrors</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://</span><span class="si">{</span><span class="n">domain</span><span class="si">}{</span><span class="n">test_path</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">domain</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">continue</span>
    <span class="k">return</span> <span class="n">mirrors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># fallback</span></div>


<span class="n">LIBGEN_DOMAIN</span> <span class="o">=</span> <span class="n">select_active_libgen_domain</span><span class="p">()</span>

<div class="viewcode-block" id="get_default_download_folder">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.libgen.get_default_download_folder">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_default_download_folder</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the default Downloads folder path for the current OS.</span>
<span class="sd">    Creates the folder if it does not exist.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">)</span>
    <span class="n">system</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">system</span> <span class="o">==</span> <span class="s2">&quot;Windows&quot;</span><span class="p">:</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">home</span><span class="p">,</span> <span class="s2">&quot;Downloads&quot;</span><span class="p">,</span> <span class="s2">&quot;getscipapers&quot;</span><span class="p">,</span> <span class="s2">&quot;libgen&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">system</span> <span class="o">==</span> <span class="s2">&quot;Darwin&quot;</span><span class="p">:</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">home</span><span class="p">,</span> <span class="s2">&quot;Downloads&quot;</span><span class="p">,</span> <span class="s2">&quot;getscipapers&quot;</span><span class="p">,</span> <span class="s2">&quot;libgen&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Assume Linux/Unix</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">home</span><span class="p">,</span> <span class="s2">&quot;Downloads&quot;</span><span class="p">,</span> <span class="s2">&quot;getscipapers&quot;</span><span class="p">,</span> <span class="s2">&quot;libgen&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">folder</span></div>


<span class="n">DEFAULT_DOWNLOAD_DIR</span> <span class="o">=</span> <span class="n">get_default_download_folder</span><span class="p">()</span>

<div class="viewcode-block" id="get_default_cache_dir">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.libgen.get_default_cache_dir">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_default_cache_dir</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the default cache directory for the current OS.</span>
<span class="sd">    Creates the folder if it does not exist.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">)</span>
    <span class="n">system</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">system</span> <span class="o">==</span> <span class="s2">&quot;Windows&quot;</span><span class="p">:</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">home</span><span class="p">,</span> <span class="s2">&quot;AppData&quot;</span><span class="p">,</span> <span class="s2">&quot;Local&quot;</span><span class="p">,</span> <span class="s2">&quot;getscipapers&quot;</span><span class="p">,</span> <span class="s2">&quot;libgen&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">system</span> <span class="o">==</span> <span class="s2">&quot;Darwin&quot;</span><span class="p">:</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">home</span><span class="p">,</span> <span class="s2">&quot;Library&quot;</span><span class="p">,</span> <span class="s2">&quot;Caches&quot;</span><span class="p">,</span> <span class="s2">&quot;getscipapers&quot;</span><span class="p">,</span> <span class="s2">&quot;libgen&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Assume Linux/Unix</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">home</span><span class="p">,</span> <span class="s2">&quot;.config&quot;</span><span class="p">,</span> <span class="s2">&quot;getscipapers&quot;</span><span class="p">,</span> <span class="s2">&quot;libgen&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">folder</span></div>


<span class="c1"># Global cache dir</span>
<span class="n">cache_dir</span> <span class="o">=</span> <span class="n">get_default_cache_dir</span><span class="p">()</span>

<span class="c1"># Global default Chrome user data dir inside cache dir</span>
<span class="n">DEFAULT_CHROME_USER_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="s2">&quot;chrome_user_data&quot;</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">DEFAULT_CHROME_USER_DIR</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="search_libgen_by_doi">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.libgen.search_libgen_by_doi">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">search_libgen_by_doi</span><span class="p">(</span><span class="n">doi</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Search for documents on LibGen using a DOI number via the JSON API,</span>
<span class="sd">    and fetch additional details from the edition page.</span>
<span class="sd">    If found, also search Crossref to update missing or incorrect information if possible.</span>

<span class="sd">    Args:</span>
<span class="sd">        doi (str): The DOI number to search for.</span>
<span class="sd">        limit (int): Maximum number of results to return.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Matching documents with extra details, or empty dict if none found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://</span><span class="si">{</span><span class="n">LIBGEN_DOMAIN</span><span class="si">}</span><span class="s2">/json.php&quot;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;object&quot;</span><span class="p">:</span> <span class="s2">&quot;e&quot;</span><span class="p">,</span>
        <span class="s2">&quot;doi&quot;</span><span class="p">:</span> <span class="n">doi</span><span class="p">,</span>
        <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span>
        <span class="s2">&quot;addkeys&quot;</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span>
        <span class="s2">&quot;limit1&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;limit2&quot;</span><span class="p">:</span> <span class="n">limit</span>
    <span class="p">}</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="c1"># Try to get Crossref metadata if LibGen found something</span>
    <span class="n">crossref_info</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">crossref_fields</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;author&quot;</span><span class="p">,</span> <span class="s2">&quot;authors&quot;</span><span class="p">,</span> <span class="s2">&quot;publisher&quot;</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;language&quot;</span><span class="p">,</span> <span class="s2">&quot;pages&quot;</span><span class="p">,</span> <span class="s2">&quot;isbn&quot;</span><span class="p">,</span> <span class="s2">&quot;isbn13&quot;</span>
    <span class="p">]</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fetch_crossref</span><span class="p">(</span><span class="n">doi</span><span class="p">):</span>
        <span class="n">api_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://api.crossref.org/works/</span><span class="si">{</span><span class="n">quote_plus</span><span class="p">(</span><span class="n">doi</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                <span class="k">if</span> <span class="s2">&quot;message&quot;</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span>
                    <span class="n">info</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="c1"># Title</span>
                    <span class="k">if</span> <span class="s2">&quot;title&quot;</span> <span class="ow">in</span> <span class="n">msg</span> <span class="ow">and</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]:</span>
                        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="c1"># Authors</span>
                    <span class="k">if</span> <span class="s2">&quot;author&quot;</span> <span class="ow">in</span> <span class="n">msg</span> <span class="ow">and</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;author&quot;</span><span class="p">]:</span>
                        <span class="n">authors</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;author&quot;</span><span class="p">]:</span>
                            <span class="n">name</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">if</span> <span class="s2">&quot;given&quot;</span> <span class="ow">in</span> <span class="n">a</span><span class="p">:</span>
                                <span class="n">name</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s2">&quot;given&quot;</span><span class="p">])</span>
                            <span class="k">if</span> <span class="s2">&quot;family&quot;</span> <span class="ow">in</span> <span class="n">a</span><span class="p">:</span>
                                <span class="n">name</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s2">&quot;family&quot;</span><span class="p">])</span>
                            <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
                                <span class="n">authors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
                        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;authors&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">authors</span><span class="p">)</span>
                    <span class="c1"># Publisher</span>
                    <span class="k">if</span> <span class="s2">&quot;publisher&quot;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
                        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;publisher&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;publisher&quot;</span><span class="p">]</span>
                    <span class="c1"># Year</span>
                    <span class="k">if</span> <span class="s2">&quot;issued&quot;</span> <span class="ow">in</span> <span class="n">msg</span> <span class="ow">and</span> <span class="s2">&quot;date-parts&quot;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;issued&quot;</span><span class="p">]:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;issued&quot;</span><span class="p">][</span><span class="s2">&quot;date-parts&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                    <span class="c1"># Language</span>
                    <span class="k">if</span> <span class="s2">&quot;language&quot;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
                        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;language&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;language&quot;</span><span class="p">]</span>
                    <span class="c1"># Pages</span>
                    <span class="k">if</span> <span class="s2">&quot;page&quot;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
                        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;pages&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;page&quot;</span><span class="p">]</span>
                    <span class="c1"># ISBN</span>
                    <span class="k">if</span> <span class="s2">&quot;ISBN&quot;</span> <span class="ow">in</span> <span class="n">msg</span> <span class="ow">and</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;ISBN&quot;</span><span class="p">]:</span>
                        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;isbn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;ISBN&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;ISBN&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;isbn13&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;ISBN&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">return</span> <span class="n">info</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="c1"># For each LibGen ID, fetch more info from edition.php</span>
    <span class="k">for</span> <span class="n">libgen_id</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">edition_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://</span><span class="si">{</span><span class="n">LIBGEN_DOMAIN</span><span class="si">}</span><span class="s2">/edition.php?id=</span><span class="si">{</span><span class="n">libgen_id</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">edition_url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s2">&quot;html.parser&quot;</span><span class="p">)</span>
                <span class="n">extra</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="c1"># Parse &lt;div class=&quot;col-xl-7 order-xl-2 col-12 order-2 float-left&quot;&gt;</span>
                <span class="n">info_div</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="s2">&quot;col-xl-7 order-xl-2 col-12 order-2 float-left&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">info_div</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">info_div</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">):</span>
                        <span class="n">strong</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;strong&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">strong</span><span class="p">:</span>
                            <span class="n">key</span> <span class="o">=</span> <span class="n">strong</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
                            <span class="c1"># Remove &lt;strong&gt; from p to get value</span>
                            <span class="n">strong</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="c1"># Special handling for DOI (may be in &lt;a&gt;)</span>
                            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;doi&quot;</span><span class="p">:</span>
                                <span class="n">a</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">a</span><span class="p">:</span>
                                    <span class="n">value</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                                    <span class="n">extra</span><span class="p">[</span><span class="s2">&quot;doi_url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">)</span>
                            <span class="n">extra</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="c1"># Try to get &lt;span class=&quot;badge badge-primary&quot;&gt; for type</span>
                    <span class="n">badge</span> <span class="o">=</span> <span class="n">info_div</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;span&quot;</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="s2">&quot;badge badge-primary&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">badge</span><span class="p">:</span>
                        <span class="n">extra</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">badge</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1"># Parse &lt;div class=&quot;col-12 order-7 float-left&quot;&gt; for files</span>
                <span class="n">files_div</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="s2">&quot;col-12 order-7 float-left&quot;</span><span class="p">)</span>
                <span class="n">files</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">files_div</span><span class="p">:</span>
                    <span class="n">table</span> <span class="o">=</span> <span class="n">files_div</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;table&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;tablelibgen&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">table</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&quot;tr&quot;</span><span class="p">):</span>
                            <span class="n">tds</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&quot;td&quot;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tds</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                                <span class="n">file_info</span> <span class="o">=</span> <span class="p">{}</span>
                                <span class="c1"># Parse size and extension</span>
                                <span class="n">size_ext_html</span> <span class="o">=</span> <span class="n">tds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">decode_contents</span><span class="p">()</span>
                                <span class="c1"># Size</span>
                                <span class="n">size_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&lt;strong&gt;Size:&lt;/strong&gt;\s*&lt;nobr&gt;([^&lt;]+)&lt;/nobr&gt;&quot;</span><span class="p">,</span> <span class="n">size_ext_html</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">size_match</span><span class="p">:</span>
                                    <span class="n">file_info</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">size_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                                <span class="c1"># Extension</span>
                                <span class="n">ext_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&lt;strong&gt;Extension:&lt;/strong&gt;\s*([a-zA-Z0-9]+)&quot;</span><span class="p">,</span> <span class="n">size_ext_html</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">ext_match</span><span class="p">:</span>
                                    <span class="n">file_info</span><span class="p">[</span><span class="s2">&quot;extension&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ext_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                                <span class="c1"># Download links and md5</span>
                                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">tds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">):</span>
                                    <span class="n">label</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                                    <span class="n">link</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="s2">&quot;md5=&quot;</span> <span class="ow">in</span> <span class="n">link</span><span class="p">:</span>
                                        <span class="n">md5</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;md5=([a-fA-F0-9]</span><span class="si">{32}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="n">md5</span><span class="p">:</span>
                                            <span class="n">file_info</span><span class="p">[</span><span class="s2">&quot;md5&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">md5</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                                    <span class="n">file_info</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;mirrors&quot;</span><span class="p">,</span> <span class="p">{})[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">link</span>
                                <span class="c1"># Add file_info to files dict (use md5 or index as key)</span>
                                <span class="n">key</span> <span class="o">=</span> <span class="n">file_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;md5&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">))</span>
                                <span class="n">files</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_info</span>
                <span class="k">if</span> <span class="n">files</span><span class="p">:</span>
                    <span class="n">extra</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">files</span>

                <span class="c1"># Add cover image if present</span>
                <span class="n">cover_img</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;img&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;cover&quot;</span><span class="p">})</span>
                <span class="k">if</span> <span class="n">cover_img</span> <span class="ow">and</span> <span class="n">cover_img</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="p">):</span>
                    <span class="n">extra</span><span class="p">[</span><span class="s2">&quot;coverurl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cover_img</span><span class="p">[</span><span class="s2">&quot;src&quot;</span><span class="p">]</span>

                <span class="c1"># Merge extra fields into entry</span>
                <span class="n">entry</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extra</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">continue</span>

    <span class="c1"># Fetch Crossref info once if LibGen found something</span>
    <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">crossref_info</span> <span class="o">=</span> <span class="n">fetch_crossref</span><span class="p">(</span><span class="n">doi</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">crossref_info</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">libgen_id</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># Only update missing or obviously incorrect fields</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">crossref_fields</span><span class="p">:</span>
                    <span class="n">crossref_val</span> <span class="o">=</span> <span class="n">crossref_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                    <span class="n">entry_val</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                    <span class="c1"># Update if missing or empty, or if title/author/publisher/pages looks suspiciously short</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">entry_val</span> <span class="ow">or</span> <span class="p">(</span>
                        <span class="n">field</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;authors&quot;</span><span class="p">,</span> <span class="s2">&quot;author&quot;</span><span class="p">,</span> <span class="s2">&quot;publisher&quot;</span><span class="p">,</span> <span class="s2">&quot;pages&quot;</span><span class="p">]</span>
                        <span class="ow">and</span> <span class="n">entry_val</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">entry_val</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">5</span>
                    <span class="p">):</span>
                        <span class="k">if</span> <span class="n">crossref_val</span><span class="p">:</span>
                            <span class="n">entry</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">crossref_val</span>
                <span class="c1"># Special: update &#39;author&#39; if &#39;authors&#39; is present</span>
                <span class="k">if</span> <span class="s2">&quot;authors&quot;</span> <span class="ow">in</span> <span class="n">entry</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;author&quot;</span><span class="p">):</span>
                    <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;author&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;authors&quot;</span><span class="p">]</span>
                <span class="c1"># Add journal field if available from Crossref</span>
                <span class="k">if</span> <span class="s2">&quot;journal&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">:</span>
                    <span class="n">journal_val</span> <span class="o">=</span> <span class="n">crossref_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;container-title&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">journal_val</span><span class="p">:</span>
                        <span class="c1"># Try to get from Crossref message if present</span>
                        <span class="n">journal_val</span> <span class="o">=</span> <span class="n">crossref_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;journal&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">journal_val</span> <span class="ow">and</span> <span class="s2">&quot;container-title&quot;</span> <span class="ow">in</span> <span class="n">crossref_info</span><span class="p">:</span>
                        <span class="n">journal_val</span> <span class="o">=</span> <span class="n">crossref_info</span><span class="p">[</span><span class="s2">&quot;container-title&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">journal_val</span> <span class="ow">and</span> <span class="s2">&quot;journal&quot;</span> <span class="ow">in</span> <span class="n">crossref_info</span><span class="p">:</span>
                        <span class="n">journal_val</span> <span class="o">=</span> <span class="n">crossref_info</span><span class="p">[</span><span class="s2">&quot;journal&quot;</span><span class="p">]</span>
                    <span class="c1"># If still not found, try to get from LibGen extra fields</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">journal_val</span><span class="p">:</span>
                        <span class="n">journal_val</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;journal&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">journal_val</span><span class="p">:</span>
                        <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;journal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">journal_val</span>

    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="print_libgen_doi_result">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.libgen.print_libgen_doi_result">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">print_libgen_doi_result</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pretty-print the result of a LibGen DOI search using icons.</span>
<span class="sd">    Only print fields that have non-empty values.</span>
<span class="sd">    Formats &#39;series&#39; to better display journal, volume, and issue if possible.</span>
<span class="sd">    If &#39;pages&#39; looks like an article number (i.e., only a single number, not a range), display as &#39;Article Number&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; No results found for the given DOI.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># If result is a dict with numeric keys (LibGen IDs), flatten to list of entries</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">v</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>  <span class="c1"># copy to avoid mutating original</span>
            <span class="n">v</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span>  <span class="c1"># set the LibGen ID explicitly</span>
            <span class="n">entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="n">result</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="p">[</span><span class="n">result</span><span class="p">]</span>

    <span class="n">field_map</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;  Title:&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]),</span>
        <span class="p">(</span><span class="s2">&quot;  ID:&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;libgen_id&quot;</span><span class="p">]),</span>
        <span class="p">(</span><span class="s2">&quot;  DOI:&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;doi&quot;</span><span class="p">,</span> <span class="s2">&quot;DOI&quot;</span><span class="p">]),</span>
        <span class="p">(</span><span class="s2">&quot; Authors:&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;author&quot;</span><span class="p">,</span> <span class="s2">&quot;authors&quot;</span><span class="p">]),</span>
        <span class="p">(</span><span class="s2">&quot; Publisher:&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;publisher&quot;</span><span class="p">]),</span>
        <span class="p">(</span><span class="s2">&quot; Year:&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]),</span>
        <span class="p">(</span><span class="s2">&quot; Language:&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;language&quot;</span><span class="p">]),</span>
        <span class="c1"># Pages/Article Number handled below</span>
        <span class="p">(</span><span class="s2">&quot; Size:&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;filesize&quot;</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">]),</span>
        <span class="p">(</span><span class="s2">&quot; Extension:&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;extension&quot;</span><span class="p">,</span> <span class="s2">&quot;filetype&quot;</span><span class="p">]),</span>
        <span class="c1"># Series/journal/volume/issue handled below</span>
        <span class="p">(</span><span class="s2">&quot;  Edition:&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;edition&quot;</span><span class="p">]),</span>
        <span class="p">(</span><span class="s2">&quot;  Identifier:&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;identifier&quot;</span><span class="p">]),</span>
        <span class="p">(</span><span class="s2">&quot;  ISBN:&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;isbn&quot;</span><span class="p">,</span> <span class="s2">&quot;isbn13&quot;</span><span class="p">]),</span>
        <span class="p">(</span><span class="s2">&quot;  ISSN:&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;issn&quot;</span><span class="p">]),</span>
        <span class="p">(</span><span class="s2">&quot;  UDC:&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;udc&quot;</span><span class="p">]),</span>
        <span class="p">(</span><span class="s2">&quot;  LBC:&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;lbc&quot;</span><span class="p">]),</span>
        <span class="p">(</span><span class="s2">&quot;  Library:&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;library&quot;</span><span class="p">]),</span>
        <span class="p">(</span><span class="s2">&quot;  City:&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;city&quot;</span><span class="p">]),</span>
        <span class="p">(</span><span class="s2">&quot;  Cover URL:&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;coverurl&quot;</span><span class="p">]),</span>
        <span class="p">(</span><span class="s2">&quot;  Type:&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]),</span>
    <span class="p">]</span>

    <span class="n">mirror_icons</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;GET&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Cloudflare&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;IPFS&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Cloud&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Main&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Z-Library&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Libgen&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Library&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;1&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;2&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;3&quot;</span><span class="p">:</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;4&quot;</span><span class="p">:</span> <span class="s2">&quot;4&quot;</span><span class="p">,</span>
        <span class="s2">&quot;5&quot;</span><span class="p">:</span> <span class="s2">&quot;5&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
        <span class="c1"># Special handling for journal/series/volume/issue</span>
        <span class="n">series</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;series&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">volume</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;volumeinfo&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;volume&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">issue</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;issue&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">journal</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;journal&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="c1"># Try to extract journal, volume, issue from &#39;series&#39; if present</span>
        <span class="c1"># Common patterns: &quot;Journal Name, Vol. 12, No. 3&quot;, &quot;Journal Name, Volume 12, Issue 3&quot;</span>
        <span class="k">if</span> <span class="n">series</span><span class="p">:</span>
            <span class="c1"># Try to split by comma and parse</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">series</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
            <span class="n">journal_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">vol</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">iss</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\b(vol\.?|volume)\b&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
                    <span class="n">vol</span> <span class="o">=</span> <span class="n">p</span>
                <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\b(no\.?|issue)\b&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
                    <span class="n">iss</span> <span class="o">=</span> <span class="n">p</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">journal_name</span><span class="p">:</span>
                    <span class="n">journal_name</span> <span class="o">=</span> <span class="n">p</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">journal</span> <span class="ow">and</span> <span class="n">journal_name</span><span class="p">:</span>
                <span class="n">journal</span> <span class="o">=</span> <span class="n">journal_name</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">volume</span> <span class="ow">and</span> <span class="n">vol</span><span class="p">:</span>
                <span class="n">volume</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;.*?(vol\.?|volume)\s*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">vol</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">issue</span> <span class="ow">and</span> <span class="n">iss</span><span class="p">:</span>
                <span class="n">issue</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;.*?(no\.?|issue)\s*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">iss</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>

        <span class="c1"># Print journal/series/volume/issue in a nice format</span>
        <span class="k">if</span> <span class="n">journal</span> <span class="ow">or</span> <span class="n">volume</span> <span class="ow">or</span> <span class="n">issue</span><span class="p">:</span>
            <span class="n">journal_line</span> <span class="o">=</span> <span class="s2">&quot;  Journal:&quot;</span>
            <span class="k">if</span> <span class="n">journal</span><span class="p">:</span>
                <span class="n">journal_line</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">journal</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">volume</span><span class="p">:</span>
                <span class="n">journal_line</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, Vol. </span><span class="si">{</span><span class="n">volume</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">issue</span><span class="p">:</span>
                <span class="n">journal_line</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, Issue </span><span class="si">{</span><span class="n">issue</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">journal_line</span><span class="p">)</span>

        <span class="c1"># Special handling for pages/article number</span>
        <span class="n">pages_val</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;pages&quot;</span><span class="p">,</span> <span class="s2">&quot;pagetotal&quot;</span><span class="p">]:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">[],</span> <span class="p">{}):</span>
                <span class="n">pages_val</span> <span class="o">=</span> <span class="n">v</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">pages_val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">[],</span> <span class="p">{}):</span>
            <span class="c1"># If pages is a single number (not a range), treat as Article Number</span>
            <span class="c1"># Accepts: only digits, or digits with possible whitespace, or e.g. &quot;e12345&quot;</span>
            <span class="c1"># If it does NOT contain &quot;--&quot; or &quot;-&quot; or &quot;&quot; or &quot;&quot; or &quot; to &quot;</span>
            <span class="n">pages_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pages_val</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(--|||-| to )&quot;</span><span class="p">,</span> <span class="n">pages_str</span><span class="p">)</span>
                <span class="ow">and</span> <span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">fullmatch</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[eE]?\d+&quot;</span><span class="p">,</span> <span class="n">pages_str</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pages_str</span><span class="o">.</span><span class="n">isdigit</span><span class="p">())</span>
            <span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39; Article Number:&#39;</span><span class="si">:</span><span class="s2">&lt;15</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">pages_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;  Pages:&#39;</span><span class="si">:</span><span class="s2">&lt;15</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">pages_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">keys</span> <span class="ow">in</span> <span class="n">field_map</span><span class="p">:</span>
            <span class="c1"># Skip &#39;series&#39;, &#39;volumeinfo&#39;, &#39;pages&#39;, &#39;pagetotal&#39; here, already handled</span>
            <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot; Series:&quot;</span><span class="p">,</span> <span class="s2">&quot;  Volume:&quot;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="s2">&quot;  Pages:&quot;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">[],</span> <span class="p">{}):</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">v</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">[],</span> <span class="p">{}):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="si">:</span><span class="s2">&lt;15</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Mirrors:&quot;</span><span class="p">)</span>
        <span class="c1"># Print download links if present in &#39;files&#39;</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;files&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">file_id</span><span class="p">,</span> <span class="n">file_info</span> <span class="ow">in</span> <span class="n">files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">ext</span> <span class="o">=</span> <span class="n">file_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;extension&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                <span class="n">size</span> <span class="o">=</span> <span class="n">file_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">md5</span> <span class="o">=</span> <span class="n">file_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;md5&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">mirrors</span> <span class="o">=</span> <span class="n">file_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mirrors&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">info_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;     [</span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">md5</span><span class="p">:</span>
                    <span class="n">info_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; | md5: </span><span class="si">{</span><span class="n">md5</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">info_str</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">mirrors</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">icon</span> <span class="o">=</span> <span class="n">mirror_icons</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">link</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        </span><span class="si">{</span><span class="n">icon</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">link</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mirrors</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mirrors&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="n">mirrors</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">mirrors</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">icon</span> <span class="o">=</span> <span class="n">mirror_icons</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">link</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">icon</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">link</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     None&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span></div>


<div class="viewcode-block" id="download_libgen_paper_by_doi">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.libgen.download_libgen_paper_by_doi">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">download_libgen_paper_by_doi</span><span class="p">(</span><span class="n">doi</span><span class="p">,</span> <span class="n">dest_folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">preferred_exts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">print_result</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download the first available file for a given DOI from LibGen.</span>

<span class="sd">    Args:</span>
<span class="sd">        doi (str): The DOI number to search and download.</span>
<span class="sd">        dest_folder (str): Folder to save the downloaded file. If None, uses default.</span>
<span class="sd">        preferred_exts (list): List of preferred file extensions (e.g., [&quot;pdf&quot;, &quot;epub&quot;]).</span>
<span class="sd">        verbose (bool): If True, print debug information.</span>
<span class="sd">        print_result (bool): If True, print download summary. If False, suppress output.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str or None: File path if download succeeded, None otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">dest_folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dest_folder</span> <span class="o">=</span> <span class="n">DEFAULT_DOWNLOAD_DIR</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">search_libgen_by_doi</span><span class="p">(</span><span class="n">doi</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No result found for DOI:&quot;</span><span class="p">,</span> <span class="n">doi</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">print_result</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Download Summary:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Failed downloads:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> (No result found)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Flatten result to first entry</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">result</span><span class="p">:</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unexpected result format.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">print_result</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Download Summary:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Failed downloads:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> (Unexpected result format)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">files</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;files&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No downloadable files found for DOI:&quot;</span><span class="p">,</span> <span class="n">doi</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">print_result</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Download Summary:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Failed downloads:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> (No downloadable files found)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Select file by preferred extension</span>
    <span class="n">file_info</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">preferred_exts</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">preferred_exts</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;extension&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">ext</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">file_info</span> <span class="o">=</span> <span class="n">f</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">file_info</span><span class="p">:</span>
                <span class="k">break</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">file_info</span><span class="p">:</span>
        <span class="c1"># Fallback: pick the first file</span>
        <span class="n">file_info</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">files</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

    <span class="n">mirrors</span> <span class="o">=</span> <span class="n">file_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mirrors&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="c1"># Try to pick a direct GET or Main mirror first, then others</span>
    <span class="n">mirror_order</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;Main&quot;</span><span class="p">]</span>
    <span class="n">tried_labels</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">urls_to_try</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">mirror_order</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">mirrors</span><span class="p">:</span>
            <span class="n">urls_to_try</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">label</span><span class="p">,</span> <span class="n">mirrors</span><span class="p">[</span><span class="n">label</span><span class="p">]))</span>
            <span class="n">tried_labels</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
    <span class="c1"># Add any other mirrors not already tried</span>
    <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">mirrors</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tried_labels</span><span class="p">:</span>
            <span class="n">urls_to_try</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">label</span><span class="p">,</span> <span class="n">url</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">urls_to_try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No download URL found for DOI:&quot;</span><span class="p">,</span> <span class="n">doi</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">print_result</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Download Summary:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Failed downloads:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> (No download URL found)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">filename</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;libgen_paper&quot;</span><span class="p">)</span>
    <span class="n">ext</span> <span class="o">=</span> <span class="n">file_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;extension&quot;</span><span class="p">,</span> <span class="s2">&quot;pdf&quot;</span><span class="p">)</span>
    <span class="n">safe_filename</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[</span><span class="se">\\</span><span class="s2">/*?</span><span class="se">\&quot;</span><span class="s2">&lt;&gt;|]&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="n">out_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">safe_filename</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">successes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">failures</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">download_url</span> <span class="ow">in</span> <span class="n">urls_to_try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trying mirror &#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">download_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving to: </span><span class="si">{</span><span class="n">out_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># If the URL is of the form /ads.php?md5=...&amp;downloadname=...</span>
            <span class="k">if</span> <span class="n">download_url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/ads.php?md5=&quot;</span><span class="p">):</span>
                <span class="n">ads_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://</span><span class="si">{</span><span class="n">LIBGEN_DOMAIN</span><span class="si">}{</span><span class="n">download_url</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Following ads.php URL: </span><span class="si">{</span><span class="n">ads_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">ads_resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ads_url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">DOWNLOAD_TIMEOUT</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ads_resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                    <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">ads_resp</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s2">&quot;html.parser&quot;</span><span class="p">)</span>
                    <span class="c1"># Find the first &lt;a&gt; tag whose href contains &quot;get.php?md5=&quot;</span>
                    <span class="n">get_link</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">soup</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                        <span class="n">href</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="s2">&quot;href&quot;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="s2">&quot;get.php?md5=&quot;</span> <span class="ow">in</span> <span class="n">href</span><span class="p">:</span>
                            <span class="c1"># Make absolute URL if needed</span>
                            <span class="k">if</span> <span class="n">href</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">):</span>
                                <span class="n">get_link</span> <span class="o">=</span> <span class="n">href</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">get_link</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://</span><span class="si">{</span><span class="n">LIBGEN_DOMAIN</span><span class="si">}</span><span class="s2">/&quot;</span> <span class="o">+</span> <span class="n">href</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
                            <span class="k">break</span>
                    <span class="k">if</span> <span class="n">get_link</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found get.php download link: </span><span class="si">{</span><span class="n">get_link</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">download_url</span> <span class="o">=</span> <span class="n">get_link</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No get.php download link found on ads.php page.&quot;</span><span class="p">)</span>
                        <span class="n">failures</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">label</span><span class="p">,</span> <span class="s2">&quot;No get.php link&quot;</span><span class="p">))</span>
                        <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to fetch ads.php page, status: </span><span class="si">{</span><span class="n">ads_resp</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">failures</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">label</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;ads.php status </span><span class="si">{</span><span class="n">ads_resp</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
                    <span class="k">continue</span>

            <span class="k">with</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">download_url</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">DOWNLOAD_TIMEOUT</span><span class="p">)</span> <span class="k">as</span> <span class="n">r</span><span class="p">:</span>
                <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">8192</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">chunk</span><span class="p">:</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Download completed from mirror &#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
            <span class="n">successes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">label</span><span class="p">,</span> <span class="n">out_path</span><span class="p">))</span>
            <span class="k">break</span>  <span class="c1"># Stop after first successful download</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Download failed from mirror &#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">failures</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">label</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
            <span class="c1"># Try next mirror</span>

    <span class="k">if</span> <span class="n">print_result</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Download Summary:&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">successes</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Successful downloads:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">successes</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Mirror &#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No successful downloads.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">failures</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Failed downloads:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">reason</span> <span class="ow">in</span> <span class="n">failures</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Mirror &#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No failed downloads.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">successes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">successes</span> <span class="k">else</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="search_libgen_by_query">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.libgen.search_libgen_by_query">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">search_libgen_by_query</span><span class="p">(</span>
    <span class="n">query</span><span class="p">,</span>
    <span class="n">limit</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">object_type</span><span class="o">=</span><span class="s2">&quot;f&quot;</span><span class="p">,</span>
    <span class="n">curtab</span><span class="o">=</span><span class="s2">&quot;f&quot;</span><span class="p">,</span>
    <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">sort_by_year</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">order_desc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Search for documents on LibGen using a query string by parsing the HTML results.</span>
<span class="sd">    If a DOI is found, also search Crossref to update missing or incorrect information if possible.</span>

<span class="sd">    Args:</span>
<span class="sd">        query (str): The search query.</span>
<span class="sd">        limit (int): Maximum number of results to return.</span>
<span class="sd">        object_type (str): The object type parameter for LibGen (default &quot;f&quot;).</span>
<span class="sd">        curtab (str): The curtab parameter for LibGen (default &quot;f&quot;).</span>
<span class="sd">        verbose (bool): If True, print debug information.</span>
<span class="sd">        sort_by_year (bool): If True, sort results by year.</span>
<span class="sd">        order_desc (bool): If True, sort descending (newest first).</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: List of matching documents (dicts), or empty list if none found.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">seen_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">page</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;https://</span><span class="si">{</span><span class="n">LIBGEN_DOMAIN</span><span class="si">}</span><span class="s2">/index.php?&amp;req=</span><span class="si">{</span><span class="n">quote_plus</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;&amp;object=</span><span class="si">{</span><span class="n">object_type</span><span class="si">}</span><span class="s2">&amp;curtab=</span><span class="si">{</span><span class="n">curtab</span><span class="si">}</span><span class="s2">&amp;page=</span><span class="si">{</span><span class="n">page</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">sort_by_year</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&amp;order=year&amp;ordermode=</span><span class="si">{</span><span class="s1">&#39;desc&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">order_desc</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;asc&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Fetching URL: </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Failed to fetch page </span><span class="si">{</span><span class="n">page</span><span class="si">}</span><span class="s2">, status code: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">break</span>

        <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s2">&quot;html.parser&quot;</span><span class="p">)</span>
        <span class="n">table</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">soup</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&quot;table&quot;</span><span class="p">):</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;tr&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">header</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&quot;th&quot;</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">:</span>
                <span class="n">table</span> <span class="o">=</span> <span class="n">t</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">table</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] No suitable table found on page </span><span class="si">{</span><span class="n">page</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">break</span>

        <span class="n">rows</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&quot;tr&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>  <span class="c1"># skip header row</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows in table on page </span><span class="si">{</span><span class="n">page</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">found_new</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rows</span><span class="p">):</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&quot;td&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Row </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2"> skipped, not enough columns (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">title_col</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># --- Custom title extraction logic ---</span>
            <span class="n">a_tags</span> <span class="o">=</span> <span class="n">title_col</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">doi</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">libgen_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">found_title</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">a_tags</span><span class="p">):</span>
                <span class="n">next_sibling</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">next_sibling</span>
                <span class="k">while</span> <span class="n">next_sibling</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">next_sibling</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">next_sibling</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;&lt;i&gt;&lt;/i&gt;&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">next_sibling</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;&lt;i&gt;&lt;/i&gt;&quot;</span><span class="p">:</span>
                        <span class="n">title</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">found_title</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
                    <span class="n">next_sibling</span> <span class="o">=</span> <span class="n">next_sibling</span><span class="o">.</span><span class="n">next_sibling</span>
                <span class="k">if</span> <span class="n">found_title</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">found_title</span><span class="p">:</span>
                <span class="n">brs</span> <span class="o">=</span> <span class="n">title_col</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&quot;br&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">brs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">after_b</span> <span class="o">=</span> <span class="n">brs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">find_next</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">after_b</span><span class="p">:</span>
                        <span class="n">title</span> <span class="o">=</span> <span class="n">after_b</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># DOI extraction from &lt;i&gt;&lt;font color=&quot;green&quot;&gt;DOI: ...&lt;/font&gt;&lt;/a&gt;&lt;/i&gt;</span>
            <span class="n">doi</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">i_tag</span> <span class="ow">in</span> <span class="n">title_col</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&quot;i&quot;</span><span class="p">):</span>
                <span class="n">font_tag</span> <span class="o">=</span> <span class="n">i_tag</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;font&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">font_tag</span> <span class="ow">and</span> <span class="s2">&quot;DOI:&quot;</span> <span class="ow">in</span> <span class="n">font_tag</span><span class="o">.</span><span class="n">get_text</span><span class="p">():</span>
                    <span class="n">doi_text</span> <span class="o">=</span> <span class="n">font_tag</span><span class="o">.</span><span class="n">get_text</span><span class="p">()</span>
                    <span class="n">doi</span> <span class="o">=</span> <span class="n">doi_text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;DOI:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">break</span>
            <span class="c1"># libgen_id extraction</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">a_tags</span><span class="p">:</span>
                <span class="n">href</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;edition.php?id=&quot;</span> <span class="ow">in</span> <span class="n">href</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">libgen_id</span><span class="p">:</span>
                        <span class="n">libgen_id</span> <span class="o">=</span> <span class="n">href</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;id=&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">authors</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">publisher</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">year</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">language</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">pages</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">extension</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">mirrors_col</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
            <span class="n">mirrors</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">mirrors_col</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">):</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">link</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">mirrors</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">link</span>

            <span class="n">unique_key</span> <span class="o">=</span> <span class="n">libgen_id</span> <span class="ow">or</span> <span class="p">(</span><span class="n">title</span> <span class="o">+</span> <span class="s2">&quot;|&quot;</span> <span class="o">+</span> <span class="n">authors</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">unique_key</span> <span class="ow">in</span> <span class="n">seen_ids</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Duplicate entry skipped: </span><span class="si">{</span><span class="n">unique_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">seen_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">unique_key</span><span class="p">)</span>
            <span class="n">found_new</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">entry</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">libgen_id</span><span class="p">,</span>
                <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
                <span class="s2">&quot;doi&quot;</span><span class="p">:</span> <span class="n">doi</span><span class="p">,</span>
                <span class="s2">&quot;authors&quot;</span><span class="p">:</span> <span class="n">authors</span><span class="p">,</span>
                <span class="s2">&quot;publisher&quot;</span><span class="p">:</span> <span class="n">publisher</span><span class="p">,</span>
                <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="n">year</span><span class="p">,</span>
                <span class="s2">&quot;language&quot;</span><span class="p">:</span> <span class="n">language</span><span class="p">,</span>
                <span class="s2">&quot;pages&quot;</span><span class="p">:</span> <span class="n">pages</span><span class="p">,</span>
                <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">size</span><span class="p">,</span>
                <span class="s2">&quot;extension&quot;</span><span class="p">:</span> <span class="n">extension</span><span class="p">,</span>
                <span class="s2">&quot;mirrors&quot;</span><span class="p">:</span> <span class="n">mirrors</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Added entry: </span><span class="si">{</span><span class="n">entry</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">limit</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">found_new</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] No new results found on page </span><span class="si">{</span><span class="n">page</span><span class="si">}</span><span class="s2">, stopping.&quot;</span><span class="p">)</span>
            <span class="k">break</span>  <span class="c1"># No more new results/pages</span>
        <span class="n">page</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">sort_by_year</span><span class="p">:</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">year_key</span><span class="p">(</span><span class="n">entry</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">0</span>
        <span class="n">results</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">year_key</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="n">order_desc</span><span class="p">)</span>

    <span class="c1"># --- Crossref enrichment for entries with DOI ---</span>
    <span class="n">crossref_fields</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;author&quot;</span><span class="p">,</span> <span class="s2">&quot;authors&quot;</span><span class="p">,</span> <span class="s2">&quot;publisher&quot;</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;language&quot;</span><span class="p">,</span> <span class="s2">&quot;pages&quot;</span><span class="p">,</span> <span class="s2">&quot;isbn&quot;</span><span class="p">,</span> <span class="s2">&quot;isbn13&quot;</span>
    <span class="p">]</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fetch_crossref</span><span class="p">(</span><span class="n">doi</span><span class="p">):</span>
        <span class="n">api_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://api.crossref.org/works/</span><span class="si">{</span><span class="n">quote_plus</span><span class="p">(</span><span class="n">doi</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                <span class="k">if</span> <span class="s2">&quot;message&quot;</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span>
                    <span class="n">info</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="c1"># Title</span>
                    <span class="k">if</span> <span class="s2">&quot;title&quot;</span> <span class="ow">in</span> <span class="n">msg</span> <span class="ow">and</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]:</span>
                        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="c1"># Authors</span>
                    <span class="k">if</span> <span class="s2">&quot;author&quot;</span> <span class="ow">in</span> <span class="n">msg</span> <span class="ow">and</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;author&quot;</span><span class="p">]:</span>
                        <span class="n">authors</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;author&quot;</span><span class="p">]:</span>
                            <span class="n">name</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">if</span> <span class="s2">&quot;given&quot;</span> <span class="ow">in</span> <span class="n">a</span><span class="p">:</span>
                                <span class="n">name</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s2">&quot;given&quot;</span><span class="p">])</span>
                            <span class="k">if</span> <span class="s2">&quot;family&quot;</span> <span class="ow">in</span> <span class="n">a</span><span class="p">:</span>
                                <span class="n">name</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="s2">&quot;family&quot;</span><span class="p">])</span>
                            <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
                                <span class="n">authors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
                        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;authors&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">authors</span><span class="p">)</span>
                    <span class="c1"># Publisher</span>
                    <span class="k">if</span> <span class="s2">&quot;publisher&quot;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
                        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;publisher&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;publisher&quot;</span><span class="p">]</span>
                    <span class="c1"># Year</span>
                    <span class="k">if</span> <span class="s2">&quot;issued&quot;</span> <span class="ow">in</span> <span class="n">msg</span> <span class="ow">and</span> <span class="s2">&quot;date-parts&quot;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;issued&quot;</span><span class="p">]:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;issued&quot;</span><span class="p">][</span><span class="s2">&quot;date-parts&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                    <span class="c1"># Language</span>
                    <span class="k">if</span> <span class="s2">&quot;language&quot;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
                        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;language&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;language&quot;</span><span class="p">]</span>
                    <span class="c1"># Pages</span>
                    <span class="k">if</span> <span class="s2">&quot;page&quot;</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
                        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;pages&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;page&quot;</span><span class="p">]</span>
                    <span class="c1"># ISBN</span>
                    <span class="k">if</span> <span class="s2">&quot;ISBN&quot;</span> <span class="ow">in</span> <span class="n">msg</span> <span class="ow">and</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;ISBN&quot;</span><span class="p">]:</span>
                        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;isbn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;ISBN&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s2">&quot;ISBN&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;isbn13&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;ISBN&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="c1"># Journal</span>
                    <span class="k">if</span> <span class="s2">&quot;container-title&quot;</span> <span class="ow">in</span> <span class="n">msg</span> <span class="ow">and</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;container-title&quot;</span><span class="p">]:</span>
                        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;journal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span><span class="p">[</span><span class="s2">&quot;container-title&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">return</span> <span class="n">info</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="n">doi</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;doi&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">doi</span><span class="p">:</span>
            <span class="n">crossref_info</span> <span class="o">=</span> <span class="n">fetch_crossref</span><span class="p">(</span><span class="n">doi</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">crossref_info</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">crossref_fields</span><span class="p">:</span>
                    <span class="n">crossref_val</span> <span class="o">=</span> <span class="n">crossref_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                    <span class="n">entry_val</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                    <span class="c1"># Update if missing or empty, or if title/author/publisher/pages looks suspiciously short</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">entry_val</span> <span class="ow">or</span> <span class="p">(</span>
                        <span class="n">field</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;authors&quot;</span><span class="p">,</span> <span class="s2">&quot;author&quot;</span><span class="p">,</span> <span class="s2">&quot;publisher&quot;</span><span class="p">,</span> <span class="s2">&quot;pages&quot;</span><span class="p">]</span>
                        <span class="ow">and</span> <span class="n">entry_val</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">entry_val</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">5</span>
                    <span class="p">):</span>
                        <span class="k">if</span> <span class="n">crossref_val</span><span class="p">:</span>
                            <span class="n">entry</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">crossref_val</span>
                <span class="c1"># Special: update &#39;author&#39; if &#39;authors&#39; is present</span>
                <span class="k">if</span> <span class="s2">&quot;authors&quot;</span> <span class="ow">in</span> <span class="n">entry</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;author&quot;</span><span class="p">):</span>
                    <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;author&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;authors&quot;</span><span class="p">]</span>
                <span class="c1"># Add journal field if available from Crossref</span>
                <span class="k">if</span> <span class="s2">&quot;journal&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">:</span>
                    <span class="n">journal_val</span> <span class="o">=</span> <span class="n">crossref_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;journal&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">journal_val</span> <span class="ow">and</span> <span class="s2">&quot;container-title&quot;</span> <span class="ow">in</span> <span class="n">crossref_info</span><span class="p">:</span>
                        <span class="n">journal_val</span> <span class="o">=</span> <span class="n">crossref_info</span><span class="p">[</span><span class="s2">&quot;container-title&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">journal_val</span> <span class="ow">and</span> <span class="s2">&quot;journal&quot;</span> <span class="ow">in</span> <span class="n">crossref_info</span><span class="p">:</span>
                        <span class="n">journal_val</span> <span class="o">=</span> <span class="n">crossref_info</span><span class="p">[</span><span class="s2">&quot;journal&quot;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">journal_val</span><span class="p">:</span>
                        <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;journal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">journal_val</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[DEBUG] Returning </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">[:</span><span class="n">limit</span><span class="p">])</span><span class="si">}</span><span class="s2"> results&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">results</span><span class="p">[:</span><span class="n">limit</span><span class="p">]</span></div>


<div class="viewcode-block" id="print_libgen_query_results">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.libgen.print_libgen_query_results">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">print_libgen_query_results</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pretty-print the results of a LibGen query search using icons and numbering.</span>
<span class="sd">    Handles &#39;series&#39; text for journal/volume/issue, and prints &#39;pages&#39; as article number if appropriate.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">results</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; No results found for the given query.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
        <span class="c1"># Handle journal/series/volume/issue from &#39;series&#39; field</span>
        <span class="n">series</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;series&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">volume</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;volumeinfo&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;volume&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">issue</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;issue&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">journal</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;journal&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="c1"># Try to extract journal, volume, issue from &#39;series&#39; if present</span>
        <span class="k">if</span> <span class="n">series</span><span class="p">:</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">series</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
            <span class="n">journal_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">vol</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">iss</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\b(vol\.?|volume)\b&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
                    <span class="n">vol</span> <span class="o">=</span> <span class="n">p</span>
                <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\b(no\.?|issue)\b&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
                    <span class="n">iss</span> <span class="o">=</span> <span class="n">p</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">journal_name</span><span class="p">:</span>
                    <span class="n">journal_name</span> <span class="o">=</span> <span class="n">p</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">journal</span> <span class="ow">and</span> <span class="n">journal_name</span><span class="p">:</span>
                <span class="n">journal</span> <span class="o">=</span> <span class="n">journal_name</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">volume</span> <span class="ow">and</span> <span class="n">vol</span><span class="p">:</span>
                <span class="n">volume</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;.*?(vol\.?|volume)\s*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">vol</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">issue</span> <span class="ow">and</span> <span class="n">iss</span><span class="p">:</span>
                <span class="n">issue</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;.*?(no\.?|issue)\s*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">iss</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;#</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">  Title:      </span><span class="si">{</span><span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">journal</span> <span class="ow">or</span> <span class="n">volume</span> <span class="ow">or</span> <span class="n">issue</span><span class="p">:</span>
            <span class="n">journal_line</span> <span class="o">=</span> <span class="s2">&quot;    Journal:&quot;</span>
            <span class="k">if</span> <span class="n">journal</span><span class="p">:</span>
                <span class="n">journal_line</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">journal</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">volume</span><span class="p">:</span>
                <span class="n">journal_line</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, Vol. </span><span class="si">{</span><span class="n">volume</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">issue</span><span class="p">:</span>
                <span class="n">journal_line</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, Issue </span><span class="si">{</span><span class="n">issue</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">journal_line</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    ID:         &quot;</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    DOI:        &quot;</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;doi&quot;</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    Authors:   &quot;</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;authors&quot;</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    Publisher:   &quot;</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;publisher&quot;</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    Year:       &quot;</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    Language:   &quot;</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;language&quot;</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">))</span>

        <span class="c1"># Handle pages/article number</span>
        <span class="n">pages_val</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;pages&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pages_val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">[],</span> <span class="p">{}):</span>
            <span class="n">pages_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pages_val</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(--|||-| to )&quot;</span><span class="p">,</span> <span class="n">pages_str</span><span class="p">)</span>
                <span class="ow">and</span> <span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">fullmatch</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[eE]?\d+&quot;</span><span class="p">,</span> <span class="n">pages_str</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pages_str</span><span class="o">.</span><span class="n">isdigit</span><span class="p">())</span>
            <span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Article Number: </span><span class="si">{</span><span class="n">pages_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Pages:      </span><span class="si">{</span><span class="n">pages_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    Pages:      N/A&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    Size:       &quot;</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    Extension:  &quot;</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;extension&quot;</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    Mirrors:&quot;</span><span class="p">)</span>
        <span class="n">mirrors</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mirrors&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="n">mirrors</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">mirrors</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;       </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">link</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;       None&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span></div>


<div class="viewcode-block" id="interactive_libgen_download">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.libgen.interactive_libgen_download">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">interactive_libgen_download</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">preferred_exts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dest_folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Search LibGen for a query, print results, and interactively ask user which to download.</span>
<span class="sd">    User can select a single index or a range (e.g., 2-4).</span>
<span class="sd">    Tries all available mirrors for each selected result until download succeeds or all fail.</span>
<span class="sd">    At the end, prints a summary of successful and failed downloads.</span>
<span class="sd">    If verbose is False, only the summary is printed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dest_folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dest_folder</span> <span class="o">=</span> <span class="n">DEFAULT_DOWNLOAD_DIR</span>

    <span class="n">results</span> <span class="o">=</span> <span class="n">search_libgen_by_query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">results</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; No results found for the given query.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">print_libgen_query_results</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Enter the number(s) of the result(s) to download (e.g., 1 or 2-4): &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">selection</span> <span class="o">=</span> <span class="nb">input</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">selection</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No selection made. Exiting.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">indices</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="s2">&quot;-&quot;</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">selection</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">))</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid range input.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">selection</span><span class="p">)]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid input.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">resolve_libgen_download_url</span><span class="p">(</span><span class="n">download_url</span><span class="p">):</span>
        <span class="c1"># Handles /ads.php?md5=... and returns the final get.php?md5=... link</span>
        <span class="k">if</span> <span class="n">download_url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/ads.php?md5=&quot;</span><span class="p">):</span>
            <span class="n">ads_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://</span><span class="si">{</span><span class="n">LIBGEN_DOMAIN</span><span class="si">}{</span><span class="n">download_url</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ads_resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ads_url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">DOWNLOAD_TIMEOUT</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ads_resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                    <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">ads_resp</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s2">&quot;html.parser&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">soup</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                        <span class="n">href</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="s2">&quot;href&quot;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="s2">&quot;get.php?md5=&quot;</span> <span class="ow">in</span> <span class="n">href</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">href</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">):</span>
                                <span class="k">return</span> <span class="n">href</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;https://</span><span class="si">{</span><span class="n">LIBGEN_DOMAIN</span><span class="si">}</span><span class="s2">/&quot;</span> <span class="o">+</span> <span class="n">href</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">download_url</span>

    <span class="n">successes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">failures</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
        <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">idx</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">mirrors</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mirrors&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">mirrors</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Result #</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2"> has no download mirrors, skipping.&quot;</span><span class="p">)</span>
                <span class="n">failures</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">idx</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">),</span> <span class="s2">&quot;No mirrors&quot;</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="c1"># Try to select preferred extension if specified</span>
            <span class="n">ext_ok</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">preferred_exts</span><span class="p">:</span>
                <span class="n">ext</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;extension&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">ext_ok</span> <span class="o">=</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">preferred_exts</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ext_ok</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Result #</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2"> extension &#39;</span><span class="si">{</span><span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;extension&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39; not in preferred_exts, skipping.&quot;</span><span class="p">)</span>
                <span class="n">failures</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">idx</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">),</span> <span class="s2">&quot;Extension not preferred&quot;</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="c1"># Try all mirrors one by one</span>
            <span class="n">mirror_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;Main&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">label</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">mirrors</span> <span class="k">if</span> <span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;Main&quot;</span><span class="p">)]</span>
            <span class="n">download_success</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">mirror_labels</span><span class="p">:</span>
                <span class="n">download_url</span> <span class="o">=</span> <span class="n">mirrors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">download_url</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">resolved_url</span> <span class="o">=</span> <span class="n">resolve_libgen_download_url</span><span class="p">(</span><span class="n">download_url</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">resolved_url</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mirror &#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&#39;: could not resolve download URL, trying next mirror.&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="n">filename</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;libgen_paper&quot;</span><span class="p">)</span>
                <span class="n">ext</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;extension&quot;</span><span class="p">,</span> <span class="s2">&quot;pdf&quot;</span><span class="p">)</span>
                <span class="n">safe_filename</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[</span><span class="se">\\</span><span class="s2">/*?</span><span class="se">\&quot;</span><span class="s2">&lt;&gt;|]&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                <span class="n">out_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">safe_filename</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloading result #</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;From: </span><span class="si">{</span><span class="n">resolved_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving to: </span><span class="si">{</span><span class="n">out_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">resolved_url</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">DOWNLOAD_TIMEOUT</span><span class="p">)</span> <span class="k">as</span> <span class="n">r</span><span class="p">:</span>
                        <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="mi">8192</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">chunk</span><span class="p">:</span>
                                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Downloaded to: </span><span class="si">{</span><span class="n">out_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">successes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">idx</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">),</span> <span class="n">out_path</span><span class="p">))</span>
                    <span class="n">download_success</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>  <span class="c1"># Stop after first successful download</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Failed to download from mirror &#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">download_success</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; All mirrors failed for result #</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="n">failures</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">idx</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">),</span> <span class="s2">&quot;All mirrors failed&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Index </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2"> is out of range.&quot;</span><span class="p">)</span>
            <span class="n">failures</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">,</span> <span class="s2">&quot;Index out of range&quot;</span><span class="p">))</span>

    <span class="c1"># Print summary</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Download Summary:&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">successes</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Successful downloads:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">successes</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   #</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No successful downloads.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">failures</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Failed downloads:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">reason</span> <span class="ow">in</span> <span class="n">failures</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   #</span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No failed downloads.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="fetch_libgen_edition_info">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.libgen.fetch_libgen_edition_info">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">fetch_libgen_edition_info</span><span class="p">(</span><span class="n">libgen_id</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fetch extra info from edition.php for a given LibGen ID.</span>

<span class="sd">    Args:</span>
<span class="sd">        libgen_id (str): The LibGen edition ID.</span>
<span class="sd">        verbose (bool): If True, print debug info.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Extracted info dictionary, or empty dict if not found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">edition_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://</span><span class="si">{</span><span class="n">LIBGEN_DOMAIN</span><span class="si">}</span><span class="s2">/edition.php?id=</span><span class="si">{</span><span class="n">libgen_id</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">info</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">edition_url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s2">&quot;html.parser&quot;</span><span class="p">)</span>
            <span class="c1"># Fetch cover and links from left column</span>
            <span class="n">left_div</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="s2">&quot;col-xl-2 order-xl-1 col-12 order-1 d-flex tall float-left&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">left_div</span><span class="p">:</span>
                <span class="n">a_tag</span> <span class="o">=</span> <span class="n">left_div</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">img_tag</span> <span class="o">=</span> <span class="n">left_div</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;img&quot;</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="s2">&quot;img-fluid&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">a_tag</span> <span class="ow">and</span> <span class="n">img_tag</span><span class="p">:</span>
                    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;coverurl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">img_tag</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;src&quot;</span><span class="p">)</span>
                    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;cover_download_link&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">a_tag</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">)</span>
            <span class="c1"># Fetch main info from center column</span>
            <span class="n">info_div</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="s2">&quot;col-xl-7 order-xl-2 col-12 order-2 float-left&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">info_div</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">info_div</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">):</span>
                    <span class="n">strong</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;strong&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">strong</span><span class="p">:</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="n">strong</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
                        <span class="n">strong</span><span class="o">.</span><span class="n">extract</span><span class="p">()</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="c1"># Special handling for DOI (may be in &lt;a&gt;)</span>
                        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;doi&quot;</span><span class="p">:</span>
                            <span class="n">a</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">a</span><span class="p">:</span>
                                <span class="n">value</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                                <span class="n">info</span><span class="p">[</span><span class="s2">&quot;doi_url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">)</span>
                        <span class="n">info</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">badge</span> <span class="o">=</span> <span class="n">info_div</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;span&quot;</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="s2">&quot;badge badge-primary&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">badge</span><span class="p">:</span>
                    <span class="n">info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">badge</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># Fetch files and download links from files table</span>
            <span class="n">files_div</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="s2">&quot;col-12 order-7 float-left&quot;</span><span class="p">)</span>
            <span class="n">files</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">files_div</span><span class="p">:</span>
                <span class="n">table</span> <span class="o">=</span> <span class="n">files_div</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;table&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;tablelibgen&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">table</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&quot;tr&quot;</span><span class="p">):</span>
                        <span class="n">tds</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&quot;td&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tds</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">file_info</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="c1"># Parse size and extension</span>
                            <span class="n">size_ext_html</span> <span class="o">=</span> <span class="n">tds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">decode_contents</span><span class="p">()</span>
                            <span class="n">size_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&lt;strong&gt;Size:&lt;/strong&gt;\s*&lt;nobr&gt;([^&lt;]+)&lt;/nobr&gt;&quot;</span><span class="p">,</span> <span class="n">size_ext_html</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">size_match</span><span class="p">:</span>
                                <span class="n">file_info</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">size_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="n">ext_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&lt;strong&gt;Extension:&lt;/strong&gt;\s*([a-zA-Z0-9]+)&quot;</span><span class="p">,</span> <span class="n">size_ext_html</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">ext_match</span><span class="p">:</span>
                                <span class="n">file_info</span><span class="p">[</span><span class="s2">&quot;extension&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ext_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="c1"># Parse pages if present</span>
                            <span class="n">pages_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&lt;strong&gt;Pages:&lt;/strong&gt;\s*([^\s&lt;]+)&quot;</span><span class="p">,</span> <span class="n">size_ext_html</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">pages_match</span><span class="p">:</span>
                                <span class="n">file_info</span><span class="p">[</span><span class="s2">&quot;pages&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pages_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="c1"># Download links and md5</span>
                            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">tds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">):</span>
                                <span class="n">label</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                                <span class="n">link</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="s2">&quot;md5=&quot;</span> <span class="ow">in</span> <span class="n">link</span><span class="p">:</span>
                                    <span class="n">md5</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;md5=([a-fA-F0-9]</span><span class="si">{32}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">md5</span><span class="p">:</span>
                                        <span class="n">file_info</span><span class="p">[</span><span class="s2">&quot;md5&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">md5</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                                <span class="n">file_info</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;mirrors&quot;</span><span class="p">,</span> <span class="p">{})[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">link</span>
                            <span class="c1"># Add file_info to files dict (use md5 or index as key)</span>
                            <span class="n">key</span> <span class="o">=</span> <span class="n">file_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;md5&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">))</span>
                            <span class="n">files</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_info</span>
            <span class="k">if</span> <span class="n">files</span><span class="p">:</span>
                <span class="n">info</span><span class="p">[</span><span class="s2">&quot;files&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">files</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Extra info from edition.php:&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">k</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not fetch edition info (HTTP </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error fetching edition info: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">info</span></div>


<span class="c1"># Calculate md5sum of the file</span>
<div class="viewcode-block" id="file_md5sum">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.libgen.file_md5sum">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">file_md5sum</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">hash_md5</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8192</span><span class="p">),</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
            <span class="n">hash_md5</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">hash_md5</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span></div>


<div class="viewcode-block" id="is_file_on_libgen">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.libgen.is_file_on_libgen">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">is_file_on_libgen</span><span class="p">(</span><span class="n">md5sum</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if a file with the given md5sum already exists in LibGen.</span>

<span class="sd">    Args:</span>
<span class="sd">        md5sum (str): The md5sum of the file.</span>
<span class="sd">        verbose (bool): If True, print debug info.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str or None: The file URL if it exists, else None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">check_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://</span><span class="si">{</span><span class="n">LIBGEN_DOMAIN</span><span class="si">}</span><span class="s2">/json.php?object=f&amp;md5=</span><span class="si">{</span><span class="n">md5sum</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">check_url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  File already exists in LibGen (by md5sum).&quot;</span><span class="p">)</span>
                <span class="n">file_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://</span><span class="si">{</span><span class="n">LIBGEN_DOMAIN</span><span class="si">}</span><span class="s2">/file.php?md5=</span><span class="si">{</span><span class="n">md5sum</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; File URL: </span><span class="si">{</span><span class="n">file_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">file_url</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error checking LibGen for md5sum: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="upload_file_to_libgen_ftp">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.libgen.upload_file_to_libgen_ftp">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">upload_file_to_libgen_ftp</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s1">&#39;anonymous&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Upload a file to ftp://ftp.libgen.bz/upload and return the file URL if successful.</span>
<span class="sd">    Before uploading, check if the file (by md5sum) already exists in LibGen.</span>

<span class="sd">    Args:</span>
<span class="sd">        filepath (str): Path to the file to upload.</span>
<span class="sd">        username (str): FTP username (default: &#39;anonymous&#39;).</span>
<span class="sd">        password (str): FTP password (default: &#39;&#39;).</span>
<span class="sd">        verbose (bool): If True, print debug info.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str or None: The URL of the uploaded file if successful, else None.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ftp_host</span> <span class="o">=</span> <span class="s2">&quot;ftp.libgen.bz&quot;</span>
    <span class="n">ftp_dir</span> <span class="o">=</span> <span class="s2">&quot;upload&quot;</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

    <span class="n">md5sum</span> <span class="o">=</span> <span class="n">file_md5sum</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MD5 sum of file: </span><span class="si">{</span><span class="n">md5sum</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Check if file already exists in LibGen</span>
    <span class="n">existing_url</span> <span class="o">=</span> <span class="n">is_file_on_libgen</span><span class="p">(</span><span class="n">md5sum</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">existing_url</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Proceed to upload if not found</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">ftplib</span><span class="o">.</span><span class="n">FTP</span><span class="p">(</span><span class="n">ftp_host</span><span class="p">)</span> <span class="k">as</span> <span class="n">ftp</span><span class="p">:</span>
            <span class="n">ftp</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">passwd</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connected to FTP: </span><span class="si">{</span><span class="n">ftp_host</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">ftp</span><span class="o">.</span><span class="n">cwd</span><span class="p">(</span><span class="n">ftp_dir</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Changed to directory: </span><span class="si">{</span><span class="n">ftp_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">ftp</span><span class="o">.</span><span class="n">storbinary</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;STOR </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Uploaded file: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Construct the URL (public access may depend on server config)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ftp://</span><span class="si">{</span><span class="n">ftp_host</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">ftp_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">url</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FTP upload failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>

    
<div class="viewcode-block" id="create_chrome_driver">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.libgen.create_chrome_driver">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_chrome_driver</span><span class="p">(</span><span class="n">headless</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">extra_prefs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create and return a Selenium Chrome WebDriver with default user data directory and options.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">options</span> <span class="o">=</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">ChromeOptions</span><span class="p">()</span>
    <span class="c1"># Suppress DevTools logging</span>
    <span class="n">options</span><span class="o">.</span><span class="n">add_experimental_option</span><span class="p">(</span><span class="s1">&#39;excludeSwitches&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;enable-logging&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">headless</span><span class="p">:</span>
        <span class="n">options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--headless=new&quot;</span><span class="p">)</span>
        <span class="n">options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--disable-gpu&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">DEFAULT_CHROME_USER_DIR</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--user-data-dir=</span><span class="si">{</span><span class="n">DEFAULT_CHROME_USER_DIR</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--no-sandbox&quot;</span><span class="p">)</span>
    <span class="n">options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--disable-dev-shm-usage&quot;</span><span class="p">)</span>
    <span class="n">options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--ignore-certificate-errors&#39;</span><span class="p">)</span>          <span class="c1"># Ignore SSL certificate errors</span>
    <span class="n">options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--ignore-ssl-errors&#39;</span><span class="p">)</span>                 <span class="c1"># Additional flag for SSL errors</span>
    <span class="n">options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--allow-running-insecure-content&#39;</span><span class="p">)</span>    <span class="c1"># Allow insecure content</span>
    <span class="n">options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--disable-web-security&#39;</span><span class="p">)</span>              <span class="c1"># Disable web security for broader bypass</span>
    <span class="c1"># Option to not automatically change to https</span>
    <span class="n">options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--allow-insecure-localhost&#39;</span><span class="p">)</span>
    <span class="n">options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--unsafely-treat-insecure-origin-as-secure=http://libgen.li&#39;</span><span class="p">)</span>
    <span class="n">options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--no-sandbox&#39;</span><span class="p">)</span>
    <span class="n">options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--disable-features=UpgradeInsecureRequests&#39;</span><span class="p">)</span>
    <span class="n">options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--disable-features=BlockInsecurePrivateNetworkRequests&#39;</span><span class="p">)</span>
    <span class="n">options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--disable-features=IsolateOrigins,site-per-process&#39;</span><span class="p">)</span>
    <span class="n">options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--disable-site-isolation-trials&#39;</span><span class="p">)</span>
    <span class="c1"># If you want to force http only, you can add:</span>
    <span class="c1"># options.add_argument(&#39;--disable-features=UpgradeInsecureRequests&#39;)</span>
    <span class="n">prefs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;profile.default_content_setting_values.notifications&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s2">&quot;credentials_enable_service&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;profile.password_manager_enabled&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;profile.default_content_setting_values.automatic_downloads&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;profile.default_content_setting_values.popups&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;safebrowsing.enabled&quot;</span><span class="p">:</span> <span class="kc">False</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">extra_prefs</span><span class="p">:</span>
        <span class="n">prefs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extra_prefs</span><span class="p">)</span>
    <span class="n">options</span><span class="o">.</span><span class="n">add_experimental_option</span><span class="p">(</span><span class="s2">&quot;prefs&quot;</span><span class="p">,</span> <span class="n">prefs</span><span class="p">)</span>
    <span class="n">options</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--disable-save-password-bubble&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">webdriver</span><span class="o">.</span><span class="n">Chrome</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span></div>


<div class="viewcode-block" id="selenium_libgen_login">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.libgen.selenium_libgen_login">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">selenium_libgen_login</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;genesis&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;upload&quot;</span><span class="p">,</span> <span class="n">headless</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Open Chrome with Selenium, load http://libgen.li/librarian.php,</span>
<span class="sd">    find and follow the login link if present, and login with phpBB forum settings.</span>
<span class="sd">    Checks &quot;remember me&quot; and &quot;hide my online status this session&quot; before login.</span>
<span class="sd">    If already logged in (by detecting upload form), skip login.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using Chrome user data directory: </span><span class="si">{</span><span class="n">DEFAULT_CHROME_USER_DIR</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">driver</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">driver</span> <span class="o">=</span> <span class="n">create_chrome_driver</span><span class="p">(</span><span class="n">headless</span><span class="o">=</span><span class="n">headless</span><span class="p">)</span>
        <span class="n">driver</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;http://libgen.li/librarian.php&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Opened librarian page.&quot;</span><span class="p">)</span>

        <span class="c1"># Check if already logged in by looking for upload form with id=&quot;upload-form&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">WebDriverWait</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">until</span><span class="p">(</span>
            <span class="n">EC</span><span class="o">.</span><span class="n">presence_of_element_located</span><span class="p">((</span><span class="n">By</span><span class="o">.</span><span class="n">TAG_NAME</span><span class="p">,</span> <span class="s2">&quot;body&quot;</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">upload_form</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_element</span><span class="p">(</span><span class="n">By</span><span class="o">.</span><span class="n">ID</span><span class="p">,</span> <span class="s2">&quot;upload-form&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">upload_form</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Already logged in (upload form detected by id=&#39;upload-form&#39;).&quot;</span><span class="p">)</span>
                    <span class="n">driver</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
                    <span class="k">return</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># Not found, continue to login flow</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Upload form with id=&#39;upload-form&#39; not found, proceeding to login.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error while checking login status:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

        <span class="c1"># Wait for the page to load and look for login/register link</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">alert_div</span> <span class="o">=</span> <span class="n">WebDriverWait</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">until</span><span class="p">(</span>
                <span class="n">EC</span><span class="o">.</span><span class="n">presence_of_element_located</span><span class="p">((</span><span class="n">By</span><span class="o">.</span><span class="n">CSS_SELECTOR</span><span class="p">,</span> <span class="s2">&quot;div.alert.alert-danger&quot;</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="n">login_link</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alert_div</span><span class="o">.</span><span class="n">find_elements</span><span class="p">(</span><span class="n">By</span><span class="o">.</span><span class="n">TAG_NAME</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">):</span>
                <span class="n">href</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">href</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;mode=login&quot;</span> <span class="ow">in</span> <span class="n">href</span> <span class="ow">or</span> <span class="s2">&quot;mode=register&quot;</span> <span class="ow">in</span> <span class="n">href</span><span class="p">):</span>
                    <span class="n">login_link</span> <span class="o">=</span> <span class="n">href</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">login_link</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found login/register link: </span><span class="si">{</span><span class="n">login_link</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">driver</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">login_link</span><span class="p">)</span>
                <span class="n">WebDriverWait</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">until</span><span class="p">(</span>
                    <span class="n">EC</span><span class="o">.</span><span class="n">presence_of_element_located</span><span class="p">((</span><span class="n">By</span><span class="o">.</span><span class="n">NAME</span><span class="p">,</span> <span class="s2">&quot;username&quot;</span><span class="p">))</span>
                <span class="p">)</span>
                <span class="n">user_input</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_element</span><span class="p">(</span><span class="n">By</span><span class="o">.</span><span class="n">NAME</span><span class="p">,</span> <span class="s2">&quot;username&quot;</span><span class="p">)</span>
                <span class="n">pass_input</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_element</span><span class="p">(</span><span class="n">By</span><span class="o">.</span><span class="n">NAME</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">)</span>
                <span class="n">user_input</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="n">user_input</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
                <span class="n">pass_input</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="n">pass_input</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">remember_checkbox</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_element</span><span class="p">(</span><span class="n">By</span><span class="o">.</span><span class="n">NAME</span><span class="p">,</span> <span class="s2">&quot;autologin&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">remember_checkbox</span><span class="o">.</span><span class="n">is_selected</span><span class="p">():</span>
                        <span class="n">remember_checkbox</span><span class="o">.</span><span class="n">click</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not find &#39;remember me&#39; checkbox.&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">hide_checkbox</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_element</span><span class="p">(</span><span class="n">By</span><span class="o">.</span><span class="n">NAME</span><span class="p">,</span> <span class="s2">&quot;viewonline&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">hide_checkbox</span><span class="o">.</span><span class="n">is_selected</span><span class="p">():</span>
                        <span class="n">hide_checkbox</span><span class="o">.</span><span class="n">click</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not find &#39;hide my online status&#39; checkbox.&quot;</span><span class="p">)</span>
                <span class="n">login_btn</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">login_btn</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_element</span><span class="p">(</span><span class="n">By</span><span class="o">.</span><span class="n">NAME</span><span class="p">,</span> <span class="s2">&quot;login&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">buttons</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_elements</span><span class="p">(</span><span class="n">By</span><span class="o">.</span><span class="n">XPATH</span><span class="p">,</span> <span class="s2">&quot;//input[@type=&#39;submit&#39;]&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">buttons</span><span class="p">:</span>
                        <span class="n">login_btn</span> <span class="o">=</span> <span class="n">buttons</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">login_btn</span><span class="p">:</span>
                    <span class="n">login_btn</span><span class="o">.</span><span class="n">click</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Submitted login form.&quot;</span><span class="p">)</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">driver</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;http://libgen.li/librarian.php&quot;</span><span class="p">)</span>
                    <span class="n">WebDriverWait</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">until</span><span class="p">(</span>
                        <span class="n">EC</span><span class="o">.</span><span class="n">presence_of_element_located</span><span class="p">((</span><span class="n">By</span><span class="o">.</span><span class="n">TAG_NAME</span><span class="p">,</span> <span class="s2">&quot;body&quot;</span><span class="p">))</span>
                    <span class="p">)</span>
                    <span class="n">page_source</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">page_source</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="s1">&#39;name=&quot;pre_lg_topic&quot;&#39;</span> <span class="ow">in</span> <span class="n">page_source</span>
                        <span class="ow">and</span> <span class="s1">&#39;id=&quot;pre_l&quot;&#39;</span> <span class="ow">in</span> <span class="n">page_source</span>
                        <span class="ow">and</span> <span class="s1">&#39;Libgen&#39;</span> <span class="ow">in</span> <span class="n">page_source</span>
                    <span class="p">):</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Login successful (upload form detected).&quot;</span><span class="p">)</span>
                        <span class="n">driver</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
                        <span class="k">return</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Login may have failed (upload form not detected).&quot;</span><span class="p">)</span>
                        <span class="n">driver</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
                        <span class="k">return</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Login button not found.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No login/register link found. Maybe already logged in or not required.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not find login/register link or alert div:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Quitting after login attempt.&quot;</span><span class="p">)</span>
        <span class="n">driver</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Selenium error:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">driver</span><span class="p">:</span>
            <span class="n">driver</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="selenium_libgen_upload">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.libgen.selenium_libgen_upload">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">selenium_libgen_upload</span><span class="p">(</span><span class="n">local_file_path</span><span class="p">,</span> <span class="n">bib_id</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s2">&quot;genesis&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;upload&quot;</span><span class="p">,</span> <span class="n">headless</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Upload a local file to http://libgen.li/librarian.php after logging in with Selenium.</span>
<span class="sd">    Fills the FTP path in the upload form and clicks the Upload button.</span>
<span class="sd">    After upload, finds the bibliography search form, selects the appropriate source (crossref for DOI, goodreads for ISBN),</span>
<span class="sd">    fills the bib_id in the bibliography search input, and clicks the Search button.</span>
<span class="sd">    Then waits for a while and clicks the Register button.</span>

<span class="sd">    Args:</span>
<span class="sd">        local_file_path (str): Path to the local file to upload.</span>
<span class="sd">        bib_id (str): DOI or ISBN to associate with the upload.</span>
<span class="sd">        username (str): LibGen username (default: &#39;genesis&#39;).</span>
<span class="sd">        password (str): LibGen password (default: &#39;upload&#39;).</span>
<span class="sd">        headless (bool): Run browser in headless mode.</span>
<span class="sd">        verbose (bool): Print debug info.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True if upload succeeded, False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ftp_url</span> <span class="o">=</span> <span class="n">upload_file_to_libgen_ftp</span><span class="p">(</span><span class="n">local_file_path</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s1">&#39;anonymous&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ftp_url</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; FTP upload failed or file already exists.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">login_success</span> <span class="o">=</span> <span class="n">selenium_libgen_login</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span> <span class="n">headless</span><span class="o">=</span><span class="n">headless</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">login_success</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Login failed, cannot upload.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">driver</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">driver</span> <span class="o">=</span> <span class="n">create_chrome_driver</span><span class="p">(</span><span class="n">headless</span><span class="o">=</span><span class="n">headless</span><span class="p">)</span>
        <span class="n">driver</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;http://libgen.li/librarian.php&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Opened librarian page for upload.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">_selenium_fill_upload_form</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="n">ftp_url</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
            <span class="n">driver</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">upload_success</span><span class="p">,</span> <span class="n">success_message</span> <span class="o">=</span> <span class="n">_selenium_wait_for_upload_success</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">upload_success</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">success_message</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Upload success message: </span><span class="si">{</span><span class="n">success_message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Upload process completed. (No explicit success message found.)&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Upload failed.&quot;</span><span class="p">)</span>
            <span class="n">driver</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">biblio_success</span> <span class="o">=</span> <span class="n">_selenium_register_bibliography</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="n">bib_id</span><span class="p">,</span> <span class="n">local_file_path</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="n">driver</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">biblio_success</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Selenium error:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">driver</span><span class="p">:</span>
            <span class="n">driver</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<span class="k">def</span><span class="w"> </span><span class="nf">_selenium_fill_upload_form</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="n">ftp_url</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fill the upload form with the FTP path and click the Upload button.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">WebDriverWait</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">until</span><span class="p">(</span>
            <span class="n">EC</span><span class="o">.</span><span class="n">presence_of_element_located</span><span class="p">((</span><span class="n">By</span><span class="o">.</span><span class="n">NAME</span><span class="p">,</span> <span class="s2">&quot;ftppath&quot;</span><span class="p">))</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; FTP path input not found:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">libgen_radio</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_element</span><span class="p">(</span><span class="n">By</span><span class="o">.</span><span class="n">ID</span><span class="p">,</span> <span class="s2">&quot;pre_l&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">libgen_radio</span><span class="o">.</span><span class="n">is_selected</span><span class="p">():</span>
            <span class="n">libgen_radio</span><span class="o">.</span><span class="n">click</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Checked the Libgen radio button.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Could not find or check Libgen radio button:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">ftppath_input</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_element</span><span class="p">(</span><span class="n">By</span><span class="o">.</span><span class="n">NAME</span><span class="p">,</span> <span class="s2">&quot;ftppath&quot;</span><span class="p">)</span>
        <span class="n">ftppath_input</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">ftppath_input</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="n">ftp_url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Pasted FTP path: </span><span class="si">{</span><span class="n">ftp_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Could not find or fill FTP path input:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">upload_btn</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_element</span><span class="p">(</span><span class="n">By</span><span class="o">.</span><span class="n">ID</span><span class="p">,</span> <span class="s2">&quot;upload-file&quot;</span><span class="p">)</span>
        <span class="n">upload_btn</span><span class="o">.</span><span class="n">click</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Clicked the Upload button.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Could not find or click Upload button:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>  <span class="c1"># Wait for upload to process</span>
    <span class="k">return</span> <span class="kc">True</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_selenium_wait_for_upload_success</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Wait for upload to complete and try to extract a success message.&quot;&quot;&quot;</span>
    <span class="n">page_source</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">page_source</span>
    <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">success_message</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">alert_success</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_elements</span><span class="p">(</span><span class="n">By</span><span class="o">.</span><span class="n">CSS_SELECTOR</span><span class="p">,</span> <span class="s2">&quot;.alert-success, .alert.alert-success&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">alert_success</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">alert</span> <span class="ow">in</span> <span class="n">alert_success</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">alert</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
                    <span class="n">success_message</span> <span class="o">=</span> <span class="n">msg</span>
                    <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">success_message</span><span class="p">:</span>
            <span class="n">divs</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_elements</span><span class="p">(</span><span class="n">By</span><span class="o">.</span><span class="n">TAG_NAME</span><span class="p">,</span> <span class="s2">&quot;div&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">div</span> <span class="ow">in</span> <span class="n">divs</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">div</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">if</span> <span class="s2">&quot;success&quot;</span> <span class="ow">in</span> <span class="n">text</span> <span class="ow">or</span> <span class="s2">&quot;uploaded&quot;</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
                    <span class="n">success_message</span> <span class="o">=</span> <span class="n">div</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">break</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">success_message</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;success&quot;</span> <span class="ow">in</span> <span class="n">page_source</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;uploaded&quot;</span> <span class="ow">in</span> <span class="n">page_source</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">success_message</span> <span class="o">=</span> <span class="s2">&quot;Upload appears to have succeeded (no explicit message found).&quot;</span>
            <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Assume success if no error found</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="n">success</span><span class="p">,</span> <span class="n">success_message</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_selenium_register_bibliography</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="n">bib_id</span><span class="p">,</span> <span class="n">local_file_path</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Register the uploaded file with a DOI or ISBN using the bibliography form.</span>
<span class="sd">    If bib_id looks like an ISBN, selects &#39;goodreads&#39; as source and uses bib_id.</span>
<span class="sd">    If bib_id looks like a DOI, selects &#39;crossref&#39; and uses bib_id.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_isbn</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
        <span class="c1"># Simple check: ISBN-10 or ISBN-13 (digits, possibly with hyphens)</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="mi">10</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="mi">13</span><span class="p">)</span> <span class="ow">and</span> <span class="n">val</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_doi</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
        <span class="c1"># Simple check: contains a slash and at least one dot</span>
        <span class="k">return</span> <span class="s2">&quot;/&quot;</span> <span class="ow">in</span> <span class="n">val</span> <span class="ow">and</span> <span class="s2">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">val</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">WebDriverWait</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">until</span><span class="p">(</span>
            <span class="n">EC</span><span class="o">.</span><span class="n">presence_of_element_located</span><span class="p">((</span><span class="n">By</span><span class="o">.</span><span class="n">ID</span><span class="p">,</span> <span class="s2">&quot;bibliosearch-form&quot;</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Found bibliography search form.&quot;</span><span class="p">)</span>

        <span class="c1"># Decide source and value</span>
        <span class="k">if</span> <span class="n">is_isbn</span><span class="p">(</span><span class="n">bib_id</span><span class="p">):</span>
            <span class="n">source_value</span> <span class="o">=</span> <span class="s2">&quot;goodreads&quot;</span>
            <span class="n">biblio_value</span> <span class="o">=</span> <span class="n">bib_id</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using ISBN: </span><span class="si">{</span><span class="n">bib_id</span><span class="si">}</span><span class="s2"> (goodreads)&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">is_doi</span><span class="p">(</span><span class="n">bib_id</span><span class="p">):</span>
            <span class="n">source_value</span> <span class="o">=</span> <span class="s2">&quot;crossref&quot;</span>
            <span class="n">biblio_value</span> <span class="o">=</span> <span class="n">bib_id</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using DOI: </span><span class="si">{</span><span class="n">bib_id</span><span class="si">}</span><span class="s2"> (crossref)&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; bib_id &#39;</span><span class="si">{</span><span class="n">bib_id</span><span class="si">}</span><span class="s2">&#39; is neither a valid DOI nor ISBN.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Select source in dropdown</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">select_elem</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_element</span><span class="p">(</span><span class="n">By</span><span class="o">.</span><span class="n">ID</span><span class="p">,</span> <span class="s2">&quot;bibliosearchsource&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">select_elem</span><span class="o">.</span><span class="n">find_elements</span><span class="p">(</span><span class="n">By</span><span class="o">.</span><span class="n">TAG_NAME</span><span class="p">,</span> <span class="s2">&quot;option&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">option</span><span class="o">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">source_value</span><span class="p">:</span>
                    <span class="n">option</span><span class="o">.</span><span class="n">click</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Selected &#39;</span><span class="si">{</span><span class="n">source_value</span><span class="si">}</span><span class="s2">&#39; in bibliography source dropdown.&quot;</span><span class="p">)</span>
                    <span class="k">break</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Could not select &#39;</span><span class="si">{</span><span class="n">source_value</span><span class="si">}</span><span class="s2">&#39; in dropdown:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

        <span class="c1"># Fill input</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">biblio_input</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_element</span><span class="p">(</span><span class="n">By</span><span class="o">.</span><span class="n">ID</span><span class="p">,</span> <span class="s2">&quot;bibliosearchid&quot;</span><span class="p">)</span>
            <span class="n">biblio_input</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">biblio_input</span><span class="o">.</span><span class="n">send_keys</span><span class="p">(</span><span class="n">biblio_value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Filled bibliography search input with </span><span class="si">{</span><span class="n">source_value</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">biblio_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Could not fill bibliography search input with </span><span class="si">{</span><span class="n">source_value</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

        <span class="c1"># Click Search</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">search_btn</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_element</span><span class="p">(</span><span class="n">By</span><span class="o">.</span><span class="n">CSS_SELECTOR</span><span class="p">,</span> <span class="s2">&quot;form#bibliosearch-form button[type=&#39;submit&#39;].btn.btn-primary&quot;</span><span class="p">)</span>
            <span class="n">search_btn</span><span class="o">.</span><span class="n">click</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Clicked the Search button in bibliography form.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Could not find or click Search button in bibliography form:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Waiting for Register button to appear...&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">WebDriverWait</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span><span class="o">.</span><span class="n">until</span><span class="p">(</span>
                <span class="n">EC</span><span class="o">.</span><span class="n">presence_of_element_located</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">By</span><span class="o">.</span><span class="n">CSS_SELECTOR</span><span class="p">,</span> <span class="s2">&quot;button.btn.btn-primary.btn-lg.btn-block.col-md-12[type=&#39;submit&#39;]&quot;</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">register_btn</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_element</span><span class="p">(</span>
                <span class="n">By</span><span class="o">.</span><span class="n">CSS_SELECTOR</span><span class="p">,</span> <span class="s2">&quot;button.btn.btn-primary.btn-lg.btn-block.col-md-12[type=&#39;submit&#39;]&quot;</span>
            <span class="p">)</span>
            <span class="n">register_btn</span><span class="o">.</span><span class="n">click</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Clicked the Register button.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Could not find or click Register button:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Waiting for final page after Register...&quot;</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">final_page_source</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">page_source</span>
            <span class="n">final_message</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">alert_divs</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_elements</span><span class="p">(</span><span class="n">By</span><span class="o">.</span><span class="n">CSS_SELECTOR</span><span class="p">,</span> <span class="s2">&quot;.alert, .alert-success, .alert-danger, .alert-info&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">div</span> <span class="ow">in</span> <span class="n">alert_divs</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="n">div</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">text</span><span class="p">:</span>
                        <span class="n">final_message</span> <span class="o">=</span> <span class="n">text</span>
                        <span class="k">break</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">final_message</span><span class="p">:</span>
                <span class="n">divs</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="n">find_elements</span><span class="p">(</span><span class="n">By</span><span class="o">.</span><span class="n">TAG_NAME</span><span class="p">,</span> <span class="s2">&quot;div&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">div</span> <span class="ow">in</span> <span class="n">divs</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="n">div</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span> <span class="ow">in</span> <span class="n">text</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="s2">&quot;registered&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;fail&quot;</span><span class="p">]):</span>
                        <span class="n">final_message</span> <span class="o">=</span> <span class="n">div</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="k">break</span>
            <span class="k">if</span> <span class="n">final_message</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Final response: </span><span class="si">{</span><span class="n">final_message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">md5sum</span> <span class="o">=</span> <span class="n">file_md5sum</span><span class="p">(</span><span class="n">local_file_path</span><span class="p">)</span>
                <span class="n">file_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://</span><span class="si">{</span><span class="n">LIBGEN_DOMAIN</span><span class="si">}</span><span class="s2">/file.php?md5=</span><span class="si">{</span><span class="n">md5sum</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Uploaded file URL: </span><span class="si">{</span><span class="n">file_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Final page loaded. (No explicit message found.)&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">final_page_source</span><span class="p">[:</span><span class="mi">1000</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Could not extract final response: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Bibliography search form not found after upload:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="upload_and_register_to_libgen">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.libgen.upload_and_register_to_libgen">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">upload_and_register_to_libgen</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">headless</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Upload and register a file to LibGen using Selenium automation.</span>
<span class="sd">    Tries to extract DOI or ISBN from the file name. If found, registers the file with that ID.</span>
<span class="sd">    If not found, uploads to FTP only (not registered in LibGen database).</span>
<span class="sd">    If the file is a PDF, tries to extract DOI from the PDF using getpapers.extract_doi_from_pdf.</span>

<span class="sd">    Args:</span>
<span class="sd">        filepath (str): Path to the file to upload.</span>
<span class="sd">        verbose (bool): Enable verbose/debug output.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str or None: URL of the uploaded file if successful, else None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; File not found: </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="n">bib_id</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># If file is PDF and no DOI found yet, try to extract DOI from PDF using getpapers</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">bib_id</span> <span class="ow">and</span> <span class="n">filename</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.pdf&quot;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Attempting to extract DOI from PDF: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">pdf_doi</span> <span class="o">=</span> <span class="n">getpapers</span><span class="o">.</span><span class="n">extract_doi_from_pdf</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pdf_doi</span><span class="p">:</span>
                <span class="n">bib_id</span> <span class="o">=</span> <span class="n">pdf_doi</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Extracted DOI from PDF: </span><span class="si">{</span><span class="n">bib_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Could not extract DOI from PDF: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># If still no bib_id, ask user to input DOI or ISBN, but timeout after 30 seconds</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">bib_id</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Enter DOI or ISBN to register this file (leave blank to upload to FTP only): &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">user_input</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">get_input</span><span class="p">():</span>
                <span class="n">user_input</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">input</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

            <span class="n">t</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">get_input</span><span class="p">)</span>
            <span class="n">t</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> No response after 30 seconds. Upload failed.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">user_input</span> <span class="ow">and</span> <span class="n">user_input</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">bib_id</span> <span class="o">=</span> <span class="n">user_input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Error or timeout while waiting for input. Upload failed.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bib_id</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">bib_id</span><span class="p">:</span>
        <span class="n">bib_id</span> <span class="o">=</span> <span class="n">bib_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">bib_id</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Registering file with DOI/ISBN: </span><span class="si">{</span><span class="n">bib_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">success</span> <span class="o">=</span> <span class="n">selenium_libgen_upload</span><span class="p">(</span>
            <span class="n">local_file_path</span><span class="o">=</span><span class="n">filepath</span><span class="p">,</span>
            <span class="n">bib_id</span><span class="o">=</span><span class="n">bib_id</span><span class="p">,</span>
            <span class="n">username</span><span class="o">=</span><span class="s2">&quot;genesis&quot;</span><span class="p">,</span>
            <span class="n">password</span><span class="o">=</span><span class="s2">&quot;upload&quot;</span><span class="p">,</span>
            <span class="n">headless</span><span class="o">=</span><span class="n">headless</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
            <span class="c1"># Return the LibGen file URL if possible</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">md5sum</span> <span class="o">=</span> <span class="n">file_md5sum</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
                <span class="n">file_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://</span><span class="si">{</span><span class="n">LIBGEN_DOMAIN</span><span class="si">}</span><span class="s2">/file.php?md5=</span><span class="si">{</span><span class="n">md5sum</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; File uploaded and registered to LibGen: </span><span class="si">{</span><span class="n">file_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">file_url</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; File uploaded and registered to LibGen.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Upload or registration failed.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">upload_file_to_libgen_ftp</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s1">&#39;anonymous&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">url</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Uploaded to FTP only: </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">url</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Upload failed or file already exists in LibGen.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="main">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.libgen.main">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="c1"># Get the parent package name from the module&#39;s __name__</span>
    <span class="n">parent_package</span> <span class="o">=</span> <span class="vm">__name__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="vm">__name__</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">parent_package</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">program_name</span> <span class="o">=</span> <span class="s1">&#39;libgen&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;_&#39;</span> <span class="ow">in</span> <span class="n">parent_package</span><span class="p">:</span>
        <span class="c1"># If the parent package has an underscore, strip it</span>
        <span class="n">parent_package</span> <span class="o">=</span> <span class="n">parent_package</span><span class="p">[:</span><span class="n">parent_package</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)]</span>
        <span class="n">program_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">parent_package</span><span class="si">}</span><span class="s2"> libgen&quot;</span>
        
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">prog</span><span class="o">=</span><span class="n">program_name</span><span class="p">,</span>
        <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">RawDescriptionHelpFormatter</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;LibGen search utility&quot;</span><span class="p">,</span>
        <span class="n">epilog</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Examples:</span>
<span class="s2">  Search for a book:</span>
<span class="s2">    </span><span class="si">%(prog)s</span><span class="s2"> --search &quot;deep learning&quot; --limit 5</span>

<span class="s2">  Search by DOI and print result:</span>
<span class="s2">    </span><span class="si">%(prog)s</span><span class="s2"> --check-doi 10.1007/978-3-030-14665-2</span>

<span class="s2">  Search and interactively download:</span>
<span class="s2">    </span><span class="si">%(prog)s</span><span class="s2"> --search &quot;artificial intelligence&quot; --download</span>

<span class="s2">  Download by DOI to a specific folder:</span>
<span class="s2">    </span><span class="si">%(prog)s</span><span class="s2"> --check-doi 10.1007/978-3-030-14665-2 --download &quot;C:/Papers&quot;</span>

<span class="s2">  Login to LibGen:</span>
<span class="s2">    </span><span class="si">%(prog)s</span><span class="s2"> --login</span>

<span class="s2">  Upload a file to LibGen FTP:</span>
<span class="s2">    </span><span class="si">%(prog)s</span><span class="s2"> --upload /path/to/file.pdf</span>

<span class="s2">  Upload a file to LibGen FTP with DOI:</span>
<span class="s2">    </span><span class="si">%(prog)s</span><span class="s2"> --upload /path/to/file.pdf --upload-doi 10.1000/xyz123</span>

<span class="s2">  Upload a file to LibGen FTP with ISBN:</span>
<span class="s2">    </span><span class="si">%(prog)s</span><span class="s2"> --upload /path/to/file.pdf --upload-isbn 9781234567890</span>

<span class="s2">  Clear cache directory:</span>
<span class="s2">    </span><span class="si">%(prog)s</span><span class="s2"> --clear-cache</span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="p">)</span>
    <span class="n">group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_mutually_exclusive_group</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--search&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Search LibGen by query string&quot;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--check-doi&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Search LibGen by DOI&quot;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--login&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Login to LibGen (default username: &#39;genesis&#39;, password: &#39;upload&#39;)&quot;</span>
    <span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--clear-cache&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Clear the cache directory and exit&quot;</span><span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--upload&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;FILEPATH&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Upload a file to LibGen FTP&quot;</span><span class="p">)</span>

    <span class="n">upload_id_group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_mutually_exclusive_group</span><span class="p">()</span>
    <span class="n">upload_id_group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--upload-doi&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;DOI to associate with --upload (required to register the file metadata to the LibGen database). &quot;</span>
             <span class="s2">&quot;If not specified, the uploaded file will NOT appear in the LibGen database.&quot;</span>
    <span class="p">)</span>
    <span class="n">upload_id_group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--upload-isbn&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;ISBN to associate with --upload (required to register the file metadata to the LibGen database). &quot;</span>
             <span class="s2">&quot;If not specified, the uploaded file will NOT appear in the LibGen database.&quot;</span>
    <span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--limit&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Maximum number of results to return (default: 10)&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--verbose&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable verbose/debug output&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--download&quot;</span><span class="p">,</span>
        <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;?&quot;</span><span class="p">,</span>
        <span class="n">const</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">metavar</span><span class="o">=</span><span class="s2">&quot;DOWNLOAD_DIR&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Download after search (interactive for --search, auto for --check-doi). Optionally specify download directory.&quot;</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--no-headless&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Run browser in non-headless mode for Selenium operations&quot;</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--proxy&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;?&quot;</span><span class="p">,</span>
        <span class="n">const</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">proxy_config</span><span class="o">.</span><span class="n">DEFAULT_PROXY_FILE</span><span class="p">),</span>
        <span class="n">help</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Path to proxy configuration JSON file (default: </span><span class="si">{</span><span class="n">proxy_config</span><span class="o">.</span><span class="n">DEFAULT_PROXY_FILE</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--no-proxy&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Disable proxy usage for LibGen requests.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--auto-proxy&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Automatically fetch a proxy configuration when missing or invalid.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="c1"># Handle --no-headless option</span>
    <span class="n">headless</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s2">&quot;no_headless&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Apply proxy configuration early so all requests honor it</span>
    <span class="k">global</span> <span class="n">ACTIVE_PROXY</span>
    <span class="n">ACTIVE_PROXY</span> <span class="o">=</span> <span class="n">proxy_config</span><span class="o">.</span><span class="n">configure_from_cli</span><span class="p">(</span>
        <span class="n">args</span><span class="o">.</span><span class="n">proxy</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">no_proxy</span><span class="p">,</span> <span class="n">auto_fetch</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">auto_proxy</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span>
    <span class="p">)</span>

    <span class="c1"># Handle clear-cache option</span>
    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s2">&quot;clear_cache&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Cache directory &#39;</span><span class="si">{</span><span class="n">cache_dir</span><span class="si">}</span><span class="s2">&#39; cleared.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Failed to clear cache directory &#39;</span><span class="si">{</span><span class="n">cache_dir</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># Handle login option</span>
    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Attempting to login to LibGen with default credentials...&quot;</span><span class="p">)</span>
        <span class="n">success</span> <span class="o">=</span> <span class="n">selenium_libgen_login</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;genesis&quot;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&quot;upload&quot;</span><span class="p">,</span> <span class="n">headless</span><span class="o">=</span><span class="n">headless</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Login successful.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Login failed.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># Handle upload option</span>
    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s2">&quot;upload&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">upload</span>
        <span class="n">upload_doi</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s2">&quot;upload_doi&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">upload_isbn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s2">&quot;upload_isbn&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">upload_doi</span> <span class="ow">and</span> <span class="n">upload_isbn</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; You cannot specify both --upload-doi and --upload-isbn.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">upload_id</span> <span class="o">=</span> <span class="n">upload_doi</span> <span class="ow">or</span> <span class="n">upload_isbn</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; File not found: </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">upload_id</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Uploading file to LibGen using Selenium: </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">success</span> <span class="o">=</span> <span class="n">selenium_libgen_upload</span><span class="p">(</span>
                <span class="n">local_file_path</span><span class="o">=</span><span class="n">filepath</span><span class="p">,</span>
                <span class="n">bib_id</span><span class="o">=</span><span class="n">upload_id</span><span class="p">,</span>
                <span class="n">username</span><span class="o">=</span><span class="s2">&quot;genesis&quot;</span><span class="p">,</span>
                <span class="n">password</span><span class="o">=</span><span class="s2">&quot;upload&quot;</span><span class="p">,</span>
                <span class="n">headless</span><span class="o">=</span><span class="n">headless</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; File registered to LibGen librarian.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Upload failed or file already exists in LibGen.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If PDF and no DOI/ISBN, try to extract and register</span>
            <span class="k">if</span> <span class="n">filepath</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.pdf&quot;</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Uploading PDF file to LibGen and trying to extract DOI/ISBN: </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">upload_and_register_to_libgen</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span> <span class="n">headless</span><span class="o">=</span><span class="n">headless</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">url</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Uploaded and registered: </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Upload failed or file already exists in LibGen.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Uploading file to LibGen FTP only (no DOI/ISBN registration): </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">url</span> <span class="o">=</span> <span class="n">upload_file_to_libgen_ftp</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s1">&#39;anonymous&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">url</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Uploaded to FTP: </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Upload failed or file already exists in LibGen.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># Determine download directory if --download is used</span>
    <span class="n">download_dir</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">download</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">download</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">download_dir</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">download</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">download_dir</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Use default</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">search</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">search_libgen_by_query</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">search</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">limit</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
        <span class="n">print_libgen_query_results</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">download</span> <span class="ow">and</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">interactive_libgen_download</span><span class="p">(</span>
                <span class="n">args</span><span class="o">.</span><span class="n">search</span><span class="p">,</span>
                <span class="n">limit</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">limit</span><span class="p">,</span>
                <span class="n">dest_folder</span><span class="o">=</span><span class="n">download_dir</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span>
            <span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">check_doi</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">search_libgen_by_doi</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">check_doi</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">limit</span><span class="p">)</span>
        <span class="n">print_libgen_doi_result</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">download</span> <span class="ow">and</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">out_path</span> <span class="o">=</span> <span class="n">download_libgen_paper_by_doi</span><span class="p">(</span>
                <span class="n">args</span><span class="o">.</span><span class="n">check_doi</span><span class="p">,</span>
                <span class="n">dest_folder</span><span class="o">=</span><span class="n">download_dir</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">out_path</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Downloaded to: </span><span class="si">{</span><span class="n">out_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Download failed or no file found.&quot;</span><span class="p">)</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023-2026, Duc A. Hoang.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>