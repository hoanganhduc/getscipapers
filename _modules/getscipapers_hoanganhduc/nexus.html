

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>getscipapers_hoanganhduc.nexus &mdash; getscipapers 0.1.4 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=9edc463e" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=fd825880"></script>
      <script src="../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            getscipapers
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Usage Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cli_reference.html">CLI Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_reference.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project_documentation.html">Project Architecture and Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project_documentation.html#getscipapers-project-documentation">getscipapers Project Documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">getscipapers</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">getscipapers_hoanganhduc.nexus</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for getscipapers_hoanganhduc.nexus</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Async interactions with the Nexus Telegram bot.</span>

<span class="sd">The routines here handle authentication, command dispatch, and output parsing</span>
<span class="sd">for the Nexus search bot. They are structured around ``Telethon`` event loops</span>
<span class="sd">so they can be driven from the CLI without blocking other concurrent work.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># Python script to interact with Nexus bot on Telegram</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">telethon</span><span class="w"> </span><span class="kn">import</span> <span class="n">TelegramClient</span><span class="p">,</span> <span class="n">events</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">platform</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">argparse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">telethon</span><span class="w"> </span><span class="kn">import</span> <span class="n">connection</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bs4</span><span class="w"> </span><span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">socket</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ssl</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">aiohttp</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">urlparse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">socks</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">aiohttp_socks</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProxyConnector</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">select</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">readline</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">signal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">concurrent.futures</span><span class="w"> </span><span class="kn">import</span> <span class="n">ThreadPoolExecutor</span><span class="p">,</span> <span class="n">as_completed</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">timedelta</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">dt</span>  <span class="c1"># Add this import at the top if not already present</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">getpass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">getpapers</span><span class="p">,</span> <span class="n">proxy_config</span>


<span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;Windows&#39;</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">msvcrt</span>

<span class="c1"># You need to get API credentials from https://my.telegram.org</span>
<span class="n">TG_API_ID</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># Replace with your actual API ID</span>
<span class="n">TG_API_HASH</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># Replace with your actual API hash</span>
<span class="n">PHONE</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># Replace with your phone number</span>
<span class="n">BOT_USERNAME</span> <span class="o">=</span> <span class="s2">&quot;SciNexBot&quot;</span>  <span class="c1"># Replace with Nexus bot username</span>
<span class="n">SESSION_FILE</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># Path to save the session file</span>

<span class="c1"># Global variables for logging</span>
<span class="n">verbose_mode</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">logger</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="setup_logging">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.setup_logging">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">setup_logging</span><span class="p">(</span><span class="n">log_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Setup logging configuration&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">logger</span><span class="p">,</span> <span class="n">verbose_mode</span>
    <span class="n">verbose_mode</span> <span class="o">=</span> <span class="n">verbose</span>
    
    <span class="c1"># Create logger</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;TelegramBot&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
    
    <span class="c1"># Clear any existing handlers</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    
    <span class="c1"># Create formatter</span>
    <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="c1"># Console handler</span>
    <span class="n">console_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
    <span class="n">console_handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
    <span class="n">console_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">console_handler</span><span class="p">)</span>
    
    <span class="c1"># File handler if log_file is specified</span>
    <span class="k">if</span> <span class="n">log_file</span><span class="p">:</span>
        <span class="c1"># Create log directory if it doesn&#39;t exist</span>
        <span class="n">log_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">log_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">log_dir</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="n">file_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">log_file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">file_handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="n">file_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">file_handler</span><span class="p">)</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Logging to file: </span><span class="si">{</span><span class="n">log_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="debug_print">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.debug_print">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">debug_print</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Print debug message if verbose mode is enabled&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">verbose_mode</span> <span class="ow">and</span> <span class="n">logger</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">verbose_mode</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DEBUG: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="info_print">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.info_print">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">info_print</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Print info message&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span></div>


<div class="viewcode-block" id="error_print">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.error_print">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">error_print</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Print error message&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<span class="c1"># Set file paths based on operating system</span>
<div class="viewcode-block" id="get_file_paths">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.get_file_paths">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_file_paths</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the appropriate file paths based on the operating system, using a single config dir for all except downloads.&quot;&quot;&quot;</span>
    <span class="n">system</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span>
    <span class="n">home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">system</span> <span class="o">==</span> <span class="s2">&quot;Windows&quot;</span><span class="p">:</span>
        <span class="c1"># Windows: Use AppData\Local\getscipapers\nexus as config dir</span>
        <span class="n">config_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;LOCALAPPDATA&quot;</span><span class="p">,</span> <span class="n">home</span><span class="p">),</span> <span class="s2">&quot;getscipapers&quot;</span><span class="p">,</span> <span class="s2">&quot;nexus&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">system</span> <span class="o">==</span> <span class="s2">&quot;Darwin&quot;</span><span class="p">:</span>  <span class="c1"># macOS</span>
        <span class="c1"># macOS: Use ~/Library/Application Support/getscipapers/nexus as config dir</span>
        <span class="n">config_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">home</span><span class="p">,</span> <span class="s2">&quot;Library&quot;</span><span class="p">,</span> <span class="s2">&quot;Application Support&quot;</span><span class="p">,</span> <span class="s2">&quot;getscipapers&quot;</span><span class="p">,</span> <span class="s2">&quot;nexus&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Linux and other Unix-like systems</span>
        <span class="c1"># Linux: Use ~/.config/getscipapers/nexus as config dir</span>
        <span class="n">config_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">home</span><span class="p">,</span> <span class="s2">&quot;.config&quot;</span><span class="p">,</span> <span class="s2">&quot;getscipapers&quot;</span><span class="p">,</span> <span class="s2">&quot;nexus&quot;</span><span class="p">)</span>

    <span class="c1"># Download dir is always ~/Downloads/getscipapers/nexus</span>
    <span class="n">download_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">home</span><span class="p">,</span> <span class="s2">&quot;Downloads&quot;</span><span class="p">,</span> <span class="s2">&quot;getscipapers&quot;</span><span class="p">,</span> <span class="s2">&quot;nexus&quot;</span><span class="p">)</span>

    <span class="c1"># Log file in config dir/logs</span>
    <span class="n">log_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config_dir</span><span class="p">,</span> <span class="s2">&quot;logs&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">config_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">download_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">default_log_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;telegram_bot_</span><span class="si">{</span><span class="n">timestamp</span><span class="si">}</span><span class="s2">.log&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;session&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config_dir</span><span class="p">,</span> <span class="s2">&quot;telegram_session.session&quot;</span><span class="p">),</span>
        <span class="s2">&quot;credentials&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config_dir</span><span class="p">,</span> <span class="s2">&quot;credentials.json&quot;</span><span class="p">),</span>
        <span class="s2">&quot;proxy&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config_dir</span><span class="p">,</span> <span class="s2">&quot;proxy.json&quot;</span><span class="p">),</span>
        <span class="s2">&quot;log&quot;</span><span class="p">:</span> <span class="n">default_log_file</span><span class="p">,</span>
        <span class="s2">&quot;download&quot;</span><span class="p">:</span> <span class="n">download_dir</span>
    <span class="p">}</span></div>


<span class="c1"># Update file paths to use the platform-specific paths</span>
<span class="n">file_paths</span> <span class="o">=</span> <span class="n">get_file_paths</span><span class="p">()</span>
<span class="n">SESSION_FILE</span> <span class="o">=</span> <span class="n">file_paths</span><span class="p">[</span><span class="s2">&quot;session&quot;</span><span class="p">]</span>
<span class="n">CREDENTIALS_FILE</span> <span class="o">=</span> <span class="n">file_paths</span><span class="p">[</span><span class="s2">&quot;credentials&quot;</span><span class="p">]</span>
<span class="n">DEFAULT_PROXY_FILE</span> <span class="o">=</span> <span class="n">file_paths</span><span class="p">[</span><span class="s2">&quot;proxy&quot;</span><span class="p">]</span>
<span class="n">DEFAULT_LOG_FILE</span> <span class="o">=</span> <span class="n">file_paths</span><span class="p">[</span><span class="s2">&quot;log&quot;</span><span class="p">]</span>
<span class="n">DEFAULT_DOWNLOAD_DIR</span> <span class="o">=</span> <span class="n">file_paths</span><span class="p">[</span><span class="s2">&quot;download&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="get_free_proxies">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.get_free_proxies">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_free_proxies</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieve and store free proxies using the shared proxy helper.&quot;&quot;&quot;</span>

    <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Retrieving free proxies from free-proxy-list.net...&quot;</span><span class="p">)</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="n">proxy_config</span><span class="o">.</span><span class="n">auto_discover_proxy</span><span class="p">(</span>
        <span class="n">config_path</span><span class="o">=</span><span class="n">DEFAULT_PROXY_FILE</span><span class="p">,</span>
        <span class="n">save_list</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose_mode</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">settings</span><span class="o">.</span><span class="n">enabled</span></div>


<div class="viewcode-block" id="test_proxy_speed">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.test_proxy_speed">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">test_proxy_speed</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test proxy speed by making a simple HTTP request through the proxy</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        ip: Proxy IP address</span>
<span class="sd">        port: Proxy port</span>
<span class="sd">        timeout: Request timeout in seconds</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Response time in milliseconds (0 if failed)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">proxy_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;http://</span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">proxies</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;http&#39;</span><span class="p">:</span> <span class="n">proxy_url</span><span class="p">,</span>
            <span class="s1">&#39;https&#39;</span><span class="p">:</span> <span class="n">proxy_url</span>
        <span class="p">}</span>
        
        <span class="c1"># Test URL - use a fast, reliable endpoint</span>
        <span class="n">test_urls</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;http://httpbin.org/ip&#39;</span><span class="p">,</span>
            <span class="s1">&#39;http://icanhazip.com&#39;</span><span class="p">,</span>
            <span class="s1">&#39;http://ipinfo.io/ip&#39;</span>
        <span class="p">]</span>
        
        <span class="k">for</span> <span class="n">test_url</span> <span class="ow">in</span> <span class="n">test_urls</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Testing proxy </span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2"> with </span><span class="si">{</span><span class="n">test_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">test_url</span><span class="p">,</span>
                    <span class="n">proxies</span><span class="o">=</span><span class="n">proxies</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
                    <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span> <span class="s1">&#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36&#39;</span><span class="p">}</span>
                <span class="p">)</span>
                
                <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                
                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                    <span class="n">response_time_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
                    <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Proxy </span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2"> responded in </span><span class="si">{</span><span class="n">response_time_ms</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">ms&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">response_time_ms</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Proxy </span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2"> returned status </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
            <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Proxy </span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2"> failed with </span><span class="si">{</span><span class="n">test_url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
        
        <span class="c1"># If all test URLs failed</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Proxy </span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2"> failed all connectivity tests&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error testing proxy </span><span class="si">{</span><span class="n">ip</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="load_proxy_config">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.load_proxy_config">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">load_proxy_config</span><span class="p">(</span><span class="n">proxy</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load proxy configuration from file or dict&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading proxy configuration from file: </span><span class="si">{</span><span class="n">proxy</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">proxy_config</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded proxy configuration from: </span><span class="si">{</span><span class="n">proxy</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Proxy config: </span><span class="si">{</span><span class="n">proxy_config</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">proxy_config</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading proxy configuration file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Attempting to fetch new proxy configuration...&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">get_free_proxies</span><span class="p">():</span>
                <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;Successfully fetched new proxy, retrying load...&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">proxy_config</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded new proxy configuration from: </span><span class="si">{</span><span class="n">proxy</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;New proxy config: </span><span class="si">{</span><span class="n">proxy_config</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">proxy_config</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">retry_e</span><span class="p">:</span>
                    <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading newly fetched proxy configuration: </span><span class="si">{</span><span class="n">retry_e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">error_print</span><span class="p">(</span><span class="s2">&quot;Failed to fetch new proxy configuration&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">proxy</span></div>


<div class="viewcode-block" id="test_proxy_telegram_connection">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.test_proxy_telegram_connection">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_proxy_telegram_connection</span><span class="p">(</span><span class="n">proxy_config</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test if a proxy can successfully connect to Telegram</span>
<span class="sd">    Based on OONI probe methodology for testing Telegram connectivity</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">proxy_config</span><span class="p">:</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;No proxy configuration provided for testing&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;No proxy configuration&quot;</span><span class="p">}</span>
    
    <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Testing proxy connection to Telegram: </span><span class="si">{</span><span class="n">proxy_config</span><span class="p">[</span><span class="s1">&#39;addr&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">proxy_config</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Telegram endpoints to test (similar to OONI probe)</span>
    <span class="n">telegram_endpoints</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;149.154.175.50&quot;</span><span class="p">,</span> <span class="mi">443</span><span class="p">),</span>  <span class="c1"># DC2 (primary)</span>
        <span class="p">(</span><span class="s2">&quot;149.154.167.51&quot;</span><span class="p">,</span> <span class="mi">443</span><span class="p">),</span>  <span class="c1"># DC4</span>
        <span class="p">(</span><span class="s2">&quot;149.154.175.100&quot;</span><span class="p">,</span> <span class="mi">443</span><span class="p">),</span> <span class="c1"># DC2 alt</span>
        <span class="p">(</span><span class="s2">&quot;95.161.76.100&quot;</span><span class="p">,</span> <span class="mi">443</span><span class="p">),</span>   <span class="c1"># DC1</span>
    <span class="p">]</span>
    
    <span class="c1"># Telegram web endpoints</span>
    <span class="n">telegram_web_endpoints</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;https://web.telegram.org&quot;</span><span class="p">,</span>
        <span class="s2">&quot;https://telegram.org&quot;</span><span class="p">,</span>
        <span class="s2">&quot;https://core.telegram.org&quot;</span>
    <span class="p">]</span>
    
    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;proxy&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">proxy_config</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">://</span><span class="si">{</span><span class="n">proxy_config</span><span class="p">[</span><span class="s1">&#39;addr&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">proxy_config</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tcp_connect&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s2">&quot;web_connectivity&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="kc">None</span>
    <span class="p">}</span>
    
    <span class="k">try</span><span class="p">:</span>
        
        <span class="c1"># Test 1: Direct TCP connection to Telegram servers</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;Testing TCP connections to Telegram servers...&quot;</span><span class="p">)</span>
        <span class="n">tcp_success_count</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">for</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">telegram_endpoints</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Testing TCP connection to </span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="c1"># Create socket connection through proxy</span>
                <span class="k">if</span> <span class="n">proxy_config</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;socks5&#39;</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">sock</span> <span class="o">=</span> <span class="n">socks</span><span class="o">.</span><span class="n">socksocket</span><span class="p">()</span>
                        <span class="n">sock</span><span class="o">.</span><span class="n">set_proxy</span><span class="p">(</span><span class="n">socks</span><span class="o">.</span><span class="n">SOCKS5</span><span class="p">,</span> <span class="n">proxy_config</span><span class="p">[</span><span class="s1">&#39;addr&#39;</span><span class="p">],</span> <span class="n">proxy_config</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">],</span>
                                        <span class="n">username</span><span class="o">=</span><span class="n">proxy_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">),</span>
                                        <span class="n">password</span><span class="o">=</span><span class="n">proxy_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">))</span>
                        <span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
                        <span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
                        <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;tcp_connect&quot;</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="s2">&quot;&lt; timeout&quot;</span><span class="p">}</span>
                        <span class="n">tcp_success_count</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; TCP connection successful to </span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                        <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;PySocks not available for SOCKS5 testing, skipping TCP test&quot;</span><span class="p">)</span>
                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;tcp_connect&quot;</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;PySocks not available&quot;</span><span class="p">}</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;tcp_connect&quot;</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
                        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; TCP connection failed to </span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># For HTTP proxies, we&#39;ll test via web connectivity instead</span>
                    <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping direct TCP test for HTTP proxy, will test via web connectivity&quot;</span><span class="p">)</span>
                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;tcp_connect&quot;</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;note&quot;</span><span class="p">:</span> <span class="s2">&quot;HTTP proxy - tested via web&quot;</span><span class="p">}</span>
                    
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;tcp_connect&quot;</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
                <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; TCP connection failed to </span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Test 2: Web connectivity to Telegram websites</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;Testing web connectivity to Telegram websites...&quot;</span><span class="p">)</span>
        <span class="n">web_success_count</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1"># Setup proxy for aiohttp</span>
        <span class="n">proxy_url</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">proxy_auth</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="k">if</span> <span class="n">proxy_config</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;http&#39;</span><span class="p">,</span> <span class="s1">&#39;https&#39;</span><span class="p">]:</span>
            <span class="n">proxy_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;http://</span><span class="si">{</span><span class="n">proxy_config</span><span class="p">[</span><span class="s1">&#39;addr&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">proxy_config</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">proxy_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">proxy_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">):</span>
                <span class="n">proxy_auth</span> <span class="o">=</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">BasicAuth</span><span class="p">(</span><span class="n">proxy_config</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span> <span class="n">proxy_config</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">proxy_config</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;socks5&#39;</span><span class="p">:</span>
            <span class="n">proxy_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;socks5://</span><span class="si">{</span><span class="n">proxy_config</span><span class="p">[</span><span class="s1">&#39;addr&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">proxy_config</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">proxy_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">proxy_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">):</span>
                <span class="n">proxy_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;socks5://</span><span class="si">{</span><span class="n">proxy_config</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">proxy_config</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">@</span><span class="si">{</span><span class="n">proxy_config</span><span class="p">[</span><span class="s1">&#39;addr&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">proxy_config</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        
        <span class="n">connector</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">proxy_url</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Try to create connector with proxy support</span>
                <span class="k">if</span> <span class="n">proxy_config</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;socks5&#39;</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">connector</span> <span class="o">=</span> <span class="n">ProxyConnector</span><span class="o">.</span><span class="n">from_url</span><span class="p">(</span><span class="n">proxy_url</span><span class="p">)</span>
                        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using SOCKS5 connector: </span><span class="si">{</span><span class="n">proxy_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                        <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;aiohttp-socks not available, falling back to basic connector&quot;</span><span class="p">)</span>
                        <span class="n">connector</span> <span class="o">=</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">TCPConnector</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">connector</span> <span class="o">=</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">TCPConnector</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating connector: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">connector</span> <span class="o">=</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">TCPConnector</span><span class="p">()</span>
        
        <span class="n">timeout_config</span> <span class="o">=</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientTimeout</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        
        <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">(</span>
            <span class="n">connector</span><span class="o">=</span><span class="n">connector</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_config</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            
            <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">telegram_web_endpoints</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Testing web connectivity to </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">start_time</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                    
                    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">if</span> <span class="n">proxy_url</span> <span class="ow">and</span> <span class="n">proxy_config</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;http&#39;</span><span class="p">,</span> <span class="s1">&#39;https&#39;</span><span class="p">]:</span>
                        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;proxy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">proxy_url</span>
                        <span class="k">if</span> <span class="n">proxy_auth</span><span class="p">:</span>
                            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;proxy_auth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">proxy_auth</span>
                    
                    <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
                        <span class="n">end_time</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                        <span class="n">response_time</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># ms</span>
                        
                        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                            <span class="c1"># Check if response contains Telegram-specific content</span>
                            <span class="n">content</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
                            <span class="n">telegram_indicators</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;telegram&#39;</span><span class="p">,</span> <span class="s1">&#39;Telegram&#39;</span><span class="p">,</span> <span class="s1">&#39;MTProto&#39;</span><span class="p">,</span> <span class="s1">&#39;telegram.org&#39;</span><span class="p">]</span>
                            <span class="n">has_telegram_content</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">indicator</span> <span class="ow">in</span> <span class="n">content</span> <span class="k">for</span> <span class="n">indicator</span> <span class="ow">in</span> <span class="n">telegram_indicators</span><span class="p">)</span>
                            
                            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;web_connectivity&quot;</span><span class="p">][</span><span class="n">url</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                <span class="s2">&quot;status_code&quot;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
                                <span class="s2">&quot;response_time_ms&quot;</span><span class="p">:</span> <span class="n">response_time</span><span class="p">,</span>
                                <span class="s2">&quot;has_telegram_content&quot;</span><span class="p">:</span> <span class="n">has_telegram_content</span>
                            <span class="p">}</span>
                            <span class="n">web_success_count</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Web connectivity successful to </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">response_time</span><span class="si">}</span><span class="s2">ms)&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;web_connectivity&quot;</span><span class="p">][</span><span class="n">url</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                <span class="s2">&quot;status_code&quot;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
                                <span class="s2">&quot;response_time_ms&quot;</span><span class="p">:</span> <span class="n">response_time</span><span class="p">,</span>
                                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;HTTP </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">}</span>
                            <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Web connectivity failed to </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">: HTTP </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            
                <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;web_connectivity&quot;</span><span class="p">][</span><span class="n">url</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Timeout&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;response_time_ms&quot;</span><span class="p">:</span> <span class="n">timeout</span> <span class="o">*</span> <span class="mi">1000</span>
                    <span class="p">}</span>
                    <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Web connectivity timeout to </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;web_connectivity&quot;</span><span class="p">][</span><span class="n">url</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="p">}</span>
                    <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Web connectivity failed to </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Determine overall success</span>
        <span class="n">total_tcp_tests</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;tcp_connect&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">])</span>
        <span class="n">total_web_tests</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">telegram_web_endpoints</span><span class="p">)</span>
        
        <span class="n">tcp_success_rate</span> <span class="o">=</span> <span class="n">tcp_success_count</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">total_tcp_tests</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">web_success_rate</span> <span class="o">=</span> <span class="n">web_success_count</span> <span class="o">/</span> <span class="n">total_web_tests</span>
        
        <span class="c1"># Consider proxy working if at least 50% of web tests pass</span>
        <span class="c1"># (TCP tests are optional depending on proxy type)</span>
        <span class="k">if</span> <span class="n">web_success_rate</span> <span class="o">&gt;=</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Proxy connectivity test PASSED - Web: </span><span class="si">{</span><span class="n">web_success_count</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total_web_tests</span><span class="si">}</span><span class="s2">, TCP: </span><span class="si">{</span><span class="n">tcp_success_count</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total_tcp_tests</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Low success rate - Web: </span><span class="si">{</span><span class="n">web_success_rate</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">, TCP: </span><span class="si">{</span><span class="n">tcp_success_rate</span><span class="si">:</span><span class="s2">.1%</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Proxy connectivity test FAILED - </span><span class="si">{</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">results</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Proxy test failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">error_print</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Proxy test exception: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">results</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">error_msg</span>
        <span class="k">return</span> <span class="n">results</span></div>


<div class="viewcode-block" id="test_and_select_working_proxy">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.test_and_select_working_proxy">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_and_select_working_proxy</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test multiple proxies in parallel and select the first working one for Telegram&quot;&quot;&quot;</span>
    <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Testing proxy connectivity to Telegram servers...&quot;</span><span class="p">)</span>
    
    <span class="c1"># First try to get fresh proxies</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">get_free_proxies</span><span class="p">():</span>
        <span class="n">error_print</span><span class="p">(</span><span class="s2">&quot;Failed to fetch proxy list&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="c1"># Load the proxy list</span>
    <span class="n">proxy_list_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">DEFAULT_PROXY_FILE</span><span class="p">)</span><span class="o">.</span><span class="n">with_name</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">Path</span><span class="p">(</span><span class="n">DEFAULT_PROXY_FILE</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span><span class="si">}{</span><span class="n">proxy_config</span><span class="o">.</span><span class="n">PROXY_LIST_SUFFIX</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">proxy_list_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">proxy_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="n">working_proxies</span> <span class="o">=</span> <span class="n">proxy_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;working&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">proxy_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;all_proxies&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">working_proxies</span><span class="p">:</span>
            <span class="n">error_print</span><span class="p">(</span><span class="s2">&quot;No proxies available for testing&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">test_proxy_list</span> <span class="o">=</span> <span class="n">working_proxies</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>
        
        <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Testing top </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">test_proxy_list</span><span class="p">)</span><span class="si">}</span><span class="s2"> fastest proxies for Telegram connectivity in parallel...&quot;</span><span class="p">)</span>
        <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Will use the first working proxy found...&quot;</span><span class="p">)</span>
        
        <span class="c1"># Create tasks for parallel testing</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_single_proxy</span><span class="p">(</span><span class="n">proxy_info</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Test a single proxy and return result with index&quot;&quot;&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">addr</span> <span class="o">=</span> <span class="n">proxy_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;addr&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">proxy_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ip&#39;</span><span class="p">)</span>
                <span class="n">port</span> <span class="o">=</span> <span class="n">proxy_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;port&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">addr</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">port</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">proxy_info</span>

                <span class="n">debug_print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Testing proxy </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">addr</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">proxy_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;country&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">) - </span><span class="si">{</span><span class="n">proxy_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;speed_ms&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">ms&quot;</span>
                <span class="p">)</span>

                <span class="n">candidate</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">proxy_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;http&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;addr&#39;</span><span class="p">:</span> <span class="n">addr</span><span class="p">,</span>
                    <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">port</span><span class="p">,</span>
                    <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">proxy_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">proxy_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">),</span>
                <span class="p">}</span>

                <span class="n">test_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">test_proxy_telegram_connection</span><span class="p">(</span><span class="n">candidate</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">test_result</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]:</span>
                    <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Proxy </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2"> WORKS: </span><span class="si">{</span><span class="n">addr</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">candidate</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">proxy_info</span>
                <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Proxy </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2"> failed: </span><span class="si">{</span><span class="n">test_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown error&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">proxy_info</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Proxy </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2"> error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">proxy_info</span>
        
        <span class="c1"># Create tasks for all proxies</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">test_single_proxy</span><span class="p">(</span><span class="n">proxy_info</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> 
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">proxy_info</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">test_proxy_list</span><span class="p">)</span>
        <span class="p">]</span>
        
        <span class="c1"># Convert coroutines to tasks for proper cancellation</span>
        <span class="n">actual_tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">coro</span><span class="p">)</span> <span class="k">for</span> <span class="n">coro</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">]</span>
        
        <span class="c1"># Run tasks in parallel and return when first one succeeds</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">as_completed</span><span class="p">(</span><span class="n">actual_tasks</span><span class="p">):</span>
                <span class="n">proxy_config</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">proxy_info</span> <span class="o">=</span> <span class="k">await</span> <span class="n">task</span>
                
                <span class="k">if</span> <span class="n">proxy_config</span><span class="p">:</span>  <span class="c1"># Found a working proxy</span>
                    <span class="n">addr</span> <span class="o">=</span> <span class="n">proxy_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;addr&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">proxy_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ip&#39;</span><span class="p">)</span>
                    <span class="n">port</span> <span class="o">=</span> <span class="n">proxy_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;port&#39;</span><span class="p">)</span>
                    <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selected working proxy: </span><span class="si">{</span><span class="n">addr</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">proxy_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;country&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                    
                    <span class="c1"># Cancel remaining tasks</span>
                    <span class="k">for</span> <span class="n">remaining_task</span> <span class="ow">in</span> <span class="n">actual_tasks</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">remaining_task</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
                            <span class="n">remaining_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
                    
                    <span class="c1"># Save the working proxy configuration</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">DEFAULT_PROXY_FILE</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">proxy_config</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

                    <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Working proxy configuration saved to: </span><span class="si">{</span><span class="n">DEFAULT_PROXY_FILE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">proxy_config</span>
            
            <span class="c1"># If we reach here, no working proxy was found</span>
            <span class="n">error_print</span><span class="p">(</span><span class="s2">&quot;No working proxies found for Telegram&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during parallel proxy testing: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parallel testing error: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
            
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error testing proxies: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Proxy testing error: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="test_telegram_connection">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.test_telegram_connection">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_telegram_connection</span><span class="p">(</span><span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span> <span class="n">phone_number</span><span class="p">,</span> <span class="n">session_file</span><span class="o">=</span><span class="n">SESSION_FILE</span><span class="p">,</span> <span class="n">proxy</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test connection to Telegram servers with comprehensive diagnostics</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        api_id: Your Telegram API ID</span>
<span class="sd">        api_hash: Your Telegram API hash</span>
<span class="sd">        phone_number: Your phone number (not used, kept for compatibility)</span>
<span class="sd">        session_file: Name of the session file</span>
<span class="sd">        proxy: Proxy configuration dict or file path</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TELEGRAM CONNECTION TEST&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
    
    <span class="c1"># Test 1: Proxy connectivity (if configured)</span>
    <span class="k">if</span> <span class="n">proxy</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Step 1: Testing proxy configuration...&quot;</span><span class="p">)</span>
        
        <span class="c1"># Load proxy configuration</span>
        <span class="n">proxy_config</span> <span class="o">=</span> <span class="n">load_proxy_config</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">proxy_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">error_print</span><span class="p">(</span><span class="s2">&quot; Failed to load proxy configuration&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using proxy: </span><span class="si">{</span><span class="n">proxy_config</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">://</span><span class="si">{</span><span class="n">proxy_config</span><span class="p">[</span><span class="s1">&#39;addr&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">proxy_config</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Test proxy connectivity to Telegram</span>
        <span class="n">proxy_test_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">test_proxy_telegram_connection</span><span class="p">(</span><span class="n">proxy_config</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">proxy_test_result</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Proxy connectivity: PASSED&quot;</span><span class="p">)</span>
            
            <span class="c1"># Show detailed proxy test results if verbose</span>
            <span class="k">if</span> <span class="n">verbose_mode</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    Proxy Test Details:&quot;</span><span class="p">)</span>
                <span class="n">tcp_results</span> <span class="o">=</span> <span class="n">proxy_test_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tcp_connect&#39;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">for</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">tcp_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;success&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2"> TCP </span><span class="si">{</span><span class="n">endpoint</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;OK&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="n">web_results</span> <span class="o">=</span> <span class="n">proxy_test_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;web_connectivity&#39;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">for</span> <span class="n">url</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">web_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;success&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                    <span class="n">time_info</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; (</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;response_time_ms&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">ms)&quot;</span> <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;response_time_ms&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2"> WEB </span><span class="si">{</span><span class="n">url</span><span class="si">}{</span><span class="n">time_info</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Proxy connectivity: FAILED&quot;</span><span class="p">)</span>
            <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Proxy test error: </span><span class="si">{</span><span class="n">proxy_test_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown error&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   Try running with --no-proxy to test direct connection&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Step 1: No proxy configured - testing direct connection&quot;</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">()</span>
    
    <span class="c1"># Test 2: Session file validation</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Step 2: Checking session file...&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">session_file</span><span class="p">):</span>
        <span class="n">file_size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">session_file</span><span class="p">)</span>
        <span class="n">file_age</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">session_file</span><span class="p">))</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Session file exists: </span><span class="si">{</span><span class="n">session_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    File size: </span><span class="si">{</span><span class="n">file_size</span><span class="si">}</span><span class="s2"> bytes&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Last modified: </span><span class="si">{</span><span class="n">file_age</span><span class="o">.</span><span class="n">days</span><span class="si">}</span><span class="s2"> days ago&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">file_size</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     Warning: Session file seems unusually small&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file_age</span><span class="o">.</span><span class="n">days</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     Warning: Session file is quite old, may need re-authentication&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Session file not found&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Expected location: </span><span class="si">{</span><span class="n">session_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   Run with --create-session to create a new session&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    
    <span class="nb">print</span><span class="p">()</span>
    
    <span class="c1"># Test 3: Telegram client connection</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Step 3: Testing Telegram client connection...&quot;</span><span class="p">)</span>
    
    <span class="c1"># Load proxy configuration</span>
    <span class="n">proxy_config</span> <span class="o">=</span> <span class="n">load_proxy_config</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span> <span class="k">if</span> <span class="n">proxy</span> <span class="k">else</span> <span class="kc">None</span>
    
    <span class="c1"># Create client</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">create_telegram_client</span><span class="p">(</span><span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span> <span class="n">session_file</span><span class="p">,</span> <span class="n">proxy_config</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Test connection</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        
        <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;Starting Telegram client for connection test...&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        
        <span class="n">connect_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Client connection: SUCCESSFUL (</span><span class="si">{</span><span class="n">connect_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s)&quot;</span><span class="p">)</span>
        
        <span class="c1"># Test authorization</span>
        <span class="k">if</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">is_user_authorized</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; User authorization: VALID&quot;</span><span class="p">)</span>
            
            <span class="c1"># Get user info</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">me</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get_me</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    User: </span><span class="si">{</span><span class="n">me</span><span class="o">.</span><span class="n">first_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">me</span><span class="o">.</span><span class="n">last_name</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2"> (@</span><span class="si">{</span><span class="n">me</span><span class="o">.</span><span class="n">username</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;no_username&#39;</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Phone: </span><span class="si">{</span><span class="n">me</span><span class="o">.</span><span class="n">phone</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;not_available&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    User ID: </span><span class="si">{</span><span class="n">me</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not get user info: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     User info: Could not retrieve&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; User authorization: EXPIRED&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   Run with --create-session to re-authenticate&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="nb">print</span><span class="p">()</span>
        
        <span class="c1"># Test 4: Bot connectivity</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Step 4: Testing bot connectivity...&quot;</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">bot_entity</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get_entity</span><span class="p">(</span><span class="n">BOT_USERNAME</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Bot resolution: Found @</span><span class="si">{</span><span class="n">BOT_USERNAME</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Bot ID: </span><span class="si">{</span><span class="n">bot_entity</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Bot Name: </span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="n">bot_entity</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;first_name&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Test sending a simple message</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    Testing message send...&quot;</span><span class="p">)</span>
            <span class="n">test_message</span> <span class="o">=</span> <span class="s2">&quot;/start&quot;</span>
            
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">BOT_USERNAME</span><span class="p">,</span> <span class="n">test_message</span><span class="p">)</span>
            <span class="n">send_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
            
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Message send: SUCCESSFUL (</span><span class="si">{</span><span class="n">send_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s)&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Message ID: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Wait briefly for potential reply</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    Waiting for bot response...&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            
            <span class="c1"># Check for recent messages</span>
            <span class="n">message_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">async</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">client</span><span class="o">.</span><span class="n">iter_messages</span><span class="p">(</span><span class="n">bot_entity</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;=</span> <span class="n">result</span><span class="o">.</span><span class="n">date</span><span class="p">:</span>
                    <span class="n">message_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">message_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Bot response: RECEIVED&quot;</span><span class="p">)</span>
                        <span class="n">response_text</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">text</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">text</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span> <span class="k">else</span> <span class="n">message</span><span class="o">.</span><span class="n">text</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Response: </span><span class="si">{</span><span class="n">response_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        
                        <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">reply_markup</span> <span class="ow">and</span> <span class="n">message</span><span class="o">.</span><span class="n">reply_markup</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
                            <span class="n">button_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">buttons</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">reply_markup</span><span class="o">.</span><span class="n">rows</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Buttons: </span><span class="si">{</span><span class="n">button_count</span><span class="si">}</span><span class="s2"> available&quot;</span><span class="p">)</span>
                    <span class="k">break</span>
            
            <span class="k">if</span> <span class="n">message_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Bot response: No immediate response (may be normal)&quot;</span><span class="p">)</span>
            
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Bot connectivity: FAILED&quot;</span><span class="p">)</span>
            <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bot test error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bot test exception: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">()</span>
        
        <span class="c1"># Test 5: Network performance</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Step 5: Network performance test...&quot;</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Test multiple small operations</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="n">operations</span> <span class="o">=</span> <span class="mi">0</span>
            
            <span class="c1"># Get dialogs (conversations)</span>
            <span class="k">async</span> <span class="k">for</span> <span class="n">dialog</span> <span class="ow">in</span> <span class="n">client</span><span class="o">.</span><span class="n">iter_dialogs</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
                <span class="n">operations</span> <span class="o">+=</span> <span class="mi">1</span>
            
            <span class="n">performance_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="n">performance_time</span> <span class="o">&lt;</span> <span class="mf">2.0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Network performance: EXCELLENT (</span><span class="si">{</span><span class="n">performance_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s for </span><span class="si">{</span><span class="n">operations</span><span class="si">}</span><span class="s2"> ops)&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">performance_time</span> <span class="o">&lt;</span> <span class="mf">5.0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Network performance: GOOD (</span><span class="si">{</span><span class="n">performance_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s for </span><span class="si">{</span><span class="n">operations</span><span class="si">}</span><span class="s2"> ops)&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">performance_time</span> <span class="o">&lt;</span> <span class="mf">10.0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Network performance: SLOW (</span><span class="si">{</span><span class="n">performance_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s for </span><span class="si">{</span><span class="n">operations</span><span class="si">}</span><span class="s2"> ops)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Network performance: VERY SLOW (</span><span class="si">{</span><span class="n">performance_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s for </span><span class="si">{</span><span class="n">operations</span><span class="si">}</span><span class="s2"> ops)&quot;</span><span class="p">)</span>
                
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Network performance: Could not test (</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Client connection: FAILED&quot;</span><span class="p">)</span>
        <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection test error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection test exception: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Provide troubleshooting suggestions</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Troubleshooting suggestions:&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;proxy&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    Check proxy configuration and connectivity&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    Try with --no-proxy for direct connection&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;auth&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;login&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    Run with --create-session to re-authenticate&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;network&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;timeout&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    Check your internet connection&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    Try using a proxy with --proxy-config-file&quot;</span><span class="p">)</span>
        
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;Disconnecting client after connection test...&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
    
    <span class="nb">print</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CONNECTION TEST COMPLETED&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="decide_proxy_usage">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.decide_proxy_usage">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">decide_proxy_usage</span><span class="p">(</span><span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span> <span class="n">phone_number</span><span class="p">,</span> <span class="n">session_file</span><span class="o">=</span><span class="n">SESSION_FILE</span><span class="p">,</span> <span class="n">proxy_file</span><span class="o">=</span><span class="n">DEFAULT_PROXY_FILE</span><span class="p">,</span> <span class="n">print_result</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decide whether to use a proxy for Telegram connection.</span>
<span class="sd">    If connection works without proxy, return None (no proxy).</span>
<span class="sd">    If not, try default proxy file. If that fails, select a new proxy and try again.</span>
<span class="sd">    Returns:</span>
<span class="sd">        None if no proxy needed,</span>
<span class="sd">        proxy_file if proxy is needed,</span>
<span class="sd">        False if neither works.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">print_result</span><span class="p">:</span>
        <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Testing Telegram connection without proxy...&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">create_telegram_client</span><span class="p">(</span><span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span> <span class="n">session_file</span><span class="p">,</span> <span class="n">proxy</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">phone</span><span class="o">=</span><span class="n">phone_number</span> <span class="k">if</span> <span class="n">phone_number</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">is_auth</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">is_user_authorized</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">is_auth</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">print_result</span><span class="p">:</span>
                <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Direct connection to Telegram works. Proxy is not needed.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">print_result</span><span class="p">:</span>
                <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Direct connection failed (not authorized). Trying default proxy configuration...&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">print_result</span><span class="p">:</span>
            <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Direct connection failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Trying default proxy configuration...&quot;</span><span class="p">)</span>

    <span class="c1"># Try default proxy file if it exists</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">proxy_file</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">proxy_config</span> <span class="o">=</span> <span class="n">load_proxy_config</span><span class="p">(</span><span class="n">proxy_file</span><span class="p">)</span>
            <span class="n">client</span> <span class="o">=</span> <span class="n">create_telegram_client</span><span class="p">(</span><span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span> <span class="n">session_file</span><span class="p">,</span> <span class="n">proxy_config</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">phone</span><span class="o">=</span><span class="n">phone_number</span> <span class="k">if</span> <span class="n">phone_number</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">is_auth</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">is_user_authorized</span><span class="p">()</span>
            <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">is_auth</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">print_result</span><span class="p">:</span>
                    <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Connection via default proxy works. Proxy will be used.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">proxy_file</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">print_result</span><span class="p">:</span>
                    <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Connection failed with default proxy (not authorized). Will try to find a new working proxy...&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">print_result</span><span class="p">:</span>
                <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection failed with default proxy: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Will try to find a new working proxy...&quot;</span><span class="p">)</span>

    <span class="c1"># Try to find a new working proxy</span>
    <span class="n">working_proxy</span> <span class="o">=</span> <span class="k">await</span> <span class="n">test_and_select_working_proxy</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">working_proxy</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">print_result</span><span class="p">:</span>
            <span class="n">error_print</span><span class="p">(</span><span class="s2">&quot;Could not find a working proxy for Telegram&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">proxy_config</span> <span class="o">=</span> <span class="n">load_proxy_config</span><span class="p">(</span><span class="n">proxy_file</span><span class="p">)</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">create_telegram_client</span><span class="p">(</span><span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span> <span class="n">session_file</span><span class="p">,</span> <span class="n">proxy_config</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">phone</span><span class="o">=</span><span class="n">phone_number</span> <span class="k">if</span> <span class="n">phone_number</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">is_auth</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">is_user_authorized</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">is_auth</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">print_result</span><span class="p">:</span>
                <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Connection via new proxy works. Proxy will be used.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">proxy_file</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">print_result</span><span class="p">:</span>
                <span class="n">error_print</span><span class="p">(</span><span class="s2">&quot;Connection failed with new proxy (not authorized).&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">print_result</span><span class="p">:</span>
            <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection failed with new proxy: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="create_telegram_client">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.create_telegram_client">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_telegram_client</span><span class="p">(</span><span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span> <span class="n">session_file</span><span class="o">=</span><span class="n">SESSION_FILE</span><span class="p">,</span> <span class="n">proxy</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create TelegramClient with or without proxy&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">proxy</span><span class="p">:</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using proxy: </span><span class="si">{</span><span class="n">proxy</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">://</span><span class="si">{</span><span class="n">proxy</span><span class="p">[</span><span class="s1">&#39;addr&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">proxy</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">proxy</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;socks5&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">TelegramClient</span><span class="p">(</span>
                <span class="n">session_file</span><span class="p">,</span> <span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span>
                <span class="n">proxy</span><span class="o">=</span><span class="p">(</span><span class="n">proxy</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span> <span class="n">proxy</span><span class="p">[</span><span class="s1">&#39;addr&#39;</span><span class="p">],</span> <span class="n">proxy</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">],</span> 
                       <span class="n">proxy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">),</span> <span class="n">proxy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">)),</span>
                <span class="n">connection</span><span class="o">=</span><span class="n">connection</span><span class="o">.</span><span class="n">ConnectionTcpMTProxyRandomizedIntermediate</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># http proxy</span>
            <span class="k">return</span> <span class="n">TelegramClient</span><span class="p">(</span>
                <span class="n">session_file</span><span class="p">,</span> <span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span>
                <span class="n">proxy</span><span class="o">=</span><span class="p">(</span><span class="n">proxy</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span> <span class="n">proxy</span><span class="p">[</span><span class="s1">&#39;addr&#39;</span><span class="p">],</span> <span class="n">proxy</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">],</span>
                       <span class="n">proxy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">),</span> <span class="n">proxy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">))</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">TelegramClient</span><span class="p">(</span><span class="n">session_file</span><span class="p">,</span> <span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">)</span></div>


<div class="viewcode-block" id="extract_button_info">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.extract_button_info">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_button_info</span><span class="p">(</span><span class="n">reply_markup</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract button information from reply markup&quot;&quot;&quot;</span>
    <span class="n">buttons</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">reply_markup</span><span class="p">:</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;Processing reply markup buttons...&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row_idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reply_markup</span><span class="o">.</span><span class="n">rows</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">btn_idx</span><span class="p">,</span> <span class="n">button</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">buttons</span><span class="p">):</span>
                <span class="n">button_info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">button</span><span class="o">.</span><span class="n">text</span><span class="p">}</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">button</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">button</span><span class="o">.</span><span class="n">url</span><span class="p">:</span>
                    <span class="n">button_info</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">button</span><span class="o">.</span><span class="n">url</span>
                    <span class="n">button_info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;url&quot;</span>
                    <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Button </span><span class="si">{</span><span class="n">row_idx</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">btn_idx</span><span class="si">}</span><span class="s2">: URL button &#39;</span><span class="si">{</span><span class="n">button</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&#39; -&gt; </span><span class="si">{</span><span class="n">button</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">button</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">):</span>
                    <span class="n">button_info</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">button</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="k">if</span> <span class="n">button</span><span class="o">.</span><span class="n">data</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="n">button_info</span><span class="p">[</span><span class="s2">&quot;callback_data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">button</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="k">if</span> <span class="n">button</span><span class="o">.</span><span class="n">data</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="n">button_info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;callback&quot;</span>
                    <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Button </span><span class="si">{</span><span class="n">row_idx</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">btn_idx</span><span class="si">}</span><span class="s2">: Callback button &#39;</span><span class="si">{</span><span class="n">button</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&#39; -&gt; </span><span class="si">{</span><span class="n">button_info</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">button_info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;keyboard&quot;</span>
                    <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Button </span><span class="si">{</span><span class="n">row_idx</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">btn_idx</span><span class="si">}</span><span class="s2">: Keyboard button &#39;</span><span class="si">{</span><span class="n">button</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                <span class="n">buttons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">button_info</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">buttons</span></div>


<div class="viewcode-block" id="create_message_handler">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.create_message_handler">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_message_handler</span><span class="p">(</span><span class="n">bot_entity</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create message handler for bot replies&quot;&quot;&quot;</span>
    <span class="n">bot_reply</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handler</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
        <span class="k">nonlocal</span> <span class="n">bot_reply</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received message from bot: ID=</span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">, Text=</span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">text</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        
        <span class="n">buttons</span> <span class="o">=</span> <span class="n">extract_button_info</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_markup</span><span class="p">)</span>
        
        <span class="n">bot_reply</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;message_id&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">timestamp</span><span class="p">(),</span>
            <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
            <span class="s2">&quot;buttons&quot;</span><span class="p">:</span> <span class="n">buttons</span>
        <span class="p">}</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bot reply captured: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">buttons</span><span class="p">)</span><span class="si">}</span><span class="s2"> buttons found&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">handler</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">bot_reply</span></div>


<div class="viewcode-block" id="wait_for_reply">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.wait_for_reply">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">wait_for_reply</span><span class="p">(</span><span class="n">get_bot_reply</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Wait for bot reply with timeout&quot;&quot;&quot;</span>
    <span class="n">elapsed</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;Waiting for bot reply...&quot;</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">get_bot_reply</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">elapsed</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">elapsed</span> <span class="o">+=</span> <span class="mf">0.1</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">elapsed</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="n">elapsed</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">):</span>  <span class="c1"># Print every second</span>
            <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting for reply... </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">elapsed</span><span class="p">)</span><span class="si">}</span><span class="s2">s / </span><span class="si">{</span><span class="n">timeout</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">elapsed</span><span class="p">)</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Print progress every 5 seconds</span>
                <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Still waiting... </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">elapsed</span><span class="p">)</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">get_bot_reply</span><span class="p">()</span></div>


<div class="viewcode-block" id="handle_search_message">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.handle_search_message">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_search_message</span><span class="p">(</span><span class="n">get_bot_reply</span><span class="p">,</span> <span class="n">set_bot_reply</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle &#39;searching...&#39; message and wait for actual result&quot;&quot;&quot;</span>
    <span class="n">bot_reply</span> <span class="o">=</span> <span class="n">get_bot_reply</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">bot_reply</span> <span class="ow">and</span> <span class="s2">&quot;searching...&quot;</span> <span class="ow">in</span> <span class="n">bot_reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;Searching by Nexus bot, waiting for final result...&quot;</span><span class="p">)</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;Detected &#39;searching...&#39; message, resetting bot_reply to wait for actual result&quot;</span><span class="p">)</span>
        <span class="n">set_bot_reply</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>  <span class="c1"># Reset to wait for the next message</span>
        
        <span class="c1"># Wait for the actual search result (extended timeout)</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">wait_for_reply</span><span class="p">(</span><span class="n">get_bot_reply</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">bot_reply</span></div>


<div class="viewcode-block" id="fetch_recent_messages">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.fetch_recent_messages">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">fetch_recent_messages</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">bot_entity</span><span class="p">,</span> <span class="n">sent_message</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fetch recent messages from bot if no immediate reply&quot;&quot;&quot;</span>
    <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;No immediate reply received, checking for recent messages...&quot;</span><span class="p">)</span>
    <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;Attempting to fetch recent messages from bot...&quot;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># Wait a bit more</span>
    
    <span class="n">message_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">seen_messages</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># Track message IDs to avoid duplicates</span>
    
    <span class="k">async</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">client</span><span class="o">.</span><span class="n">iter_messages</span><span class="p">(</span><span class="n">bot_entity</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">message_count</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c1"># Skip if we&#39;ve already processed this message</span>
        <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">seen_messages</span><span class="p">:</span>
            <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping duplicate message ID: </span><span class="si">{</span><span class="n">message</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
        
        <span class="n">seen_messages</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Checking message </span><span class="si">{</span><span class="n">message_count</span><span class="si">}</span><span class="s2">: ID=</span><span class="si">{</span><span class="n">message</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">, Date=</span><span class="si">{</span><span class="n">message</span><span class="o">.</span><span class="n">date</span><span class="si">}</span><span class="s2">, Text=</span><span class="si">{</span><span class="n">message</span><span class="o">.</span><span class="n">text</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        
        <span class="c1"># Check if this message is newer than our sent message</span>
        <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;=</span> <span class="n">sent_message</span><span class="o">.</span><span class="n">date</span><span class="p">:</span>
            <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;Found newer message from bot!&quot;</span><span class="p">)</span>
            <span class="n">buttons</span> <span class="o">=</span> <span class="n">extract_button_info</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">reply_markup</span><span class="p">)</span>
            
            <span class="n">bot_reply</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;message_id&quot;</span><span class="p">:</span> <span class="n">message</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="n">message</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">timestamp</span><span class="p">(),</span>
                <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">message</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
                <span class="s2">&quot;buttons&quot;</span><span class="p">:</span> <span class="n">buttons</span>
            <span class="p">}</span>
            <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;Found recent message from bot!&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">bot_reply</span>
    
    <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No newer messages found among </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">seen_messages</span><span class="p">)</span><span class="si">}</span><span class="s2"> unique recent messages&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="click_callback_button">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.click_callback_button">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">click_callback_button</span><span class="p">(</span><span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span> <span class="n">phone_number</span><span class="p">,</span> <span class="n">bot_username</span><span class="p">,</span> <span class="n">message_id</span><span class="p">,</span> <span class="n">button_data</span><span class="p">,</span> <span class="n">session_file</span><span class="o">=</span><span class="n">SESSION_FILE</span><span class="p">,</span> <span class="n">proxy</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Click a callback button in a bot&#39;s message</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        api_id: Your Telegram API ID</span>
<span class="sd">        api_hash: Your Telegram API hash</span>
<span class="sd">        phone_number: Your phone number (not used, kept for compatibility)</span>
<span class="sd">        bot_username: Bot&#39;s username</span>
<span class="sd">        message_id: ID of the message containing the button</span>
<span class="sd">        button_data: The callback data of the button to click</span>
<span class="sd">        session_file: Name of the session file</span>
<span class="sd">        proxy: Proxy configuration dict with keys: type, addr, port, username, password</span>
<span class="sd">               Example: {&#39;type&#39;: &#39;http&#39;, &#39;addr&#39;: &#39;127.0.0.1&#39;, &#39;port&#39;: 8080}</span>
<span class="sd">               or {&#39;type&#39;: &#39;socks5&#39;, &#39;addr&#39;: &#39;127.0.0.1&#39;, &#39;port&#39;: 1080, &#39;username&#39;: &#39;user&#39;, &#39;password&#39;: &#39;pass&#39;}</span>
<span class="sd">               or string path to JSON file containing proxy configuration</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Clicking callback button: message_id=</span><span class="si">{</span><span class="n">message_id</span><span class="si">}</span><span class="s2">, button_data=</span><span class="si">{</span><span class="n">button_data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Load proxy configuration</span>
    <span class="n">proxy_config</span> <span class="o">=</span> <span class="n">load_proxy_config</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">proxy</span> <span class="ow">and</span> <span class="n">proxy_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Error loading proxy configuration&quot;</span><span class="p">}</span>
    
    <span class="c1"># Create client with or without proxy</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">create_telegram_client</span><span class="p">(</span><span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span> <span class="n">session_file</span><span class="p">,</span> <span class="n">proxy_config</span><span class="p">)</span>
    <span class="n">bot_reply</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">session_file</span><span class="p">):</span>
            <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Session file not found: </span><span class="si">{</span><span class="n">session_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Session file not found. Run script interactively first to create session.&quot;</span><span class="p">}</span>
        
        <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;Starting client for button click...&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">proxy_config</span><span class="p">:</span>
            <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connecting through proxy for button click: </span><span class="si">{</span><span class="n">proxy_config</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">://</span><span class="si">{</span><span class="n">proxy_config</span><span class="p">[</span><span class="s1">&#39;addr&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">proxy_config</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">is_user_authorized</span><span class="p">():</span>
            <span class="n">error_print</span><span class="p">(</span><span class="s2">&quot;Session expired or not authorized&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Session expired. Please delete the session file and run interactively to re-authenticate.&quot;</span><span class="p">}</span>
        
        <span class="c1"># Get the bot entity</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Getting bot entity: </span><span class="si">{</span><span class="n">bot_username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">bot_entity</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get_entity</span><span class="p">(</span><span class="n">bot_username</span><span class="p">)</span>
        
        <span class="c1"># Handler for incoming messages from the bot after button click</span>
        <span class="nd">@client</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">events</span><span class="o">.</span><span class="n">NewMessage</span><span class="p">(</span><span class="n">from_users</span><span class="o">=</span><span class="n">bot_entity</span><span class="p">))</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">message_handler</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
            <span class="k">nonlocal</span> <span class="n">bot_reply</span>
            <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received response after button click: </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">text</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
            <span class="n">buttons</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_markup</span><span class="p">:</span>
                <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;Processing reply markup after button click...&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">event</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_markup</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">button</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">buttons</span><span class="p">:</span>
                        <span class="n">button_info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">button</span><span class="o">.</span><span class="n">text</span><span class="p">}</span>
                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">button</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">button</span><span class="o">.</span><span class="n">url</span><span class="p">:</span>
                            <span class="n">button_info</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">button</span><span class="o">.</span><span class="n">url</span>
                            <span class="n">button_info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;url&quot;</span>
                        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">button</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">):</span>
                            <span class="n">button_info</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">button</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="k">if</span> <span class="n">button</span><span class="o">.</span><span class="n">data</span> <span class="k">else</span> <span class="kc">None</span>
                            <span class="n">button_info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;callback&quot;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">button_info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;keyboard&quot;</span>
                        <span class="n">buttons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">button_info</span><span class="p">)</span>
            
            <span class="n">bot_reply</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;message_id&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">timestamp</span><span class="p">(),</span>
                <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
                <span class="s2">&quot;buttons&quot;</span><span class="p">:</span> <span class="n">buttons</span>
            <span class="p">}</span>
        
        <span class="c1"># Click the callback button using the correct method</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;Executing callback button click...&quot;</span><span class="p">)</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">telethon.tl.functions.messages</span><span class="w"> </span><span class="kn">import</span> <span class="n">GetBotCallbackAnswerRequest</span>

        <span class="k">await</span> <span class="n">client</span><span class="p">(</span><span class="n">GetBotCallbackAnswerRequest</span><span class="p">(</span>
            <span class="n">peer</span><span class="o">=</span><span class="n">bot_entity</span><span class="p">,</span>
            <span class="n">msg_id</span><span class="o">=</span><span class="n">message_id</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">button_data</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">button_data</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">button_data</span>
        <span class="p">))</span>
        <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Callback button clicked successfully&quot;</span><span class="p">)</span>
        
        <span class="c1"># Wait for bot reply (timeout after 30 seconds)</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="n">elapsed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">bot_reply</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">elapsed</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
            <span class="n">elapsed</span> <span class="o">+=</span> <span class="mf">0.1</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">elapsed</span><span class="p">)</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">elapsed</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="n">elapsed</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">):</span>
                <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting for response after button click... </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">elapsed</span><span class="p">)</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
        
        <span class="c1"># If no immediate reply, check for recent messages</span>
        <span class="k">if</span> <span class="n">bot_reply</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;No immediate response, checking recent messages...&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            
            <span class="k">async</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">client</span><span class="o">.</span><span class="n">iter_messages</span><span class="p">(</span><span class="n">bot_entity</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
                <span class="c1"># Ensure both datetimes are timezone-aware for comparison</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">tzinfo</span><span class="p">)</span> <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">tzinfo</span> <span class="k">else</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">date</span> <span class="o">&gt;</span> <span class="n">now</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">35</span><span class="p">):</span>  <span class="c1"># Messages from last 35 seconds</span>
                    <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found recent message: </span><span class="si">{</span><span class="n">message</span><span class="o">.</span><span class="n">text</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
                    <span class="n">buttons</span> <span class="o">=</span> <span class="p">[]</span>
                    
                    <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">reply_markup</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">reply_markup</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">button</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">buttons</span><span class="p">:</span>
                                <span class="n">button_info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">button</span><span class="o">.</span><span class="n">text</span><span class="p">}</span>
                                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">button</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">button</span><span class="o">.</span><span class="n">url</span><span class="p">:</span>
                                    <span class="n">button_info</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">button</span><span class="o">.</span><span class="n">url</span>
                                    <span class="n">button_info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;url&quot;</span>
                                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">button</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">):</span>
                                    <span class="n">button_info</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">button</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="k">if</span> <span class="n">button</span><span class="o">.</span><span class="n">data</span> <span class="k">else</span> <span class="kc">None</span>
                                    <span class="n">button_info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;callback&quot;</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">button_info</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;keyboard&quot;</span>
                                <span class="n">buttons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">button_info</span><span class="p">)</span>
                    
                    <span class="n">bot_reply</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;message_id&quot;</span><span class="p">:</span> <span class="n">message</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                        <span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="n">message</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">timestamp</span><span class="p">(),</span>
                        <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">message</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
                        <span class="s2">&quot;buttons&quot;</span><span class="p">:</span> <span class="n">buttons</span>
                    <span class="p">}</span>
                    <span class="k">break</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;button_clicked&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;message_id&quot;</span><span class="p">:</span> <span class="n">message_id</span><span class="p">,</span>
                <span class="s2">&quot;button_data&quot;</span><span class="p">:</span> <span class="n">button_data</span>
            <span class="p">},</span>
            <span class="s2">&quot;bot_reply&quot;</span><span class="p">:</span> <span class="n">bot_reply</span>
        <span class="p">}</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;Button click operation completed successfully&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error clicking button: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Button click exception: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Error clicking button: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;Disconnecting client after button click...&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span></div>


<div class="viewcode-block" id="send_message_to_bot">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.send_message_to_bot">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">send_message_to_bot</span><span class="p">(</span><span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span> <span class="n">phone_number</span><span class="p">,</span> <span class="n">bot_username</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">session_file</span><span class="o">=</span><span class="n">SESSION_FILE</span><span class="p">,</span> <span class="n">proxy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Send a message from your user account to a Telegram bot and wait for its reply.</span>

<span class="sd">    Args:</span>
<span class="sd">        api_id: Your Telegram API ID (get from my.telegram.org)</span>
<span class="sd">        api_hash: Your Telegram API hash</span>
<span class="sd">        phone_number: Your phone number</span>
<span class="sd">        bot_username: Bot&#39;s username (e.g., &#39;your_bot_name&#39;)</span>
<span class="sd">        message: Message text to send (search query or DOI)</span>
<span class="sd">        session_file: Name of the session file to save/load</span>
<span class="sd">        proxy: Proxy configuration dict or file path (see create_telegram_client)</span>
<span class="sd">        limit: Maximum number of search results to fetch (default: 1 for DOI, 5 for search; can be set by user)</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: {</span>
<span class="sd">            &quot;ok&quot;: True if successful, False or &quot;error&quot; key otherwise,</span>
<span class="sd">            &quot;sent_message&quot;: {</span>
<span class="sd">                &quot;message_id&quot;: int,</span>
<span class="sd">                &quot;date&quot;: float (timestamp),</span>
<span class="sd">                &quot;text&quot;: str</span>
<span class="sd">            },</span>
<span class="sd">            &quot;bot_reply&quot;: {</span>
<span class="sd">                &quot;message_id&quot;: int,</span>
<span class="sd">                &quot;date&quot;: float (timestamp),</span>
<span class="sd">                &quot;text&quot;: str,  # reply text, possibly concatenated for search</span>
<span class="sd">                &quot;buttons&quot;: list of dicts with button info (text, type, callback_data/url)</span>
<span class="sd">            }</span>
<span class="sd">        }</span>
<span class="sd">        If an error occurs, returns {&quot;error&quot;: &quot;...&quot;}.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initializing TelegramClient with session file: </span><span class="si">{</span><span class="n">session_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Load proxy configuration</span>
    <span class="n">proxy_config</span> <span class="o">=</span> <span class="n">load_proxy_config</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">proxy</span> <span class="ow">and</span> <span class="n">proxy_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Error loading proxy configuration&quot;</span><span class="p">}</span>

    <span class="c1"># Create client</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">create_telegram_client</span><span class="p">(</span><span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span> <span class="n">session_file</span><span class="p">,</span> <span class="n">proxy_config</span><span class="p">)</span>

    <span class="c1"># Define all result markers</span>
    <span class="n">result_markers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot; **&quot;</span><span class="p">,</span> <span class="s2">&quot; **&quot;</span><span class="p">,</span> <span class="s2">&quot; **&quot;</span><span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Check if session file exists</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Checking for session file: </span><span class="si">{</span><span class="n">session_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">session_file</span><span class="p">):</span>
            <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Session file &#39;</span><span class="si">{</span><span class="n">session_file</span><span class="si">}</span><span class="s2">&#39; not found!&quot;</span><span class="p">)</span>
            <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;You need to create a session first by running this script interactively once.&quot;</span><span class="p">)</span>
            <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;After that, the session will be saved and you can run without manual input.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Session file not found. Run script interactively first to create session.&quot;</span><span class="p">}</span>

        <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;Using cached session...&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">proxy_config</span><span class="p">:</span>
            <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connecting through proxy: </span><span class="si">{</span><span class="n">proxy_config</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">://</span><span class="si">{</span><span class="n">proxy_config</span><span class="p">[</span><span class="s1">&#39;addr&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">proxy_config</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;Starting Telegram client...&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;Client started successfully&quot;</span><span class="p">)</span>

        <span class="c1"># Verify we&#39;re connected</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;Checking user authorization...&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">is_user_authorized</span><span class="p">():</span>
            <span class="n">error_print</span><span class="p">(</span><span class="s2">&quot;Session expired or not authorized&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Session expired. Please delete the session file and run interactively to re-authenticate.&quot;</span><span class="p">}</span>

        <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;User authorized successfully&quot;</span><span class="p">)</span>

        <span class="c1"># Get the bot entity</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Getting bot entity for: </span><span class="si">{</span><span class="n">bot_username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">bot_entity</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get_entity</span><span class="p">(</span><span class="n">bot_username</span><span class="p">)</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bot entity retrieved: </span><span class="si">{</span><span class="n">bot_entity</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Create message handler</span>
        <span class="c1"># Set up handler closure for getting and setting bot_reply</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">create_setter</span><span class="p">():</span>
            <span class="n">bot_reply_value</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>

            <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">new_handler</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
                <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received message from bot: ID=</span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">, Text=</span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">text</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

                <span class="n">buttons</span> <span class="o">=</span> <span class="n">extract_button_info</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">reply_markup</span><span class="p">)</span>

                <span class="n">bot_reply_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;message_id&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">timestamp</span><span class="p">(),</span>
                    <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
                    <span class="s2">&quot;buttons&quot;</span><span class="p">:</span> <span class="n">buttons</span>
                <span class="p">}</span>
                <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bot reply captured: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">buttons</span><span class="p">)</span><span class="si">}</span><span class="s2"> buttons found&quot;</span><span class="p">)</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">get_reply</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">bot_reply_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">set_reply</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="n">bot_reply_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

            <span class="k">return</span> <span class="n">new_handler</span><span class="p">,</span> <span class="n">get_reply</span><span class="p">,</span> <span class="n">set_reply</span>

        <span class="n">handler</span><span class="p">,</span> <span class="n">get_bot_reply</span><span class="p">,</span> <span class="n">set_bot_reply</span> <span class="o">=</span> <span class="n">create_setter</span><span class="p">()</span>
        <span class="n">client</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">events</span><span class="o">.</span><span class="n">NewMessage</span><span class="p">(</span><span class="n">from_users</span><span class="o">=</span><span class="n">bot_entity</span><span class="p">))(</span><span class="n">handler</span><span class="p">)</span>

        <span class="c1"># Determine if message is a DOI</span>
        <span class="n">is_doi</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^10\.\d+/.+&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>
        <span class="c1"># Use user-specified limit if provided, else default logic</span>
        <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">reply_limit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reply_limit</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">is_doi</span> <span class="k">else</span> <span class="mi">5</span>

        <span class="c1"># Check if message is a command (starts with / and is not a DOI)</span>
        <span class="n">is_command</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_doi</span>

        <span class="c1"># Send message to the bot</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sending message to bot: &#39;</span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">bot_username</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Message sent successfully. Message ID: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Wait for bot reply</span>
        <span class="n">bot_reply</span> <span class="o">=</span> <span class="k">await</span> <span class="n">wait_for_reply</span><span class="p">(</span><span class="n">get_bot_reply</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
        <span class="n">bot_reply</span> <span class="o">=</span> <span class="k">await</span> <span class="n">handle_search_message</span><span class="p">(</span><span class="n">get_bot_reply</span><span class="p">,</span> <span class="n">set_bot_reply</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bot_reply</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bot_reply</span> <span class="o">=</span> <span class="k">await</span> <span class="n">fetch_recent_messages</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">bot_entity</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>

        <span class="c1"># If message is a command, just return the reply as is</span>
        <span class="k">if</span> <span class="n">is_command</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">bot_reply</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s2">&quot;sent_message&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;message_id&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                        <span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">timestamp</span><span class="p">(),</span>
                        <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">text</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;bot_reply&quot;</span><span class="p">:</span> <span class="n">bot_reply</span>
                <span class="p">}</span>
                <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Command response prepared. Bot reply: </span><span class="si">{</span><span class="n">bot_reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;No text&#39;</span><span class="p">)[:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">response</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;No reply received from bot for command.&quot;</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">is_doi</span><span class="p">:</span>
            <span class="c1"># Handle DOI: just return the first reply</span>
            <span class="k">if</span> <span class="n">bot_reply</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s2">&quot;sent_message&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;message_id&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                        <span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">timestamp</span><span class="p">(),</span>
                        <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">text</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;bot_reply&quot;</span><span class="p">:</span> <span class="n">bot_reply</span>
                <span class="p">}</span>
                <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DOI response prepared. Bot reply: </span><span class="si">{</span><span class="n">bot_reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;No text&#39;</span><span class="p">)[:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">response</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;No reply received from bot for DOI.&quot;</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Handle search (not DOI)</span>
            <span class="n">bot_replies</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">bot_reply</span><span class="p">:</span>
                <span class="n">bot_replies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bot_reply</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;No reply received from bot for search.&quot;</span><span class="p">}</span>

            <span class="c1"># --- Extract total number of results from Nexus reply ---</span>
            <span class="n">total_results</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">bot_reply</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bot_reply</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">bot_reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;__([\d,]+)\s+results__&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                    <span class="n">total_results_str</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">total_results</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">total_results_str</span><span class="p">)</span>
                        <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total results found in Nexus: </span><span class="si">{</span><span class="n">total_results</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total results found in Nexus: </span><span class="si">{</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;Could not extract total results from bot reply text.&quot;</span><span class="p">)</span>

            <span class="c1"># Try to determine the number of current results from the text</span>
            <span class="n">n_results</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">bot_reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">marker</span><span class="p">)</span> <span class="k">for</span> <span class="n">marker</span> <span class="ow">in</span> <span class="n">result_markers</span><span class="p">)</span>
            <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detected </span><span class="si">{</span><span class="n">n_results</span><span class="si">}</span><span class="s2"> search results in bot reply text using markers </span><span class="si">{</span><span class="n">result_markers</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># If the number of results already exceeds the limit, stop here</span>
            <span class="k">if</span> <span class="n">n_results</span> <span class="o">&gt;=</span> <span class="n">reply_limit</span><span class="p">:</span>
                <span class="c1"># Split by all markers, keep only the first &lt;limit&gt; results, then join back</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">bot_reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">marker_positions</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">marker</span> <span class="ow">in</span> <span class="n">result_markers</span><span class="p">:</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">idx</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">marker</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="n">marker_positions</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">idx</span><span class="p">,</span> <span class="n">marker</span><span class="p">))</span>
                        <span class="n">idx</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">marker</span><span class="p">)</span>
                <span class="n">marker_positions</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">marker_positions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">reply_limit</span><span class="p">:</span>
                    <span class="n">cut_idx</span> <span class="o">=</span> <span class="n">marker_positions</span><span class="p">[</span><span class="n">reply_limit</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">concatenated_text</span> <span class="o">=</span> <span class="n">text</span><span class="p">[:</span><span class="n">cut_idx</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">concatenated_text</span> <span class="o">=</span> <span class="n">text</span>
                <span class="n">bot_reply_final</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">bot_reply</span><span class="p">)</span>
                <span class="n">bot_reply_final</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">concatenated_text</span>
                <span class="n">response</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s2">&quot;sent_message&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;message_id&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                        <span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">timestamp</span><span class="p">(),</span>
                        <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">text</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;bot_reply&quot;</span><span class="p">:</span> <span class="n">bot_reply_final</span>
                <span class="p">}</span>
                <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Response prepared early due to enough results. Bot reply count: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">bot_replies</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">response</span>

            <span class="c1"># Try to fetch more results if limit not reached</span>
            <span class="n">seen_search_callbacks</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">all_texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">bot_reply</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]]</span> <span class="k">if</span> <span class="n">bot_reply</span> <span class="ow">and</span> <span class="s2">&quot;text&quot;</span> <span class="ow">in</span> <span class="n">bot_reply</span> <span class="k">else</span> <span class="p">[]</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">count_all_markers</span><span class="p">(</span><span class="n">texts</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">marker</span><span class="p">)</span> <span class="k">for</span> <span class="n">marker</span> <span class="ow">in</span> <span class="n">result_markers</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">)</span>

            <span class="n">current_count</span> <span class="o">=</span> <span class="n">count_all_markers</span><span class="p">(</span><span class="n">all_texts</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">current_count</span> <span class="o">&lt;</span> <span class="n">reply_limit</span><span class="p">:</span>
                <span class="n">last_reply</span> <span class="o">=</span> <span class="n">bot_replies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">bot_replies</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">last_reply</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">last_reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;buttons&quot;</span><span class="p">):</span>
                    <span class="k">break</span>

                <span class="c1"># Find all callback buttons whose text contains &quot;&gt;&quot; and callback_data like &quot;/search_&lt;number&gt;&quot;</span>
                <span class="n">search_buttons</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">btn</span> <span class="ow">in</span> <span class="n">last_reply</span><span class="p">[</span><span class="s2">&quot;buttons&quot;</span><span class="p">]:</span>
                    <span class="n">btn_text</span> <span class="o">=</span> <span class="n">btn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="n">cb_data</span> <span class="o">=</span> <span class="n">btn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;callback_data&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">btn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">cb_data</span> <span class="ow">and</span> <span class="s2">&quot;&gt;&quot;</span> <span class="ow">in</span> <span class="n">btn_text</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cb_data</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                            <span class="n">cb_data_str</span> <span class="o">=</span> <span class="n">cb_data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">cb_data_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cb_data</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^/search_\d+$&quot;</span><span class="p">,</span> <span class="n">cb_data_str</span><span class="p">):</span>
                            <span class="n">search_buttons</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">btn</span><span class="p">,</span> <span class="n">cb_data_str</span><span class="p">))</span>

                <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">btn</span><span class="p">,</span> <span class="n">cb_data_str</span> <span class="ow">in</span> <span class="n">search_buttons</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">cb_data_str</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen_search_callbacks</span><span class="p">:</span>
                        <span class="n">seen_search_callbacks</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cb_data_str</span><span class="p">)</span>
                        <span class="n">cb_data</span> <span class="o">=</span> <span class="n">btn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;callback_data&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">btn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>
                        <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Clicking search button (text contains &#39;&gt;&#39;) to fetch more results: </span><span class="si">{</span><span class="n">btn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
                            <span class="n">click_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">click_callback_button</span><span class="p">(</span>
                                <span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span> <span class="n">phone_number</span><span class="p">,</span> <span class="n">bot_username</span><span class="p">,</span>
                                <span class="n">last_reply</span><span class="p">[</span><span class="s2">&quot;message_id&quot;</span><span class="p">],</span> <span class="n">cb_data</span><span class="p">,</span> <span class="n">session_file</span><span class="p">,</span> <span class="n">proxy</span>
                            <span class="p">)</span>
                            <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                            <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Search button </span><span class="si">{</span><span class="n">btn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> clicked successfully. Result: </span><span class="si">{</span><span class="n">click_result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Fetching new results...&quot;</span><span class="p">)</span>
                            <span class="n">new_reply</span> <span class="o">=</span> <span class="k">await</span> <span class="n">fetch_recent_messages</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">bot_entity</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
                            <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;New reply fetched: </span><span class="si">{</span><span class="n">new_reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;No text&#39;</span><span class="p">)[:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">new_reply</span> <span class="ow">and</span> <span class="n">new_reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">):</span>
                                <span class="n">all_texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_reply</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">])</span>
                                <span class="n">bot_replies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_reply</span><span class="p">)</span>
                                <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error clicking search button: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">break</span>  <span class="c1"># Only click one button per loop</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
                    <span class="k">break</span>

                <span class="n">concatenated_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">all_texts</span><span class="p">)</span> <span class="k">if</span> <span class="n">all_texts</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                <span class="n">current_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">concatenated_text</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">marker</span><span class="p">)</span> <span class="k">for</span> <span class="n">marker</span> <span class="ow">in</span> <span class="n">result_markers</span><span class="p">)</span>
                <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current total marker count: </span><span class="si">{</span><span class="n">current_count</span><span class="si">}</span><span class="s2">, reply_limit: </span><span class="si">{</span><span class="n">reply_limit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">current_count</span> <span class="o">&gt;=</span> <span class="n">reply_limit</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="c1"># Concatenate all texts for final bot_reply</span>
            <span class="n">concatenated_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">all_texts</span><span class="p">)</span> <span class="k">if</span> <span class="n">all_texts</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

            <span class="c1"># If the result contains more results than the &lt;limit&gt;, only fetch the first &lt;limit&gt; number of results</span>
            <span class="k">if</span> <span class="n">reply_limit</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">marker_positions</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">marker</span> <span class="ow">in</span> <span class="n">result_markers</span><span class="p">:</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">idx</span> <span class="o">=</span> <span class="n">concatenated_text</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">marker</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="n">marker_positions</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">idx</span><span class="p">,</span> <span class="n">marker</span><span class="p">))</span>
                        <span class="n">idx</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">marker</span><span class="p">)</span>
                <span class="n">marker_positions</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">marker_positions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">reply_limit</span><span class="p">:</span>
                    <span class="n">cut_idx</span> <span class="o">=</span> <span class="n">marker_positions</span><span class="p">[</span><span class="n">reply_limit</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">concatenated_text</span> <span class="o">=</span> <span class="n">concatenated_text</span><span class="p">[:</span><span class="n">cut_idx</span><span class="p">]</span>
                    <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trimmed search results to first </span><span class="si">{</span><span class="n">reply_limit</span><span class="si">}</span><span class="s2"> entries.&quot;</span><span class="p">)</span>

                <span class="c1"># Remove &quot;__&lt;number&gt; results__&quot; from the text</span>
                <span class="n">concatenated_text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;__[\d,]+\s+results__\s*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">concatenated_text</span><span class="p">)</span>

                <span class="c1"># Remove advertising or footer lines starting with an emoji (not our result markers)</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="n">concatenated_text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
                <span class="n">filtered_lines</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">result_counter</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                    <span class="n">stripped</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">stripped</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">marker</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span> <span class="k">for</span> <span class="n">marker</span> <span class="ow">in</span> <span class="n">result_markers</span><span class="p">):</span>
                        <span class="n">filtered_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">result_counter</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">result_counter</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^[^\w\s]&quot;</span><span class="p">,</span> <span class="n">stripped</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">filtered_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">concatenated_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filtered_lines</span><span class="p">)</span>

                <span class="c1"># Only prepend this line if the original message is not &quot;/profile&quot;</span>
                <span class="n">concatenated_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;The first </span><span class="si">{</span><span class="n">reply_limit</span><span class="si">}</span><span class="s2"> results among </span><span class="si">{</span><span class="n">total_results</span><span class="si">}</span><span class="s2"> results found:</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">concatenated_text</span>

                <span class="n">bot_reply_final</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">bot_replies</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">bot_reply_final</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">concatenated_text</span>

                <span class="n">response</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s2">&quot;sent_message&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;message_id&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                        <span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">timestamp</span><span class="p">(),</span>
                        <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">text</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;bot_reply&quot;</span><span class="p">:</span> <span class="n">bot_reply_final</span>
                <span class="p">}</span>
                <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Response prepared successfully. Bot reply count: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">bot_replies</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">info_print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">response</span>

            <span class="c1"># Fallback: just return the first reply if nothing else</span>
            <span class="n">response</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;sent_message&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;message_id&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">timestamp</span><span class="p">(),</span>
                    <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">text</span>
                <span class="p">},</span>
                <span class="s2">&quot;bot_reply&quot;</span><span class="p">:</span> <span class="n">bot_replies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">response</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;Disconnecting client...&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;Client disconnected&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="create_session">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.create_session">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_session</span><span class="p">(</span><span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span> <span class="n">phone_number</span><span class="p">,</span> <span class="n">session_file</span><span class="o">=</span><span class="n">SESSION_FILE</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a new session file interactively&quot;&quot;&quot;</span>
    <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating new session with file: </span><span class="si">{</span><span class="n">session_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">TelegramClient</span><span class="p">(</span><span class="n">session_file</span><span class="p">,</span> <span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;Starting client for session creation...&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">phone_number</span><span class="p">)</span>
        <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Session created successfully! File saved as &#39;</span><span class="si">{</span><span class="n">session_file</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;You can now run the script without manual input.&quot;</span><span class="p">)</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;Session creation completed successfully&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating session: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Session creation failed: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;Disconnecting client after session creation...&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span></div>


<div class="viewcode-block" id="format_result">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.format_result">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">format_result</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Format the result in a human-readable way&quot;&quot;&quot;</span>
    <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;TELEGRAM BOT INTERACTION RESULT&quot;</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; ERROR: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">error_print</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ok&quot;</span><span class="p">):</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; SUCCESS: Message sent and received!&quot;</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        
        <span class="c1"># Format sent message</span>
        <span class="n">sent_msg</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sent_message&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="n">sent_msg</span><span class="p">:</span>
            <span class="n">sent_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">sent_msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; SENT MESSAGE:&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   ID: </span><span class="si">{</span><span class="n">sent_msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message_id&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Time: </span><span class="si">{</span><span class="n">sent_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Text: </span><span class="si">{</span><span class="n">sent_msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            
            <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sent message details: ID=</span><span class="si">{</span><span class="n">sent_msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message_id&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">, Time=</span><span class="si">{</span><span class="n">sent_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Format bot reply</span>
        <span class="n">bot_reply</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bot_reply&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bot_reply</span><span class="p">:</span>
            <span class="n">reply_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">bot_reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; BOT REPLY:&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   ID: </span><span class="si">{</span><span class="n">bot_reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message_id&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Time: </span><span class="si">{</span><span class="n">reply_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Text: </span><span class="si">{</span><span class="n">bot_reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bot reply details: ID=</span><span class="si">{</span><span class="n">bot_reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message_id&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">, Time=</span><span class="si">{</span><span class="n">reply_time</span><span class="si">}</span><span class="s2">, Buttons=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">bot_reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;buttons&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[]))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Format buttons if present</span>
            <span class="n">buttons</span> <span class="o">=</span> <span class="n">bot_reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;buttons&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="n">buttons</span><span class="p">:</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;   Buttons:&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">button</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">buttons</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">button_type</span> <span class="o">=</span> <span class="n">button</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
                    <span class="n">button_text</span> <span class="o">=</span> <span class="n">button</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">button_type</span> <span class="o">==</span> <span class="s2">&quot;url&quot;</span><span class="p">:</span>
                        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">button_text</span><span class="si">}</span><span class="s2"> (URL: </span><span class="si">{</span><span class="n">button</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Button </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: URL - </span><span class="si">{</span><span class="n">button_text</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">button</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">button_type</span> <span class="o">==</span> <span class="s2">&quot;callback&quot;</span><span class="p">:</span>
                        <span class="n">callback_data</span> <span class="o">=</span> <span class="n">button</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;callback_data&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span>
                        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">button_text</span><span class="si">}</span><span class="s2"> (Callback: </span><span class="si">{</span><span class="n">callback_data</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Button </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: Callback - </span><span class="si">{</span><span class="n">button_text</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">callback_data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">button_text</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">button_type</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Button </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">button_type</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">button_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; BOT REPLY: No reply received (timeout)&quot;</span><span class="p">)</span>
            <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;No bot reply received within timeout period&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; FAILED: Message sending failed&quot;</span><span class="p">)</span>
        <span class="n">error_print</span><span class="p">(</span><span class="s2">&quot;Message sending failed&quot;</span><span class="p">)</span>
    
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
    
    <span class="c1"># Print to console and log</span>
    <span class="n">result_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Formatting result for display&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">result_text</span><span class="p">)</span></div>


<div class="viewcode-block" id="handle_single_search_result">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.handle_single_search_result">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">handle_single_search_result</span><span class="p">(</span><span class="n">bot_reply</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handle a single search result based on whether the first callback button contains &quot;Request&quot;</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        bot_reply: Dictionary containing bot reply with buttons</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with action type and relevant information</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">bot_reply</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">bot_reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;buttons&quot;</span><span class="p">):</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;No bot reply or buttons found&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;no_buttons&quot;</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;No buttons available in the response&quot;</span>
        <span class="p">}</span>
    
    <span class="n">buttons</span> <span class="o">=</span> <span class="n">bot_reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;buttons&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">buttons</span><span class="p">:</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;Empty buttons list&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;no_buttons&quot;</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;No buttons available in the response&quot;</span>
        <span class="p">}</span>
    
    <span class="c1"># Find the first callback button</span>
    <span class="n">first_callback_button</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">button</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">button</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;callback&quot;</span><span class="p">:</span>
            <span class="n">first_callback_button</span> <span class="o">=</span> <span class="n">button</span>
            <span class="k">break</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">first_callback_button</span><span class="p">:</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;No callback buttons found&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;no_callback_buttons&quot;</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;No callback buttons available in the response&quot;</span>
        <span class="p">}</span>
    
    <span class="n">button_text</span> <span class="o">=</span> <span class="n">first_callback_button</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">callback_data</span> <span class="o">=</span> <span class="n">first_callback_button</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;callback_data&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">first_callback_button</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>
    
    <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;First callback button text: &#39;</span><span class="si">{</span><span class="n">button_text</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    
    <span class="c1"># Check if the first callback button contains &quot;Request&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;request&quot;</span> <span class="ow">in</span> <span class="n">button_text</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found &#39;Request&#39; callback button: </span><span class="si">{</span><span class="n">button_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;request_callback&quot;</span><span class="p">,</span>
            <span class="s2">&quot;button_text&quot;</span><span class="p">:</span> <span class="n">button_text</span><span class="p">,</span>
            <span class="s2">&quot;callback_data&quot;</span><span class="p">:</span> <span class="n">callback_data</span><span class="p">,</span>
            <span class="s2">&quot;message_id&quot;</span><span class="p">:</span> <span class="n">bot_reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message_id&quot;</span><span class="p">),</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Ready to click request button: </span><span class="si">{</span><span class="n">button_text</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;First callback button does not contain &#39;Request&#39;: </span><span class="si">{</span><span class="n">button_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;other_callback&quot;</span><span class="p">,</span>
            <span class="s2">&quot;button_text&quot;</span><span class="p">:</span> <span class="n">button_text</span><span class="p">,</span>
            <span class="s2">&quot;callback_data&quot;</span><span class="p">:</span> <span class="n">callback_data</span><span class="p">,</span>
            <span class="s2">&quot;message_id&quot;</span><span class="p">:</span> <span class="n">bot_reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message_id&quot;</span><span class="p">),</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Other callback button found: </span><span class="si">{</span><span class="n">button_text</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="handle_button_click_logic">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.handle_button_click_logic">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_button_click_logic</span><span class="p">(</span><span class="n">bot_reply</span><span class="p">,</span> <span class="n">proxy</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handle button clicking based on button text - interactive prompts for user</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        bot_reply: Dictionary containing bot reply with buttons</span>
<span class="sd">        proxy: Proxy configuration (same format as other functions)</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with click result or None if no action needed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">bot_reply</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">bot_reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;buttons&quot;</span><span class="p">):</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;No bot reply or buttons found for button click logic&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="n">buttons</span> <span class="o">=</span> <span class="n">bot_reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;buttons&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">buttons</span><span class="p">:</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;Empty buttons list for button click logic&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="c1"># Find the first callback button</span>
    <span class="n">first_callback_button</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">button</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">button</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;callback&quot;</span><span class="p">:</span>
            <span class="n">first_callback_button</span> <span class="o">=</span> <span class="n">button</span>
            <span class="k">break</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">first_callback_button</span><span class="p">:</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;No callback buttons found for button click logic&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="n">button_text</span> <span class="o">=</span> <span class="n">first_callback_button</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">callback_data</span> <span class="o">=</span> <span class="n">first_callback_button</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;callback_data&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">first_callback_button</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>
    <span class="n">message_id</span> <span class="o">=</span> <span class="n">bot_reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message_id&quot;</span><span class="p">)</span>
    
    <span class="n">has_request</span> <span class="o">=</span> <span class="s2">&quot;request&quot;</span> <span class="ow">in</span> <span class="n">button_text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    
    <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Button click logic - Button text: &#39;</span><span class="si">{</span><span class="n">button_text</span><span class="si">}</span><span class="s2">&#39;, Has &#39;Request&#39;: </span><span class="si">{</span><span class="n">has_request</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">has_request</span><span class="p">:</span>
        <span class="c1"># Paper is not available on Nexus - ask if user wants to request it</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> The corresponding paper is not available on Nexus.&quot;</span><span class="p">)</span>
        <span class="n">user_input</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span><span class="s2">&quot;Do you want to request it? [y/N]: &quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;n&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">user_input</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;yes&#39;</span><span class="p">]:</span>
            <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User chose to request the paper - clicking button: </span><span class="si">{</span><span class="n">button_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Request button click parameters - Message ID: </span><span class="si">{</span><span class="n">message_id</span><span class="si">}</span><span class="s2">, Callback data: </span><span class="si">{</span><span class="n">callback_data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Click the callback button</span>
            <span class="n">click_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">click_callback_button</span><span class="p">(</span>
            <span class="n">TG_API_ID</span><span class="p">,</span> <span class="n">TG_API_HASH</span><span class="p">,</span> <span class="n">PHONE</span><span class="p">,</span> <span class="n">BOT_USERNAME</span><span class="p">,</span> 
            <span class="n">message_id</span><span class="p">,</span> <span class="n">callback_data</span><span class="p">,</span> <span class="n">SESSION_FILE</span><span class="p">,</span> <span class="n">proxy</span>
            <span class="p">)</span>
            
            <span class="k">return</span> <span class="n">click_result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;User chose not to request the paper&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Paper is available - clean button text and ask if user wants to download</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> The corresponding paper is available on Nexus.&quot;</span><span class="p">)</span>
        <span class="n">user_input</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span><span class="s2">&quot;Do you want to download it? [y/N]: &quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;n&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">user_input</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;yes&#39;</span><span class="p">]:</span>
            <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User chose to download the paper - clicking button: </span><span class="si">{</span><span class="n">button_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Download button click parameters - Message ID: </span><span class="si">{</span><span class="n">message_id</span><span class="si">}</span><span class="s2">, Callback data: </span><span class="si">{</span><span class="n">callback_data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Click the callback button</span>
            <span class="n">click_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">click_callback_button</span><span class="p">(</span>
            <span class="n">TG_API_ID</span><span class="p">,</span> <span class="n">TG_API_HASH</span><span class="p">,</span> <span class="n">PHONE</span><span class="p">,</span> <span class="n">BOT_USERNAME</span><span class="p">,</span> 
            <span class="n">message_id</span><span class="p">,</span> <span class="n">callback_data</span><span class="p">,</span> <span class="n">SESSION_FILE</span><span class="p">,</span> <span class="n">proxy</span>
            <span class="p">)</span>
            
            <span class="k">return</span> <span class="n">click_result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;User chose not to download the paper&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="download_telegram_file">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.download_telegram_file">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">download_telegram_file</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">download_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download a file from a Telegram message</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        client: TelegramClient instance</span>
<span class="sd">        message: Telegram message containing the file</span>
<span class="sd">        download_path: Path where to save the file (optional)</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with download result</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Check if message has media</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">message</span><span class="o">.</span><span class="n">media</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Message contains no media&quot;</span><span class="p">}</span>
        
        <span class="c1"># Get file name</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">media</span><span class="p">,</span> <span class="s1">&#39;filename&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
            <span class="c1"># Try to get filename from document attributes</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">media</span><span class="p">,</span> <span class="s1">&#39;document&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">message</span><span class="o">.</span><span class="n">media</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">media</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">attributes</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="s1">&#39;file_name&#39;</span><span class="p">):</span>
                        <span class="n">filename</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">file_name</span>
                        <span class="k">break</span>
            
            <span class="c1"># If still no filename, generate one</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
                <span class="n">file_ext</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">media</span><span class="p">,</span> <span class="s1">&#39;document&#39;</span><span class="p">):</span>
                    <span class="n">mime_type</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">media</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">mime_type</span>
                    <span class="k">if</span> <span class="n">mime_type</span> <span class="o">==</span> <span class="s1">&#39;application/pdf&#39;</span><span class="p">:</span>
                        <span class="n">file_ext</span> <span class="o">=</span> <span class="s2">&quot;.pdf&quot;</span>
                    <span class="k">elif</span> <span class="s1">&#39;image&#39;</span> <span class="ow">in</span> <span class="n">mime_type</span><span class="p">:</span>
                        <span class="n">file_ext</span> <span class="o">=</span> <span class="s2">&quot;.jpg&quot;</span>
                    <span class="k">elif</span> <span class="s1">&#39;video&#39;</span> <span class="ow">in</span> <span class="n">mime_type</span><span class="p">:</span>
                        <span class="n">file_ext</span> <span class="o">=</span> <span class="s2">&quot;.mp4&quot;</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;telegram_file_</span><span class="si">{</span><span class="n">message</span><span class="o">.</span><span class="n">id</span><span class="si">}{</span><span class="n">file_ext</span><span class="si">}</span><span class="s2">&quot;</span>
        
        <span class="c1"># Set download path</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">download_path</span><span class="p">:</span>
            <span class="c1"># Create downloads directory in user&#39;s home</span>
            <span class="n">downloads_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">),</span> <span class="s2">&quot;Downloads&quot;</span><span class="p">,</span> <span class="s2">&quot;TelegramFiles&quot;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">downloads_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">download_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">downloads_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">download_path</span><span class="p">):</span>
            <span class="n">download_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">download_path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        
        <span class="c1"># Get file size</span>
        <span class="n">file_size</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">media</span><span class="o">.</span><span class="n">document</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">media</span><span class="p">,</span> <span class="s1">&#39;document&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
        
        <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting download: </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File size: </span><span class="si">{</span><span class="n">file_size</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB&quot;</span> <span class="k">if</span> <span class="n">file_size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;File size: Unknown&quot;</span><span class="p">)</span>
        <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Download path: </span><span class="si">{</span><span class="n">download_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Download with progress</span>
        <span class="n">last_progress</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">def</span><span class="w"> </span><span class="nf">progress_callback</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">total</span><span class="p">):</span>
            <span class="k">nonlocal</span> <span class="n">last_progress</span>
            <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">progress</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">current</span> <span class="o">/</span> <span class="n">total</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">progress</span> <span class="o">&gt;=</span> <span class="n">last_progress</span> <span class="o">+</span> <span class="mi">5</span><span class="p">:</span>  <span class="c1"># Update every 5%</span>
                    <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Download progress: </span><span class="si">{</span><span class="n">progress</span><span class="si">}</span><span class="s2">% (</span><span class="si">{</span><span class="n">current</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB)&quot;</span><span class="p">)</span>
                    <span class="n">last_progress</span> <span class="o">=</span> <span class="n">progress</span>
        
        <span class="c1"># Perform the download</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">path</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">download_media</span><span class="p">(</span>
            <span class="n">message</span><span class="p">,</span>
            <span class="n">file</span><span class="o">=</span><span class="n">download_path</span><span class="p">,</span>
            <span class="n">progress_callback</span><span class="o">=</span><span class="n">progress_callback</span>
        <span class="p">)</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        
        <span class="n">download_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">actual_size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">speed_mbps</span> <span class="o">=</span> <span class="p">(</span><span class="n">actual_size</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">))</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">download_time</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            
            <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Download completed successfully!&quot;</span><span class="p">)</span>
            <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File saved to: </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Download time: </span><span class="si">{</span><span class="n">download_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
            <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average speed: </span><span class="si">{</span><span class="n">speed_mbps</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB/s&quot;</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;file_path&quot;</span><span class="p">:</span> <span class="n">path</span><span class="p">,</span>
                <span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="n">filename</span><span class="p">,</span>
                <span class="s2">&quot;file_size&quot;</span><span class="p">:</span> <span class="n">actual_size</span><span class="p">,</span>
                <span class="s2">&quot;download_time&quot;</span><span class="p">:</span> <span class="n">download_time</span><span class="p">,</span>
                <span class="s2">&quot;speed_mbps&quot;</span><span class="p">:</span> <span class="n">speed_mbps</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;File download failed - file not found after download&quot;</span><span class="p">}</span>
            
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error downloading file: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Download error details: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Download failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span></div>


<div class="viewcode-block" id="handle_file_download_from_bot_reply">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.handle_file_download_from_bot_reply">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_file_download_from_bot_reply</span><span class="p">(</span><span class="n">bot_reply</span><span class="p">,</span> <span class="n">proxy</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handle file download from bot reply if it contains a document</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        bot_reply: Dictionary containing bot reply information</span>
<span class="sd">        proxy: Proxy configuration (same format as other functions)</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with download result or None if no file to download</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">bot_reply</span><span class="p">:</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;No bot reply for file download&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="c1"># Load proxy configuration</span>
    <span class="n">proxy_config</span> <span class="o">=</span> <span class="n">load_proxy_config</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">proxy</span> <span class="ow">and</span> <span class="n">proxy_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Error loading proxy configuration&quot;</span><span class="p">}</span>
    
    <span class="c1"># Create client</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">create_telegram_client</span><span class="p">(</span><span class="n">TG_API_ID</span><span class="p">,</span> <span class="n">TG_API_HASH</span><span class="p">,</span> <span class="n">SESSION_FILE</span><span class="p">,</span> <span class="n">proxy_config</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Start client</span>
        <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">is_user_authorized</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Session expired&quot;</span><span class="p">}</span>
        
        <span class="c1"># Get the bot entity</span>
        <span class="n">bot_entity</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get_entity</span><span class="p">(</span><span class="n">BOT_USERNAME</span><span class="p">)</span>
        
        <span class="c1"># Get the message by ID</span>
        <span class="n">message_id</span> <span class="o">=</span> <span class="n">bot_reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message_id&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">message_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;No message ID in bot reply&quot;</span><span class="p">}</span>
        
        <span class="c1"># Fetch the message</span>
        <span class="n">message</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get_messages</span><span class="p">(</span><span class="n">bot_entity</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="n">message_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">message</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Could not fetch message&quot;</span><span class="p">}</span>
        
        <span class="c1"># Check if message contains a file</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">message</span><span class="o">.</span><span class="n">media</span><span class="p">:</span>
            <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;Message contains no media for download&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        
        <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;File detected in bot reply, starting download...&quot;</span><span class="p">)</span>
        
        <span class="c1"># Download the file</span>
        <span class="n">download_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">download_telegram_file</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">download_result</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error handling file download: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File download handling error: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;File download handling failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span></div>



<div class="viewcode-block" id="wait_for_file_message_and_download">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.wait_for_file_message_and_download">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">wait_for_file_message_and_download</span><span class="p">(</span>
    <span class="n">api_id</span><span class="p">,</span>
    <span class="n">api_hash</span><span class="p">,</span>
    <span class="n">bot_username</span><span class="p">,</span>
    <span class="n">session_file</span><span class="o">=</span><span class="n">SESSION_FILE</span><span class="p">,</span>
    <span class="n">proxy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">after_message_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
    <span class="n">poll_interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Poll the bot for a new file message and download it when it appears.&quot;&quot;&quot;</span>
    <span class="n">proxy_config</span> <span class="o">=</span> <span class="n">load_proxy_config</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">proxy</span> <span class="ow">and</span> <span class="n">proxy_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Error loading proxy configuration&quot;</span><span class="p">}</span>

    <span class="n">client</span> <span class="o">=</span> <span class="n">create_telegram_client</span><span class="p">(</span><span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span> <span class="n">session_file</span><span class="p">,</span> <span class="n">proxy_config</span><span class="p">)</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">is_user_authorized</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Session expired&quot;</span><span class="p">}</span>

        <span class="n">bot_entity</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get_entity</span><span class="p">(</span><span class="n">bot_username</span><span class="p">)</span>
        <span class="n">debug_print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Polling for new file message from </span><span class="si">{</span><span class="n">bot_username</span><span class="si">}</span><span class="s2"> (timeout=</span><span class="si">{</span><span class="n">timeout</span><span class="si">}</span><span class="s2">s, interval=</span><span class="si">{</span><span class="n">poll_interval</span><span class="si">}</span><span class="s2">s)&quot;</span>
        <span class="p">)</span>

        <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">client</span><span class="o">.</span><span class="n">iter_messages</span><span class="p">(</span><span class="n">bot_entity</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">after_message_id</span> <span class="ow">and</span> <span class="n">message</span><span class="o">.</span><span class="n">id</span> <span class="o">&lt;=</span> <span class="n">after_message_id</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">media</span><span class="p">:</span>
                    <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Detected file message from bot. Starting download...&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="k">await</span> <span class="n">download_telegram_file</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">poll_interval</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Timeout waiting for file message from bot&quot;</span><span class="p">}</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error while waiting for file message: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wait error details: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Wait for file failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span></div>


<span class="c1"># Get user input with timeout</span>
<div class="viewcode-block" id="get_input_with_timeout">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.get_input_with_timeout">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_input_with_timeout</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">keep_origin</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get user input with timeout, return default if timeout occurs&quot;&quot;&quot;</span>
    
    <span class="c1"># Check if we&#39;re prompting for a file path (contains &quot;path&quot; or &quot;file&quot;)</span>
    <span class="n">is_path_prompt</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">keyword</span> <span class="ow">in</span> <span class="n">prompt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">keyword</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="s1">&#39;file&#39;</span><span class="p">])</span>
    
    <span class="k">if</span> <span class="n">is_path_prompt</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Enable tab completion for file paths</span>
            <span class="n">readline</span><span class="o">.</span><span class="n">set_completer_delims</span><span class="p">(</span><span class="s1">&#39; </span><span class="se">\t\n</span><span class="s1">=&#39;</span><span class="p">)</span>
            <span class="n">readline</span><span class="o">.</span><span class="n">parse_and_bind</span><span class="p">(</span><span class="s2">&quot;tab: complete&quot;</span><span class="p">)</span>
            
            <span class="c1"># Use input() for path prompts to enable readline features</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            
            <span class="k">def</span><span class="w"> </span><span class="nf">timeout_handler</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Timeout after </span><span class="si">{</span><span class="n">timeout</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
            
            <span class="c1"># Set up timeout for Unix-like systems</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">!=</span> <span class="s1">&#39;win32&#39;</span><span class="p">:</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">timeout_handler</span><span class="p">)</span>
                <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user_input</span> <span class="o">=</span> <span class="nb">input</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">!=</span> <span class="s1">&#39;win32&#39;</span><span class="p">:</span>
                    <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Cancel timeout</span>
                <span class="k">return</span> <span class="n">user_input</span> <span class="k">if</span> <span class="n">keep_origin</span> <span class="k">else</span> <span class="n">user_input</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">TimeoutError</span><span class="p">,</span> <span class="ne">KeyboardInterrupt</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">!=</span> <span class="s1">&#39;win32&#39;</span><span class="p">:</span>
                    <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Cancel timeout</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Timeout after </span><span class="si">{</span><span class="n">timeout</span><span class="si">}</span><span class="s2"> seconds, using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">default</span>
                
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="c1"># Fallback if readline is not available</span>
            <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;readline not available, falling back to basic input&quot;</span><span class="p">)</span>
    
    <span class="c1"># Original implementation for non-path prompts or when readline is not available</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;win32&#39;</span><span class="p">:</span>
        <span class="c1"># Windows doesn&#39;t support select on stdin, use a simpler approach</span>
        
        <span class="n">input_chars</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">msvcrt</span><span class="o">.</span><span class="n">kbhit</span><span class="p">():</span>
                <span class="n">char</span> <span class="o">=</span> <span class="n">msvcrt</span><span class="o">.</span><span class="n">getch</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">char</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">:</span>  <span class="c1"># Enter key</span>
                    <span class="nb">print</span><span class="p">()</span>
                    <span class="n">user_input</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_chars</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">user_input</span> <span class="k">if</span> <span class="n">keep_origin</span> <span class="k">else</span> <span class="n">user_input</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="se">\b</span><span class="s1">&#39;</span><span class="p">:</span>  <span class="c1"># Backspace</span>
                    <span class="k">if</span> <span class="n">input_chars</span><span class="p">:</span>
                        <span class="n">input_chars</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\b</span><span class="s1"> </span><span class="se">\b</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">input_chars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">char</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span> <span class="o">&gt;</span> <span class="n">timeout</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Timeout after </span><span class="si">{</span><span class="n">timeout</span><span class="si">}</span><span class="s2"> seconds, using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">default</span>
            
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Unix/Linux/macOS</span>
        <span class="n">ready</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ready</span><span class="p">:</span>
            <span class="n">user_input</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">user_input</span> <span class="k">if</span> <span class="n">keep_origin</span> <span class="k">else</span> <span class="n">user_input</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Timeout after </span><span class="si">{</span><span class="n">timeout</span><span class="si">}</span><span class="s2"> seconds, using default: </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">default</span></div>


<div class="viewcode-block" id="load_credentials_from_file">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.load_credentials_from_file">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">load_credentials_from_file</span><span class="p">(</span><span class="n">credentials_path</span><span class="p">,</span> <span class="n">print_result</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load API credentials from JSON file, validate, and prompt user if invalid or missing.&quot;&quot;&quot;</span>

    <span class="k">global</span> <span class="n">TG_API_ID</span><span class="p">,</span> <span class="n">TG_API_HASH</span><span class="p">,</span> <span class="n">PHONE</span><span class="p">,</span> <span class="n">BOT_USERNAME</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">prompt_for_credentials</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">print_result</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Please enter your Telegram API credentials.&quot;</span><span class="p">)</span>
        <span class="n">tg_api_id</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span><span class="s2">&quot;API ID: &quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">keep_origin</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tg_api_id</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">print_result</span><span class="p">:</span>
                <span class="n">error_print</span><span class="p">(</span><span class="s2">&quot;No API ID entered. Exiting.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">tg_api_hash</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span><span class="s2">&quot;API Hash: &quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">keep_origin</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tg_api_hash</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">print_result</span><span class="p">:</span>
                <span class="n">error_print</span><span class="p">(</span><span class="s2">&quot;No API Hash entered. Exiting.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">phone</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span><span class="s2">&quot;Phone number (with country code): &quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">keep_origin</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">phone</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">print_result</span><span class="p">:</span>
                <span class="n">error_print</span><span class="p">(</span><span class="s2">&quot;No phone number entered. Exiting.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">bot_username</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span><span class="s2">&quot;Bot username (default: SciNexBot): &quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;SciNexBot&quot;</span><span class="p">,</span> <span class="n">keep_origin</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bot_username</span><span class="p">:</span>
            <span class="n">bot_username</span> <span class="o">=</span> <span class="s2">&quot;SciNexBot&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;tg_api_id&quot;</span><span class="p">:</span> <span class="n">tg_api_id</span><span class="p">,</span>
            <span class="s2">&quot;tg_api_hash&quot;</span><span class="p">:</span> <span class="n">tg_api_hash</span><span class="p">,</span>
            <span class="s2">&quot;phone&quot;</span><span class="p">:</span> <span class="n">phone</span><span class="p">,</span>
            <span class="s2">&quot;bot_username&quot;</span><span class="p">:</span> <span class="n">bot_username</span>
        <span class="p">}</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">validate_and_save</span><span class="p">(</span><span class="n">creds</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">TG_API_ID</span><span class="p">,</span> <span class="n">TG_API_HASH</span><span class="p">,</span> <span class="n">PHONE</span><span class="p">,</span> <span class="n">BOT_USERNAME</span>
        <span class="n">TG_API_ID</span> <span class="o">=</span> <span class="n">creds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tg_api_id&quot;</span><span class="p">,</span> <span class="n">TG_API_ID</span><span class="p">)</span>
        <span class="n">TG_API_HASH</span> <span class="o">=</span> <span class="n">creds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tg_api_hash&quot;</span><span class="p">,</span> <span class="n">TG_API_HASH</span><span class="p">)</span>
        <span class="n">PHONE</span> <span class="o">=</span> <span class="n">creds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;phone&quot;</span><span class="p">,</span> <span class="n">PHONE</span><span class="p">)</span>
        <span class="n">BOT_USERNAME</span> <span class="o">=</span> <span class="n">creds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bot_username&quot;</span><span class="p">,</span> <span class="n">BOT_USERNAME</span><span class="p">)</span>
        <span class="c1"># Validate credentials</span>
        <span class="n">test_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">test_credentials</span><span class="p">(</span><span class="n">TG_API_ID</span><span class="p">,</span> <span class="n">TG_API_HASH</span><span class="p">,</span> <span class="n">PHONE</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">DEFAULT_PROXY_FILE</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">print_result</span><span class="p">:</span>
                <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Proxy file not found: </span><span class="si">{</span><span class="n">DEFAULT_PROXY_FILE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Attempting to find a suitable free proxy...&quot;</span><span class="p">)</span>
            <span class="n">working_proxy</span> <span class="o">=</span> <span class="k">await</span> <span class="n">test_and_select_working_proxy</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">working_proxy</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">print_result</span><span class="p">:</span>
                    <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot; Found and configured a working proxy&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">print_result</span><span class="p">:</span>
                    <span class="n">error_print</span><span class="p">(</span><span class="s2">&quot;Could not find a working proxy for Telegram&quot;</span><span class="p">)</span>
                    <span class="n">error_print</span><span class="p">(</span><span class="s2">&quot;You can either:&quot;</span><span class="p">)</span>
                    <span class="n">error_print</span><span class="p">(</span><span class="s2">&quot;1. Try running again (will test different proxies)&quot;</span><span class="p">)</span>
                    <span class="n">error_print</span><span class="p">(</span><span class="s2">&quot;2. Run with --no-proxy to connect directly&quot;</span><span class="p">)</span>
                    <span class="n">error_print</span><span class="p">(</span><span class="s2">&quot;3. Provide a custom proxy configuration file&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">test_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ok&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">DEFAULT_PROXY_FILE</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">print_result</span><span class="p">:</span>
                <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Credential test failed without proxy, retrying with proxy...&quot;</span><span class="p">)</span>
            <span class="n">test_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">test_credentials</span><span class="p">(</span><span class="n">TG_API_ID</span><span class="p">,</span> <span class="n">TG_API_HASH</span><span class="p">,</span> <span class="n">PHONE</span><span class="p">,</span> <span class="n">proxy</span><span class="o">=</span><span class="n">DEFAULT_PROXY_FILE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">test_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ok&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">print_result</span><span class="p">:</span>
                <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Credentials validated successfully.&quot;</span><span class="p">)</span>
            <span class="c1"># Save to default location if not already there or if different</span>
            <span class="n">save_needed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">CREDENTIALS_FILE</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">CREDENTIALS_FILE</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">existing</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">existing</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tg_api_id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">TG_API_ID</span><span class="p">)</span>
                        <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">existing</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tg_api_hash&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">TG_API_HASH</span><span class="p">)</span>
                        <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">existing</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;phone&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">PHONE</span><span class="p">)</span>
                        <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">existing</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bot_username&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">BOT_USERNAME</span><span class="p">)</span>
                    <span class="p">):</span>
                        <span class="n">save_needed</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">save_needed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">save_needed</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">CREDENTIALS_FILE</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">({</span>
                            <span class="s2">&quot;tg_api_id&quot;</span><span class="p">:</span> <span class="n">TG_API_ID</span><span class="p">,</span>
                            <span class="s2">&quot;tg_api_hash&quot;</span><span class="p">:</span> <span class="n">TG_API_HASH</span><span class="p">,</span>
                            <span class="s2">&quot;phone&quot;</span><span class="p">:</span> <span class="n">PHONE</span><span class="p">,</span>
                            <span class="s2">&quot;bot_username&quot;</span><span class="p">:</span> <span class="n">BOT_USERNAME</span>
                        <span class="p">},</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">print_result</span><span class="p">:</span>
                        <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Credentials saved to: </span><span class="si">{</span><span class="n">CREDENTIALS_FILE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Could not save credentials to default location: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">TG_API_ID</span><span class="p">,</span> <span class="n">TG_API_HASH</span><span class="p">,</span> <span class="n">PHONE</span><span class="p">,</span> <span class="n">BOT_USERNAME</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">print_result</span><span class="p">:</span>
                <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Credential validation failed: </span><span class="si">{</span><span class="n">test_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown error&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading credentials from: </span><span class="si">{</span><span class="n">credentials_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">creds</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">credentials_path</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">credentials_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">creds</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">validate_and_save</span><span class="p">(</span><span class="n">creds</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">result</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">print_result</span><span class="p">:</span>
                    <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Credentials in file are invalid. Please re-enter.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">print_result</span><span class="p">:</span>
                <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading credentials file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Credentials loading error: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">creds</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">credentials_path</span> <span class="o">!=</span> <span class="n">CREDENTIALS_FILE</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">CREDENTIALS_FILE</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">CREDENTIALS_FILE</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">creds</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">validate_and_save</span><span class="p">(</span><span class="n">creds</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">result</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">print_result</span><span class="p">:</span>
                    <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Credentials in default location are invalid. Please re-enter.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">print_result</span><span class="p">:</span>
                <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error loading credentials file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Credentials loading error: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">creds</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">creds</span> <span class="o">=</span> <span class="n">prompt_for_credentials</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">creds</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">print_result</span><span class="p">:</span>
                <span class="n">error_print</span><span class="p">(</span><span class="s2">&quot;No credentials provided. Exiting.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">validate_and_save</span><span class="p">(</span><span class="n">creds</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">print_result</span><span class="p">:</span>
                <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Credentials invalid. Please try again.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">print_result</span><span class="p">:</span>
        <span class="n">error_print</span><span class="p">(</span><span class="s2">&quot;Failed to provide valid credentials after multiple attempts or timeout.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span></div>

    
<div class="viewcode-block" id="test_credentials">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.test_credentials">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">test_credentials</span><span class="p">(</span><span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span> <span class="n">phone_number</span><span class="p">,</span> <span class="n">session_file</span><span class="o">=</span><span class="n">SESSION_FILE</span><span class="p">,</span> <span class="n">proxy</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test if the provided Telegram API credentials are correct by attempting to connect and authorize.</span>
<span class="sd">    Returns a dictionary with the result.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="kc">None</span>
    <span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">proxy_config</span> <span class="o">=</span> <span class="n">load_proxy_config</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span> <span class="k">if</span> <span class="n">proxy</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">create_telegram_client</span><span class="p">(</span><span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span> <span class="n">session_file</span><span class="p">,</span> <span class="n">proxy_config</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">phone</span><span class="o">=</span><span class="n">phone_number</span> <span class="k">if</span> <span class="n">phone_number</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">is_user_authorized</span><span class="p">():</span>
            <span class="n">me</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get_me</span><span class="p">()</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;ok&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">me</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s2">&quot;first_name&quot;</span><span class="p">:</span> <span class="n">me</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span>
                <span class="s2">&quot;last_name&quot;</span><span class="p">:</span> <span class="n">me</span><span class="o">.</span><span class="n">last_name</span><span class="p">,</span>
                <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">me</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
                <span class="s2">&quot;phone&quot;</span><span class="p">:</span> <span class="n">me</span><span class="o">.</span><span class="n">phone</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Not authorized. Credentials may be invalid or session expired.&quot;</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Credential test failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="setup_proxy_configuration">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.setup_proxy_configuration">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">setup_proxy_configuration</span><span class="p">(</span><span class="n">proxy_arg</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Setup proxy configuration - load existing or find new working proxy&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">proxy_arg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;No proxy specified, connecting directly&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Proxy option specified&quot;</span><span class="p">)</span>
    
    <span class="c1"># If proxy is just the flag without value, use default</span>
    <span class="n">proxy_file</span> <span class="o">=</span> <span class="n">proxy_arg</span> <span class="k">if</span> <span class="n">proxy_arg</span> <span class="k">else</span> <span class="n">DEFAULT_PROXY_FILE</span>
    <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Proxy file path: </span><span class="si">{</span><span class="n">proxy_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Check if proxy file exists</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">proxy_file</span><span class="p">):</span>
        <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading existing proxy configuration from: </span><span class="si">{</span><span class="n">proxy_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">proxy_config</span> <span class="o">=</span> <span class="n">load_proxy_config</span><span class="p">(</span><span class="n">proxy_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">proxy_config</span><span class="p">:</span>
            <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot; Proxy configuration loaded successfully&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">proxy_file</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load proxy configuration from: </span><span class="si">{</span><span class="n">proxy_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Proxy file not found: </span><span class="si">{</span><span class="n">proxy_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Searching for a working proxy...&quot;</span><span class="p">)</span>
        
        <span class="c1"># Try to find a working proxy</span>
        <span class="n">working_proxy</span> <span class="o">=</span> <span class="k">await</span> <span class="n">test_and_select_working_proxy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">working_proxy</span><span class="p">:</span>
            <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot; Found and configured a working proxy&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">DEFAULT_PROXY_FILE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">error_print</span><span class="p">(</span><span class="s2">&quot;Could not find a working proxy for Telegram&quot;</span><span class="p">)</span>
            <span class="n">error_print</span><span class="p">(</span><span class="s2">&quot;You can either:&quot;</span><span class="p">)</span>
            <span class="n">error_print</span><span class="p">(</span><span class="s2">&quot;1. Try running again (will test different proxies)&quot;</span><span class="p">)</span>
            <span class="n">error_print</span><span class="p">(</span><span class="s2">&quot;2. Run with --no-proxy to connect directly&quot;</span><span class="p">)</span>
            <span class="n">error_print</span><span class="p">(</span><span class="s2">&quot;3. Provide a custom proxy configuration file&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="handle_request_button">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.handle_request_button">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_request_button</span><span class="p">(</span><span class="n">button_text</span><span class="p">,</span> <span class="n">callback_data</span><span class="p">,</span> <span class="n">message_id</span><span class="p">,</span> <span class="n">proxy_to_use</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle request button click&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> The corresponding paper is not available on Nexus.&quot;</span><span class="p">)</span>
    <span class="n">user_input</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span><span class="s2">&quot;Do you want to request it? [y/N]: &quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;n&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">user_input</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;yes&#39;</span><span class="p">]:</span>
        <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User chose to request the paper - clicking button: </span><span class="si">{</span><span class="n">button_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Click the request button</span>
        <span class="n">click_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">click_callback_button</span><span class="p">(</span>
            <span class="n">TG_API_ID</span><span class="p">,</span> <span class="n">TG_API_HASH</span><span class="p">,</span> <span class="n">PHONE</span><span class="p">,</span> <span class="n">BOT_USERNAME</span><span class="p">,</span>
            <span class="n">message_id</span><span class="p">,</span> <span class="n">callback_data</span><span class="p">,</span> <span class="n">SESSION_FILE</span><span class="p">,</span> <span class="n">proxy_to_use</span>
        <span class="p">)</span>
        
        <span class="k">if</span> <span class="n">click_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ok&quot;</span><span class="p">):</span>
            <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot; Successfully requested the paper&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">click_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bot_reply&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">click_result</span><span class="p">[</span><span class="s2">&quot;bot_reply&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bot response: </span><span class="si">{</span><span class="n">click_result</span><span class="p">[</span><span class="s1">&#39;bot_reply&#39;</span><span class="p">][</span><span class="s1">&#39;text&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Failed to request the paper: </span><span class="si">{</span><span class="n">click_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown error&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;User chose not to request the paper&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="handle_download_button">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.handle_download_button">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_download_button</span><span class="p">(</span><span class="n">button_text</span><span class="p">,</span> <span class="n">callback_data</span><span class="p">,</span> <span class="n">message_id</span><span class="p">,</span> <span class="n">proxy_to_use</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle download button click&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> The corresponding paper is available on Nexus.&quot;</span><span class="p">)</span>
    
    <span class="c1"># Try to extract file size from button text first, then from callback_data</span>
    <span class="n">button_size_info</span> <span class="o">=</span> <span class="n">extract_file_size_from_button_text</span><span class="p">(</span><span class="n">button_text</span><span class="p">)</span>
    <span class="n">callback_size_info</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="c1"># If button text doesn&#39;t contain size info, try callback_data</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">button_size_info</span> <span class="ow">and</span> <span class="n">callback_data</span><span class="p">:</span>
        <span class="n">callback_size_info</span> <span class="o">=</span> <span class="n">extract_file_size_from_callback_data</span><span class="p">(</span><span class="n">callback_data</span><span class="p">)</span>
    
    <span class="c1"># Use whichever source provided the size info (button text takes priority)</span>
    <span class="n">size_info</span> <span class="o">=</span> <span class="n">button_size_info</span> <span class="ow">or</span> <span class="n">callback_size_info</span>
    <span class="k">if</span> <span class="n">size_info</span><span class="p">:</span>
        <span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;button text&quot;</span> <span class="k">if</span> <span class="n">button_size_info</span> <span class="k">else</span> <span class="s2">&quot;callback data&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; File size: </span><span class="si">{</span><span class="n">size_info</span><span class="p">[</span><span class="s1">&#39;original_size&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">size_info</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">size_info</span><span class="p">[</span><span class="s1">&#39;size_mb&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB)&quot;</span><span class="p">)</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File size extracted from </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">size_info</span><span class="p">[</span><span class="s1">&#39;original_size&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">size_info</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">size_info</span><span class="p">[</span><span class="s1">&#39;size_mb&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB)&quot;</span><span class="p">)</span>
    
    <span class="n">user_input</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span><span class="s2">&quot;Do you want to download it? [y/N]: &quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;n&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">user_input</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;yes&#39;</span><span class="p">]:</span>
        <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User chose to download the paper - clicking button: </span><span class="si">{</span><span class="n">button_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Click the download button</span>
        <span class="n">click_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">click_callback_button</span><span class="p">(</span>
            <span class="n">TG_API_ID</span><span class="p">,</span> <span class="n">TG_API_HASH</span><span class="p">,</span> <span class="n">PHONE</span><span class="p">,</span> <span class="n">BOT_USERNAME</span><span class="p">,</span>
            <span class="n">message_id</span><span class="p">,</span> <span class="n">callback_data</span><span class="p">,</span> <span class="n">SESSION_FILE</span><span class="p">,</span> <span class="n">proxy_to_use</span>
        <span class="p">)</span>
        
        <span class="c1"># Add file size information to click_result if available</span>
        <span class="k">if</span> <span class="n">size_info</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;button_info&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">click_result</span><span class="p">:</span>
                <span class="n">click_result</span><span class="p">[</span><span class="s1">&#39;button_info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">click_result</span><span class="p">[</span><span class="s1">&#39;button_info&#39;</span><span class="p">][</span><span class="s1">&#39;file_size_mb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">size_info</span><span class="p">[</span><span class="s1">&#39;size_mb&#39;</span><span class="p">]</span>
            <span class="n">click_result</span><span class="p">[</span><span class="s1">&#39;button_info&#39;</span><span class="p">][</span><span class="s1">&#39;size_unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">size_info</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span>
            <span class="n">click_result</span><span class="p">[</span><span class="s1">&#39;button_info&#39;</span><span class="p">][</span><span class="s1">&#39;original_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">size_info</span><span class="p">[</span><span class="s1">&#39;original_size&#39;</span><span class="p">]</span>
            
            <span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;button_text&quot;</span> <span class="k">if</span> <span class="n">button_size_info</span> <span class="k">else</span> <span class="s2">&quot;callback_data&quot;</span>
            <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added file size from </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">size_info</span><span class="p">[</span><span class="s1">&#39;original_size&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">size_info</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">size_info</span><span class="p">[</span><span class="s1">&#39;size_mb&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB)&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">click_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ok&quot;</span><span class="p">):</span>
            <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot; Successfully initiated download&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">click_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bot_reply&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">click_result</span><span class="p">[</span><span class="s2">&quot;bot_reply&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bot response: </span><span class="si">{</span><span class="n">click_result</span><span class="p">[</span><span class="s1">&#39;bot_reply&#39;</span><span class="p">][</span><span class="s1">&#39;text&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="k">await</span> <span class="n">wait_and_download_file</span><span class="p">(</span><span class="n">click_result</span><span class="p">,</span> <span class="n">proxy_to_use</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Failed to download the paper: </span><span class="si">{</span><span class="n">click_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown error&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;User chose not to download the paper&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="extract_file_size_from_callback_data">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.extract_file_size_from_callback_data">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_file_size_from_callback_data</span><span class="p">(</span><span class="n">callback_data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract file size information from callback data</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        callback_data: The callback data string that might contain file size info</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with size information or None if not found</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">callback_data</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="c1"># Convert bytes to string if needed</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">callback_data</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
        <span class="n">callback_data</span> <span class="o">=</span> <span class="n">callback_data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
    
    <span class="n">callback_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">callback_data</span><span class="p">)</span>
    <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analyzing callback_data for file size: </span><span class="si">{</span><span class="n">callback_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Look for various file size patterns</span>
    <span class="n">size_patterns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c1"># MB patterns</span>
        <span class="sa">r</span><span class="s1">&#39;(\d+(?:\.\d+)?)\s*(?:mb|MB|megabytes?)&#39;</span><span class="p">,</span>
        <span class="c1"># MiB patterns  </span>
        <span class="sa">r</span><span class="s1">&#39;(\d+(?:\.\d+)?)\s*(?:mib|MiB)&#39;</span><span class="p">,</span>
        <span class="c1"># KB patterns</span>
        <span class="sa">r</span><span class="s1">&#39;(\d+(?:\.\d+)?)\s*(?:kb|KB|kilobytes?)&#39;</span><span class="p">,</span>
        <span class="c1"># KiB patterns</span>
        <span class="sa">r</span><span class="s1">&#39;(\d+(?:\.\d+)?)\s*(?:kib|KiB)&#39;</span><span class="p">,</span>
        <span class="c1"># GB patterns</span>
        <span class="sa">r</span><span class="s1">&#39;(\d+(?:\.\d+)?)\s*(?:gb|GB|gigabytes?)&#39;</span><span class="p">,</span>
        <span class="c1"># GiB patterns</span>
        <span class="sa">r</span><span class="s1">&#39;(\d+(?:\.\d+)?)\s*(?:gib|GiB)&#39;</span><span class="p">,</span>
        <span class="c1"># Bytes patterns</span>
        <span class="sa">r</span><span class="s1">&#39;(\d+)\s*(?:bytes?|B)&#39;</span><span class="p">,</span>
    <span class="p">]</span>
    
    <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">size_patterns</span><span class="p">:</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">callback_str</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">size_value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">size_text</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            
            <span class="c1"># Convert to MB for standardization</span>
            <span class="k">if</span> <span class="s1">&#39;mb&#39;</span> <span class="ow">in</span> <span class="n">size_text</span> <span class="ow">or</span> <span class="s1">&#39;megabyte&#39;</span> <span class="ow">in</span> <span class="n">size_text</span><span class="p">:</span>
                <span class="n">size_mb</span> <span class="o">=</span> <span class="n">size_value</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;MB&#39;</span>
            <span class="k">elif</span> <span class="s1">&#39;mib&#39;</span> <span class="ow">in</span> <span class="n">size_text</span><span class="p">:</span>
                <span class="n">size_mb</span> <span class="o">=</span> <span class="n">size_value</span> <span class="o">*</span> <span class="mf">1.048576</span>  <span class="c1"># 1 MiB = 1.048576 MB</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;MiB&#39;</span>
            <span class="k">elif</span> <span class="s1">&#39;gb&#39;</span> <span class="ow">in</span> <span class="n">size_text</span> <span class="ow">or</span> <span class="s1">&#39;gigabyte&#39;</span> <span class="ow">in</span> <span class="n">size_text</span><span class="p">:</span>
                <span class="n">size_mb</span> <span class="o">=</span> <span class="n">size_value</span> <span class="o">*</span> <span class="mi">1000</span>  <span class="c1"># 1 GB = 1000 MB</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;GB&#39;</span>
            <span class="k">elif</span> <span class="s1">&#39;gib&#39;</span> <span class="ow">in</span> <span class="n">size_text</span><span class="p">:</span>
                <span class="n">size_mb</span> <span class="o">=</span> <span class="n">size_value</span> <span class="o">*</span> <span class="mf">1073.741824</span>  <span class="c1"># 1 GiB = 1073.741824 MB</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;GiB&#39;</span>
            <span class="k">elif</span> <span class="s1">&#39;kb&#39;</span> <span class="ow">in</span> <span class="n">size_text</span> <span class="ow">or</span> <span class="s1">&#39;kilobyte&#39;</span> <span class="ow">in</span> <span class="n">size_text</span><span class="p">:</span>
                <span class="n">size_mb</span> <span class="o">=</span> <span class="n">size_value</span> <span class="o">/</span> <span class="mi">1000</span>  <span class="c1"># 1000 KB = 1 MB</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;KB&#39;</span>
            <span class="k">elif</span> <span class="s1">&#39;kib&#39;</span> <span class="ow">in</span> <span class="n">size_text</span><span class="p">:</span>
                <span class="n">size_mb</span> <span class="o">=</span> <span class="n">size_value</span> <span class="o">/</span> <span class="mf">976.5625</span>  <span class="c1"># 1024 KiB = 1.024 MB</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;KiB&#39;</span>
            <span class="k">elif</span> <span class="s1">&#39;byte&#39;</span> <span class="ow">in</span> <span class="n">size_text</span> <span class="ow">or</span> <span class="n">size_text</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">):</span>
                <span class="n">size_mb</span> <span class="o">=</span> <span class="n">size_value</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>  <span class="c1"># Convert bytes to MB</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;bytes&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;size_mb&#39;</span><span class="p">:</span> <span class="n">size_mb</span><span class="p">,</span>
                <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="n">unit</span><span class="p">,</span>
                <span class="s1">&#39;original_size&#39;</span><span class="p">:</span> <span class="n">size_value</span>
            <span class="p">}</span>
    
    <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;No file size information found in callback_data&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="extract_file_size_from_button_text">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.extract_file_size_from_button_text">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">extract_file_size_from_button_text</span><span class="p">(</span><span class="n">button_text</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract file size information from button text</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        button_text: The button text string that might contain file size info</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with size information or None if not found</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">button_text</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="n">button_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">button_text</span><span class="p">)</span>
    <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analyzing button_text for file size: </span><span class="si">{</span><span class="n">button_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Look for various file size patterns in button text</span>
    <span class="n">size_patterns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c1"># MB patterns with common formats like &quot;Download (5.2 MB)&quot; or &quot;5.2MB&quot;</span>
        <span class="sa">r</span><span class="s1">&#39;(\d+(?:\.\d+)?)\s*(?:mb|MB|megabytes?)&#39;</span><span class="p">,</span>
        <span class="c1"># MiB patterns  </span>
        <span class="sa">r</span><span class="s1">&#39;(\d+(?:\.\d+)?)\s*(?:mib|MiB)&#39;</span><span class="p">,</span>
        <span class="c1"># KB patterns</span>
        <span class="sa">r</span><span class="s1">&#39;(\d+(?:\.\d+)?)\s*(?:kb|KB|kilobytes?)&#39;</span><span class="p">,</span>
        <span class="c1"># KiB patterns</span>
        <span class="sa">r</span><span class="s1">&#39;(\d+(?:\.\d+)?)\s*(?:kib|KiB)&#39;</span><span class="p">,</span>
        <span class="c1"># GB patterns</span>
        <span class="sa">r</span><span class="s1">&#39;(\d+(?:\.\d+)?)\s*(?:gb|GB|gigabytes?)&#39;</span><span class="p">,</span>
        <span class="c1"># GiB patterns</span>
        <span class="sa">r</span><span class="s1">&#39;(\d+(?:\.\d+)?)\s*(?:gib|GiB)&#39;</span><span class="p">,</span>
        <span class="c1"># Bytes patterns</span>
        <span class="sa">r</span><span class="s1">&#39;(\d+)\s*(?:bytes?|B)&#39;</span><span class="p">,</span>
        <span class="c1"># Pattern for sizes in parentheses like &quot;(5.2 MB)&quot;</span>
        <span class="sa">r</span><span class="s1">&#39;\((\d+(?:\.\d+)?)\s*(?:mb|MB|megabytes?)\)&#39;</span><span class="p">,</span>
        <span class="sa">r</span><span class="s1">&#39;\((\d+(?:\.\d+)?)\s*(?:mib|MiB)\)&#39;</span><span class="p">,</span>
        <span class="sa">r</span><span class="s1">&#39;\((\d+(?:\.\d+)?)\s*(?:kb|KB|kilobytes?)\)&#39;</span><span class="p">,</span>
        <span class="sa">r</span><span class="s1">&#39;\((\d+(?:\.\d+)?)\s*(?:kib|KiB)\)&#39;</span><span class="p">,</span>
        <span class="sa">r</span><span class="s1">&#39;\((\d+(?:\.\d+)?)\s*(?:gb|GB|gigabytes?)\)&#39;</span><span class="p">,</span>
        <span class="sa">r</span><span class="s1">&#39;\((\d+(?:\.\d+)?)\s*(?:gib|GiB)\)&#39;</span><span class="p">,</span>
    <span class="p">]</span>
    
    <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">size_patterns</span><span class="p">:</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">button_str</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">size_value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">size_text</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            
            <span class="c1"># Convert to MB for standardization</span>
            <span class="k">if</span> <span class="s1">&#39;mb&#39;</span> <span class="ow">in</span> <span class="n">size_text</span> <span class="ow">or</span> <span class="s1">&#39;megabyte&#39;</span> <span class="ow">in</span> <span class="n">size_text</span><span class="p">:</span>
                <span class="n">size_mb</span> <span class="o">=</span> <span class="n">size_value</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;MB&#39;</span>
            <span class="k">elif</span> <span class="s1">&#39;mib&#39;</span> <span class="ow">in</span> <span class="n">size_text</span><span class="p">:</span>
                <span class="n">size_mb</span> <span class="o">=</span> <span class="n">size_value</span> <span class="o">*</span> <span class="mf">1.048576</span>  <span class="c1"># 1 MiB = 1.048576 MB</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;MiB&#39;</span>
            <span class="k">elif</span> <span class="s1">&#39;gb&#39;</span> <span class="ow">in</span> <span class="n">size_text</span> <span class="ow">or</span> <span class="s1">&#39;gigabyte&#39;</span> <span class="ow">in</span> <span class="n">size_text</span><span class="p">:</span>
                <span class="n">size_mb</span> <span class="o">=</span> <span class="n">size_value</span> <span class="o">*</span> <span class="mi">1000</span>  <span class="c1"># 1 GB = 1000 MB</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;GB&#39;</span>
            <span class="k">elif</span> <span class="s1">&#39;gib&#39;</span> <span class="ow">in</span> <span class="n">size_text</span><span class="p">:</span>
                <span class="n">size_mb</span> <span class="o">=</span> <span class="n">size_value</span> <span class="o">*</span> <span class="mf">1073.741824</span>  <span class="c1"># 1 GiB = 1073.741824 MB</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;GiB&#39;</span>
            <span class="k">elif</span> <span class="s1">&#39;kb&#39;</span> <span class="ow">in</span> <span class="n">size_text</span> <span class="ow">or</span> <span class="s1">&#39;kilobyte&#39;</span> <span class="ow">in</span> <span class="n">size_text</span><span class="p">:</span>
                <span class="n">size_mb</span> <span class="o">=</span> <span class="n">size_value</span> <span class="o">/</span> <span class="mi">1000</span>  <span class="c1"># 1000 KB = 1 MB</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;KB&#39;</span>
            <span class="k">elif</span> <span class="s1">&#39;kib&#39;</span> <span class="ow">in</span> <span class="n">size_text</span><span class="p">:</span>
                <span class="n">size_mb</span> <span class="o">=</span> <span class="n">size_value</span> <span class="o">/</span> <span class="mf">976.5625</span>  <span class="c1"># 1024 KiB = 1.024 MB</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;KiB&#39;</span>
            <span class="k">elif</span> <span class="s1">&#39;byte&#39;</span> <span class="ow">in</span> <span class="n">size_text</span> <span class="ow">or</span> <span class="n">size_text</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">):</span>
                <span class="n">size_mb</span> <span class="o">=</span> <span class="n">size_value</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>  <span class="c1"># Convert bytes to MB</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;bytes&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracted file size from button text: </span><span class="si">{</span><span class="n">size_value</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">size_mb</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB)&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;size_mb&#39;</span><span class="p">:</span> <span class="n">size_mb</span><span class="p">,</span>
                <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="n">unit</span><span class="p">,</span>
                <span class="s1">&#39;original_size&#39;</span><span class="p">:</span> <span class="n">size_value</span>
            <span class="p">}</span>
    
    <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;No file size information found in button_text&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="wait_and_download_file">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.wait_and_download_file">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">wait_and_download_file</span><span class="p">(</span><span class="n">click_result</span><span class="p">,</span> <span class="n">proxy_to_use</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Wait for file upload to Telegram and download it&quot;&quot;&quot;</span>
    <span class="c1"># Extract file size information from click_result (previously parsed from callback_data)</span>
    <span class="k">if</span> <span class="n">verbose_mode</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Clicked button result:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">click_result</span><span class="p">)</span>
    
    <span class="c1"># First check if file size was already extracted from callback_data</span>
    <span class="n">button_info</span> <span class="o">=</span> <span class="n">click_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;button_info&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">file_size_mb</span> <span class="o">=</span> <span class="n">button_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_size_mb&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">file_size_mb</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">size_unit</span> <span class="o">=</span> <span class="n">button_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;size_unit&quot;</span><span class="p">,</span> <span class="s2">&quot;MB&quot;</span><span class="p">)</span>
        <span class="n">original_size</span> <span class="o">=</span> <span class="n">button_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;original_size&quot;</span><span class="p">,</span> <span class="n">file_size_mb</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose_mode</span><span class="p">:</span>
            <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using file size from button: </span><span class="si">{</span><span class="n">original_size</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">size_unit</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">file_size_mb</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB)&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Fallback: try to extract from bot response text</span>
        <span class="n">bot_text</span> <span class="o">=</span> <span class="n">click_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bot_reply&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        
        <span class="c1"># Handle MB and MiB separately since they are different units</span>
        <span class="n">mb_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\d+(?:\.\d+)?)\s*(?:mb|MB|megabytes?)&#39;</span><span class="p">,</span> <span class="n">bot_text</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
        <span class="n">mib_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\d+(?:\.\d+)?)\s*(?:mib|MiB)&#39;</span><span class="p">,</span> <span class="n">bot_text</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">mb_match</span><span class="p">:</span>
            <span class="n">file_size_mb</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">mb_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">verbose_mode</span><span class="p">:</span>
                <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detected file size from bot text: </span><span class="si">{</span><span class="n">file_size_mb</span><span class="si">}</span><span class="s2"> MB&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mib_match</span><span class="p">:</span>
            <span class="c1"># Convert MiB to MB: 1 MiB = 1.048576 MB</span>
            <span class="n">file_size_mib</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">mib_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">file_size_mb</span> <span class="o">=</span> <span class="n">file_size_mib</span> <span class="o">*</span> <span class="mf">1.048576</span>
            <span class="k">if</span> <span class="n">verbose_mode</span><span class="p">:</span>
                <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detected file size from bot text: </span><span class="si">{</span><span class="n">file_size_mib</span><span class="si">}</span><span class="s2"> MiB (</span><span class="si">{</span><span class="n">file_size_mb</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB)&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Check for other size units</span>
            <span class="n">kb_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\d+(?:\.\d+)?)\s*(?:kb|KB|kilobytes?)&#39;</span><span class="p">,</span> <span class="n">bot_text</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
            <span class="n">kib_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\d+(?:\.\d+)?)\s*(?:kib|KiB)&#39;</span><span class="p">,</span> <span class="n">bot_text</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">kb_match</span><span class="p">:</span>
                <span class="n">file_size_mb</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">kb_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="mi">1000</span>
                <span class="k">if</span> <span class="n">verbose_mode</span><span class="p">:</span>
                    <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detected file size from bot text: </span><span class="si">{</span><span class="n">file_size_mb</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">kib_match</span><span class="p">:</span>
                <span class="c1"># Convert KiB to MB: 1 KiB = 0.001024 MB</span>
                <span class="n">file_size_kib</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">kib_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">file_size_mb</span> <span class="o">=</span> <span class="n">file_size_kib</span> <span class="o">*</span> <span class="mf">0.001024</span>
                <span class="k">if</span> <span class="n">verbose_mode</span><span class="p">:</span>
                    <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detected file size from bot text: </span><span class="si">{</span><span class="n">file_size_kib</span><span class="si">}</span><span class="s2"> KiB (</span><span class="si">{</span><span class="n">file_size_mb</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Default assumption for academic papers</span>
                <span class="n">file_size_mb</span> <span class="o">=</span> <span class="mf">5.0</span>
                <span class="k">if</span> <span class="n">verbose_mode</span><span class="p">:</span>
                    <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;No file size detected, assuming 5 MB for academic paper&quot;</span><span class="p">)</span>
    
    <span class="c1"># Calculate wait time based on file size</span>
    <span class="n">base_wait</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">size_based_wait</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">file_size_mb</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">total_wait</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">base_wait</span><span class="p">,</span> <span class="n">size_based_wait</span><span class="p">)</span>
    
    <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting </span><span class="si">{</span><span class="n">total_wait</span><span class="si">}</span><span class="s2"> seconds for file preparation...&quot;</span><span class="p">)</span>
    
    <span class="c1"># Wait with progress indication (only show progress in verbose mode)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">total_wait</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose_mode</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Still waiting... </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total_wait</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Checking for file...&quot;</span><span class="p">)</span>
    
    <span class="c1"># Handle file download if the bot reply contains a file</span>
    <span class="n">download_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">handle_file_download_from_bot_reply</span><span class="p">(</span>
        <span class="n">click_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bot_reply&quot;</span><span class="p">),</span> <span class="n">proxy_to_use</span>
    <span class="p">)</span>
    
    <span class="k">if</span> <span class="n">download_result</span> <span class="ow">and</span> <span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">):</span>
        <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot; File downloaded successfully!&quot;</span><span class="p">)</span>
        <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File saved to: </span><span class="si">{</span><span class="n">download_result</span><span class="p">[</span><span class="s1">&#39;file_path&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose_mode</span><span class="p">:</span>
            <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File size: </span><span class="si">{</span><span class="n">download_result</span><span class="p">[</span><span class="s1">&#39;file_size&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB&quot;</span><span class="p">)</span>
            <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Download speed: </span><span class="si">{</span><span class="n">download_result</span><span class="p">[</span><span class="s1">&#39;speed_mbps&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB/s&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">download_result</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">):</span>
        <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; File download failed: </span><span class="si">{</span><span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown error&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;No file to download in bot reply&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="process_callback_buttons">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.process_callback_buttons">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process_callback_buttons</span><span class="p">(</span><span class="n">bot_reply</span><span class="p">,</span> <span class="n">proxy_to_use</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Process callback buttons from bot reply&quot;&quot;&quot;</span>
    <span class="n">callback_buttons</span> <span class="o">=</span> <span class="p">[</span><span class="n">btn</span> <span class="k">for</span> <span class="n">btn</span> <span class="ow">in</span> <span class="n">bot_reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;buttons&quot;</span><span class="p">,</span> <span class="p">[])</span> <span class="k">if</span> <span class="n">btn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;callback&quot;</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">callback_buttons</span><span class="p">:</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;No callback buttons found in search results&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    
    <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">callback_buttons</span><span class="p">)</span><span class="si">}</span><span class="s2"> callback buttons in search results&quot;</span><span class="p">)</span>
    
    <span class="c1"># Only handle the first callback button</span>
    <span class="n">first_button</span> <span class="o">=</span> <span class="n">callback_buttons</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">button_text</span> <span class="o">=</span> <span class="n">first_button</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">callback_data</span> <span class="o">=</span> <span class="n">first_button</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;callback_data&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">first_button</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>
    <span class="n">message_id</span> <span class="o">=</span> <span class="n">bot_reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message_id&quot;</span><span class="p">)</span>
    
    <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Processing First Button ---&quot;</span><span class="p">)</span>
    <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Button text: </span><span class="si">{</span><span class="n">button_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Determine if this is a request or download button</span>
    <span class="n">has_request</span> <span class="o">=</span> <span class="s2">&quot;request&quot;</span> <span class="ow">in</span> <span class="n">button_text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="c1"># Check if the button text contains a download symbol (e.g., &quot;&quot; or &quot;&quot; or &quot;download&quot;)</span>
    <span class="n">has_download</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">sym</span> <span class="ow">in</span> <span class="n">button_text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">sym</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;download&quot;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">has_request</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">handle_request_button</span><span class="p">(</span><span class="n">button_text</span><span class="p">,</span> <span class="n">callback_data</span><span class="p">,</span> <span class="n">message_id</span><span class="p">,</span> <span class="n">proxy_to_use</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">has_download</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">handle_download_button</span><span class="p">(</span><span class="n">button_text</span><span class="p">,</span> <span class="n">callback_data</span><span class="p">,</span> <span class="n">message_id</span><span class="p">,</span> <span class="n">proxy_to_use</span><span class="p">)</span>
    
    <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Completed processing all </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">callback_buttons</span><span class="p">)</span><span class="si">}</span><span class="s2"> buttons ---&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_latest_messages_from_bot">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.get_latest_messages_from_bot">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_latest_messages_from_bot</span><span class="p">(</span><span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span> <span class="n">bot_username</span><span class="p">,</span> <span class="n">session_file</span><span class="o">=</span><span class="n">SESSION_FILE</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">proxy</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the latest messages from a bot</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        api_id: Your Telegram API ID</span>
<span class="sd">        api_hash: Your Telegram API hash</span>
<span class="sd">        bot_username: Bot&#39;s username</span>
<span class="sd">        session_file: Name of the session file</span>
<span class="sd">        limit: Maximum number of messages to retrieve (default: 10)</span>
<span class="sd">        proxy: Proxy configuration dict or file path</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with success status and messages list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Getting latest </span><span class="si">{</span><span class="n">limit</span><span class="si">}</span><span class="s2"> messages from bot: </span><span class="si">{</span><span class="n">bot_username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Load proxy configuration</span>
    <span class="n">proxy_config</span> <span class="o">=</span> <span class="n">load_proxy_config</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">proxy</span> <span class="ow">and</span> <span class="n">proxy_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Error loading proxy configuration&quot;</span><span class="p">}</span>
    
    <span class="c1"># Create client</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">create_telegram_client</span><span class="p">(</span><span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span> <span class="n">session_file</span><span class="p">,</span> <span class="n">proxy_config</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Check if session file exists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">session_file</span><span class="p">):</span>
            <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Session file not found: </span><span class="si">{</span><span class="n">session_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Session file not found. Run script interactively first to create session.&quot;</span><span class="p">}</span>
        
        <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;Starting client to get latest messages...&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">proxy_config</span><span class="p">:</span>
            <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connecting through proxy: </span><span class="si">{</span><span class="n">proxy_config</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">://</span><span class="si">{</span><span class="n">proxy_config</span><span class="p">[</span><span class="s1">&#39;addr&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">proxy_config</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        
        <span class="c1"># Verify we&#39;re connected</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">is_user_authorized</span><span class="p">():</span>
            <span class="n">error_print</span><span class="p">(</span><span class="s2">&quot;Session expired or not authorized&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Session expired. Please delete the session file and run interactively to re-authenticate.&quot;</span><span class="p">}</span>
        
        <span class="c1"># Get the bot entity</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Getting bot entity for: </span><span class="si">{</span><span class="n">bot_username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">bot_entity</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get_entity</span><span class="p">(</span><span class="n">bot_username</span><span class="p">)</span>
        
        <span class="c1"># Fetch messages</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fetching latest </span><span class="si">{</span><span class="n">limit</span><span class="si">}</span><span class="s2"> messages from bot...&quot;</span><span class="p">)</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">async</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">client</span><span class="o">.</span><span class="n">iter_messages</span><span class="p">(</span><span class="n">bot_entity</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">):</span>
            <span class="c1"># Extract button information</span>
            <span class="n">buttons</span> <span class="o">=</span> <span class="n">extract_button_info</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">reply_markup</span><span class="p">)</span>
            
            <span class="c1"># Check if message has media</span>
            <span class="n">has_media</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">media</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">media_type</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">has_media</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">media</span><span class="p">,</span> <span class="s1">&#39;document&#39;</span><span class="p">):</span>
                    <span class="n">media_type</span> <span class="o">=</span> <span class="s2">&quot;document&quot;</span>
                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">media</span><span class="p">,</span> <span class="s1">&#39;photo&#39;</span><span class="p">):</span>
                    <span class="n">media_type</span> <span class="o">=</span> <span class="s2">&quot;photo&quot;</span>
                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">media</span><span class="p">,</span> <span class="s1">&#39;video&#39;</span><span class="p">):</span>
                    <span class="n">media_type</span> <span class="o">=</span> <span class="s2">&quot;video&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">media_type</span> <span class="o">=</span> <span class="s2">&quot;other&quot;</span>
            
            <span class="n">message_data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;message_id&quot;</span><span class="p">:</span> <span class="n">message</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="n">message</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">timestamp</span><span class="p">(),</span>
                <span class="s2">&quot;date_formatted&quot;</span><span class="p">:</span> <span class="n">message</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">),</span>
                <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">message</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
                <span class="s2">&quot;buttons&quot;</span><span class="p">:</span> <span class="n">buttons</span><span class="p">,</span>
                <span class="s2">&quot;has_media&quot;</span><span class="p">:</span> <span class="n">has_media</span><span class="p">,</span>
                <span class="s2">&quot;media_type&quot;</span><span class="p">:</span> <span class="n">media_type</span><span class="p">,</span>
                <span class="s2">&quot;is_reply&quot;</span><span class="p">:</span> <span class="n">message</span><span class="o">.</span><span class="n">reply_to</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;views&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s1">&#39;views&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="s2">&quot;forwards&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s1">&#39;forwards&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="p">}</span>
            
            <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message_data</span><span class="p">)</span>
            <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retrieved message </span><span class="si">{</span><span class="n">message</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">message</span><span class="o">.</span><span class="n">text</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        
        <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully retrieved </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span><span class="si">}</span><span class="s2"> messages from </span><span class="si">{</span><span class="n">bot_username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;bot_username&quot;</span><span class="p">:</span> <span class="n">bot_username</span><span class="p">,</span>
            <span class="s2">&quot;messages_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">messages</span><span class="p">),</span>
            <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">messages</span>
        <span class="p">}</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error getting latest messages: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exception details: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Error getting latest messages: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;Disconnecting client...&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span></div>


<div class="viewcode-block" id="get_user_profile">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.get_user_profile">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_user_profile</span><span class="p">(</span><span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span> <span class="n">phone_number</span><span class="p">,</span> <span class="n">bot_username</span><span class="p">,</span> <span class="n">session_file</span><span class="o">=</span><span class="n">SESSION_FILE</span><span class="p">,</span> <span class="n">proxy</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get user profile information from Nexus bot by sending /profile command</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        api_id: Your Telegram API ID</span>
<span class="sd">        api_hash: Your Telegram API hash</span>
<span class="sd">        phone_number: Your phone number (not used, kept for compatibility)</span>
<span class="sd">        bot_username: Bot&#39;s username</span>
<span class="sd">        session_file: Name of the session file</span>
<span class="sd">        proxy: Proxy configuration dict or file path</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with user profile information or error</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Getting user profile information from Nexus bot...&quot;</span><span class="p">)</span>
    <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;Sending /profile command to bot&quot;</span><span class="p">)</span>
    
    <span class="c1"># Use the existing send_message_to_bot function to send /profile</span>
    <span class="n">profile_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">send_message_to_bot</span><span class="p">(</span>
        <span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span> <span class="n">phone_number</span><span class="p">,</span> <span class="n">bot_username</span><span class="p">,</span> 
        <span class="s2">&quot;/profile&quot;</span><span class="p">,</span> <span class="n">session_file</span><span class="p">,</span> <span class="n">proxy</span>
    <span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">profile_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ok&quot;</span><span class="p">):</span>
        <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to get profile: </span><span class="si">{</span><span class="n">profile_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown error&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">profile_result</span>
    
    <span class="n">bot_reply</span> <span class="o">=</span> <span class="n">profile_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bot_reply&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">bot_reply</span><span class="p">:</span>
        <span class="n">error_print</span><span class="p">(</span><span class="s2">&quot;No reply received from bot for /profile command&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;No reply received from bot for /profile command&quot;</span><span class="p">}</span>
    
    <span class="n">profile_text</span> <span class="o">=</span> <span class="n">bot_reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Profile response text: </span><span class="si">{</span><span class="n">profile_text</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
    
    <span class="c1"># Parse profile information from the bot response</span>
    <span class="n">profile_info</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;raw_response&quot;</span><span class="p">:</span> <span class="n">profile_text</span><span class="p">,</span>
        <span class="s2">&quot;user_level&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;level_emoji&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;level_name&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;n_points&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;uploaded_count&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;leaderboard_position&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;orcid_url&quot;</span><span class="p">:</span> <span class="kc">None</span>
    <span class="p">}</span>
    
    <span class="c1"># Extract information using regex patterns for the specific Nexus format</span>
    
    <span class="c1"># Extract user level with emoji and name</span>
    <span class="n">level_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;User level:\s*([^\s]+)\s+(.+?)\s+with\s+(\d+)\s+n-points&quot;</span>
    <span class="n">level_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">level_pattern</span><span class="p">,</span> <span class="n">profile_text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">level_match</span><span class="p">:</span>
        <span class="n">profile_info</span><span class="p">[</span><span class="s2">&quot;level_emoji&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">level_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">profile_info</span><span class="p">[</span><span class="s2">&quot;level_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">level_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">profile_info</span><span class="p">[</span><span class="s2">&quot;n_points&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">level_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
        <span class="n">profile_info</span><span class="p">[</span><span class="s2">&quot;user_level&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">profile_info</span><span class="p">[</span><span class="s1">&#39;level_emoji&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">profile_info</span><span class="p">[</span><span class="s1">&#39;level_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracted user level: </span><span class="si">{</span><span class="n">profile_info</span><span class="p">[</span><span class="s1">&#39;user_level&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> with </span><span class="si">{</span><span class="n">profile_info</span><span class="p">[</span><span class="s1">&#39;n_points&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> n-points&quot;</span><span class="p">)</span>
    
    <span class="c1"># Extract uploaded count</span>
    <span class="n">uploaded_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;uploaded\s+(\d+)\s+books and papers&quot;</span>
    <span class="n">uploaded_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">uploaded_pattern</span><span class="p">,</span> <span class="n">profile_text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">uploaded_match</span><span class="p">:</span>
        <span class="n">profile_info</span><span class="p">[</span><span class="s2">&quot;uploaded_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">uploaded_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracted uploaded count: </span><span class="si">{</span><span class="n">profile_info</span><span class="p">[</span><span class="s1">&#39;uploaded_count&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Extract leaderboard position</span>
    <span class="n">leaderboard_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;takes\s+(\d+)(?:st|nd|rd|th)\s+leaderboard position&quot;</span>
    <span class="n">leaderboard_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">leaderboard_pattern</span><span class="p">,</span> <span class="n">profile_text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">leaderboard_match</span><span class="p">:</span>
        <span class="n">profile_info</span><span class="p">[</span><span class="s2">&quot;leaderboard_position&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">leaderboard_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracted leaderboard position: </span><span class="si">{</span><span class="n">profile_info</span><span class="p">[</span><span class="s1">&#39;leaderboard_position&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Extract OrcID URL</span>
    <span class="n">orcid_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;OrcID:\s*Link your OrcID\s*\(([^)]+)\)&quot;</span>
    <span class="n">orcid_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">orcid_pattern</span><span class="p">,</span> <span class="n">profile_text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">orcid_match</span><span class="p">:</span>
        <span class="n">profile_info</span><span class="p">[</span><span class="s2">&quot;orcid_url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">orcid_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracted OrcID URL: </span><span class="si">{</span><span class="n">profile_info</span><span class="p">[</span><span class="s1">&#39;orcid_url&#39;</span><span class="p">][:</span><span class="mi">50</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
    
    <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Successfully retrieved and parsed user profile information&quot;</span><span class="p">)</span>
    <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Profile info extracted: </span><span class="si">{</span><span class="n">profile_info</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;profile&quot;</span><span class="p">:</span> <span class="n">profile_info</span><span class="p">,</span>
        <span class="s2">&quot;bot_reply&quot;</span><span class="p">:</span> <span class="n">bot_reply</span><span class="p">,</span>
        <span class="s2">&quot;sent_message&quot;</span><span class="p">:</span> <span class="n">profile_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sent_message&quot;</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="format_profile_result">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.format_profile_result">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">format_profile_result</span><span class="p">(</span><span class="n">profile_result</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Format the profile result in a human-readable way&quot;&quot;&quot;</span>
    <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;NEXUS USER PROFILE&quot;</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">profile_result</span><span class="p">:</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; ERROR: </span><span class="si">{</span><span class="n">profile_result</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">error_print</span><span class="p">(</span><span class="n">profile_result</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">profile_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ok&quot;</span><span class="p">):</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; SUCCESS: Profile information retrieved!&quot;</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        
        <span class="n">profile</span> <span class="o">=</span> <span class="n">profile_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;profile&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">raw_response</span> <span class="o">=</span> <span class="n">profile</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;raw_response&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">raw_response</span><span class="p">:</span>
            <span class="c1"># Parse the raw response with improved formatting</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">raw_response</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            
            <span class="c1"># Parse user level information from the markdown formatted text</span>
            <span class="n">level_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\*\*User level:\*\*\s*`([^\s]+)\s+([^`]+)`\s+with\s+`(\d+)`\s+n-points,\s+uploaded\s+`(\d+)`\s+books and papers,\s+takes\s+`(\d+)(?:st|nd|rd|th)`\s+leaderboard position&quot;</span>
            <span class="n">level_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">level_pattern</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">level_match</span><span class="p">:</span>
                <span class="n">emoji</span> <span class="o">=</span> <span class="n">level_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">level_name</span> <span class="o">=</span> <span class="n">level_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">n_points</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">level_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
                <span class="n">uploaded_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">level_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
                <span class="n">position</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">level_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
                
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; User Level: </span><span class="si">{</span><span class="n">emoji</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">level_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; N-Points: </span><span class="si">{</span><span class="n">n_points</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Contributions: </span><span class="si">{</span><span class="n">uploaded_count</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> books and papers uploaded&quot;</span><span class="p">)</span>
                
                <span class="c1"># Add ordinal suffix for position</span>
                <span class="k">if</span> <span class="mi">10</span> <span class="o">&lt;=</span> <span class="n">position</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">:</span>
                    <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;th&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">suffix</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;st&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s2">&quot;nd&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="s2">&quot;rd&quot;</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">position</span> <span class="o">%</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;th&quot;</span><span class="p">)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Leaderboard Rank: #</span><span class="si">{</span><span class="n">position</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Parse OrcID information</span>
            <span class="n">orcid_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;\*\*OrcID:\*\*\s*\[([^\]]+)\]\(([^)]+)\)&quot;</span>
            <span class="n">orcid_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">orcid_pattern</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">orcid_match</span><span class="p">:</span>
                <span class="n">link_text</span> <span class="o">=</span> <span class="n">orcid_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">link_url</span> <span class="o">=</span> <span class="n">orcid_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="s2">&quot;Link your OrcID&quot;</span> <span class="ow">in</span> <span class="n">link_text</span><span class="p">:</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; OrcID Status: Not linked&quot;</span><span class="p">)</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Connect at: </span><span class="si">{</span><span class="n">link_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; OrcID: </span><span class="si">{</span><span class="n">link_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   URL: </span><span class="si">{</span><span class="n">link_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Add summary section if we have the main stats</span>
            <span class="k">if</span> <span class="n">level_match</span><span class="p">:</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; SUMMARY&quot;</span><span class="p">)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>
                
                <span class="c1"># Calculate average points per upload</span>
                <span class="k">if</span> <span class="n">uploaded_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">avg_points</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">n_points</span> <span class="o">/</span> <span class="n">uploaded_count</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Average points per contribution: </span><span class="si">{</span><span class="n">avg_points</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="c1"># Status messages based on level</span>
                <span class="n">status_messages</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;Willing Spirit&quot;</span><span class="p">:</span> <span class="s2">&quot; Active contributor, building reputation&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Scholar&quot;</span><span class="p">:</span> <span class="s2">&quot; Experienced researcher&quot;</span><span class="p">,</span> 
                    <span class="s2">&quot;Expert&quot;</span><span class="p">:</span> <span class="s2">&quot; Recognized expert in the community&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Master&quot;</span><span class="p">:</span> <span class="s2">&quot; Top-tier contributor&quot;</span>
                <span class="p">}</span>
                
                <span class="k">if</span> <span class="n">level_name</span> <span class="ow">in</span> <span class="n">status_messages</span><span class="p">:</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Status: </span><span class="si">{</span><span class="n">status_messages</span><span class="p">[</span><span class="n">level_name</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="c1"># Leaderboard context</span>
                <span class="k">if</span> <span class="n">position</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Top 10 contributor! Excellent work!&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">position</span> <span class="o">&lt;=</span> <span class="mi">50</span><span class="p">:</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Top 50 contributor! Great performance!&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">position</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="p">:</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Top 100 contributor! Keep it up!&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Building reputation - </span><span class="si">{</span><span class="n">position</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2"> place&quot;</span><span class="p">)</span>
        
        <span class="c1"># Show profile settings from buttons if available</span>
        <span class="n">bot_reply</span> <span class="o">=</span> <span class="n">profile_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bot_reply&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">buttons</span> <span class="o">=</span> <span class="n">bot_reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;buttons&quot;</span><span class="p">,</span> <span class="p">[])</span>
        
        <span class="k">if</span> <span class="n">buttons</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; PROFILE SETTINGS&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">button</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">:</span>
                <span class="n">button_text</span> <span class="o">=</span> <span class="n">button</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="s2">&quot;Gaia Subscription&quot;</span> <span class="ow">in</span> <span class="n">button_text</span><span class="p">:</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;  Gaia Subscription available&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s2">&quot;profile is invisible&quot;</span> <span class="ow">in</span> <span class="n">button_text</span><span class="p">:</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;  Profile visibility: Private&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s2">&quot;interests are invisible&quot;</span> <span class="ow">in</span> <span class="n">button_text</span><span class="p">:</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;  Interest visibility: Private&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s2">&quot;Receiving daily free points&quot;</span> <span class="ow">in</span> <span class="n">button_text</span><span class="p">:</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;  Daily free points: Enabled&quot;</span><span class="p">)</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; No profile information available in response&quot;</span><span class="p">)</span>
    
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; FAILED: Could not retrieve profile information&quot;</span><span class="p">)</span>
        <span class="n">error_print</span><span class="p">(</span><span class="s2">&quot;Profile retrieval failed&quot;</span><span class="p">)</span>
    
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
    
    <span class="c1"># Print to console and log</span>
    <span class="n">result_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Formatting profile result for display&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">result_text</span><span class="p">)</span></div>


<div class="viewcode-block" id="format_messages_result">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.format_messages_result">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">format_messages_result</span><span class="p">(</span><span class="n">messages_result</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Format the messages result in a human-readable way&quot;&quot;&quot;</span>
    <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;RECENT MESSAGES FROM BOT&quot;</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">messages_result</span><span class="p">:</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; ERROR: </span><span class="si">{</span><span class="n">messages_result</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">error_print</span><span class="p">(</span><span class="n">messages_result</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">messages_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ok&quot;</span><span class="p">):</span>
        <span class="n">bot_username</span> <span class="o">=</span> <span class="n">messages_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bot_username&quot;</span><span class="p">,</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">)</span>
        <span class="n">messages_count</span> <span class="o">=</span> <span class="n">messages_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;messages_count&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="n">messages_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;messages&quot;</span><span class="p">,</span> <span class="p">[])</span>
        
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; SUCCESS: Retrieved </span><span class="si">{</span><span class="n">messages_count</span><span class="si">}</span><span class="s2"> messages from @</span><span class="si">{</span><span class="n">bot_username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">messages</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; No messages found&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">msg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Message #</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   ID: </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message_id&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Date: </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;date_formatted&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="c1"># Message text</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">text</span><span class="p">:</span>
                    <span class="c1"># Truncate long messages for display</span>
                    <span class="n">display_text</span> <span class="o">=</span> <span class="n">text</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">200</span> <span class="k">else</span> <span class="n">text</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Text: </span><span class="si">{</span><span class="n">display_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;   Text: [No text content]&quot;</span><span class="p">)</span>
                
                <span class="c1"># Media information</span>
                <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;has_media&#39;</span><span class="p">):</span>
                    <span class="n">media_type</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;media_type&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Media: </span><span class="si">{</span><span class="n">media_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="c1"># Buttons information</span>
                <span class="n">buttons</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;buttons&#39;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="k">if</span> <span class="n">buttons</span><span class="p">:</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Buttons: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">buttons</span><span class="p">)</span><span class="si">}</span><span class="s2"> button(s)&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">btn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">buttons</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="mi">1</span><span class="p">):</span>  <span class="c1"># Show max 3 buttons</span>
                        <span class="n">btn_text</span> <span class="o">=</span> <span class="n">btn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span>
                        <span class="n">btn_type</span> <span class="o">=</span> <span class="n">btn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
                        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">btn_text</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">btn_type</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">buttons</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;      ... and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">buttons</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">3</span><span class="si">}</span><span class="s2"> more&quot;</span><span class="p">)</span>
                
                <span class="c1"># Additional info</span>
                <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;is_reply&#39;</span><span class="p">):</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;    Reply to previous message&quot;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;views&#39;</span><span class="p">):</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Views: </span><span class="si">{</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;views&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;forwards&#39;</span><span class="p">):</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Forwards: </span><span class="si">{</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;forwards&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># Blank line between messages</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; FAILED: Could not retrieve messages&quot;</span><span class="p">)</span>
        <span class="n">error_print</span><span class="p">(</span><span class="s2">&quot;Message retrieval failed&quot;</span><span class="p">)</span>
    
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
    
    <span class="c1"># Print to console and log</span>
    <span class="n">result_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Formatting messages result for display&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">result_text</span><span class="p">)</span></div>


<div class="viewcode-block" id="fetch_and_display_recent_messages">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.fetch_and_display_recent_messages">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">fetch_and_display_recent_messages</span><span class="p">(</span><span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span> <span class="n">bot_username</span><span class="p">,</span> <span class="n">session_file</span><span class="o">=</span><span class="n">SESSION_FILE</span><span class="p">,</span> 
                                            <span class="n">limit</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">proxy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fetch recent messages from a bot and optionally display them</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        api_id: Your Telegram API ID</span>
<span class="sd">        api_hash: Your Telegram API hash</span>
<span class="sd">        bot_username: Bot&#39;s username</span>
<span class="sd">        session_file: Name of the session file</span>
<span class="sd">        limit: Maximum number of messages to retrieve (default: 10, max: 100)</span>
<span class="sd">        proxy: Proxy configuration dict or file path</span>
<span class="sd">        display: Whether to display formatted results (default: True)</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with success status and messages list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Validate and clamp limit</span>
    <span class="k">if</span> <span class="n">limit</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">limit</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>  <span class="c1"># Reasonable maximum to prevent excessive API calls</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Limit clamped to maximum of 100 messages&quot;</span><span class="p">)</span>
    
    <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fetching </span><span class="si">{</span><span class="n">limit</span><span class="si">}</span><span class="s2"> recent messages from @</span><span class="si">{</span><span class="n">bot_username</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
    
    <span class="c1"># Use existing function to get messages</span>
    <span class="n">messages_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_latest_messages_from_bot</span><span class="p">(</span>
        <span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span> <span class="n">bot_username</span><span class="p">,</span> <span class="n">session_file</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">proxy</span>
    <span class="p">)</span>
    
    <span class="c1"># Display results if requested</span>
    <span class="k">if</span> <span class="n">display</span><span class="p">:</span>
        <span class="n">format_messages_result</span><span class="p">(</span><span class="n">messages_result</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">messages_result</span></div>


<div class="viewcode-block" id="fetch_nexus_aaron_messages">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.fetch_nexus_aaron_messages">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">fetch_nexus_aaron_messages</span><span class="p">(</span><span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span> <span class="n">phone_number</span><span class="p">,</span> <span class="n">session_file</span><span class="o">=</span><span class="n">SESSION_FILE</span><span class="p">,</span> 
                                    <span class="n">limit</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">proxy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fetch recent messages from the @nexus_aaron bot specifically</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        api_id: Your Telegram API ID</span>
<span class="sd">        api_hash: Your Telegram API hash</span>
<span class="sd">        phone_number: Your phone number (not used, kept for compatibility)</span>
<span class="sd">        session_file: Name of the session file</span>
<span class="sd">        limit: Maximum number of messages to retrieve (default: 10, max: 100)</span>
<span class="sd">        proxy: Proxy configuration dict or file path</span>
<span class="sd">        display: Whether to display formatted results (default: True)</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with success status and messages list from @nexus_aaron</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nexus_aaron_username</span> <span class="o">=</span> <span class="s2">&quot;nexus_aaron&quot;</span>
    
    <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fetching </span><span class="si">{</span><span class="n">limit</span><span class="si">}</span><span class="s2"> recent messages from @</span><span class="si">{</span><span class="n">nexus_aaron_username</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
    <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Specialized function for Nexus Aaron bot messages&quot;</span><span class="p">)</span>
    
    <span class="c1"># Use existing function to get messages from nexus_aaron</span>
    <span class="n">messages_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_latest_messages_from_bot</span><span class="p">(</span>
        <span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span> <span class="n">nexus_aaron_username</span><span class="p">,</span> <span class="n">session_file</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">proxy</span>
    <span class="p">)</span>
    
    <span class="c1"># Display results if requested with specialized formatting for nexus_aaron</span>
    <span class="k">if</span> <span class="n">display</span> <span class="ow">and</span> <span class="n">messages_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ok&quot;</span><span class="p">):</span>
        <span class="n">format_nexus_aaron_messages</span><span class="p">(</span><span class="n">messages_result</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">display</span><span class="p">:</span>
        <span class="n">format_messages_result</span><span class="p">(</span><span class="n">messages_result</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">messages_result</span></div>


<div class="viewcode-block" id="format_nexus_aaron_messages">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.format_nexus_aaron_messages">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">format_nexus_aaron_messages</span><span class="p">(</span><span class="n">messages_result</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Format nexus_aaron messages with specialized formatting for research requests&quot;&quot;&quot;</span>
    <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;RECENT MESSAGES FROM @nexus_aaron&quot;</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">messages_result</span><span class="p">:</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; ERROR: </span><span class="si">{</span><span class="n">messages_result</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">error_print</span><span class="p">(</span><span class="n">messages_result</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">messages_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ok&quot;</span><span class="p">):</span>
        <span class="n">bot_username</span> <span class="o">=</span> <span class="n">messages_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bot_username&quot;</span><span class="p">,</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">)</span>
        <span class="n">messages_count</span> <span class="o">=</span> <span class="n">messages_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;messages_count&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="n">messages_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;messages&quot;</span><span class="p">,</span> <span class="p">[])</span>
        
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; SUCCESS: Retrieved </span><span class="si">{</span><span class="n">messages_count</span><span class="si">}</span><span class="s2"> messages from @</span><span class="si">{</span><span class="n">bot_username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">messages</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; No messages found&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Categorize messages</span>
            <span class="n">requests</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">uploads</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">other</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">text</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#request&#39;</span><span class="p">):</span>
                    <span class="n">requests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s1">&#39;#voting&#39;</span> <span class="ow">in</span> <span class="n">text</span> <span class="ow">and</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;has_media&#39;</span><span class="p">):</span>
                    <span class="n">uploads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">other</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            
            <span class="c1"># Display statistics</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; MESSAGE BREAKDOWN:&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Research Requests: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">requests</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Document Uploads: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">uploads</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Other Messages: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            
            <span class="c1"># Display research requests</span>
            <span class="k">if</span> <span class="n">requests</span><span class="p">:</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; RESEARCH REQUESTS:&quot;</span><span class="p">)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">msg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">requests</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">request_info</span> <span class="o">=</span> <span class="n">parse_nexus_aaron_request</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
                    
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]  Request Point: </span><span class="si">{</span><span class="n">request_info</span><span class="p">[</span><span class="s1">&#39;request_count&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Time: </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;date_formatted&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Type: </span><span class="si">{</span><span class="n">request_info</span><span class="p">[</span><span class="s1">&#39;pub_type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">request_info</span><span class="p">[</span><span class="s1">&#39;doi&#39;</span><span class="p">]:</span>
                        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    DOI: </span><span class="si">{</span><span class="n">request_info</span><span class="p">[</span><span class="s1">&#39;doi&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        
                        <span class="c1"># Extract publisher name from DOI</span>
                        <span class="n">publisher_name</span> <span class="o">=</span> <span class="n">get_publisher_name_from_doi</span><span class="p">(</span><span class="n">request_info</span><span class="p">[</span><span class="s1">&#39;doi&#39;</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">publisher_name</span><span class="p">:</span>
                            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Publisher: </span><span class="si">{</span><span class="n">publisher_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">request_info</span><span class="p">[</span><span class="s1">&#39;publisher_code&#39;</span><span class="p">]:</span>
                            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Publisher Code: </span><span class="si">{</span><span class="n">request_info</span><span class="p">[</span><span class="s1">&#39;publisher_code&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">request_info</span><span class="p">[</span><span class="s1">&#39;publisher_code&#39;</span><span class="p">]:</span>
                        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Publisher Code: </span><span class="si">{</span><span class="n">request_info</span><span class="p">[</span><span class="s1">&#39;publisher_code&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">request_info</span><span class="p">[</span><span class="s1">&#39;libstc_link&#39;</span><span class="p">]:</span>
                        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    LibSTC: </span><span class="si">{</span><span class="n">request_info</span><span class="p">[</span><span class="s1">&#39;libstc_link&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">request_info</span><span class="p">[</span><span class="s1">&#39;worldcat_link&#39;</span><span class="p">]:</span>
                        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    WorldCat: </span><span class="si">{</span><span class="n">request_info</span><span class="p">[</span><span class="s1">&#39;worldcat_link&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Message ID: </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message_id&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            
            <span class="c1"># Display document uploads</span>
            <span class="k">if</span> <span class="n">uploads</span><span class="p">:</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; DOCUMENT UPLOADS:&quot;</span><span class="p">)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">msg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">uploads</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">upload_info</span> <span class="o">=</span> <span class="n">parse_nexus_aaron_upload</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
                    
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;#</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">upload_info</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Time: </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;date_formatted&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Type: </span><span class="si">{</span><span class="n">upload_info</span><span class="p">[</span><span class="s1">&#39;pub_type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">upload_info</span><span class="p">[</span><span class="s1">&#39;author&#39;</span><span class="p">]:</span>
                        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Author: </span><span class="si">{</span><span class="n">upload_info</span><span class="p">[</span><span class="s1">&#39;author&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">upload_info</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]:</span>
                        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Year: </span><span class="si">{</span><span class="n">upload_info</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">upload_info</span><span class="p">[</span><span class="s1">&#39;pages&#39;</span><span class="p">]:</span>
                        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Pages: </span><span class="si">{</span><span class="n">upload_info</span><span class="p">[</span><span class="s1">&#39;pages&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">upload_info</span><span class="p">[</span><span class="s1">&#39;doi&#39;</span><span class="p">]:</span>
                        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    DOI: </span><span class="si">{</span><span class="n">upload_info</span><span class="p">[</span><span class="s1">&#39;doi&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        
                        <span class="c1"># Extract publisher name from DOI</span>
                        <span class="n">publisher_name</span> <span class="o">=</span> <span class="n">get_publisher_name_from_doi</span><span class="p">(</span><span class="n">upload_info</span><span class="p">[</span><span class="s1">&#39;doi&#39;</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">publisher_name</span><span class="p">:</span>
                            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Publisher: </span><span class="si">{</span><span class="n">publisher_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">upload_info</span><span class="p">[</span><span class="s1">&#39;worldcat_link&#39;</span><span class="p">]:</span>
                        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    WorldCat: </span><span class="si">{</span><span class="n">upload_info</span><span class="p">[</span><span class="s1">&#39;worldcat_link&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">upload_info</span><span class="p">[</span><span class="s1">&#39;isbn&#39;</span><span class="p">]:</span>
                        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    ISBN: </span><span class="si">{</span><span class="n">upload_info</span><span class="p">[</span><span class="s1">&#39;isbn&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="n">voting_status</span> <span class="o">=</span> <span class="s2">&quot; Available for voting&quot;</span> <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;buttons&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot; No voting available&quot;</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Status: </span><span class="si">{</span><span class="n">voting_status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Message ID: </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message_id&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            
            <span class="c1"># Display other messages</span>
            <span class="k">if</span> <span class="n">other</span><span class="p">:</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; OTHER MESSAGES:&quot;</span><span class="p">)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">msg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">display_text</span> <span class="o">=</span> <span class="n">text</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span> <span class="k">else</span> <span class="n">text</span>
                    
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;#</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">display_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Time: </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;date_formatted&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Message ID: </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message_id&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;has_media&#39;</span><span class="p">):</span>
                        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Media: </span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;media_type&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;buttons&#39;</span><span class="p">):</span>
                        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Buttons: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;buttons&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; FAILED: Could not retrieve messages&quot;</span><span class="p">)</span>
        <span class="n">error_print</span><span class="p">(</span><span class="s2">&quot;Messages retrieval failed&quot;</span><span class="p">)</span>
    
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
    
    <span class="c1"># Print to console and log</span>
    <span class="n">result_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Formatting nexus_aaron messages for display&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">result_text</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_publisher_name_from_doi">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.get_publisher_name_from_doi">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_publisher_name_from_doi</span><span class="p">(</span><span class="n">doi</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract publisher name from DOI using Crossref API</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        doi: DOI string (e.g., &quot;10.1038/nature12373&quot;)</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Publisher name string or None if not found</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">doi</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">doi</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="c1"># Extract publisher prefix from DOI (part between 10. and /)</span>
    <span class="n">doi_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^10\.(\d+)/&#39;</span><span class="p">,</span> <span class="n">doi</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">doi_match</span><span class="p">:</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid DOI format for publisher extraction: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="n">publisher_prefix</span> <span class="o">=</span> <span class="n">doi_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracted publisher prefix from DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">publisher_prefix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Query Crossref API for publisher information</span>
        <span class="c1"># Use the DOI to get work information which includes publisher</span>
        <span class="n">crossref_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://api.crossref.org/works/</span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span>
        
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span> <span class="s1">&#39;Mozilla/5.0 (compatible; TelegramBot/1.0; mailto:your-email@example.com)&#39;</span>
        <span class="p">}</span>
        
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Querying Crossref API for DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">crossref_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            
            <span class="c1"># Extract publisher name from the response</span>
            <span class="n">work</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">publisher</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;publisher&#39;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">publisher</span><span class="p">:</span>
                <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found publisher name for DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">publisher</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">publisher</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No publisher information found in Crossref response for DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="c1"># Fallback: try to get institution/organization info</span>
                <span class="n">institution</span> <span class="o">=</span> <span class="n">work</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;institution&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">institution</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">institution</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">institution</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">inst_name</span> <span class="o">=</span> <span class="n">institution</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">inst_name</span><span class="p">:</span>
                        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found institution name as fallback for DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">inst_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">inst_name</span>
        
        <span class="k">elif</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
            <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DOI not found in Crossref database: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Crossref API error for DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">: HTTP </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
            
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error querying Crossref API for DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error getting publisher name for DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    
    <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="parse_nexus_aaron_request">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.parse_nexus_aaron_request">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">parse_nexus_aaron_request</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse a nexus_aaron request message to extract structured information</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        text: The raw message text from nexus_aaron</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with parsed information</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">request_info</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;request_count&#39;</span><span class="p">:</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pub_type&#39;</span><span class="p">:</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">,</span>
        <span class="s1">&#39;doi&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;publisher_code&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;libstc_link&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;worldcat_link&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;raw_text&#39;</span><span class="p">:</span> <span class="n">text</span>
    <span class="p">}</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">request_info</span>
    
    <span class="c1"># Extract request count: #request (X)</span>
    <span class="n">request_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;#request \((\d+)\)&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request_match</span><span class="p">:</span>
        <span class="n">request_info</span><span class="p">[</span><span class="s1">&#39;request_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># Determine publication type by emoji</span>
    <span class="k">if</span> <span class="s1">&#39;&#39;</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
        <span class="n">request_info</span><span class="p">[</span><span class="s1">&#39;pub_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Research Paper&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;&#39;</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
        <span class="n">request_info</span><span class="p">[</span><span class="s1">&#39;pub_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Book&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;&#39;</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
        <span class="n">request_info</span><span class="p">[</span><span class="s1">&#39;pub_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Book Chapter&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">request_info</span><span class="p">[</span><span class="s1">&#39;pub_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Unknown&#39;</span>
    
    <span class="c1"># Extract DOI</span>
    <span class="n">doi_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(10\.\d+/[^\s\]]+)&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">doi_match</span><span class="p">:</span>
        <span class="n">request_info</span><span class="p">[</span><span class="s1">&#39;doi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">doi_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># Extract publisher code (e.g., #p_1177)</span>
    <span class="n">publisher_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;#p_(\d+)&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">publisher_match</span><span class="p">:</span>
        <span class="n">request_info</span><span class="p">[</span><span class="s1">&#39;publisher_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;p_</span><span class="si">{</span><span class="n">publisher_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    
    <span class="c1"># Extract LibSTC link</span>
    <span class="n">libstc_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\[\]\((https://libstc\.cc/[^)]+)\)&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">libstc_match</span><span class="p">:</span>
        <span class="n">libstc_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\[\]\((https://libstc\.cc/[^)]+)\)&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">libstc_match</span><span class="p">:</span>
        <span class="n">request_info</span><span class="p">[</span><span class="s1">&#39;libstc_link&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">libstc_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># Extract WorldCat link</span>
    <span class="n">worldcat_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\[worldcat\]\((https://search\.worldcat\.org/[^)]+)\)&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">worldcat_match</span><span class="p">:</span>
        <span class="n">request_info</span><span class="p">[</span><span class="s1">&#39;worldcat_link&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">worldcat_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">request_info</span></div>


<div class="viewcode-block" id="parse_nexus_aaron_upload">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.parse_nexus_aaron_upload">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">parse_nexus_aaron_upload</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse a nexus_aaron upload/voting message to extract structured information</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        text: The raw message text from nexus_aaron upload</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with parsed upload information</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">upload_info</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">,</span>
        <span class="s1">&#39;author&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;pages&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;pub_type&#39;</span><span class="p">:</span> <span class="s1">&#39;Unknown&#39;</span><span class="p">,</span>
        <span class="s1">&#39;doi&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;worldcat_link&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;isbn&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;libstc_link&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;raw_text&#39;</span><span class="p">:</span> <span class="n">text</span>
    <span class="p">}</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">upload_info</span>
    
    <span class="c1"># Determine publication type by emoji</span>
    <span class="k">if</span> <span class="s1">&#39;&#39;</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
        <span class="n">upload_info</span><span class="p">[</span><span class="s1">&#39;pub_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Research Paper&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;&#39;</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
        <span class="n">upload_info</span><span class="p">[</span><span class="s1">&#39;pub_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Book&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;&#39;</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
        <span class="n">upload_info</span><span class="p">[</span><span class="s1">&#39;pub_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Book Chapter&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">upload_info</span><span class="p">[</span><span class="s1">&#39;pub_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Unknown&#39;</span>
    
    <span class="c1"># Extract title from **title** format</span>
    <span class="n">title_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\*\*([^*]+)\*\*&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">title_match</span><span class="p">:</span>
        <span class="n">upload_info</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">title_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    
    <span class="c1"># Extract year from (YYYY) or (YYYY-MM) format</span>
    <span class="n">year_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\((\d</span><span class="si">{4}</span><span class="s1">)(?:-\d</span><span class="si">{2}</span><span class="s1">)?\)&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">year_match</span><span class="p">:</span>
        <span class="n">upload_info</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">year_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># Extract author name (appears after title and before year)</span>
    <span class="c1"># Pattern: **Title** (year) \nAuthor pp. pages</span>
    <span class="n">author_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\*\*[^*]+\*\*[^</span><span class="se">\\</span><span class="s1">n]*</span><span class="se">\\</span><span class="s1">n([^</span><span class="se">\\</span><span class="s1">n]+?)(?:\s+pp\.\s+\d+)?&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">author_match</span><span class="p">:</span>
        <span class="n">upload_info</span><span class="p">[</span><span class="s1">&#39;author&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">author_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    
    <span class="c1"># Extract pages</span>
    <span class="n">pages_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;pp\.\s+(\d+)&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pages_match</span><span class="p">:</span>
        <span class="n">upload_info</span><span class="p">[</span><span class="s1">&#39;pages&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pages_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># Extract DOI</span>
    <span class="n">doi_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(10\.\d+/[^\s\]]+)&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">doi_match</span><span class="p">:</span>
        <span class="n">upload_info</span><span class="p">[</span><span class="s1">&#39;doi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">doi_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># Extract WorldCat link and ISBN</span>
    <span class="n">worldcat_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\[isbn:(\d+)\]\((https://search\.worldcat\.org/[^)]+)\)&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">worldcat_match</span><span class="p">:</span>
        <span class="n">upload_info</span><span class="p">[</span><span class="s1">&#39;isbn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">worldcat_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">upload_info</span><span class="p">[</span><span class="s1">&#39;worldcat_link&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">worldcat_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="c1"># Extract LibSTC link</span>
    <span class="n">libstc_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\[\]\((https://libstc\.cc/[^)]+)\)&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">libstc_match</span><span class="p">:</span>
        <span class="n">libstc_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\[\]\((https://libstc\.cc/[^)]+)\)&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">libstc_match</span><span class="p">:</span>
        <span class="n">upload_info</span><span class="p">[</span><span class="s1">&#39;libstc_link&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">libstc_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">upload_info</span></div>


<div class="viewcode-block" id="upload_file_to_bot">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.upload_file_to_bot">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">upload_file_to_bot</span><span class="p">(</span><span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span> <span class="n">phone_number</span><span class="p">,</span> <span class="n">bot_username</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">session_file</span><span class="o">=</span><span class="n">SESSION_FILE</span><span class="p">,</span> <span class="n">proxy</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Upload a file to a Telegram bot with optional message</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        api_id: Your Telegram API ID</span>
<span class="sd">        api_hash: Your Telegram API hash</span>
<span class="sd">        phone_number: Your phone number (not used, kept for compatibility)</span>
<span class="sd">        bot_username: Bot&#39;s username</span>
<span class="sd">        file_path: Path to the file to upload</span>
<span class="sd">        message: Optional message to send with the file (default: &quot;&quot;)</span>
<span class="sd">        session_file: Name of the session file</span>
<span class="sd">        proxy: Proxy configuration dict or file path</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with upload result and bot reply</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Uploading file to bot: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Validate file exists</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File not found: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;File not found: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
    
    <span class="c1"># Get file info</span>
    <span class="n">file_size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    <span class="n">file_size_mb</span> <span class="o">=</span> <span class="n">file_size</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>
    
    <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Preparing to upload: </span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File size: </span><span class="si">{</span><span class="n">file_size_mb</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB&quot;</span><span class="p">)</span>
    
    <span class="c1"># Load proxy configuration</span>
    <span class="n">proxy_config</span> <span class="o">=</span> <span class="n">load_proxy_config</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">proxy</span> <span class="ow">and</span> <span class="n">proxy_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Error loading proxy configuration&quot;</span><span class="p">}</span>
    
    <span class="c1"># Create client</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">create_telegram_client</span><span class="p">(</span><span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span> <span class="n">session_file</span><span class="p">,</span> <span class="n">proxy_config</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Check if session file exists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">session_file</span><span class="p">):</span>
            <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Session file not found: </span><span class="si">{</span><span class="n">session_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Session file not found. Run script interactively first to create session.&quot;</span><span class="p">}</span>
        
        <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;Starting client for file upload...&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">proxy_config</span><span class="p">:</span>
            <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connecting through proxy: </span><span class="si">{</span><span class="n">proxy_config</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">://</span><span class="si">{</span><span class="n">proxy_config</span><span class="p">[</span><span class="s1">&#39;addr&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">proxy_config</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        
        <span class="c1"># Verify we&#39;re connected</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">is_user_authorized</span><span class="p">():</span>
            <span class="n">error_print</span><span class="p">(</span><span class="s2">&quot;Session expired or not authorized&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Session expired. Please delete the session file and run interactively to re-authenticate.&quot;</span><span class="p">}</span>
        
        <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;User authorized successfully&quot;</span><span class="p">)</span>
        
        <span class="c1"># Get the bot entity</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Getting bot entity for: </span><span class="si">{</span><span class="n">bot_username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">bot_entity</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get_entity</span><span class="p">(</span><span class="n">bot_username</span><span class="p">)</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bot entity retrieved: </span><span class="si">{</span><span class="n">bot_entity</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Create message handler for bot responses</span>
        <span class="n">handler</span><span class="p">,</span> <span class="n">get_bot_reply</span> <span class="o">=</span> <span class="n">create_message_handler</span><span class="p">(</span><span class="n">bot_entity</span><span class="p">)</span>
        <span class="n">client</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">events</span><span class="o">.</span><span class="n">NewMessage</span><span class="p">(</span><span class="n">from_users</span><span class="o">=</span><span class="n">bot_entity</span><span class="p">))(</span><span class="n">handler</span><span class="p">)</span>
        
        <span class="c1"># Upload progress callback</span>
        <span class="n">last_progress</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">def</span><span class="w"> </span><span class="nf">progress_callback</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">total</span><span class="p">):</span>
            <span class="k">nonlocal</span> <span class="n">last_progress</span>
            <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">progress</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">current</span> <span class="o">/</span> <span class="n">total</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">progress</span> <span class="o">&gt;=</span> <span class="n">last_progress</span> <span class="o">+</span> <span class="mi">10</span><span class="p">:</span>  <span class="c1"># Update every 10%</span>
                    <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Upload progress: </span><span class="si">{</span><span class="n">progress</span><span class="si">}</span><span class="s2">% (</span><span class="si">{</span><span class="n">current</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB)&quot;</span><span class="p">)</span>
                    <span class="n">last_progress</span> <span class="o">=</span> <span class="n">progress</span>
        
        <span class="c1"># Send file with optional message</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting file upload: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">send_file</span><span class="p">(</span>
            <span class="n">bot_username</span><span class="p">,</span>
            <span class="n">file_path</span><span class="p">,</span>
            <span class="n">caption</span><span class="o">=</span><span class="n">message</span> <span class="k">if</span> <span class="n">message</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">progress_callback</span><span class="o">=</span><span class="n">progress_callback</span>
        <span class="p">)</span>
        
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">upload_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="n">upload_speed_mbps</span> <span class="o">=</span> <span class="n">file_size_mb</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">upload_time</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; File uploaded successfully!&quot;</span><span class="p">)</span>
        <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Upload time: </span><span class="si">{</span><span class="n">upload_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
        <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Upload speed: </span><span class="si">{</span><span class="n">upload_speed_mbps</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB/s&quot;</span><span class="p">)</span>
        <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Message ID: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Wait for bot reply</span>
        <span class="n">bot_reply</span> <span class="o">=</span> <span class="k">await</span> <span class="n">wait_for_reply</span><span class="p">(</span><span class="n">get_bot_reply</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
        
        <span class="c1"># If no immediate reply, fetch recent messages</span>
        <span class="k">if</span> <span class="n">bot_reply</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bot_reply</span> <span class="o">=</span> <span class="k">await</span> <span class="n">fetch_recent_messages</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">bot_entity</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        
        <span class="n">response</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;uploaded_file&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;file_path&quot;</span><span class="p">:</span> <span class="n">file_path</span><span class="p">,</span>
                <span class="s2">&quot;file_name&quot;</span><span class="p">:</span> <span class="n">file_name</span><span class="p">,</span>
                <span class="s2">&quot;file_size&quot;</span><span class="p">:</span> <span class="n">file_size</span><span class="p">,</span>
                <span class="s2">&quot;file_size_mb&quot;</span><span class="p">:</span> <span class="n">file_size_mb</span><span class="p">,</span>
                <span class="s2">&quot;upload_time&quot;</span><span class="p">:</span> <span class="n">upload_time</span><span class="p">,</span>
                <span class="s2">&quot;upload_speed_mbps&quot;</span><span class="p">:</span> <span class="n">upload_speed_mbps</span><span class="p">,</span>
                <span class="s2">&quot;message_id&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">timestamp</span><span class="p">(),</span>
                <span class="s2">&quot;caption&quot;</span><span class="p">:</span> <span class="n">message</span> <span class="k">if</span> <span class="n">message</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="p">},</span>
            <span class="s2">&quot;bot_reply&quot;</span><span class="p">:</span> <span class="n">bot_reply</span>
        <span class="p">}</span>
        
        <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;File upload operation completed successfully&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error uploading file: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File upload exception: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Error uploading file: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;Disconnecting client after file upload...&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span></div>


<div class="viewcode-block" id="format_upload_result">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.format_upload_result">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">format_upload_result</span><span class="p">(</span><span class="n">upload_result</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Format the upload result in a human-readable way&quot;&quot;&quot;</span>
    <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;FILE UPLOAD RESULT&quot;</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">upload_result</span><span class="p">:</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; ERROR: </span><span class="si">{</span><span class="n">upload_result</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">error_print</span><span class="p">(</span><span class="n">upload_result</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">upload_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ok&quot;</span><span class="p">):</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; SUCCESS: File uploaded successfully!&quot;</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        
        <span class="c1"># Format uploaded file info</span>
        <span class="n">file_info</span> <span class="o">=</span> <span class="n">upload_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;uploaded_file&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="n">file_info</span><span class="p">:</span>
            <span class="n">upload_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">file_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; UPLOADED FILE:&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Name: </span><span class="si">{</span><span class="n">file_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Size: </span><span class="si">{</span><span class="n">file_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_size_mb&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Upload Time: </span><span class="si">{</span><span class="n">file_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;upload_time&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Speed: </span><span class="si">{</span><span class="n">file_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;upload_speed_mbps&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB/s&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Message ID: </span><span class="si">{</span><span class="n">file_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message_id&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Time: </span><span class="si">{</span><span class="n">upload_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="n">caption</span> <span class="o">=</span> <span class="n">file_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;caption&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">caption</span><span class="p">:</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Caption: </span><span class="si">{</span><span class="n">caption</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Upload details: </span><span class="si">{</span><span class="n">file_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">file_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_size_mb&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB in </span><span class="si">{</span><span class="n">file_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;upload_time&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
        
        <span class="c1"># Format bot reply</span>
        <span class="n">bot_reply</span> <span class="o">=</span> <span class="n">upload_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bot_reply&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bot_reply</span><span class="p">:</span>
            <span class="n">reply_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">bot_reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; BOT REPLY:&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    ID: </span><span class="si">{</span><span class="n">bot_reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message_id&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Time: </span><span class="si">{</span><span class="n">reply_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Text: </span><span class="si">{</span><span class="n">bot_reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Format buttons if present</span>
            <span class="n">buttons</span> <span class="o">=</span> <span class="n">bot_reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;buttons&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="n">buttons</span><span class="p">:</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;    Buttons:&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">button</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">buttons</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">button_type</span> <span class="o">=</span> <span class="n">button</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
                    <span class="n">button_text</span> <span class="o">=</span> <span class="n">button</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">button_type</span> <span class="o">==</span> <span class="s2">&quot;url&quot;</span><span class="p">:</span>
                        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">button_text</span><span class="si">}</span><span class="s2"> (URL: </span><span class="si">{</span><span class="n">button</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">button_type</span> <span class="o">==</span> <span class="s2">&quot;callback&quot;</span><span class="p">:</span>
                        <span class="n">callback_data</span> <span class="o">=</span> <span class="n">button</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;callback_data&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span>
                        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">button_text</span><span class="si">}</span><span class="s2"> (Callback: </span><span class="si">{</span><span class="n">callback_data</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">button_text</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">button_type</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            
            <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bot reply: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">buttons</span><span class="p">)</span><span class="si">}</span><span class="s2"> buttons, </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">bot_reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">))</span><span class="si">}</span><span class="s2"> chars&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; BOT REPLY: No reply received (timeout)&quot;</span><span class="p">)</span>
            <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;No bot reply received for file upload&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; FAILED: File upload failed&quot;</span><span class="p">)</span>
        <span class="n">error_print</span><span class="p">(</span><span class="s2">&quot;File upload failed&quot;</span><span class="p">)</span>
    
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
    
    <span class="c1"># Print to console and log</span>
    <span class="n">result_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Formatting upload result for display&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">result_text</span><span class="p">)</span></div>


<div class="viewcode-block" id="upload_file_to_nexus_aaron">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.upload_file_to_nexus_aaron">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">upload_file_to_nexus_aaron</span><span class="p">(</span><span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span> <span class="n">phone_number</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">session_file</span><span class="o">=</span><span class="n">SESSION_FILE</span><span class="p">,</span> <span class="n">proxy</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Upload a file to the @nexus_aaron bot specifically</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        api_id: Your Telegram API ID</span>
<span class="sd">        api_hash: Your Telegram API hash</span>
<span class="sd">        phone_number: Your phone number (not used, kept for compatibility)</span>
<span class="sd">        file_path: Path to the file to upload</span>
<span class="sd">        message: Optional message to send with the file (default: &quot;&quot;)</span>
<span class="sd">        session_file: Name of the session file</span>
<span class="sd">        proxy: Proxy configuration dict or file path</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with upload result and bot reply from @nexus_aaron</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nexus_aaron_username</span> <span class="o">=</span> <span class="s2">&quot;nexus_aaron&quot;</span>
    
    <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Uploading file to @</span><span class="si">{</span><span class="n">nexus_aaron_username</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
    <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File path: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Use the existing upload_file_to_bot function with nexus_aaron as target</span>
    <span class="n">upload_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">upload_file_to_bot</span><span class="p">(</span>
        <span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span> <span class="n">phone_number</span><span class="p">,</span> <span class="n">nexus_aaron_username</span><span class="p">,</span> 
        <span class="n">file_path</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">session_file</span><span class="p">,</span> <span class="n">proxy</span>
    <span class="p">)</span>
    
    <span class="k">if</span> <span class="n">upload_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ok&quot;</span><span class="p">):</span>
        <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Successfully uploaded file to @</span><span class="si">{</span><span class="n">nexus_aaron_username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Add nexus_aaron specific information to the result</span>
        <span class="n">upload_result</span><span class="p">[</span><span class="s2">&quot;target_bot&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nexus_aaron_username</span>
        <span class="n">upload_result</span><span class="p">[</span><span class="s2">&quot;upload_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;nexus_aaron_contribution&quot;</span>
        
        <span class="c1"># Parse bot reply for nexus_aaron specific content</span>
        <span class="n">bot_reply</span> <span class="o">=</span> <span class="n">upload_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bot_reply&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bot_reply</span> <span class="ow">and</span> <span class="n">bot_reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">):</span>
            <span class="n">reply_text</span> <span class="o">=</span> <span class="n">bot_reply</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">]</span>
            
            <span class="c1"># Check for common nexus_aaron responses</span>
            <span class="k">if</span> <span class="s2">&quot;thank you&quot;</span> <span class="ow">in</span> <span class="n">reply_text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;received&quot;</span> <span class="ow">in</span> <span class="n">reply_text</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">upload_result</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;received&quot;</span>
                <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;File was received by nexus_aaron&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s2">&quot;voting&quot;</span> <span class="ow">in</span> <span class="n">reply_text</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">upload_result</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;pending_voting&quot;</span>
                <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;File is pending community voting&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">reply_text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;problem&quot;</span> <span class="ow">in</span> <span class="n">reply_text</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">upload_result</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span>
                <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;nexus_aaron reported an issue with the file&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">upload_result</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;uploaded&quot;</span>
        
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Upload to nexus_aaron completed with status: </span><span class="si">{</span><span class="n">upload_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Failed to upload file to @</span><span class="si">{</span><span class="n">nexus_aaron_username</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">upload_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown error&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">upload_result</span></div>


<div class="viewcode-block" id="simple_upload_to_nexus_aaron">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.simple_upload_to_nexus_aaron">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">simple_upload_to_nexus_aaron</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Upload a file to the @nexus_aaron bot with minimal input.</span>
<span class="sd">    If the file is a PDF, try to extract the DOI using getpapers.</span>
<span class="sd">    If DOI extraction fails, prompt the user to enter a DOI manually (with timeout).</span>
<span class="sd">    Args:</span>
<span class="sd">        file_path (str): Path to the file to upload.</span>
<span class="sd">        verbose (bool): If True, enable verbose output.</span>
<span class="sd">    Returns:</span>
<span class="sd">        dict: Upload result.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Optionally enable verbose mode and logging</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">setup_logging</span><span class="p">(</span><span class="n">DEFAULT_LOG_FILE</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Verbose mode enabled for simple upload.&quot;</span><span class="p">)</span>

    <span class="c1"># Load credentials from default location</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">CREDENTIALS_FILE</span><span class="p">):</span>
        <span class="n">error_print</span><span class="p">(</span><span class="s2">&quot;Credentials file not found. Please run the script interactively to set up credentials.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Credentials file not found.&quot;</span><span class="p">}</span>
    <span class="n">creds</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">CREDENTIALS_FILE</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">creds</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load credentials: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Failed to load credentials: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
    <span class="n">api_id</span> <span class="o">=</span> <span class="n">creds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tg_api_id&quot;</span><span class="p">)</span>
    <span class="n">api_hash</span> <span class="o">=</span> <span class="n">creds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tg_api_hash&quot;</span><span class="p">)</span>
    <span class="n">phone</span> <span class="o">=</span> <span class="n">creds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;phone&quot;</span><span class="p">)</span>
    <span class="c1"># Use default session file and proxy if available</span>
    <span class="n">session_file</span> <span class="o">=</span> <span class="n">SESSION_FILE</span>
    <span class="n">proxy</span> <span class="o">=</span> <span class="k">await</span> <span class="n">decide_proxy_usage</span><span class="p">(</span><span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span> <span class="n">phone</span><span class="p">,</span> <span class="n">SESSION_FILE</span><span class="p">,</span> <span class="n">DEFAULT_PROXY_FILE</span><span class="p">)</span>
    
    <span class="c1"># Print proxy decision for debugging/visibility</span>
    <span class="k">if</span> <span class="n">proxy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Proxy decision: No proxy needed (direct connection)&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">proxy</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Proxy decision: No working proxy found (connection may fail)&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Proxy decision: Using proxy configuration: </span><span class="si">{</span><span class="n">proxy</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># If file is a PDF, try to extract DOI for caption</span>
    <span class="n">caption</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">doi</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">file_path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.pdf&quot;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attempting to extract DOI from PDF: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">doi</span> <span class="o">=</span> <span class="n">getpapers</span><span class="o">.</span><span class="n">extract_doi_from_pdf</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">doi</span><span class="p">:</span>
                <span class="n">caption</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracted DOI from PDF: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Could not extract DOI from PDF.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not extract DOI from PDF: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Could not extract DOI from PDF.&quot;</span><span class="p">)</span>

        <span class="c1"># If DOI extraction failed, prompt user for manual input</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">doi</span><span class="p">:</span>
            <span class="n">user_doi</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span>
                <span class="s2">&quot;Enter DOI for this PDF (or leave blank to cancel): &quot;</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">keep_origin</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">user_doi</span> <span class="o">=</span> <span class="n">user_doi</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">user_doi</span><span class="p">:</span>
                <span class="n">error_print</span><span class="p">(</span><span class="s2">&quot;No DOI provided. Upload cancelled.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;No DOI provided. Upload cancelled.&quot;</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">caption</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;DOI: </span><span class="si">{</span><span class="n">user_doi</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using manually entered DOI: </span><span class="si">{</span><span class="n">user_doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Call upload_file_to_nexus_aaron</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">upload_file_to_nexus_aaron</span><span class="p">(</span>
        <span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span> <span class="n">phone</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">caption</span><span class="p">,</span> <span class="n">session_file</span><span class="p">,</span> <span class="n">proxy</span>
    <span class="p">)</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">format_nexus_aaron_upload_result</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="format_nexus_aaron_upload_result">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.format_nexus_aaron_upload_result">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">format_nexus_aaron_upload_result</span><span class="p">(</span><span class="n">upload_result</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Format the nexus_aaron upload result with specialized formatting&quot;&quot;&quot;</span>
    <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;NEXUS AARON FILE UPLOAD RESULT&quot;</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">upload_result</span><span class="p">:</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; ERROR: </span><span class="si">{</span><span class="n">upload_result</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">error_print</span><span class="p">(</span><span class="n">upload_result</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">upload_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ok&quot;</span><span class="p">):</span>
        <span class="n">target_bot</span> <span class="o">=</span> <span class="n">upload_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target_bot&quot;</span><span class="p">,</span> <span class="s2">&quot;nexus_aaron&quot;</span><span class="p">)</span>
        <span class="n">upload_status</span> <span class="o">=</span> <span class="n">upload_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">,</span> <span class="s2">&quot;uploaded&quot;</span><span class="p">)</span>
        
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; SUCCESS: File uploaded to @</span><span class="si">{</span><span class="n">target_bot</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">)</span>
        
        <span class="c1"># Status-specific messages</span>
        <span class="n">status_messages</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;received&quot;</span><span class="p">:</span> <span class="s2">&quot; File received and being processed&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pending_voting&quot;</span><span class="p">:</span> <span class="s2">&quot; File is pending for voting&quot;</span><span class="p">,</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot; nexus_aaron reported an issue&quot;</span><span class="p">,</span>
            <span class="s2">&quot;uploaded&quot;</span><span class="p">:</span> <span class="s2">&quot; File uploaded successfully&quot;</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="n">upload_status</span> <span class="ow">in</span> <span class="n">status_messages</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Status: </span><span class="si">{</span><span class="n">status_messages</span><span class="p">[</span><span class="n">upload_status</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        
        <span class="c1"># Format uploaded file info</span>
        <span class="n">file_info</span> <span class="o">=</span> <span class="n">upload_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;uploaded_file&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="n">file_info</span><span class="p">:</span>
            <span class="n">upload_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">file_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; UPLOADED FILE:&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Name: </span><span class="si">{</span><span class="n">file_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Size: </span><span class="si">{</span><span class="n">file_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_size_mb&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Upload Time: </span><span class="si">{</span><span class="n">file_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;upload_time&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Speed: </span><span class="si">{</span><span class="n">file_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;upload_speed_mbps&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB/s&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Message ID: </span><span class="si">{</span><span class="n">file_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message_id&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Time: </span><span class="si">{</span><span class="n">upload_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="n">caption</span> <span class="o">=</span> <span class="n">file_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;caption&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">caption</span><span class="p">:</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Caption: </span><span class="si">{</span><span class="n">caption</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; FAILED: File upload to nexus_aaron failed&quot;</span><span class="p">)</span>
        <span class="n">error_print</span><span class="p">(</span><span class="s2">&quot;nexus_aaron upload failed&quot;</span><span class="p">)</span>
    
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
    
    <span class="c1"># Print to console and log</span>
    <span class="n">result_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Formatting nexus_aaron upload result for display&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">result_text</span><span class="p">)</span></div>


<div class="viewcode-block" id="list_and_reply_to_nexus_aaron_message">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.list_and_reply_to_nexus_aaron_message">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">list_and_reply_to_nexus_aaron_message</span><span class="p">(</span><span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span> <span class="n">phone_number</span><span class="p">,</span> <span class="n">session_file</span><span class="o">=</span><span class="n">SESSION_FILE</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">proxy</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    List recent research request messages from @nexus_aaron, allow user to select one, and upload a file as reply</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        api_id: Your Telegram API ID</span>
<span class="sd">        api_hash: Your Telegram API hash</span>
<span class="sd">        phone_number: Your phone number (not used, kept for compatibility)</span>
<span class="sd">        session_file: Name of the session file</span>
<span class="sd">        limit: Maximum number of messages to retrieve (default: 10, max: 50)</span>
<span class="sd">        proxy: Proxy configuration dict or file path</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with operation result</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nexus_aaron_username</span> <span class="o">=</span> <span class="s2">&quot;nexus_aaron&quot;</span>
    
    <span class="c1"># Validate and clamp limit</span>
    <span class="k">if</span> <span class="n">limit</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">limit</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="mi">50</span>
        <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Message limit adjusted to maximum of 50 for better interaction&quot;</span><span class="p">)</span>
    
    <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fetching up to </span><span class="si">{</span><span class="n">limit</span><span class="si">}</span><span class="s2"> recent messages from @</span><span class="si">{</span><span class="n">nexus_aaron_username</span><span class="si">}</span><span class="s2"> to find research requests...&quot;</span><span class="p">)</span>
    
    <span class="c1"># Get more messages than requested to filter for research requests only</span>
    <span class="c1"># We&#39;ll fetch up to 3x the limit to ensure we get enough research requests</span>
    <span class="n">fetch_limit</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">limit</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>  <span class="c1"># Cap at 100 to avoid excessive API calls</span>
    
    <span class="c1"># Use existing function to get messages</span>
    <span class="n">messages_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_latest_messages_from_bot</span><span class="p">(</span>
        <span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span> <span class="n">nexus_aaron_username</span><span class="p">,</span> <span class="n">session_file</span><span class="p">,</span> <span class="n">fetch_limit</span><span class="p">,</span> <span class="n">proxy</span>
    <span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">messages_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ok&quot;</span><span class="p">):</span>
        <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to fetch messages: </span><span class="si">{</span><span class="n">messages_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown error&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">messages_result</span>
    
    <span class="n">all_messages</span> <span class="o">=</span> <span class="n">messages_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;messages&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">all_messages</span><span class="p">:</span>
        <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;No messages found&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;No messages found in the bot&quot;</span><span class="p">}</span>
    
    <span class="c1"># Filter for research request messages only</span>
    <span class="n">research_requests</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">all_messages</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">text</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#request&#39;</span><span class="p">):</span>
            <span class="n">research_requests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">research_requests</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">limit</span><span class="p">:</span>
                <span class="k">break</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">research_requests</span><span class="p">:</span>
        <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;No research request messages found&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;No research request messages found in recent messages&quot;</span><span class="p">}</span>
    
    <span class="c1"># Display research request messages for user selection</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RESEARCH REQUESTS FROM @nexus_aaron - SELECT ONE TO REPLY&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">research_requests</span><span class="p">)</span><span class="si">}</span><span class="s2"> recent research request messages. Select one to reply to:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">msg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">research_requests</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
        <span class="c1"># Parse request information</span>
        <span class="n">request_info</span> <span class="o">=</span> <span class="n">parse_nexus_aaron_request</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">] Message ID: </span><span class="si">{</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;message_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Date: </span><span class="si">{</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;date_formatted&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Request Point: </span><span class="si">{</span><span class="n">request_info</span><span class="p">[</span><span class="s1">&#39;request_count&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Type: </span><span class="si">{</span><span class="n">request_info</span><span class="p">[</span><span class="s1">&#39;pub_type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">request_info</span><span class="p">[</span><span class="s1">&#39;doi&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     DOI: </span><span class="si">{</span><span class="n">request_info</span><span class="p">[</span><span class="s1">&#39;doi&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">request_info</span><span class="p">[</span><span class="s1">&#39;publisher_code&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Publisher: </span><span class="si">{</span><span class="n">request_info</span><span class="p">[</span><span class="s1">&#39;publisher_code&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">request_info</span><span class="p">[</span><span class="s1">&#39;libstc_link&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     LibSTC: </span><span class="si">{</span><span class="n">request_info</span><span class="p">[</span><span class="s1">&#39;libstc_link&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">request_info</span><span class="p">[</span><span class="s1">&#39;worldcat_link&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     WorldCat: </span><span class="si">{</span><span class="n">request_info</span><span class="p">[</span><span class="s1">&#39;worldcat_link&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Additional message information</span>
        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;has_media&#39;</span><span class="p">):</span>
            <span class="n">media_type</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;media_type&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Media: </span><span class="si">{</span><span class="n">media_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;buttons&#39;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Interactive elements: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;buttons&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> button(s)&quot;</span><span class="p">)</span>
        
        <span class="c1"># Additional stats</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;views&#39;</span><span class="p">):</span>
            <span class="n">stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;views&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> views&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;forwards&#39;</span><span class="p">):</span>
            <span class="n">stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">msg</span><span class="p">[</span><span class="s1">&#39;forwards&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> forwards&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;is_reply&#39;</span><span class="p">):</span>
            <span class="n">stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; Reply&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stats</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Stats: </span><span class="si">{</span><span class="s1">&#39; | &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    &quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span> <span class="o">*</span> <span class="mi">76</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>
    
    <span class="c1"># Get user selection</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">selection</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Select a research request to reply to (1-</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">research_requests</span><span class="p">)</span><span class="si">}</span><span class="s2">) or &#39;q&#39; to quit: &quot;</span><span class="p">,</span> 
                <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> 
                <span class="n">default</span><span class="o">=</span><span class="s1">&#39;q&#39;</span>
            <span class="p">)</span>
            
            <span class="k">if</span> <span class="n">selection</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;q&#39;</span><span class="p">:</span>
                <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Operation cancelled by user&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;cancelled&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Operation cancelled by user&quot;</span><span class="p">}</span>
            
            <span class="n">selected_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">selected_index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">research_requests</span><span class="p">):</span>
                <span class="n">selected_message</span> <span class="o">=</span> <span class="n">research_requests</span><span class="p">[</span><span class="n">selected_index</span><span class="p">]</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid selection. Please choose a number between 1 and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">research_requests</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid input. Please enter a number or &#39;q&#39; to quit&quot;</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Selected message </span><span class="si">{</span><span class="n">selected_message</span><span class="p">[</span><span class="s1">&#39;message_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">selected_message</span><span class="p">[</span><span class="s1">&#39;date_formatted&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Show selected message details with enhanced formatting</span>
    <span class="n">request_info</span> <span class="o">=</span> <span class="n">parse_nexus_aaron_request</span><span class="p">(</span><span class="n">selected_message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Selected Research Request [</span><span class="si">{</span><span class="n">selected_index</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Publication Type: </span><span class="si">{</span><span class="n">request_info</span><span class="p">[</span><span class="s1">&#39;pub_type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request_info</span><span class="p">[</span><span class="s1">&#39;doi&#39;</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; DOI: </span><span class="si">{</span><span class="n">request_info</span><span class="p">[</span><span class="s1">&#39;doi&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Get file path for upload</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span>
            <span class="s2">&quot;Enter the full path to the file you want to upload as reply (or &#39;q&#39; to quit): &quot;</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="s1">&#39;q&#39;</span><span class="p">,</span>
            <span class="n">keep_origin</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        
        <span class="k">if</span> <span class="n">file_path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;q&#39;</span><span class="p">:</span>
            <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;File upload cancelled by user&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;cancelled&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;File upload cancelled by user&quot;</span><span class="p">}</span>
        
        <span class="c1"># Expand user path and resolve relative paths</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">file_path</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">))</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File not found: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please enter a valid file path or &#39;q&#39; to quit&quot;</span><span class="p">)</span>
    
    <span class="c1"># Get file info</span>
    <span class="n">file_size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    <span class="n">file_size_mb</span> <span class="o">=</span> <span class="n">file_size</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> File selected: </span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Size: </span><span class="si">{</span><span class="n">file_size_mb</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB&quot;</span><span class="p">)</span>
    
    <span class="c1"># Validate file size</span>
    <span class="k">if</span> <span class="n">file_size_mb</span> <span class="o">&gt;</span> <span class="mi">2000</span><span class="p">:</span>  <span class="c1"># 2GB Telegram limit</span>
        <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File is too large (</span><span class="si">{</span><span class="n">file_size_mb</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB). Telegram limit is 2GB.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;File too large: </span><span class="si">{</span><span class="n">file_size_mb</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB exceeds 2GB limit&quot;</span><span class="p">}</span>
    
    <span class="k">if</span> <span class="n">file_size_mb</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>  <span class="c1"># Warn for large files</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Large file (</span><span class="si">{</span><span class="n">file_size_mb</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB) may take time to upload&quot;</span><span class="p">)</span>
    
    <span class="c1"># Get optional caption for the file</span>
    <span class="n">caption</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span>
        <span class="s2">&quot;Enter an optional caption for the file (or press Enter for no caption): &quot;</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">keep_origin</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    
    <span class="k">if</span> <span class="n">caption</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Caption: </span><span class="si">{</span><span class="n">caption</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Confirm upload</span>
    <span class="n">confirm</span> <span class="o">=</span> <span class="n">get_input_with_timeout</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Confirm upload &#39;</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&#39; as reply to request [</span><span class="si">{</span><span class="n">selected_index</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">] (message </span><span class="si">{</span><span class="n">selected_message</span><span class="p">[</span><span class="s1">&#39;message_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)? [y/N]: &quot;</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s1">&#39;n&#39;</span>
    <span class="p">)</span>
    
    <span class="k">if</span> <span class="n">confirm</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;yes&#39;</span><span class="p">]:</span>
        <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Upload cancelled by user&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;cancelled&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Upload cancelled by user&quot;</span><span class="p">}</span>
    
    <span class="c1"># Now perform the actual reply upload using existing proxy and client setup logic</span>
    <span class="n">proxy_config</span> <span class="o">=</span> <span class="n">load_proxy_config</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">proxy</span> <span class="ow">and</span> <span class="n">proxy_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Error loading proxy configuration&quot;</span><span class="p">}</span>
    
    <span class="n">client</span> <span class="o">=</span> <span class="n">create_telegram_client</span><span class="p">(</span><span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span> <span class="n">session_file</span><span class="p">,</span> <span class="n">proxy_config</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Check if session file exists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">session_file</span><span class="p">):</span>
            <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Session file not found: </span><span class="si">{</span><span class="n">session_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Session file not found. Run script interactively first to create session.&quot;</span><span class="p">}</span>
        
        <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;Starting client for reply upload...&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">proxy_config</span><span class="p">:</span>
            <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connecting through proxy: </span><span class="si">{</span><span class="n">proxy_config</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">://</span><span class="si">{</span><span class="n">proxy_config</span><span class="p">[</span><span class="s1">&#39;addr&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">proxy_config</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        
        <span class="c1"># Verify we&#39;re connected</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">is_user_authorized</span><span class="p">():</span>
            <span class="n">error_print</span><span class="p">(</span><span class="s2">&quot;Session expired or not authorized&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Session expired. Please delete the session file and run interactively to re-authenticate.&quot;</span><span class="p">}</span>
        
        <span class="c1"># Get the bot entity</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Getting bot entity for: </span><span class="si">{</span><span class="n">nexus_aaron_username</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">bot_entity</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get_entity</span><span class="p">(</span><span class="n">nexus_aaron_username</span><span class="p">)</span>
        
        <span class="c1"># Get the specific message to reply to</span>
        <span class="n">target_message</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get_messages</span><span class="p">(</span><span class="n">bot_entity</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="n">selected_message</span><span class="p">[</span><span class="s1">&#39;message_id&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">target_message</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Could not fetch target message </span><span class="si">{</span><span class="n">selected_message</span><span class="p">[</span><span class="s1">&#39;message_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
        
        <span class="c1"># Create message handler for bot responses</span>
        <span class="n">handler</span><span class="p">,</span> <span class="n">get_bot_reply</span> <span class="o">=</span> <span class="n">create_message_handler</span><span class="p">(</span><span class="n">bot_entity</span><span class="p">)</span>
        <span class="n">client</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">events</span><span class="o">.</span><span class="n">NewMessage</span><span class="p">(</span><span class="n">from_users</span><span class="o">=</span><span class="n">bot_entity</span><span class="p">))(</span><span class="n">handler</span><span class="p">)</span>
        
        <span class="c1"># Upload progress callback</span>
        <span class="n">last_progress</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">def</span><span class="w"> </span><span class="nf">progress_callback</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">total</span><span class="p">):</span>
            <span class="k">nonlocal</span> <span class="n">last_progress</span>
            <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">progress</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">current</span> <span class="o">/</span> <span class="n">total</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">progress</span> <span class="o">&gt;=</span> <span class="n">last_progress</span> <span class="o">+</span> <span class="mi">10</span><span class="p">:</span>  <span class="c1"># Update every 10%</span>
                    <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Upload progress: </span><span class="si">{</span><span class="n">progress</span><span class="si">}</span><span class="s2">% (</span><span class="si">{</span><span class="n">current</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB)&quot;</span><span class="p">)</span>
                    <span class="n">last_progress</span> <span class="o">=</span> <span class="n">progress</span>
        
        <span class="c1"># Send file as reply</span>
        <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Uploading &#39;</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&#39; as reply to request [</span><span class="si">{</span><span class="n">selected_index</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">] (message </span><span class="si">{</span><span class="n">selected_message</span><span class="p">[</span><span class="s1">&#39;message_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)...&quot;</span><span class="p">)</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">send_file</span><span class="p">(</span>
            <span class="n">bot_entity</span><span class="p">,</span>
            <span class="n">file_path</span><span class="p">,</span>
            <span class="n">caption</span><span class="o">=</span><span class="n">caption</span> <span class="k">if</span> <span class="n">caption</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">reply_to</span><span class="o">=</span><span class="n">target_message</span><span class="p">,</span>  <span class="c1"># Reply to the selected message</span>
            <span class="n">progress_callback</span><span class="o">=</span><span class="n">progress_callback</span>
        <span class="p">)</span>
        
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">upload_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="n">upload_speed_mbps</span> <span class="o">=</span> <span class="n">file_size_mb</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">upload_time</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; File uploaded successfully as reply!&quot;</span><span class="p">)</span>
        <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Upload time: </span><span class="si">{</span><span class="n">upload_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
        <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Upload speed: </span><span class="si">{</span><span class="n">upload_speed_mbps</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB/s&quot;</span><span class="p">)</span>
        <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reply message ID: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">response</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;selected_message&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;message_id&quot;</span><span class="p">:</span> <span class="n">selected_message</span><span class="p">[</span><span class="s1">&#39;message_id&#39;</span><span class="p">],</span>
                <span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="n">selected_message</span><span class="p">[</span><span class="s1">&#39;date_formatted&#39;</span><span class="p">],</span>
                <span class="s2">&quot;request_count&quot;</span><span class="p">:</span> <span class="n">request_info</span><span class="p">[</span><span class="s1">&#39;request_count&#39;</span><span class="p">],</span>
                <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">selected_message</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">][:</span><span class="mi">200</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">200</span> <span class="k">else</span> <span class="n">selected_message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="p">},</span>
            <span class="s2">&quot;uploaded_file&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;file_path&quot;</span><span class="p">:</span> <span class="n">file_path</span><span class="p">,</span>
                <span class="s2">&quot;file_name&quot;</span><span class="p">:</span> <span class="n">file_name</span><span class="p">,</span>
                <span class="s2">&quot;file_size&quot;</span><span class="p">:</span> <span class="n">file_size</span><span class="p">,</span>
                <span class="s2">&quot;file_size_mb&quot;</span><span class="p">:</span> <span class="n">file_size_mb</span><span class="p">,</span>
                <span class="s2">&quot;upload_time&quot;</span><span class="p">:</span> <span class="n">upload_time</span><span class="p">,</span>
                <span class="s2">&quot;upload_speed_mbps&quot;</span><span class="p">:</span> <span class="n">upload_speed_mbps</span><span class="p">,</span>
                <span class="s2">&quot;reply_message_id&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">timestamp</span><span class="p">(),</span>
                <span class="s2">&quot;caption&quot;</span><span class="p">:</span> <span class="n">caption</span> <span class="k">if</span> <span class="n">caption</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;Message reply with file upload completed successfully&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in reply upload operation: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reply upload exception: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Error in reply upload operation: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;Disconnecting client after reply upload operation...&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span></div>


<div class="viewcode-block" id="format_list_and_reply_result">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.format_list_and_reply_result">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">format_list_and_reply_result</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Format the list and reply result in a human-readable way&quot;&quot;&quot;</span>
    <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;NEXUS AARON MESSAGE REPLY RESULT&quot;</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; ERROR: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">error_print</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cancelled&quot;</span><span class="p">):</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; CANCELLED: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Operation cancelled&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">info_print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="s1">&#39;Operation cancelled&#39;</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ok&quot;</span><span class="p">):</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; SUCCESS: File uploaded as reply successfully!&quot;</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        
        <span class="c1"># Format selected message info</span>
        <span class="n">selected_msg</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;selected_message&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="n">selected_msg</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; REPLIED TO MESSAGE:&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Message ID: </span><span class="si">{</span><span class="n">selected_msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message_id&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Date: </span><span class="si">{</span><span class="n">selected_msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Content: </span><span class="si">{</span><span class="n">selected_msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        
        <span class="c1"># Format uploaded file info</span>
        <span class="n">file_info</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;uploaded_file&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="n">file_info</span><span class="p">:</span>
            <span class="n">upload_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">file_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; UPLOADED FILE REPLY:&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Name: </span><span class="si">{</span><span class="n">file_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Size: </span><span class="si">{</span><span class="n">file_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_size_mb&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Upload Time: </span><span class="si">{</span><span class="n">file_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;upload_time&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Speed: </span><span class="si">{</span><span class="n">file_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;upload_speed_mbps&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB/s&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Reply Message ID: </span><span class="si">{</span><span class="n">file_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reply_message_id&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Time: </span><span class="si">{</span><span class="n">upload_time</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="n">caption</span> <span class="o">=</span> <span class="n">file_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;caption&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">caption</span><span class="p">:</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Caption: </span><span class="si">{</span><span class="n">caption</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; FAILED: Operation failed&quot;</span><span class="p">)</span>
        <span class="n">error_print</span><span class="p">(</span><span class="s2">&quot;List and reply operation failed&quot;</span><span class="p">)</span>
    
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
    
    <span class="c1"># Print to console and log</span>
    <span class="n">result_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">result_text</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Formatting list and reply result for display&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">result_text</span><span class="p">)</span></div>


<div class="viewcode-block" id="check_doi_availability_on_nexus">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.check_doi_availability_on_nexus">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">check_doi_availability_on_nexus</span><span class="p">(</span><span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span> <span class="n">phone_number</span><span class="p">,</span> <span class="n">bot_username</span><span class="p">,</span> <span class="n">doi</span><span class="p">,</span> <span class="n">session_file</span><span class="o">=</span><span class="n">SESSION_FILE</span><span class="p">,</span> <span class="n">proxy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if a DOI is available on Nexus by sending it to the bot and analyzing the response</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        api_id: Your Telegram API ID</span>
<span class="sd">        api_hash: Your Telegram API hash</span>
<span class="sd">        phone_number: Your phone number (not used, kept for compatibility)</span>
<span class="sd">        bot_username: Bot&#39;s username</span>
<span class="sd">        doi: DOI number to check (e.g., &quot;10.1038/nature12373&quot;)</span>
<span class="sd">        session_file: Name of the session file</span>
<span class="sd">        proxy: Proxy configuration dict or file path</span>
<span class="sd">        download: If True, automatically download the paper if available (default: False)</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with availability status and details, including download result if applicable</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Checking DOI availability on Nexus: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DOI to check: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">download</span><span class="p">:</span>
        <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Auto-download enabled - will download paper if available&quot;</span><span class="p">)</span>
    
    <span class="c1"># Validate DOI format</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">doi</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">doi</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid DOI: DOI must be a non-empty string&quot;</span><span class="p">}</span>
    
    <span class="c1"># Clean and validate DOI format</span>
    <span class="n">doi</span> <span class="o">=</span> <span class="n">doi</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^10\.\d+/.+&#39;</span><span class="p">,</span> <span class="n">doi</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Invalid DOI format: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">. DOI should start with &#39;10.&#39; followed by digits and a slash&quot;</span><span class="p">}</span>
    
    <span class="c1"># Send DOI to the bot</span>
    <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sending DOI query to </span><span class="si">{</span><span class="n">bot_username</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">send_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">send_message_to_bot</span><span class="p">(</span>
            <span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span> <span class="n">phone_number</span><span class="p">,</span> <span class="n">bot_username</span><span class="p">,</span> 
            <span class="n">doi</span><span class="p">,</span> <span class="n">session_file</span><span class="p">,</span> <span class="n">proxy</span>
        <span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">send_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ok&quot;</span><span class="p">):</span>
            <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to send DOI query: </span><span class="si">{</span><span class="n">send_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown error&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Failed to send DOI query: </span><span class="si">{</span><span class="n">send_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown error&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
        
        <span class="n">bot_reply</span> <span class="o">=</span> <span class="n">send_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bot_reply&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bot_reply</span><span class="p">:</span>
            <span class="n">error_print</span><span class="p">(</span><span class="s2">&quot;No reply received from bot for DOI query&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;No reply received from bot for DOI query&quot;</span><span class="p">}</span>
        
        <span class="n">reply_text</span> <span class="o">=</span> <span class="n">bot_reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">buttons</span> <span class="o">=</span> <span class="n">bot_reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;buttons&quot;</span><span class="p">,</span> <span class="p">[])</span>
        
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bot reply text (first 200 chars): </span><span class="si">{</span><span class="n">reply_text</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of buttons in reply: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">buttons</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Analyze the response to determine availability</span>
        <span class="n">availability_result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;doi&quot;</span><span class="p">:</span> <span class="n">doi</span><span class="p">,</span>
            <span class="s2">&quot;available&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
            <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;raw_response&quot;</span><span class="p">:</span> <span class="n">bot_reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="s2">&quot;buttons&quot;</span><span class="p">:</span> <span class="n">buttons</span><span class="p">,</span>
            <span class="s2">&quot;message_id&quot;</span><span class="p">:</span> <span class="n">bot_reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message_id&quot;</span><span class="p">),</span>
            <span class="s2">&quot;download_requested&quot;</span><span class="p">:</span> <span class="n">download</span>
        <span class="p">}</span>
        
        <span class="c1"># Check for common &quot;not found&quot; or &quot;no results&quot; indicators</span>
        <span class="n">not_found_indicators</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;no results found&quot;</span><span class="p">,</span>
            <span class="s2">&quot;not found&quot;</span><span class="p">,</span>
            <span class="s2">&quot;no matches&quot;</span><span class="p">,</span>
            <span class="s2">&quot;nothing found&quot;</span><span class="p">,</span>
            <span class="s2">&quot;0 results&quot;</span><span class="p">,</span>
            <span class="s2">&quot;no books or papers found&quot;</span><span class="p">,</span>
            <span class="s2">&quot;search returned no results&quot;</span>
        <span class="p">]</span>
        
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">indicator</span> <span class="ow">in</span> <span class="n">reply_text</span> <span class="k">for</span> <span class="n">indicator</span> <span class="ow">in</span> <span class="n">not_found_indicators</span><span class="p">):</span>
            <span class="n">availability_result</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;not_found&quot;</span>
            <span class="n">availability_result</span><span class="p">[</span><span class="s2">&quot;available&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">availability_result</span><span class="p">[</span><span class="s2">&quot;details&quot;</span><span class="p">][</span><span class="s2">&quot;reason&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;DOI not found in Nexus database&quot;</span>
            <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> is NOT available on Nexus (not found)&quot;</span><span class="p">)</span>
            <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;DOI marked as not found based on reply text indicators&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">availability_result</span>
        
        <span class="c1"># Check for error messages</span>
        <span class="n">error_indicators</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;error&quot;</span><span class="p">,</span>
            <span class="s2">&quot;invalid&quot;</span><span class="p">,</span>
            <span class="s2">&quot;malformed&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cannot process&quot;</span><span class="p">,</span>
            <span class="s2">&quot;failed to search&quot;</span>
        <span class="p">]</span>
        
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">indicator</span> <span class="ow">in</span> <span class="n">reply_text</span> <span class="k">for</span> <span class="n">indicator</span> <span class="ow">in</span> <span class="n">error_indicators</span><span class="p">):</span>
            <span class="n">availability_result</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span>
            <span class="n">availability_result</span><span class="p">[</span><span class="s2">&quot;available&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">availability_result</span><span class="p">[</span><span class="s2">&quot;details&quot;</span><span class="p">][</span><span class="s2">&quot;reason&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Error processing DOI query&quot;</span>
            <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;DOI query resulted in error based on reply text&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">availability_result</span>
        
        <span class="c1"># If we have buttons, analyze them to determine availability</span>
        <span class="k">if</span> <span class="n">buttons</span><span class="p">:</span>
            <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;Analyzing buttons to determine DOI availability...&quot;</span><span class="p">)</span>
            
            <span class="c1"># Look for callback buttons (these typically indicate results)</span>
            <span class="n">callback_buttons</span> <span class="o">=</span> <span class="p">[</span><span class="n">btn</span> <span class="k">for</span> <span class="n">btn</span> <span class="ow">in</span> <span class="n">buttons</span> <span class="k">if</span> <span class="n">btn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;callback&quot;</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">callback_buttons</span><span class="p">:</span>
                <span class="n">first_button</span> <span class="o">=</span> <span class="n">callback_buttons</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">button_text</span> <span class="o">=</span> <span class="n">first_button</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                
                <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;First callback button text: &#39;</span><span class="si">{</span><span class="n">button_text</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                
                <span class="c1"># Check if button indicates availability</span>
                <span class="k">if</span> <span class="s2">&quot;request&quot;</span> <span class="ow">in</span> <span class="n">button_text</span><span class="p">:</span>
                    <span class="c1"># Paper is not available, needs to be requested</span>
                    <span class="n">availability_result</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;not_available_requestable&quot;</span>
                    <span class="n">availability_result</span><span class="p">[</span><span class="s2">&quot;available&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">availability_result</span><span class="p">[</span><span class="s2">&quot;details&quot;</span><span class="p">][</span><span class="s2">&quot;reason&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Paper not available but can be requested&quot;</span>
                    <span class="n">availability_result</span><span class="p">[</span><span class="s2">&quot;details&quot;</span><span class="p">][</span><span class="s2">&quot;request_button&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">first_button</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">),</span>
                        <span class="s2">&quot;callback_data&quot;</span><span class="p">:</span> <span class="n">first_button</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;callback_data&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">first_button</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">),</span>
                        <span class="s2">&quot;message_id&quot;</span><span class="p">:</span> <span class="n">bot_reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message_id&quot;</span><span class="p">)</span>
                    <span class="p">}</span>
                    <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> is NOT available on Nexus but can be requested&quot;</span><span class="p">)</span>
                    <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;DOI can be requested based on button analysis&quot;</span><span class="p">)</span>
                    
                <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">word</span> <span class="ow">in</span> <span class="n">button_text</span> <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;download&quot;</span><span class="p">,</span> <span class="s2">&quot;get&quot;</span><span class="p">,</span> <span class="s2">&quot;pdf&quot;</span><span class="p">,</span> <span class="s2">&quot;file&quot;</span><span class="p">]):</span>
                    <span class="c1"># Paper is available for download</span>
                    <span class="n">availability_result</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;available&quot;</span>
                    <span class="n">availability_result</span><span class="p">[</span><span class="s2">&quot;available&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">availability_result</span><span class="p">[</span><span class="s2">&quot;details&quot;</span><span class="p">][</span><span class="s2">&quot;reason&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Paper is available for download&quot;</span>
                    
                    <span class="c1"># Try to extract file size information</span>
                    <span class="n">button_size_info</span> <span class="o">=</span> <span class="n">extract_file_size_from_button_text</span><span class="p">(</span><span class="n">first_button</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
                    <span class="n">callback_size_info</span> <span class="o">=</span> <span class="n">extract_file_size_from_callback_data</span><span class="p">(</span><span class="n">first_button</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;callback_data&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">first_button</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">))</span>
                    
                    <span class="n">size_info</span> <span class="o">=</span> <span class="n">button_size_info</span> <span class="ow">or</span> <span class="n">callback_size_info</span>
                    <span class="k">if</span> <span class="n">size_info</span><span class="p">:</span>
                        <span class="n">availability_result</span><span class="p">[</span><span class="s2">&quot;details&quot;</span><span class="p">][</span><span class="s2">&quot;file_size_mb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">size_info</span><span class="p">[</span><span class="s2">&quot;size_mb&quot;</span><span class="p">]</span>
                        <span class="n">availability_result</span><span class="p">[</span><span class="s2">&quot;details&quot;</span><span class="p">][</span><span class="s2">&quot;file_size_unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">size_info</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span>
                        <span class="n">availability_result</span><span class="p">[</span><span class="s2">&quot;details&quot;</span><span class="p">][</span><span class="s2">&quot;file_size_original&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">size_info</span><span class="p">[</span><span class="s2">&quot;original_size&quot;</span><span class="p">]</span>
                        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracted file size: </span><span class="si">{</span><span class="n">size_info</span><span class="p">[</span><span class="s1">&#39;original_size&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">size_info</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">size_info</span><span class="p">[</span><span class="s1">&#39;size_mb&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB)&quot;</span><span class="p">)</span>
                    
                    <span class="n">availability_result</span><span class="p">[</span><span class="s2">&quot;details&quot;</span><span class="p">][</span><span class="s2">&quot;download_button&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">first_button</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">),</span>
                        <span class="s2">&quot;callback_data&quot;</span><span class="p">:</span> <span class="n">first_button</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;callback_data&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">first_button</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">),</span>
                        <span class="s2">&quot;message_id&quot;</span><span class="p">:</span> <span class="n">bot_reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message_id&quot;</span><span class="p">)</span>
                    <span class="p">}</span>
                    <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> is AVAILABLE on Nexus for download&quot;</span><span class="p">)</span>
                    <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;DOI is available for download based on button analysis&quot;</span><span class="p">)</span>
                    
                    <span class="c1"># Auto-download if requested</span>
                    <span class="k">if</span> <span class="n">download</span><span class="p">:</span>
                        <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Auto-downloading paper for DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;Starting automatic download process...&quot;</span><span class="p">)</span>
                        
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># Click the download button using existing function</span>
                            <span class="n">button_callback_data</span> <span class="o">=</span> <span class="n">first_button</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;callback_data&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">first_button</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>
                            <span class="n">message_id</span> <span class="o">=</span> <span class="n">bot_reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message_id&quot;</span><span class="p">)</span>
                            
                            <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Clicking download button - Message ID: </span><span class="si">{</span><span class="n">message_id</span><span class="si">}</span><span class="s2">, Callback: </span><span class="si">{</span><span class="n">button_callback_data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            
                            <span class="n">click_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">click_callback_button</span><span class="p">(</span>
                                <span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span> <span class="n">phone_number</span><span class="p">,</span> <span class="n">bot_username</span><span class="p">,</span>
                                <span class="n">message_id</span><span class="p">,</span> <span class="n">button_callback_data</span><span class="p">,</span> <span class="n">session_file</span><span class="p">,</span> <span class="n">proxy</span>
                            <span class="p">)</span>
                            
                            <span class="k">if</span> <span class="n">click_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ok&quot;</span><span class="p">):</span>
                                <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot; Download button clicked successfully&quot;</span><span class="p">)</span>
                                
                                <span class="c1"># Wait for file and download using existing function</span>
                                <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;Waiting for file preparation and download...&quot;</span><span class="p">)</span>
                                
                                <span class="c1"># Calculate wait time based on file size if available</span>
                                <span class="n">file_size_mb</span> <span class="o">=</span> <span class="n">size_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;size_mb&quot;</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">)</span> <span class="k">if</span> <span class="n">size_info</span> <span class="k">else</span> <span class="mf">5.0</span>
                                <span class="n">base_wait</span> <span class="o">=</span> <span class="mi">10</span>
                                <span class="n">size_based_wait</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">file_size_mb</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span>  <span class="c1"># 5 seconds per MB</span>
                                <span class="n">total_wait</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">base_wait</span><span class="p">,</span> <span class="n">size_based_wait</span><span class="p">)</span>
                                
                                <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting up to </span><span class="si">{</span><span class="n">total_wait</span><span class="si">}</span><span class="s2"> seconds for file preparation...&quot;</span><span class="p">)</span>
                                
                                <span class="c1"># First try immediate bot reply (if it contains the file)</span>
                                <span class="n">download_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">handle_file_download_from_bot_reply</span><span class="p">(</span>
                                    <span class="n">click_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bot_reply&quot;</span><span class="p">),</span> <span class="n">proxy</span>
                                <span class="p">)</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">download_result</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">):</span>
                                    <span class="c1"># Poll for a new file message from the bot</span>
                                    <span class="n">after_id</span> <span class="o">=</span> <span class="kc">None</span>
                                    <span class="n">bot_reply</span> <span class="o">=</span> <span class="n">click_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bot_reply&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>
                                    <span class="k">if</span> <span class="n">bot_reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message_id&quot;</span><span class="p">):</span>
                                        <span class="n">after_id</span> <span class="o">=</span> <span class="n">bot_reply</span><span class="p">[</span><span class="s2">&quot;message_id&quot;</span><span class="p">]</span>
                                    <span class="k">elif</span> <span class="n">click_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;button_clicked&quot;</span><span class="p">):</span>
                                        <span class="n">after_id</span> <span class="o">=</span> <span class="n">click_result</span><span class="p">[</span><span class="s2">&quot;button_clicked&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message_id&quot;</span><span class="p">)</span>
                                    <span class="n">download_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">wait_for_file_message_and_download</span><span class="p">(</span>
                                        <span class="n">api_id</span><span class="p">,</span>
                                        <span class="n">api_hash</span><span class="p">,</span>
                                        <span class="n">bot_username</span><span class="p">,</span>
                                        <span class="n">session_file</span><span class="p">,</span>
                                        <span class="n">proxy</span><span class="p">,</span>
                                        <span class="n">after_message_id</span><span class="o">=</span><span class="n">after_id</span><span class="p">,</span>
                                        <span class="n">timeout</span><span class="o">=</span><span class="n">total_wait</span><span class="p">,</span>
                                    <span class="p">)</span>
                                
                                <span class="k">if</span> <span class="n">download_result</span> <span class="ow">and</span> <span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">):</span>
                                    <span class="n">availability_result</span><span class="p">[</span><span class="s2">&quot;download_result&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                                        <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                        <span class="s2">&quot;file_path&quot;</span><span class="p">:</span> <span class="n">download_result</span><span class="p">[</span><span class="s2">&quot;file_path&quot;</span><span class="p">],</span>
                                        <span class="s2">&quot;file_name&quot;</span><span class="p">:</span> <span class="n">download_result</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">],</span>
                                        <span class="s2">&quot;file_size&quot;</span><span class="p">:</span> <span class="n">download_result</span><span class="p">[</span><span class="s2">&quot;file_size&quot;</span><span class="p">],</span>
                                        <span class="s2">&quot;file_size_mb&quot;</span><span class="p">:</span> <span class="n">download_result</span><span class="p">[</span><span class="s2">&quot;file_size&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">),</span>
                                        <span class="s2">&quot;download_time&quot;</span><span class="p">:</span> <span class="n">download_result</span><span class="p">[</span><span class="s2">&quot;download_time&quot;</span><span class="p">],</span>
                                        <span class="s2">&quot;speed_mbps&quot;</span><span class="p">:</span> <span class="n">download_result</span><span class="p">[</span><span class="s2">&quot;speed_mbps&quot;</span><span class="p">]</span>
                                    <span class="p">}</span>
                                    <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Auto-download completed successfully!&quot;</span><span class="p">)</span>
                                    <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File saved to: </span><span class="si">{</span><span class="n">download_result</span><span class="p">[</span><span class="s1">&#39;file_path&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                    <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Download stats - Size: </span><span class="si">{</span><span class="n">download_result</span><span class="p">[</span><span class="s1">&#39;file_size&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB, Speed: </span><span class="si">{</span><span class="n">download_result</span><span class="p">[</span><span class="s1">&#39;speed_mbps&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB/s&quot;</span><span class="p">)</span>
                                
                                <span class="k">elif</span> <span class="n">download_result</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">):</span>
                                    <span class="n">availability_result</span><span class="p">[</span><span class="s2">&quot;download_result&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                                        <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;Unknown download error&quot;</span><span class="p">)</span>
                                    <span class="p">}</span>
                                    <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Auto-download failed: </span><span class="si">{</span><span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown error&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                    <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;File download from bot reply failed&quot;</span><span class="p">)</span>
                                
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="c1"># No file in bot reply, this might be normal for some responses</span>
                                    <span class="n">availability_result</span><span class="p">[</span><span class="s2">&quot;download_result&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                                        <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;No file received from bot after clicking download button&quot;</span>
                                    <span class="p">}</span>
                                    <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot; No file received after clicking download button (may be normal depending on bot response)&quot;</span><span class="p">)</span>
                                    <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;No file detected in bot reply after download button click&quot;</span><span class="p">)</span>
                            
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">availability_result</span><span class="p">[</span><span class="s2">&quot;download_result&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                                    <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Failed to click download button: </span><span class="si">{</span><span class="n">click_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown error&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="p">}</span>
                                <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Failed to click download button: </span><span class="si">{</span><span class="n">click_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown error&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;Download button click failed&quot;</span><span class="p">)</span>
                        
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">download_error</span><span class="p">:</span>
                            <span class="n">availability_result</span><span class="p">[</span><span class="s2">&quot;download_result&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Auto-download error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">download_error</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">}</span>
                            <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Auto-download error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">download_error</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Auto-download exception: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">download_error</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">download_error</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Unknown button type, but presence suggests some result</span>
                    <span class="n">availability_result</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;found_unknown&quot;</span>
                    <span class="n">availability_result</span><span class="p">[</span><span class="s2">&quot;available&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Uncertain</span>
                    <span class="n">availability_result</span><span class="p">[</span><span class="s2">&quot;details&quot;</span><span class="p">][</span><span class="s2">&quot;reason&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;DOI found but availability status unclear&quot;</span>
                    <span class="n">availability_result</span><span class="p">[</span><span class="s2">&quot;details&quot;</span><span class="p">][</span><span class="s2">&quot;first_button&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">first_button</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">),</span>
                        <span class="s2">&quot;callback_data&quot;</span><span class="p">:</span> <span class="n">first_button</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;callback_data&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">first_button</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">),</span>
                        <span class="s2">&quot;message_id&quot;</span><span class="p">:</span> <span class="n">bot_reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message_id&quot;</span><span class="p">)</span>
                    <span class="p">}</span>
                    <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> found but availability status unclear&quot;</span><span class="p">)</span>
                    <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;DOI found but button type unclear&quot;</span><span class="p">)</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Has buttons but no callback buttons (might be URL buttons)</span>
                <span class="n">url_buttons</span> <span class="o">=</span> <span class="p">[</span><span class="n">btn</span> <span class="k">for</span> <span class="n">btn</span> <span class="ow">in</span> <span class="n">buttons</span> <span class="k">if</span> <span class="n">btn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;url&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">url_buttons</span><span class="p">:</span>
                    <span class="n">availability_result</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;found_external_links&quot;</span>
                    <span class="n">availability_result</span><span class="p">[</span><span class="s2">&quot;available&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">availability_result</span><span class="p">[</span><span class="s2">&quot;details&quot;</span><span class="p">][</span><span class="s2">&quot;reason&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;DOI found with external links but not directly available&quot;</span>
                    <span class="n">availability_result</span><span class="p">[</span><span class="s2">&quot;details&quot;</span><span class="p">][</span><span class="s2">&quot;external_links&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">btn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">),</span> <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="n">btn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">)}</span> 
                        <span class="k">for</span> <span class="n">btn</span> <span class="ow">in</span> <span class="n">url_buttons</span>
                    <span class="p">]</span>
                    <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> found with external links but not available on Nexus&quot;</span><span class="p">)</span>
                    <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;DOI found with external URL buttons&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Unknown button types</span>
                    <span class="n">availability_result</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;found_unknown_buttons&quot;</span>
                    <span class="n">availability_result</span><span class="p">[</span><span class="s2">&quot;available&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">availability_result</span><span class="p">[</span><span class="s2">&quot;details&quot;</span><span class="p">][</span><span class="s2">&quot;reason&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;DOI found with unknown button types&quot;</span>
                    <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> found but button types unclear&quot;</span><span class="p">)</span>
                    <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;DOI found with unknown button types&quot;</span><span class="p">)</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># No buttons in response</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reply_text</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>  <span class="c1"># Substantial text response</span>
                <span class="n">availability_result</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;found_text_only&quot;</span>
                <span class="n">availability_result</span><span class="p">[</span><span class="s2">&quot;available&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">availability_result</span><span class="p">[</span><span class="s2">&quot;details&quot;</span><span class="p">][</span><span class="s2">&quot;reason&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;DOI found with text response but no interactive elements&quot;</span>
                <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> found with text response but no buttons&quot;</span><span class="p">)</span>
                <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;DOI query returned text but no buttons&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">availability_result</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;minimal_response&quot;</span>
                <span class="n">availability_result</span><span class="p">[</span><span class="s2">&quot;available&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">availability_result</span><span class="p">[</span><span class="s2">&quot;details&quot;</span><span class="p">][</span><span class="s2">&quot;reason&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Minimal response received&quot;</span>
                <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> query returned minimal response&quot;</span><span class="p">)</span>
                <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;DOI query returned minimal response&quot;</span><span class="p">)</span>
        
        <span class="c1"># Add search metadata</span>
        <span class="n">availability_result</span><span class="p">[</span><span class="s2">&quot;search_metadata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;query_sent&quot;</span><span class="p">:</span> <span class="n">doi</span><span class="p">,</span>
            <span class="s2">&quot;response_length&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">reply_text</span><span class="p">),</span>
            <span class="s2">&quot;button_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">buttons</span><span class="p">),</span>
            <span class="s2">&quot;callback_button_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">([</span><span class="n">btn</span> <span class="k">for</span> <span class="n">btn</span> <span class="ow">in</span> <span class="n">buttons</span> <span class="k">if</span> <span class="n">btn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;callback&quot;</span><span class="p">]),</span>
            <span class="s2">&quot;url_button_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">([</span><span class="n">btn</span> <span class="k">for</span> <span class="n">btn</span> <span class="ow">in</span> <span class="n">buttons</span> <span class="k">if</span> <span class="n">btn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;url&quot;</span><span class="p">]),</span>
            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="p">}</span>
        
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DOI availability check completed. Status: </span><span class="si">{</span><span class="n">availability_result</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, Available: </span><span class="si">{</span><span class="n">availability_result</span><span class="p">[</span><span class="s1">&#39;available&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">download</span> <span class="ow">and</span> <span class="n">availability_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;download_result&quot;</span><span class="p">):</span>
            <span class="n">download_success</span> <span class="o">=</span> <span class="n">availability_result</span><span class="p">[</span><span class="s2">&quot;download_result&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Auto-download completed. Success: </span><span class="si">{</span><span class="n">download_success</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">availability_result</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error checking DOI availability: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DOI availability check exception: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Error checking DOI availability: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span></div>


<div class="viewcode-block" id="format_doi_availability_result">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.format_doi_availability_result">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">format_doi_availability_result</span><span class="p">(</span><span class="n">availability_result</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Format the DOI availability result in a human-readable way&quot;&quot;&quot;</span>
    <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;DOI AVAILABILITY CHECK RESULT&quot;</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">availability_result</span><span class="p">:</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; ERROR: </span><span class="si">{</span><span class="n">availability_result</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">error_print</span><span class="p">(</span><span class="n">availability_result</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">doi</span> <span class="o">=</span> <span class="n">availability_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;doi&quot;</span><span class="p">,</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">availability_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
        <span class="n">available</span> <span class="o">=</span> <span class="n">availability_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;available&quot;</span><span class="p">)</span>
        <span class="n">details</span> <span class="o">=</span> <span class="n">availability_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;details&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">download_result</span> <span class="o">=</span> <span class="n">availability_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;download_result&quot;</span><span class="p">)</span>
        
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        
        <span class="c1"># Status-specific formatting</span>
        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;available&quot;</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; STATUS: AVAILABLE on Nexus&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; The paper is available for download&quot;</span><span class="p">)</span>
            
            <span class="c1"># File size information</span>
            <span class="k">if</span> <span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_size_mb&quot;</span><span class="p">):</span>
                <span class="n">size_unit</span> <span class="o">=</span> <span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_size_unit&quot;</span><span class="p">,</span> <span class="s2">&quot;MB&quot;</span><span class="p">)</span>
                <span class="n">original_size</span> <span class="o">=</span> <span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_size_original&quot;</span><span class="p">,</span> <span class="n">details</span><span class="p">[</span><span class="s2">&quot;file_size_mb&quot;</span><span class="p">])</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; File Size: </span><span class="si">{</span><span class="n">original_size</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">size_unit</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">details</span><span class="p">[</span><span class="s1">&#39;file_size_mb&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB)&quot;</span><span class="p">)</span>
            
            <span class="c1"># Download button info</span>
            <span class="n">download_btn</span> <span class="o">=</span> <span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;download_button&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="n">download_btn</span><span class="p">:</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Download Button: &#39;</span><span class="si">{</span><span class="n">download_btn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Message ID: </span><span class="si">{</span><span class="n">download_btn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message_id&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Show download result if auto-download was attempted</span>
            <span class="k">if</span> <span class="n">download_result</span><span class="p">:</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">):</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; AUTO-DOWNLOAD: SUCCESSFUL&quot;</span><span class="p">)</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; File saved to: </span><span class="si">{</span><span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_path&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; File name: </span><span class="si">{</span><span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_size_mb&#39;</span><span class="p">):</span>
                        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Downloaded size: </span><span class="si">{</span><span class="n">download_result</span><span class="p">[</span><span class="s1">&#39;file_size_mb&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;download_time&#39;</span><span class="p">):</span>
                        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Download time: </span><span class="si">{</span><span class="n">download_result</span><span class="p">[</span><span class="s1">&#39;download_time&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;speed_mbps&#39;</span><span class="p">):</span>
                        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Download speed: </span><span class="si">{</span><span class="n">download_result</span><span class="p">[</span><span class="s1">&#39;speed_mbps&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB/s&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; AUTO-DOWNLOAD: FAILED&quot;</span><span class="p">)</span>
                    <span class="n">error_msg</span> <span class="o">=</span> <span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;Unknown download error&#39;</span><span class="p">)</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Error: </span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;not_available_requestable&quot;</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; STATUS: NOT AVAILABLE on Nexus&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; The paper can be requested from the community&quot;</span><span class="p">)</span>
            
            <span class="c1"># Request button info</span>
            <span class="n">request_btn</span> <span class="o">=</span> <span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;request_button&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="n">request_btn</span><span class="p">:</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Request Button: &#39;</span><span class="si">{</span><span class="n">request_btn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Message ID: </span><span class="si">{</span><span class="n">request_btn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message_id&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;not_found&quot;</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; STATUS: NOT FOUND&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; The DOI was not found in the Nexus database&quot;</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;found_external_links&quot;</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; STATUS: FOUND with External Links&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; DOI found but only external links available&quot;</span><span class="p">)</span>
            
            <span class="n">external_links</span> <span class="o">=</span> <span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;external_links&quot;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="n">external_links</span><span class="p">:</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; External Links:&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">link</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">external_links</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">link</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">link</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; STATUS: ERROR&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; Error processing the DOI query&quot;</span><span class="p">)</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Unknown or unclear status</span>
            <span class="n">status_display</span> <span class="o">=</span> <span class="n">status</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; STATUS: </span><span class="si">{</span><span class="n">status_display</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">available</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; Appears to be available&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">available</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; Appears to be unavailable&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; Availability unclear&quot;</span><span class="p">)</span>
        
        <span class="c1"># Reason</span>
        <span class="n">reason</span> <span class="o">=</span> <span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reason&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reason</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Details: </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        
        <span class="c1"># Search metadata</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">availability_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;search_metadata&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="n">metadata</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; SEARCH DETAILS:&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Response Length: </span><span class="si">{</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;response_length&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> characters&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Total Buttons: </span><span class="si">{</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;button_count&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;callback_button_count&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Callback Buttons: </span><span class="si">{</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;callback_button_count&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;url_button_count&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    URL Buttons: </span><span class="si">{</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;url_button_count&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">):</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Checked: </span><span class="si">{</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Auto-download status summary</span>
        <span class="k">if</span> <span class="n">availability_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;download_requested&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">download_result</span><span class="p">:</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; Auto-download was requested but no download occurred (paper may not be available)&quot;</span><span class="p">)</span>
    
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
    
    <span class="c1"># Print to console and log</span>
    <span class="n">result_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Formatting DOI availability result for display&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">result_text</span><span class="p">)</span></div>


<div class="viewcode-block" id="batch_check_doi_availability">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.batch_check_doi_availability">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">batch_check_doi_availability</span><span class="p">(</span><span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span> <span class="n">phone_number</span><span class="p">,</span> <span class="n">bot_username</span><span class="p">,</span> <span class="n">doi_list</span><span class="p">,</span> <span class="n">session_file</span><span class="o">=</span><span class="n">SESSION_FILE</span><span class="p">,</span> <span class="n">proxy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check availability of multiple DOIs on Nexus with rate limiting and optional auto-download</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        api_id: Your Telegram API ID</span>
<span class="sd">        api_hash: Your Telegram API hash</span>
<span class="sd">        phone_number: Your phone number (not used, kept for compatibility)</span>
<span class="sd">        bot_username: Bot&#39;s username</span>
<span class="sd">        doi_list: List of DOI strings to check</span>
<span class="sd">        session_file: Name of the session file</span>
<span class="sd">        proxy: Proxy configuration dict or file path</span>
<span class="sd">        delay: Delay in seconds between requests to avoid rate limiting (default: 2)</span>
<span class="sd">        download: If True, automatically download papers that are available (default: False)</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with batch results including download information</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">doi_list</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">doi_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;DOI list must be a non-empty list&quot;</span><span class="p">}</span>
    
    <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting batch DOI availability check for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">doi_list</span><span class="p">)</span><span class="si">}</span><span class="s2"> DOIs&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">download</span><span class="p">:</span>
        <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Auto-download enabled - will download available papers&quot;</span><span class="p">)</span>
    <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Delay between requests: </span><span class="si">{</span><span class="n">delay</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
    
    <span class="n">batch_results</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;total_dois&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">doi_list</span><span class="p">),</span>
        <span class="s2">&quot;processed&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;available&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;not_available&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;requestable&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;not_found&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;downloaded&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;download_errors&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;downloads&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;summary&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s2">&quot;download_enabled&quot;</span><span class="p">:</span> <span class="n">download</span><span class="p">,</span>
        <span class="s2">&quot;started_at&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
    <span class="p">}</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">doi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">doi_list</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Checking DOI </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">doi_list</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Check individual DOI with download option</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">check_doi_availability_on_nexus</span><span class="p">(</span>
                <span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span> <span class="n">phone_number</span><span class="p">,</span> <span class="n">bot_username</span><span class="p">,</span> 
                <span class="n">doi</span><span class="p">,</span> <span class="n">session_file</span><span class="p">,</span> <span class="n">proxy</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="n">download</span>
            <span class="p">)</span>
            
            <span class="c1"># Add to batch results</span>
            <span class="n">batch_results</span><span class="p">[</span><span class="s2">&quot;results&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="n">batch_results</span><span class="p">[</span><span class="s2">&quot;processed&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            
            <span class="c1"># Update counters based on result</span>
            <span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">batch_results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> resulted in error: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
                <span class="n">available</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;available&quot;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;available&quot;</span><span class="p">:</span>
                    <span class="n">batch_results</span><span class="p">[</span><span class="s2">&quot;available&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    
                    <span class="c1"># Check if download was attempted and track results</span>
                    <span class="k">if</span> <span class="n">download</span><span class="p">:</span>
                        <span class="n">download_result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;download_result&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">download_result</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">):</span>
                                <span class="n">batch_results</span><span class="p">[</span><span class="s2">&quot;downloaded&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="n">batch_results</span><span class="p">[</span><span class="s2">&quot;downloads&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                                    <span class="s2">&quot;doi&quot;</span><span class="p">:</span> <span class="n">doi</span><span class="p">,</span>
                                    <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                                    <span class="s2">&quot;file_path&quot;</span><span class="p">:</span> <span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_path&quot;</span><span class="p">),</span>
                                    <span class="s2">&quot;file_name&quot;</span><span class="p">:</span> <span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_name&quot;</span><span class="p">),</span>
                                    <span class="s2">&quot;file_size_mb&quot;</span><span class="p">:</span> <span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_size_mb&quot;</span><span class="p">),</span>
                                    <span class="s2">&quot;download_time&quot;</span><span class="p">:</span> <span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;download_time&quot;</span><span class="p">),</span>
                                    <span class="s2">&quot;speed_mbps&quot;</span><span class="p">:</span> <span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;speed_mbps&quot;</span><span class="p">)</span>
                                <span class="p">})</span>
                                <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Downloaded paper for DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">batch_results</span><span class="p">[</span><span class="s2">&quot;download_errors&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="n">batch_results</span><span class="p">[</span><span class="s2">&quot;downloads&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                                    <span class="s2">&quot;doi&quot;</span><span class="p">:</span> <span class="n">doi</span><span class="p">,</span>
                                    <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;Unknown download error&quot;</span><span class="p">)</span>
                                <span class="p">})</span>
                                <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Failed to download paper for DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Available but no download attempted (shouldn&#39;t happen if download=True)</span>
                            <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> available but no download result found&quot;</span><span class="p">)</span>
                            
                <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;not_available_requestable&quot;</span><span class="p">:</span>
                    <span class="n">batch_results</span><span class="p">[</span><span class="s2">&quot;requestable&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">batch_results</span><span class="p">[</span><span class="s2">&quot;not_available&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;not_found&quot;</span><span class="p">:</span>
                    <span class="n">batch_results</span><span class="p">[</span><span class="s2">&quot;not_found&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">batch_results</span><span class="p">[</span><span class="s2">&quot;not_available&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">batch_results</span><span class="p">[</span><span class="s2">&quot;not_available&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                
                <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> status: </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">, available: </span><span class="si">{</span><span class="n">available</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Rate limiting delay (except for last request)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">doi_list</span><span class="p">):</span>
                <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting </span><span class="si">{</span><span class="n">delay</span><span class="si">}</span><span class="s2"> seconds before next request...&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
        
        <span class="c1"># Generate summary</span>
        <span class="n">batch_results</span><span class="p">[</span><span class="s2">&quot;completed_at&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="n">batch_results</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;available_count&quot;</span><span class="p">:</span> <span class="n">batch_results</span><span class="p">[</span><span class="s2">&quot;available&quot;</span><span class="p">],</span>
            <span class="s2">&quot;requestable_count&quot;</span><span class="p">:</span> <span class="n">batch_results</span><span class="p">[</span><span class="s2">&quot;requestable&quot;</span><span class="p">],</span>
            <span class="s2">&quot;not_found_count&quot;</span><span class="p">:</span> <span class="n">batch_results</span><span class="p">[</span><span class="s2">&quot;not_found&quot;</span><span class="p">],</span>
            <span class="s2">&quot;error_count&quot;</span><span class="p">:</span> <span class="n">batch_results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">],</span>
            <span class="s2">&quot;success_rate&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">((</span><span class="n">batch_results</span><span class="p">[</span><span class="s2">&quot;processed&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">batch_results</span><span class="p">[</span><span class="s2">&quot;errors&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="n">batch_results</span><span class="p">[</span><span class="s2">&quot;total_dois&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="s2">&quot;availability_rate&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">batch_results</span><span class="p">[</span><span class="s2">&quot;available&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">batch_results</span><span class="p">[</span><span class="s2">&quot;total_dois&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">batch_results</span><span class="p">[</span><span class="s2">&quot;total_dois&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="p">}</span>
        
        <span class="c1"># Add download summary if download was enabled</span>
        <span class="k">if</span> <span class="n">download</span><span class="p">:</span>
            <span class="n">batch_results</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">][</span><span class="s2">&quot;downloaded_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">batch_results</span><span class="p">[</span><span class="s2">&quot;downloaded&quot;</span><span class="p">]</span>
            <span class="n">batch_results</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">][</span><span class="s2">&quot;download_errors_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">batch_results</span><span class="p">[</span><span class="s2">&quot;download_errors&quot;</span><span class="p">]</span>
            <span class="n">batch_results</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">][</span><span class="s2">&quot;download_success_rate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">batch_results</span><span class="p">[</span><span class="s2">&quot;downloaded&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">batch_results</span><span class="p">[</span><span class="s2">&quot;available&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">batch_results</span><span class="p">[</span><span class="s2">&quot;available&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
            
            <span class="c1"># Calculate total download statistics</span>
            <span class="n">successful_downloads</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">batch_results</span><span class="p">[</span><span class="s2">&quot;downloads&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">successful_downloads</span><span class="p">:</span>
                <span class="n">total_size_mb</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_size_mb&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">successful_downloads</span><span class="p">)</span>
                <span class="n">total_time</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;download_time&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">successful_downloads</span><span class="p">)</span>
                <span class="n">avg_speed</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;speed_mbps&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">successful_downloads</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">successful_downloads</span><span class="p">)</span>
                
                <span class="n">batch_results</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">][</span><span class="s2">&quot;total_downloaded_mb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">total_size_mb</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">batch_results</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">][</span><span class="s2">&quot;total_download_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">total_time</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">batch_results</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">][</span><span class="s2">&quot;average_download_speed_mbps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">avg_speed</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        
        <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Batch DOI check completed: </span><span class="si">{</span><span class="n">batch_results</span><span class="p">[</span><span class="s1">&#39;available&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> available, </span><span class="si">{</span><span class="n">batch_results</span><span class="p">[</span><span class="s1">&#39;requestable&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> requestable, </span><span class="si">{</span><span class="n">batch_results</span><span class="p">[</span><span class="s1">&#39;not_found&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> not found, </span><span class="si">{</span><span class="n">batch_results</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> errors&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">download</span><span class="p">:</span>
            <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Download results: </span><span class="si">{</span><span class="n">batch_results</span><span class="p">[</span><span class="s1">&#39;downloaded&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> successful, </span><span class="si">{</span><span class="n">batch_results</span><span class="p">[</span><span class="s1">&#39;download_errors&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> failed&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">batch_results</span>
        
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in batch DOI availability check: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Batch check exception: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">batch_results</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Batch processing error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">batch_results</span><span class="p">[</span><span class="s2">&quot;completed_at&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">batch_results</span></div>


<div class="viewcode-block" id="format_batch_doi_results">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.format_batch_doi_results">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">format_batch_doi_results</span><span class="p">(</span><span class="n">batch_results</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Format the batch DOI results in a human-readable way&quot;&quot;&quot;</span>
    <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;BATCH DOI AVAILABILITY CHECK RESULTS&quot;</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">batch_results</span><span class="p">:</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; BATCH ERROR: </span><span class="si">{</span><span class="n">batch_results</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">error_print</span><span class="p">(</span><span class="n">batch_results</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    
    <span class="c1"># Summary statistics</span>
    <span class="n">total</span> <span class="o">=</span> <span class="n">batch_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;total_dois&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">processed</span> <span class="o">=</span> <span class="n">batch_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;processed&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">available</span> <span class="o">=</span> <span class="n">batch_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;available&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">requestable</span> <span class="o">=</span> <span class="n">batch_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;requestable&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">not_found</span> <span class="o">=</span> <span class="n">batch_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;not_found&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="n">batch_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;errors&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">download_enabled</span> <span class="o">=</span> <span class="n">batch_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;download_enabled&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; SUMMARY: Processed </span><span class="si">{</span><span class="n">processed</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2"> DOIs&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">download_enabled</span><span class="p">:</span>
        <span class="n">downloaded</span> <span class="o">=</span> <span class="n">batch_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;downloaded&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">download_errors</span> <span class="o">=</span> <span class="n">batch_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;download_errors&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Download Mode: ENABLED (</span><span class="si">{</span><span class="n">downloaded</span><span class="si">}</span><span class="s2"> successful, </span><span class="si">{</span><span class="n">download_errors</span><span class="si">}</span><span class="s2"> failed)&quot;</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Available on Nexus: </span><span class="si">{</span><span class="n">available</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">available</span><span class="o">/</span><span class="n">total</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span> <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot; Available on Nexus: 0&quot;</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Requestable: </span><span class="si">{</span><span class="n">requestable</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">requestable</span><span class="o">/</span><span class="n">total</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span> <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot; Requestable: 0&quot;</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Not Found: </span><span class="si">{</span><span class="n">not_found</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">not_found</span><span class="o">/</span><span class="n">total</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span> <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot; Not Found: 0&quot;</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Errors: </span><span class="si">{</span><span class="n">errors</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">errors</span><span class="o">/</span><span class="n">total</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span> <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot; Errors: 0&quot;</span><span class="p">)</span>
    
    <span class="n">summary</span> <span class="o">=</span> <span class="n">batch_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="k">if</span> <span class="n">summary</span><span class="p">:</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Success Rate: </span><span class="si">{</span><span class="n">summary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;success_rate&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Availability Rate: </span><span class="si">{</span><span class="n">summary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;availability_rate&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
        
        <span class="c1"># Download statistics</span>
        <span class="k">if</span> <span class="n">download_enabled</span> <span class="ow">and</span> <span class="n">summary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;downloaded_count&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Download Success Rate: </span><span class="si">{</span><span class="n">summary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;download_success_rate&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Total Downloaded: </span><span class="si">{</span><span class="n">summary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_downloaded_mb&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Total Download Time: </span><span class="si">{</span><span class="n">summary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total_download_time&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Average Download Speed: </span><span class="si">{</span><span class="n">summary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;average_download_speed_mbps&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB/s&quot;</span><span class="p">)</span>
    
    <span class="c1"># Timing information</span>
    <span class="n">started_at</span> <span class="o">=</span> <span class="n">batch_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;started_at&quot;</span><span class="p">)</span>
    <span class="n">completed_at</span> <span class="o">=</span> <span class="n">batch_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;completed_at&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">started_at</span> <span class="ow">and</span> <span class="n">completed_at</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">started_at</span><span class="p">)</span>
            <span class="n">end_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">completed_at</span><span class="p">)</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Total Time: </span><span class="si">{</span><span class="n">duration</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">processed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Average Time per DOI: </span><span class="si">{</span><span class="n">duration</span><span class="o">/</span><span class="n">processed</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;Could not calculate timing information&quot;</span><span class="p">)</span>
    
    <span class="c1"># Download details section</span>
    <span class="k">if</span> <span class="n">download_enabled</span><span class="p">:</span>
        <span class="n">downloads</span> <span class="o">=</span> <span class="n">batch_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;downloads&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">successful_downloads</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">downloads</span> <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">)]</span>
        <span class="n">failed_downloads</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">downloads</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">)]</span>
        
        <span class="k">if</span> <span class="n">successful_downloads</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; SUCCESSFUL DOWNLOADS:&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">download</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">successful_downloads</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">2d</span><span class="si">}</span><span class="s2">.  </span><span class="si">{</span><span class="n">download</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;doi&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown DOI&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     File: </span><span class="si">{</span><span class="n">download</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Size: </span><span class="si">{</span><span class="n">download</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_size_mb&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB&quot;</span><span class="p">)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Time: </span><span class="si">{</span><span class="n">download</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;download_time&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Speed: </span><span class="si">{</span><span class="n">download</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;speed_mbps&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB/s&quot;</span><span class="p">)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Path: </span><span class="si">{</span><span class="n">download</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_path&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">failed_downloads</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; FAILED DOWNLOADS:&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">download</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">failed_downloads</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">2d</span><span class="si">}</span><span class="s2">.  </span><span class="si">{</span><span class="n">download</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;doi&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown DOI&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Error: </span><span class="si">{</span><span class="n">download</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown error&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; DETAILED RESULTS:&quot;</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
    
    <span class="c1"># Individual results</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">batch_results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;results&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">2d</span><span class="si">}</span><span class="s2">.  ERROR: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;doi&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown DOI&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">doi</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;doi&quot;</span><span class="p">,</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">)</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
            <span class="n">available</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;available&quot;</span><span class="p">)</span>
            
            <span class="c1"># Status emoji and text</span>
            <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;available&quot;</span><span class="p">:</span>
                <span class="n">status_emoji</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">status_text</span> <span class="o">=</span> <span class="s2">&quot;AVAILABLE&quot;</span>
                
                <span class="c1"># Add download status if enabled</span>
                <span class="k">if</span> <span class="n">download_enabled</span><span class="p">:</span>
                    <span class="n">download_result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;download_result&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">download_result</span> <span class="ow">and</span> <span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">):</span>
                        <span class="n">status_text</span> <span class="o">+=</span> <span class="s2">&quot; + DOWNLOADED&quot;</span>
                    <span class="k">elif</span> <span class="n">download_result</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">):</span>
                        <span class="n">status_text</span> <span class="o">+=</span> <span class="s2">&quot; + DOWNLOAD FAILED&quot;</span>
                        
            <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;not_available_requestable&quot;</span><span class="p">:</span>
                <span class="n">status_emoji</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">status_text</span> <span class="o">=</span> <span class="s2">&quot;REQUESTABLE&quot;</span>
            <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;not_found&quot;</span><span class="p">:</span>
                <span class="n">status_emoji</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">status_text</span> <span class="o">=</span> <span class="s2">&quot;NOT FOUND&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">status_emoji</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">status_text</span> <span class="o">=</span> <span class="n">status</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">2d</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">status_emoji</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">status_text</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Additional details</span>
            <span class="n">details</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;details&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_size_mb&quot;</span><span class="p">):</span>
                <span class="n">size_unit</span> <span class="o">=</span> <span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_size_unit&quot;</span><span class="p">,</span> <span class="s2">&quot;MB&quot;</span><span class="p">)</span>
                <span class="n">original_size</span> <span class="o">=</span> <span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_size_original&quot;</span><span class="p">,</span> <span class="n">details</span><span class="p">[</span><span class="s2">&quot;file_size_mb&quot;</span><span class="p">])</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Size: </span><span class="si">{</span><span class="n">original_size</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">size_unit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># Download details</span>
            <span class="k">if</span> <span class="n">download_enabled</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;download_result&quot;</span><span class="p">):</span>
                <span class="n">download_result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;download_result&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">):</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Downloaded: </span><span class="si">{</span><span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_name&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Saved to: </span><span class="si">{</span><span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file_path&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     Download failed: </span><span class="si">{</span><span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown error&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="n">reason</span> <span class="o">=</span> <span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reason&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">reason</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">reason</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>  <span class="c1"># Only show short reasons</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     </span><span class="si">{</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
    
    <span class="c1"># Print to console and log</span>
    <span class="n">result_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Formatting batch DOI results for display&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">result_text</span><span class="p">)</span></div>


<div class="viewcode-block" id="download_from_nexus_bot">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.download_from_nexus_bot">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">download_from_nexus_bot</span><span class="p">(</span><span class="n">doi</span><span class="p">,</span> <span class="n">download_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bot_username</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download a paper from Nexus based on DOI</span>

<span class="sd">    Args:</span>
<span class="sd">        doi: DOI string to search and download (e.g., &quot;10.1038/nature12373&quot;)</span>
<span class="sd">        download_dir: Target directory to save the file (optional, uses default if None)</span>
<span class="sd">        bot_username: Bot username to use (optional, uses global BOT_USERNAME if None)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with download result and file information</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">doi</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">doi</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid DOI: DOI must be a non-empty string&quot;</span><span class="p">}</span>

    <span class="n">doi</span> <span class="o">=</span> <span class="n">doi</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^10\.\d+/.+&#39;</span><span class="p">,</span> <span class="n">doi</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Invalid DOI format: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">. DOI should start with &#39;10.&#39; followed by digits and a slash&quot;</span><span class="p">}</span>

    <span class="n">target_bot</span> <span class="o">=</span> <span class="n">bot_username</span> <span class="ow">or</span> <span class="n">BOT_USERNAME</span>

    <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloading from Nexus - DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Target bot: </span><span class="si">{</span><span class="n">target_bot</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Download directory: </span><span class="si">{</span><span class="n">download_dir</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;default&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Step 1: Decide proxy usage (try direct connection first)</span>
        <span class="n">proxy_to_use</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">client</span> <span class="o">=</span> <span class="n">create_telegram_client</span><span class="p">(</span><span class="n">TG_API_ID</span><span class="p">,</span> <span class="n">TG_API_HASH</span><span class="p">,</span> <span class="n">SESSION_FILE</span><span class="p">,</span> <span class="n">proxy</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">phone</span><span class="o">=</span><span class="n">PHONE</span> <span class="k">if</span> <span class="n">PHONE</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">is_auth</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">is_user_authorized</span><span class="p">()</span>
            <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_auth</span><span class="p">:</span>
                <span class="n">proxy_to_use</span> <span class="o">=</span> <span class="k">await</span> <span class="n">decide_proxy_usage</span><span class="p">(</span><span class="n">TG_API_ID</span><span class="p">,</span> <span class="n">TG_API_HASH</span><span class="p">,</span> <span class="n">PHONE</span><span class="p">,</span> <span class="n">SESSION_FILE</span><span class="p">,</span> <span class="n">DEFAULT_PROXY_FILE</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">proxy_to_use</span> <span class="o">=</span> <span class="k">await</span> <span class="n">decide_proxy_usage</span><span class="p">(</span><span class="n">TG_API_ID</span><span class="p">,</span> <span class="n">TG_API_HASH</span><span class="p">,</span> <span class="n">PHONE</span><span class="p">,</span> <span class="n">SESSION_FILE</span><span class="p">,</span> <span class="n">DEFAULT_PROXY_FILE</span><span class="p">)</span>

        <span class="c1"># Step 2: Check DOI availability with auto-download enabled</span>
        <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Step 1: Checking DOI availability on Nexus...&quot;</span><span class="p">)</span>
        <span class="n">availability_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">check_doi_availability_on_nexus</span><span class="p">(</span>
            <span class="n">TG_API_ID</span><span class="p">,</span> <span class="n">TG_API_HASH</span><span class="p">,</span> <span class="n">PHONE</span><span class="p">,</span> <span class="n">target_bot</span><span class="p">,</span>
            <span class="n">doi</span><span class="p">,</span> <span class="n">SESSION_FILE</span><span class="p">,</span> <span class="n">proxy_to_use</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">in</span> <span class="n">availability_result</span><span class="p">:</span>
            <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DOI availability check failed: </span><span class="si">{</span><span class="n">availability_result</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;DOI availability check failed: </span><span class="si">{</span><span class="n">availability_result</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s2">&quot;doi&quot;</span><span class="p">:</span> <span class="n">doi</span>
            <span class="p">}</span>

        <span class="n">status</span> <span class="o">=</span> <span class="n">availability_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
        <span class="n">available</span> <span class="o">=</span> <span class="n">availability_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;available&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DOI status: </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">, Available: </span><span class="si">{</span><span class="n">available</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">available</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;not_available_requestable&quot;</span><span class="p">:</span>
                <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Paper is not available on Nexus but can be requested&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Paper not available on Nexus - can be requested from community&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;doi&quot;</span><span class="p">:</span> <span class="n">doi</span><span class="p">,</span>
                    <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;requestable&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;request_info&quot;</span><span class="p">:</span> <span class="n">availability_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;details&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;request_button&quot;</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;not_found&quot;</span><span class="p">:</span>
                <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;DOI not found in Nexus database&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;DOI not found in Nexus database&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;doi&quot;</span><span class="p">:</span> <span class="n">doi</span><span class="p">,</span>
                    <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;not_found&quot;</span>
                <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Paper not available - status: </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Paper not available - status: </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;doi&quot;</span><span class="p">:</span> <span class="n">doi</span><span class="p">,</span>
                    <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">status</span>
                <span class="p">}</span>

        <span class="n">download_result</span> <span class="o">=</span> <span class="n">availability_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;download_result&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">download_result</span><span class="p">:</span>
            <span class="n">error_print</span><span class="p">(</span><span class="s2">&quot;Paper is available but no download was attempted&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Paper is available but download was not attempted&quot;</span><span class="p">,</span>
                <span class="s2">&quot;doi&quot;</span><span class="p">:</span> <span class="n">doi</span><span class="p">,</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;available_no_download&quot;</span>
            <span class="p">}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">):</span>
            <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Download failed: </span><span class="si">{</span><span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown download error&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Download failed: </span><span class="si">{</span><span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown download error&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s2">&quot;doi&quot;</span><span class="p">:</span> <span class="n">doi</span><span class="p">,</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;download_failed&quot;</span>
            <span class="p">}</span>

        <span class="n">downloaded_file_path</span> <span class="o">=</span> <span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_path&quot;</span><span class="p">)</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_name&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;filename&quot;</span><span class="p">)</span>
        <span class="n">file_size</span> <span class="o">=</span> <span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_size&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">file_size_mb</span> <span class="o">=</span> <span class="n">file_size</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span> <span class="k">if</span> <span class="n">file_size</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">downloaded_file_path</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">downloaded_file_path</span><span class="p">):</span>
            <span class="n">error_print</span><span class="p">(</span><span class="s2">&quot;Downloaded file not found on disk&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Downloaded file not found on disk&quot;</span><span class="p">,</span>
                <span class="s2">&quot;doi&quot;</span><span class="p">:</span> <span class="n">doi</span><span class="p">,</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;file_missing&quot;</span>
            <span class="p">}</span>

        <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; File downloaded successfully: </span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File size: </span><span class="si">{</span><span class="n">file_size_mb</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB&quot;</span><span class="p">)</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloaded to: </span><span class="si">{</span><span class="n">downloaded_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">final_file_path</span> <span class="o">=</span> <span class="n">downloaded_file_path</span>

        <span class="k">if</span> <span class="n">download_dir</span><span class="p">:</span>
            <span class="n">target_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">download_dir</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="n">target_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">target_dir</span><span class="p">)</span>
            <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Target directory specified: </span><span class="si">{</span><span class="n">target_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">target_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Target directory created/verified: </span><span class="si">{</span><span class="n">target_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">target_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_dir</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">target_file_path</span><span class="p">):</span>
                    <span class="n">base_name</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
                    <span class="n">counter</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">target_file_path</span><span class="p">):</span>
                        <span class="n">new_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">counter</span><span class="si">}{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">target_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_dir</span><span class="p">,</span> <span class="n">new_name</span><span class="p">)</span>
                        <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File name conflict resolved: </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">target_file_path</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Original file exists, using: </span><span class="si">{</span><span class="n">target_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">downloaded_file_path</span><span class="p">,</span> <span class="n">target_file_path</span><span class="p">)</span>
                <span class="n">final_file_path</span> <span class="o">=</span> <span class="n">target_file_path</span>
                <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; File moved to: </span><span class="si">{</span><span class="n">target_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;File move operation completed successfully&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">move_error</span><span class="p">:</span>
                <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Could not move file to specified directory: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">move_error</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File move exception: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">move_error</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">move_error</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File remains at: </span><span class="si">{</span><span class="n">downloaded_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;doi&quot;</span><span class="p">:</span> <span class="n">doi</span><span class="p">,</span>
            <span class="s2">&quot;file_path&quot;</span><span class="p">:</span> <span class="n">final_file_path</span><span class="p">,</span>
            <span class="s2">&quot;file_name&quot;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">final_file_path</span><span class="p">),</span>
            <span class="s2">&quot;file_size&quot;</span><span class="p">:</span> <span class="n">file_size</span><span class="p">,</span>
            <span class="s2">&quot;file_size_mb&quot;</span><span class="p">:</span> <span class="n">file_size_mb</span><span class="p">,</span>
            <span class="s2">&quot;download_time&quot;</span><span class="p">:</span> <span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;download_time&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s2">&quot;speed_mbps&quot;</span><span class="p">:</span> <span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;speed_mbps&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s2">&quot;original_download_path&quot;</span><span class="p">:</span> <span class="n">downloaded_file_path</span><span class="p">,</span>
            <span class="s2">&quot;moved_to_target_dir&quot;</span><span class="p">:</span> <span class="n">download_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">final_file_path</span> <span class="o">!=</span> <span class="n">downloaded_file_path</span><span class="p">,</span>
            <span class="s2">&quot;target_directory&quot;</span><span class="p">:</span> <span class="n">download_dir</span><span class="p">,</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;downloaded&quot;</span>
        <span class="p">}</span>

        <span class="n">details</span> <span class="o">=</span> <span class="n">availability_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;details&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_size_mb&quot;</span><span class="p">):</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;expected_file_size_mb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s2">&quot;file_size_mb&quot;</span><span class="p">]</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;file_size_unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_size_unit&quot;</span><span class="p">,</span> <span class="s2">&quot;MB&quot;</span><span class="p">)</span>

        <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Download completed successfully!&quot;</span><span class="p">)</span>
        <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final location: </span><span class="si">{</span><span class="n">final_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Download result: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in download_from_nexus: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Download function exception: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Download operation failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;doi&quot;</span><span class="p">:</span> <span class="n">doi</span><span class="p">,</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="format_download_from_nexus_bot_result">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.format_download_from_nexus_bot_result">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">format_download_from_nexus_bot_result</span><span class="p">(</span><span class="n">download_result</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Format the download result in a human-readable way&quot;&quot;&quot;</span>
    <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;NEXUS DOWNLOAD RESULT&quot;</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">):</span>
        <span class="n">doi</span> <span class="o">=</span> <span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;doi&quot;</span><span class="p">,</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">)</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;Unknown error&quot;</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
        
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; DOWNLOAD FAILED: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Error: </span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Status: </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Provide specific guidance based on status</span>
        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;requestable&quot;</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; SUGGESTION:&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;   The paper is not available on Nexus but can be requested.&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;   Use the request feature to ask the community to upload it.&quot;</span><span class="p">)</span>
            
            <span class="n">request_info</span> <span class="o">=</span> <span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;request_info&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">request_info</span><span class="p">:</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Request button: &#39;</span><span class="si">{</span><span class="n">request_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                
        <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;not_found&quot;</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; SUGGESTION:&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;   The DOI was not found in the Nexus database.&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;   Please verify the DOI is correct or try a different search.&quot;</span><span class="p">)</span>
            
        <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;download_failed&quot;</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; SUGGESTION:&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;   The paper is available but download failed.&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;   Try running the download again or check your connection.&quot;</span><span class="p">)</span>
        
        <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Download failed for DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">doi</span> <span class="o">=</span> <span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;doi&quot;</span><span class="p">,</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">)</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_path&quot;</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">)</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_name&quot;</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">)</span>
        <span class="n">file_size_mb</span> <span class="o">=</span> <span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file_size_mb&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">download_time</span> <span class="o">=</span> <span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;download_time&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">speed_mbps</span> <span class="o">=</span> <span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;speed_mbps&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; DOWNLOAD SUCCESSFUL: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; FILE INFORMATION:&quot;</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    File Name: </span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    File Size: </span><span class="si">{</span><span class="n">file_size_mb</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB&quot;</span><span class="p">)</span>
        <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    Location: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># File movement information</span>
        <span class="k">if</span> <span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;moved_to_target_dir&quot;</span><span class="p">):</span>
            <span class="n">original_path</span> <span class="o">=</span> <span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;original_download_path&quot;</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">)</span>
            <span class="n">target_dir</span> <span class="o">=</span> <span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target_directory&quot;</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; FILE MOVEMENT:&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    From: </span><span class="si">{</span><span class="n">original_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    To: </span><span class="si">{</span><span class="n">target_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;    Successfully moved to target directory&quot;</span><span class="p">)</span>
        
        <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Successfully downloaded paper for DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File saved to: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">70</span><span class="p">)</span>
    
    <span class="c1"># Print to console and log</span>
    <span class="n">result_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">logger</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Formatting download result for display&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">result_text</span><span class="p">)</span></div>


<div class="viewcode-block" id="request_paper_by_doi">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.request_paper_by_doi">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">request_paper_by_doi</span><span class="p">(</span><span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span> <span class="n">phone_number</span><span class="p">,</span> <span class="n">bot_username</span><span class="p">,</span> <span class="n">doi</span><span class="p">,</span> <span class="n">session_file</span><span class="o">=</span><span class="n">SESSION_FILE</span><span class="p">,</span> <span class="n">proxy</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Request a paper from Nexus by DOI.</span>
<span class="sd">    This will send the DOI to the bot, detect if a request is needed, and click the request button if available.</span>

<span class="sd">    Args:</span>
<span class="sd">        api_id: Telegram API ID</span>
<span class="sd">        api_hash: Telegram API hash</span>
<span class="sd">        phone_number: Your phone number (not used, kept for compatibility)</span>
<span class="sd">        bot_username: Bot&#39;s username</span>
<span class="sd">        doi: DOI string to request (e.g., &quot;10.1038/nature12373&quot;)</span>
<span class="sd">        session_file: Session file name</span>
<span class="sd">        proxy: Proxy configuration dict or file path</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: {</span>
<span class="sd">            &quot;ok&quot;: True if request sent, False or &quot;error&quot; otherwise,</span>
<span class="sd">            &quot;doi&quot;: &lt;doi&gt;,</span>
<span class="sd">            &quot;request_sent&quot;: True/False,</span>
<span class="sd">            &quot;details&quot;: ...,</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Requesting paper by DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># Step 1: Send DOI to the bot and get reply</span>
    <span class="n">send_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">send_message_to_bot</span><span class="p">(</span>
        <span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span> <span class="n">phone_number</span><span class="p">,</span> <span class="n">bot_username</span><span class="p">,</span> <span class="n">doi</span><span class="p">,</span> <span class="n">session_file</span><span class="p">,</span> <span class="n">proxy</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">send_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ok&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Failed to send DOI to bot: </span><span class="si">{</span><span class="n">send_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown error&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;doi&quot;</span><span class="p">:</span> <span class="n">doi</span><span class="p">}</span>

    <span class="n">bot_reply</span> <span class="o">=</span> <span class="n">send_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bot_reply&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">bot_reply</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">bot_reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;buttons&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;No reply or no buttons found in bot response&quot;</span><span class="p">,</span> <span class="s2">&quot;doi&quot;</span><span class="p">:</span> <span class="n">doi</span><span class="p">}</span>

    <span class="c1"># Step 2: Find the request button</span>
    <span class="n">request_button</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">btn</span> <span class="ow">in</span> <span class="n">bot_reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;buttons&quot;</span><span class="p">,</span> <span class="p">[]):</span>
        <span class="k">if</span> <span class="n">btn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;callback&quot;</span> <span class="ow">and</span> <span class="s2">&quot;request&quot;</span> <span class="ow">in</span> <span class="n">btn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">request_button</span> <span class="o">=</span> <span class="n">btn</span>
            <span class="k">break</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">request_button</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;doi&quot;</span><span class="p">:</span> <span class="n">doi</span><span class="p">,</span> <span class="s2">&quot;request_sent&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="s2">&quot;No request button found. Paper may already be available or not requestable.&quot;</span><span class="p">}</span>

    <span class="c1"># Step 3: Click the request button</span>
    <span class="n">message_id</span> <span class="o">=</span> <span class="n">bot_reply</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message_id&quot;</span><span class="p">)</span>
    <span class="n">callback_data</span> <span class="o">=</span> <span class="n">request_button</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;callback_data&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">request_button</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">)</span>
    <span class="n">click_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">click_callback_button</span><span class="p">(</span>
        <span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span> <span class="n">phone_number</span><span class="p">,</span> <span class="n">bot_username</span><span class="p">,</span> <span class="n">message_id</span><span class="p">,</span> <span class="n">callback_data</span><span class="p">,</span> <span class="n">session_file</span><span class="p">,</span> <span class="n">proxy</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">click_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ok&quot;</span><span class="p">):</span>
        <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Paper request sent successfully.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;doi&quot;</span><span class="p">:</span> <span class="n">doi</span><span class="p">,</span>
            <span class="s2">&quot;request_sent&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="n">click_result</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;ok&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;doi&quot;</span><span class="p">:</span> <span class="n">doi</span><span class="p">,</span>
            <span class="s2">&quot;request_sent&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;details&quot;</span><span class="p">:</span> <span class="n">click_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;Unknown error&quot;</span><span class="p">)</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="batch_request_papers_by_doi">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.batch_request_papers_by_doi">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">batch_request_papers_by_doi</span><span class="p">(</span><span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span> <span class="n">phone_number</span><span class="p">,</span> <span class="n">bot_username</span><span class="p">,</span> <span class="n">doi_list</span><span class="p">,</span> <span class="n">session_file</span><span class="o">=</span><span class="n">SESSION_FILE</span><span class="p">,</span> <span class="n">proxy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Request multiple papers from Nexus by DOI.</span>
<span class="sd">    For each DOI, sends the DOI to the bot, detects if a request is needed, and clicks the request button if available.</span>

<span class="sd">    Args:</span>
<span class="sd">        api_id: Telegram API ID</span>
<span class="sd">        api_hash: Telegram API hash</span>
<span class="sd">        phone_number: Your phone number (not used, kept for compatibility)</span>
<span class="sd">        bot_username: Bot&#39;s username</span>
<span class="sd">        doi_list: List of DOI strings to request</span>
<span class="sd">        session_file: Session file name</span>
<span class="sd">        proxy: Proxy configuration dict or file path</span>
<span class="sd">        delay: Delay in seconds between requests (default: 2)</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: {</span>
<span class="sd">            &quot;total&quot;: int,</span>
<span class="sd">            &quot;requested&quot;: int,</span>
<span class="sd">            &quot;skipped&quot;: int,</span>
<span class="sd">            &quot;errors&quot;: int,</span>
<span class="sd">            &quot;results&quot;: list of per-DOI results</span>
<span class="sd">        }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">doi_list</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">doi_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;DOI list must be a non-empty list&quot;</span><span class="p">}</span>

    <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting batch paper request for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">doi_list</span><span class="p">)</span><span class="si">}</span><span class="s2"> DOIs&quot;</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">requested</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">skipped</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">doi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">doi_list</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Requesting DOI </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">doi_list</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">request_paper_by_doi</span><span class="p">(</span>
                <span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span> <span class="n">phone_number</span><span class="p">,</span> <span class="n">bot_username</span><span class="p">,</span> <span class="n">doi</span><span class="p">,</span> <span class="n">session_file</span><span class="p">,</span> <span class="n">proxy</span>
            <span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ok&quot;</span><span class="p">):</span>
                <span class="n">requested</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Requested paper for DOI: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;request_sent&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">skipped</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipped DOI (no request needed or possible): </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">errors</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error requesting DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;details&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown error&#39;</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">errors</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exception requesting DOI </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;doi&quot;</span><span class="p">:</span> <span class="n">doi</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">doi_list</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>

    <span class="n">summary</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">doi_list</span><span class="p">),</span>
        <span class="s2">&quot;requested&quot;</span><span class="p">:</span> <span class="n">requested</span><span class="p">,</span>
        <span class="s2">&quot;skipped&quot;</span><span class="p">:</span> <span class="n">skipped</span><span class="p">,</span>
        <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="n">errors</span><span class="p">,</span>
        <span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="n">results</span>
    <span class="p">}</span>
    <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Batch request completed: </span><span class="si">{</span><span class="n">requested</span><span class="si">}</span><span class="s2"> requested, </span><span class="si">{</span><span class="n">skipped</span><span class="si">}</span><span class="s2"> skipped, </span><span class="si">{</span><span class="n">errors</span><span class="si">}</span><span class="s2"> errors&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">summary</span></div>


<div class="viewcode-block" id="request_papers_by_doi_list">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.request_papers_by_doi_list">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">request_papers_by_doi_list</span><span class="p">(</span><span class="n">doi_list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Request one or more papers by DOI using the Nexus bot.</span>
<span class="sd">    Attempts direct connection first, falls back to proxy if needed.</span>

<span class="sd">    Args:</span>
<span class="sd">        doi_list (list): List of DOI strings.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Summary of request results.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">doi_list</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">doi_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Input must be a non-empty list of DOIs&quot;</span><span class="p">}</span>

    <span class="c1"># Load credentials from default location</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">CREDENTIALS_FILE</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Credentials file not found. Please set up credentials first.&quot;</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">CREDENTIALS_FILE</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">creds</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">api_id</span> <span class="o">=</span> <span class="n">creds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tg_api_id&quot;</span><span class="p">)</span>
        <span class="n">api_hash</span> <span class="o">=</span> <span class="n">creds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tg_api_hash&quot;</span><span class="p">)</span>
        <span class="n">phone</span> <span class="o">=</span> <span class="n">creds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;phone&quot;</span><span class="p">)</span>
        <span class="n">bot_username</span> <span class="o">=</span> <span class="n">creds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bot_username&quot;</span><span class="p">,</span> <span class="n">BOT_USERNAME</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Failed to load credentials: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>

    <span class="c1"># Try direct connection first</span>
    <span class="n">proxy_to_use</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">create_telegram_client</span><span class="p">(</span><span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span> <span class="n">SESSION_FILE</span><span class="p">,</span> <span class="n">proxy</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">phone</span><span class="o">=</span><span class="n">phone</span> <span class="k">if</span> <span class="n">phone</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">is_auth</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">is_user_authorized</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_auth</span><span class="p">:</span>
            <span class="n">proxy_to_use</span> <span class="o">=</span> <span class="k">await</span> <span class="n">decide_proxy_usage</span><span class="p">(</span><span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span> <span class="n">phone</span><span class="p">,</span> <span class="n">SESSION_FILE</span><span class="p">,</span> <span class="n">DEFAULT_PROXY_FILE</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">proxy_to_use</span> <span class="o">=</span> <span class="k">await</span> <span class="n">decide_proxy_usage</span><span class="p">(</span><span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span> <span class="n">phone</span><span class="p">,</span> <span class="n">SESSION_FILE</span><span class="p">,</span> <span class="n">DEFAULT_PROXY_FILE</span><span class="p">)</span>

    <span class="c1"># Use batch_request_papers_by_doi for all DOIs</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">batch_request_papers_by_doi</span><span class="p">(</span>
        <span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span> <span class="n">phone</span><span class="p">,</span> <span class="n">bot_username</span><span class="p">,</span> <span class="n">doi_list</span><span class="p">,</span> <span class="n">SESSION_FILE</span><span class="p">,</span> <span class="n">proxy_to_use</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="print_default_paths">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.print_default_paths">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">print_default_paths</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Print all default file and directory paths used by the script.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DEFAULT FILE AND DIRECTORY PATHS&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Session file:         </span><span class="si">{</span><span class="n">SESSION_FILE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Credentials file:     </span><span class="si">{</span><span class="n">CREDENTIALS_FILE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Proxy config file:    </span><span class="si">{</span><span class="n">DEFAULT_PROXY_FILE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Proxy list file:      </span><span class="si">{</span><span class="n">DEFAULT_PROXY_FILE</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.json&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_list.json&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Log file:             </span><span class="si">{</span><span class="n">DEFAULT_LOG_FILE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Download directory:   </span><span class="si">{</span><span class="n">DEFAULT_DOWNLOAD_DIR</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">50</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="main">
<a class="viewcode-back" href="../../api_reference.html#getscipapers_hoanganhduc.nexus.main">[docs]</a>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">TG_API_ID</span><span class="p">,</span> <span class="n">TG_API_HASH</span><span class="p">,</span> <span class="n">PHONE</span><span class="p">,</span> <span class="n">BOT_USERNAME</span>

    <span class="c1"># Get the parent package name from the module&#39;s __name__</span>
    <span class="n">parent_package</span> <span class="o">=</span> <span class="vm">__name__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="vm">__name__</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">parent_package</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">program_name</span> <span class="o">=</span> <span class="s1">&#39;nexus&#39;</span>
    <span class="k">elif</span> <span class="s1">&#39;_&#39;</span> <span class="ow">in</span> <span class="n">parent_package</span><span class="p">:</span>
        <span class="c1"># If the parent package has an underscore, strip it</span>
        <span class="n">parent_package</span> <span class="o">=</span> <span class="n">parent_package</span><span class="p">[:</span><span class="n">parent_package</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)]</span>
        <span class="n">program_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">parent_package</span><span class="si">}</span><span class="s2"> nexus&quot;</span>

    <span class="c1"># Parse command line arguments using argparse</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">prog</span><span class="o">=</span><span class="n">program_name</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Interact with Telegram bots, especially Nexus scientific paper bot&#39;</span><span class="p">,</span>
        <span class="n">epilog</span><span class="o">=</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">Examples:</span>
<span class="s1">  </span><span class="si">%(prog)s</span><span class="s1"> --search &quot;artificial intelligence&quot;</span>
<span class="s1">    Search for papers on artificial intelligence</span>
<span class="s1">  </span>
<span class="s1">  </span><span class="si">%(prog)s</span><span class="s1"> --check-doi 10.1038/nature12373</span>
<span class="s1">    Check if a specific DOI is available on Nexus</span>
<span class="s1">  </span>
<span class="s1">  </span><span class="si">%(prog)s</span><span class="s1"> --check-doi 10.1038/nature12373 --download</span>
<span class="s1">    Check DOI availability and auto-download if available</span>
<span class="s1">  </span>
<span class="s1">  </span><span class="si">%(prog)s</span><span class="s1"> --check-doi dois.txt --download</span>
<span class="s1">    Check multiple DOIs from file and download available papers</span>

<span class="s1">  </span><span class="si">%(prog)s</span><span class="s1"> --check-doi &quot;10.1038/nature12373,10.1126/science.abc123&quot;</span>
<span class="s1">    Check multiple DOIs by comma-separated list</span>

<span class="s1">  </span><span class="si">%(prog)s</span><span class="s1"> --check-doi &quot;10.1038/nature12373 10.1126/science.abc123&quot;</span>
<span class="s1">    Check multiple DOIs by space-separated list</span>
<span class="s1">  </span>
<span class="s1">  </span><span class="si">%(prog)s</span><span class="s1"> --user-info</span>
<span class="s1">    Get your Nexus user profile information</span>
<span class="s1">  </span>
<span class="s1">  </span><span class="si">%(prog)s</span><span class="s1"> --fetch-nexus-aaron 20</span>
<span class="s1">    Fetch 20 recent messages from @nexus_aaron bot</span>
<span class="s1">  </span>
<span class="s1">  </span><span class="si">%(prog)s</span><span class="s1"> --upload-to-nexus-aaron paper.pdf --upload-message &quot;New research paper&quot;</span>
<span class="s1">    Upload a file to @nexus_aaron with optional message</span>
<span class="s1">  </span>
<span class="s1">  </span><span class="si">%(prog)s</span><span class="s1"> --solve-requests 5</span>
<span class="s1">    Help solve research requests from @nexus_aaron</span>
<span class="s1">  </span>
<span class="s1">  </span><span class="si">%(prog)s</span><span class="s1"> --create-session</span>
<span class="s1">    Create new Telegram session interactively</span>
<span class="s1">  </span>
<span class="s1">  </span><span class="si">%(prog)s</span><span class="s1"> --test-connection --proxy proxy.json</span>
<span class="s1">    Test connection with proxy configuration</span>
<span class="s1">  </span>
<span class="s1">  </span><span class="si">%(prog)s</span><span class="s1"> --clear-proxy --clear-credentials</span>
<span class="s1">    Clean up configuration files</span>

<span class="s1">  </span><span class="si">%(prog)s</span><span class="s1"> --request-doi 10.1038/nature12373</span>
<span class="s1">    Request a paper by DOI if not available</span>

<span class="s1">  </span><span class="si">%(prog)s</span><span class="s1"> --request-doi &quot;10.1038/nature12373,10.1126/science.abc123&quot;</span>
<span class="s1">    Request multiple papers by comma-separated DOIs</span>

<span class="s1">  </span><span class="si">%(prog)s</span><span class="s1"> --request-doi &quot;10.1038/nature12373 10.1126/science.abc123&quot;</span>
<span class="s1">    Request multiple papers by space-separated DOIs</span>

<span class="s1">  </span><span class="si">%(prog)s</span><span class="s1"> --request-doi dois.txt</span>
<span class="s1">    Request papers by DOIs listed in a file (one per line)</span>
<span class="s1">        &#39;&#39;&#39;</span><span class="p">,</span>
        <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">RawDescriptionHelpFormatter</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-S&#39;</span><span class="p">,</span> <span class="s1">&#39;--create-session&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Create a new session file interactively&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39;--credentials&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Path to credentials JSON file containing API credentials. &#39;</span>
                            <span class="s1">&#39;Example file content: {&quot;tg_api_id&quot;: &quot;12345678&quot;, &quot;tg_api_hash&quot;: &quot;abcd1234efgh5678&quot;, &#39;</span>
                            <span class="s1">&#39;&quot;phone&quot;: &quot;+1234567890&quot;, &quot;bot_username&quot;: &quot;SciNexBot&quot;}&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="s1">&#39;--search&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                       <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Search query to send to the bot&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-L&#39;</span><span class="p">,</span> <span class="s1">&#39;--search-limit&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Limit the number of search results returned when using --search&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--bot&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Bot username to interact with (overrides default)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-v&#39;</span><span class="p">,</span> <span class="s1">&#39;--verbose&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Enable verbose output for debugging&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-l&#39;</span><span class="p">,</span> <span class="s1">&#39;--log&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="n">DEFAULT_LOG_FILE</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Save output to log file (default: </span><span class="si">{</span><span class="n">DEFAULT_LOG_FILE</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="s1">&#39;--proxy&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="n">DEFAULT_PROXY_FILE</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Path to proxy configuration JSON file (default: </span><span class="si">{</span><span class="n">DEFAULT_PROXY_FILE</span><span class="si">}</span><span class="s1">). &#39;</span>
                            <span class="s1">&#39;Example file content: {&quot;type&quot;: &quot;http&quot;, &quot;addr&quot;: &quot;127.0.0.1&quot;, &quot;port&quot;: 8080} &#39;</span>
                            <span class="s1">&#39;or {&quot;type&quot;: &quot;socks5&quot;, &quot;addr&quot;: &quot;127.0.0.1&quot;, &quot;port&quot;: 1080, &quot;username&quot;: &quot;user&quot;, &quot;password&quot;: &quot;pass&quot;}&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-P&#39;</span><span class="p">,</span> <span class="s1">&#39;--no-proxy&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Disable proxy usage and connect directly&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-u&#39;</span><span class="p">,</span> <span class="s1">&#39;--user-info&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Get and display user profile information from Nexus bot&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-X&#39;</span><span class="p">,</span> <span class="s1">&#39;--clear-proxy&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Clear proxy configuration files (delete default proxy files)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-C&#39;</span><span class="p">,</span> <span class="s1">&#39;--clear-credentials&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Clear credentials configuration file (delete default credentials file)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="s1">&#39;--fetch-nexus-aaron&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;LIMIT&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Fetch recent messages from @nexus_aaron bot (default: 10, max: 100)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-t&#39;</span><span class="p">,</span> <span class="s1">&#39;--test-connection&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Test connection to Telegram servers and proxy (if configured)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-U&#39;</span><span class="p">,</span> <span class="s1">&#39;--upload-to-nexus-aaron&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;FILE_PATH&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Upload a file to @nexus_aaron bot&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-m&#39;</span><span class="p">,</span> <span class="s1">&#39;--upload-message&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Optional message to send with the uploaded file (use with --upload-to-nexus-aaron)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-R&#39;</span><span class="p">,</span> <span class="s1">&#39;--solve-requests&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;LIMIT&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Reply to research requests from @nexus_aaron bot (default: 10, max: 50)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-k&#39;</span><span class="p">,</span> <span class="s1">&#39;--check-doi&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;DOI_OR_LIST_OR_FILE&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Check if a paper with the specified DOI(s) is available on Nexus. &#39;</span>
                            <span class="s1">&#39;Accepts a single DOI, a comma/space separated list, or a file path (one DOI per line).&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-b&#39;</span><span class="p">,</span> <span class="s1">&#39;--batch-delay&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;SECONDS&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Delay between batch DOI checks to avoid rate limiting (default: 2.0 seconds)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-d&#39;</span><span class="p">,</span> <span class="s1">&#39;--download&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Automatically download papers if available (use with --check-doi)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-r&#39;</span><span class="p">,</span> <span class="s1">&#39;--request-doi&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;DOI_OR_LIST_OR_FILE&#39;</span><span class="p">,</span>
                       <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Request a paper by DOI, a comma/space separated list of DOIs, or a file containing DOIs (one per line)&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--print-default&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Print all default paths and configuration file locations used by the script&quot;</span>
    <span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="c1"># Argument conflict checks</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">proxy</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">no_proxy</span><span class="p">:</span>
        <span class="n">error_print</span><span class="p">(</span><span class="s2">&quot;--proxy and --no-proxy cannot be specified at the same time.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">proxy</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">clear_proxy</span><span class="p">:</span>
        <span class="n">error_print</span><span class="p">(</span><span class="s2">&quot;--proxy and --clear-proxy cannot be specified at the same time.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># Setup logging</span>
    <span class="n">setup_logging</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">log</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Verbose mode enabled&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
        <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Logging enabled to: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">log</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Platform: </span><span class="si">{</span><span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Session file: </span><span class="si">{</span><span class="n">SESSION_FILE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Default log file: </span><span class="si">{</span><span class="n">DEFAULT_LOG_FILE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Handle --print-default before anything else</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">print_default</span><span class="p">:</span>
        <span class="n">print_default_paths</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="c1"># Handle clear-proxy and clear-credentials commands</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">clear_proxy</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">clear_credentials</span><span class="p">:</span>
        <span class="c1"># Only allow these options if no other actionable arguments are specified</span>
        <span class="n">actionable_args</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">args</span><span class="o">.</span><span class="n">create_session</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">search</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">user_info</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">check_doi</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">request_doi</span><span class="p">,</span>
            <span class="n">args</span><span class="o">.</span><span class="n">fetch_nexus_aaron</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">upload_to_nexus_aaron</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">solve_requests</span><span class="p">,</span>
            <span class="n">args</span><span class="o">.</span><span class="n">test_connection</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">actionable_args</span><span class="p">):</span>
            <span class="n">error_print</span><span class="p">(</span><span class="s2">&quot;--clear-proxy and --clear-credentials can only be used alone or together, not with other options.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">clear_proxy</span><span class="p">:</span>
            <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Clearing proxy configuration files...&quot;</span><span class="p">)</span>
            <span class="n">proxy_files_to_clear</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">DEFAULT_PROXY_FILE</span><span class="p">,</span>
                <span class="n">DEFAULT_PROXY_FILE</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.json&#39;</span><span class="p">,</span> <span class="s1">&#39;_list.json&#39;</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">cleared_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">proxy_file</span> <span class="ow">in</span> <span class="n">proxy_files_to_clear</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">proxy_file</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">proxy_file</span><span class="p">)</span>
                        <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Removed proxy file: </span><span class="si">{</span><span class="n">proxy_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">cleared_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Failed to remove proxy file </span><span class="si">{</span><span class="n">proxy_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Proxy file does not exist: </span><span class="si">{</span><span class="n">proxy_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cleared_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully cleared </span><span class="si">{</span><span class="n">cleared_count</span><span class="si">}</span><span class="s2"> proxy configuration files&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;No proxy configuration files found to clear&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">clear_credentials</span><span class="p">:</span>
            <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Clearing credentials configuration file...&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">CREDENTIALS_FILE</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">CREDENTIALS_FILE</span><span class="p">)</span>
                    <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Removed credentials file: </span><span class="si">{</span><span class="n">CREDENTIALS_FILE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Credentials cleared successfully&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Failed to remove credentials file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;No credentials file found to clear&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    
    <span class="c1"># Load credentials if specified, otherwise try default location</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">credentials</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="k">await</span> <span class="n">load_credentials_from_file</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">credentials</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="c1"># Quit after loading credentials if no other actionable argument is specified</span>
        <span class="n">actionable_args</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">args</span><span class="o">.</span><span class="n">create_session</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">search</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">user_info</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">check_doi</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">request_doi</span><span class="p">,</span>
            <span class="n">args</span><span class="o">.</span><span class="n">fetch_nexus_aaron</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">upload_to_nexus_aaron</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">solve_requests</span><span class="p">,</span>
            <span class="n">args</span><span class="o">.</span><span class="n">test_connection</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">clear_proxy</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">clear_credentials</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">actionable_args</span><span class="p">):</span>
            <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Credentials loaded successfully.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Try to load from default location</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">CREDENTIALS_FILE</span><span class="p">):</span>
            <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No credentials file for `nexus` module specified, trying default location: </span><span class="si">{</span><span class="n">CREDENTIALS_FILE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="k">await</span> <span class="n">load_credentials_from_file</span><span class="p">(</span><span class="n">CREDENTIALS_FILE</span><span class="p">):</span>
                <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;Failed to load credentials from default location&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Quit after loading credentials if no other actionable argument is specified</span>
                <span class="n">actionable_args</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">args</span><span class="o">.</span><span class="n">create_session</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">search</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">user_info</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">check_doi</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">request_doi</span><span class="p">,</span>
                    <span class="n">args</span><span class="o">.</span><span class="n">fetch_nexus_aaron</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">upload_to_nexus_aaron</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">solve_requests</span><span class="p">,</span>
                    <span class="n">args</span><span class="o">.</span><span class="n">test_connection</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">clear_proxy</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">clear_credentials</span>
                <span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">actionable_args</span><span class="p">):</span>
                    <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Credentials loaded successfully.&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No credentials file found at default location: </span><span class="si">{</span><span class="n">CREDENTIALS_FILE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Update bot username if specified</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">bot</span><span class="p">:</span>
        <span class="n">BOT_USERNAME</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">bot</span>
        <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using specified bot username: </span><span class="si">{</span><span class="n">BOT_USERNAME</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Bot username updated from command line argument&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using default bot username: </span><span class="si">{</span><span class="n">BOT_USERNAME</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Handle create-session command</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">create_session</span><span class="p">:</span>
        <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Creating new session...&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">create_session</span><span class="p">(</span><span class="n">TG_API_ID</span><span class="p">,</span> <span class="n">TG_API_HASH</span><span class="p">,</span> <span class="n">PHONE</span><span class="p">,</span> <span class="n">SESSION_FILE</span><span class="p">)</span>
        <span class="k">return</span>
    
    <span class="c1"># Determine proxy usage</span>
    <span class="n">proxy_to_use</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">no_proxy</span><span class="p">:</span>
        <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Proxy disabled by --no-proxy flag&quot;</span><span class="p">)</span>
        <span class="n">proxy_to_use</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">proxy</span><span class="p">:</span>
        <span class="c1"># Use the proxy config file specified by --proxy</span>
        <span class="n">proxy_to_use</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">proxy</span>
        <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using proxy configuration file specified by --proxy: </span><span class="si">{</span><span class="n">proxy_to_use</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Decide whether to use proxy</span>
        <span class="n">proxy_to_use</span> <span class="o">=</span> <span class="k">await</span> <span class="n">decide_proxy_usage</span><span class="p">(</span><span class="n">TG_API_ID</span><span class="p">,</span> <span class="n">TG_API_HASH</span><span class="p">,</span> <span class="n">PHONE</span><span class="p">,</span> <span class="n">SESSION_FILE</span><span class="p">,</span> <span class="n">DEFAULT_PROXY_FILE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">proxy_to_use</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>  <span class="c1"># Explicitly check for False (error case)</span>
            <span class="k">return</span>
    
    <span class="c1"># Handle test-connection command</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">test_connection</span><span class="p">:</span>
        <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Testing connection to Telegram servers...&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">test_telegram_connection</span><span class="p">(</span><span class="n">TG_API_ID</span><span class="p">,</span> <span class="n">TG_API_HASH</span><span class="p">,</span> <span class="n">PHONE</span><span class="p">,</span> <span class="n">SESSION_FILE</span><span class="p">,</span> <span class="n">proxy_to_use</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># Handle request-doi command (updated to support single DOI, list, or file)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">request_doi</span><span class="p">:</span>
        <span class="n">input_value</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">request_doi</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">doi_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Check if input is a file path</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">input_value</span><span class="p">):</span>
            <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reading DOIs from file: </span><span class="si">{</span><span class="n">input_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">doi_list</span> <span class="o">=</span> <span class="n">getpapers</span><span class="o">.</span><span class="n">extract_dois_from_file</span><span class="p">(</span><span class="n">input_value</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">doi_list</span><span class="p">:</span>
                    <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No valid DOIs found in file: </span><span class="si">{</span><span class="n">input_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to extract DOIs from file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use extract_dois_from_text for comma/space separated input</span>
            <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracting DOIs from input: </span><span class="si">{</span><span class="n">input_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">doi_list</span> <span class="o">=</span> <span class="n">getpapers</span><span class="o">.</span><span class="n">extract_dois_from_text</span><span class="p">(</span><span class="n">input_value</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">doi_list</span><span class="p">:</span>
                <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No valid DOIs found in input: </span><span class="si">{</span><span class="n">input_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">doi_list</span><span class="p">:</span>
            <span class="n">error_print</span><span class="p">(</span><span class="s2">&quot;No valid DOIs provided for --request-doi&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">doi_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Requesting paper by DOI: </span><span class="si">{</span><span class="n">doi_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">request_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">request_paper_by_doi</span><span class="p">(</span>
                <span class="n">TG_API_ID</span><span class="p">,</span> <span class="n">TG_API_HASH</span><span class="p">,</span> <span class="n">PHONE</span><span class="p">,</span> <span class="n">BOT_USERNAME</span><span class="p">,</span> <span class="n">doi_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">SESSION_FILE</span><span class="p">,</span> <span class="n">proxy_to_use</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">request_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ok&quot;</span><span class="p">):</span>
                <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Paper request sent for DOI </span><span class="si">{</span><span class="n">doi_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Request details:&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">request_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;details&quot;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Failed to request paper: </span><span class="si">{</span><span class="n">request_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;details&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">request_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown error&#39;</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Requesting papers for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">doi_list</span><span class="p">)</span><span class="si">}</span><span class="s2"> DOIs...&quot;</span><span class="p">)</span>
            <span class="n">batch_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">batch_request_papers_by_doi</span><span class="p">(</span>
                <span class="n">TG_API_ID</span><span class="p">,</span> <span class="n">TG_API_HASH</span><span class="p">,</span> <span class="n">PHONE</span><span class="p">,</span> <span class="n">BOT_USERNAME</span><span class="p">,</span> <span class="n">doi_list</span><span class="p">,</span> <span class="n">SESSION_FILE</span><span class="p">,</span> <span class="n">proxy_to_use</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Batch request summary:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Total: </span><span class="si">{</span><span class="n">batch_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;total&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Requested: </span><span class="si">{</span><span class="n">batch_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;requested&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Skipped: </span><span class="si">{</span><span class="n">batch_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;skipped&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Errors: </span><span class="si">{</span><span class="n">batch_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;errors&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">batch_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;results&quot;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="n">doi</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;doi&quot;</span><span class="p">,</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ok&quot;</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Requested: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;request_sent&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - Skipped (no request needed): </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   Error: </span><span class="si">{</span><span class="n">doi</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;details&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown error&#39;</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># Handle check-doi command (now supports single DOI, list, or file)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">check_doi</span><span class="p">:</span>
        <span class="n">input_value</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">check_doi</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">doi_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Check if input is a file path</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">input_value</span><span class="p">):</span>
            <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reading DOIs from file: </span><span class="si">{</span><span class="n">input_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">doi_list</span> <span class="o">=</span> <span class="n">getpapers</span><span class="o">.</span><span class="n">extract_dois_from_file</span><span class="p">(</span><span class="n">input_value</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">doi_list</span><span class="p">:</span>
                    <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No valid DOIs found in file: </span><span class="si">{</span><span class="n">input_value</span><span class="si">}</span><span class="s2">. Either the DOI is invaild or it cannot be verified on Crossref.&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to extract DOIs from file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use extract_dois_from_text for comma/space separated input</span>
            <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extracting DOIs from input: </span><span class="si">{</span><span class="n">input_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">doi_list</span> <span class="o">=</span> <span class="n">getpapers</span><span class="o">.</span><span class="n">extract_dois_from_text</span><span class="p">(</span><span class="n">input_value</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">doi_list</span><span class="p">:</span>
                <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No valid DOIs found in input: </span><span class="si">{</span><span class="n">input_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">doi_list</span><span class="p">:</span>
            <span class="n">error_print</span><span class="p">(</span><span class="s2">&quot;No valid DOIs provided for --check-doi&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">download_enabled</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">download</span>
        <span class="k">if</span> <span class="n">download_enabled</span><span class="p">:</span>
            <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Auto-download enabled - will download paper(s) if available&quot;</span><span class="p">)</span>

        <span class="c1"># If only one DOI, do single check</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">doi_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Checking DOI availability: </span><span class="si">{</span><span class="n">doi_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DOI to check: </span><span class="si">{</span><span class="n">doi_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Download enabled: </span><span class="si">{</span><span class="n">download_enabled</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">availability_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">check_doi_availability_on_nexus</span><span class="p">(</span>
                <span class="n">TG_API_ID</span><span class="p">,</span> <span class="n">TG_API_HASH</span><span class="p">,</span> <span class="n">PHONE</span><span class="p">,</span> <span class="n">BOT_USERNAME</span><span class="p">,</span> <span class="n">doi_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">SESSION_FILE</span><span class="p">,</span> <span class="n">proxy_to_use</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="n">download_enabled</span>
            <span class="p">)</span>
            <span class="n">format_doi_availability_result</span><span class="p">(</span><span class="n">availability_result</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">availability_result</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">availability_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;available&quot;</span><span class="p">:</span>
                    <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot; DOI check completed - Paper is available on Nexus&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">download_enabled</span><span class="p">:</span>
                        <span class="n">download_result</span> <span class="o">=</span> <span class="n">availability_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;download_result&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">download_result</span> <span class="ow">and</span> <span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">):</span>
                            <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot; Paper downloaded successfully&quot;</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">download_result</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">):</span>
                            <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Download failed: </span><span class="si">{</span><span class="n">download_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown error&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">download_enabled</span><span class="p">:</span>
                            <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot; Download was requested but no download occurred&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;not_available_requestable&quot;</span><span class="p">:</span>
                    <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot; DOI check completed - Paper can be requested from Nexus&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;not_found&quot;</span><span class="p">:</span>
                    <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot; DOI check completed - Paper not found in Nexus database&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; DOI check completed - Status: </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; DOI check failed: </span><span class="si">{</span><span class="n">availability_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown error&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Batch check</span>
            <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Batch checking </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">doi_list</span><span class="p">)</span><span class="si">}</span><span class="s2"> DOIs...&quot;</span><span class="p">)</span>
            <span class="n">batch_delay</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">batch_delay</span>
            <span class="k">if</span> <span class="n">batch_delay</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
                <span class="n">batch_delay</span> <span class="o">=</span> <span class="mf">0.5</span>
                <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Batch delay adjusted to minimum of 0.5 seconds&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">batch_delay</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">batch_delay</span> <span class="o">=</span> <span class="mi">10</span>
                <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Batch delay adjusted to maximum of 10 seconds&quot;</span><span class="p">)</span>
            <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using batch delay of </span><span class="si">{</span><span class="n">batch_delay</span><span class="si">}</span><span class="s2"> seconds between requests&quot;</span><span class="p">)</span>
            <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Download enabled for batch: </span><span class="si">{</span><span class="n">download_enabled</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">batch_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">batch_check_doi_availability</span><span class="p">(</span>
                <span class="n">TG_API_ID</span><span class="p">,</span> <span class="n">TG_API_HASH</span><span class="p">,</span> <span class="n">PHONE</span><span class="p">,</span> <span class="n">BOT_USERNAME</span><span class="p">,</span> <span class="n">doi_list</span><span class="p">,</span>
                <span class="n">SESSION_FILE</span><span class="p">,</span> <span class="n">proxy_to_use</span><span class="p">,</span> <span class="n">batch_delay</span><span class="p">,</span> <span class="n">download</span><span class="o">=</span><span class="n">download_enabled</span>
            <span class="p">)</span>
            <span class="n">format_batch_doi_results</span><span class="p">(</span><span class="n">batch_result</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;error&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">batch_result</span><span class="p">:</span>
                <span class="n">summary</span> <span class="o">=</span> <span class="n">batch_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="n">available_count</span> <span class="o">=</span> <span class="n">batch_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;available&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">total_dois</span> <span class="o">=</span> <span class="n">batch_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;total_dois&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Batch DOI check completed: </span><span class="si">{</span><span class="n">available_count</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total_dois</span><span class="si">}</span><span class="s2"> papers available on Nexus&quot;</span><span class="p">)</span>
                <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Success rate: </span><span class="si">{</span><span class="n">summary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;success_rate&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">download_enabled</span><span class="p">:</span>
                    <span class="n">downloaded_count</span> <span class="o">=</span> <span class="n">batch_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;downloaded&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">download_errors</span> <span class="o">=</span> <span class="n">batch_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;download_errors&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Download results: </span><span class="si">{</span><span class="n">downloaded_count</span><span class="si">}</span><span class="s2"> successful, </span><span class="si">{</span><span class="n">download_errors</span><span class="si">}</span><span class="s2"> failed&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">downloaded_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">total_downloaded_mb</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;total_downloaded_mb&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total downloaded: </span><span class="si">{</span><span class="n">total_downloaded_mb</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Batch DOI check failed: </span><span class="si">{</span><span class="n">batch_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown error&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>

    <span class="c1"># Validate --download flag usage</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">download</span><span class="p">:</span>
        <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot; Warning: --download flag is only effective when used with --check-doi&quot;</span><span class="p">)</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;Download flag specified but no compatible command found&quot;</span><span class="p">)</span>
    
    <span class="c1"># Handle fetch-nexus-aaron command</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">fetch_nexus_aaron</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Fetching messages from @nexus_aaron...&quot;</span><span class="p">)</span>
        
        <span class="c1"># Validate and clamp limit</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">fetch_nexus_aaron</span>
        <span class="k">if</span> <span class="n">limit</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Message limit adjusted to minimum of 1&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">limit</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="mi">100</span>
            <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Message limit adjusted to maximum of 100&quot;</span><span class="p">)</span>
        
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fetching </span><span class="si">{</span><span class="n">limit</span><span class="si">}</span><span class="s2"> messages from @nexus_aaron&quot;</span><span class="p">)</span>
        <span class="n">messages_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">fetch_nexus_aaron_messages</span><span class="p">(</span>
            <span class="n">TG_API_ID</span><span class="p">,</span> <span class="n">TG_API_HASH</span><span class="p">,</span> <span class="n">PHONE</span><span class="p">,</span> <span class="n">SESSION_FILE</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">proxy_to_use</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        
        <span class="k">if</span> <span class="n">messages_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ok&quot;</span><span class="p">):</span>
            <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully fetched </span><span class="si">{</span><span class="n">messages_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;messages_count&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> messages from @nexus_aaron&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to fetch messages from @nexus_aaron: </span><span class="si">{</span><span class="n">messages_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown error&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span>
    
    <span class="c1"># Handle upload-to-nexus-aaron command</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">upload_to_nexus_aaron</span><span class="p">:</span>
        <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Uploading file to @nexus_aaron...&quot;</span><span class="p">)</span>
        
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">upload_to_nexus_aaron</span>
        <span class="n">upload_message</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">upload_message</span>
        
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File to upload: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Upload message: &#39;</span><span class="si">{</span><span class="n">upload_message</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        
        <span class="c1"># Validate file exists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File not found: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># Get file info for validation</span>
        <span class="n">file_size</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="n">file_size_mb</span> <span class="o">=</span> <span class="n">file_size</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        
        <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File: </span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Size: </span><span class="si">{</span><span class="n">file_size_mb</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB&quot;</span><span class="p">)</span>
        
        <span class="c1"># Warn for large files (Telegram has limits)</span>
        <span class="k">if</span> <span class="n">file_size_mb</span> <span class="o">&gt;</span> <span class="mi">2000</span><span class="p">:</span>  <span class="c1"># 2GB limit</span>
            <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File is too large (</span><span class="si">{</span><span class="n">file_size_mb</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB). Telegram limit is 2GB.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">file_size_mb</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>  <span class="c1"># Warn for files over 50MB</span>
            <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Large file (</span><span class="si">{</span><span class="n">file_size_mb</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB) may take time to upload&quot;</span><span class="p">)</span>
        
        <span class="c1"># If the file is a PDF and no upload_message is specified, use simple_upload_to_nexus_aaron</span>
        <span class="k">if</span> <span class="n">file_path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.pdf&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">upload_message</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="n">upload_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">simple_upload_to_nexus_aaron</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Perform the upload</span>
            <span class="n">upload_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">upload_file_to_nexus_aaron</span><span class="p">(</span>
            <span class="n">TG_API_ID</span><span class="p">,</span> <span class="n">TG_API_HASH</span><span class="p">,</span> <span class="n">PHONE</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">upload_message</span><span class="p">,</span> <span class="n">SESSION_FILE</span><span class="p">,</span> <span class="n">proxy_to_use</span>
            <span class="p">)</span>
        
        <span class="c1"># Display results with specialized formatting</span>
        <span class="n">format_nexus_aaron_upload_result</span><span class="p">(</span><span class="n">upload_result</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">upload_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ok&quot;</span><span class="p">):</span>
            <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot; File upload to @nexus_aaron completed successfully&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; File upload to @nexus_aaron failed: </span><span class="si">{</span><span class="n">upload_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown error&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span>
    
    <span class="c1"># Handle solve-requests command</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">solve_requests</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Solving research requests from @nexus_aaron...&quot;</span><span class="p">)</span>
        
        <span class="c1"># Validate and clamp limit</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">solve_requests</span>
        <span class="k">if</span> <span class="n">limit</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Request limit adjusted to minimum of 1&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">limit</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="mi">50</span>
            <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Request limit adjusted to maximum of 50&quot;</span><span class="p">)</span>
        
        <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing up to </span><span class="si">{</span><span class="n">limit</span><span class="si">}</span><span class="s2"> research requests from @nexus_aaron&quot;</span><span class="p">)</span>
        
        <span class="c1"># Use the existing function to handle request solving</span>
        <span class="n">solve_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">list_and_reply_to_nexus_aaron_message</span><span class="p">(</span>
            <span class="n">TG_API_ID</span><span class="p">,</span> <span class="n">TG_API_HASH</span><span class="p">,</span> <span class="n">PHONE</span><span class="p">,</span> <span class="n">SESSION_FILE</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">proxy_to_use</span>
        <span class="p">)</span>
        
        <span class="c1"># Display results with specialized formatting</span>
        <span class="n">format_list_and_reply_result</span><span class="p">(</span><span class="n">solve_result</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">solve_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ok&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">solve_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cancelled&quot;</span><span class="p">):</span>
            <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot; Request solving completed successfully&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">solve_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cancelled&quot;</span><span class="p">):</span>
            <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Request solving cancelled by user&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">error_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; Request solving failed: </span><span class="si">{</span><span class="n">solve_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Unknown error&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span>
    
    <span class="c1"># Handle user-info command</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">user_info</span><span class="p">:</span>
        <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Getting user profile information...&quot;</span><span class="p">)</span>
        
        <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;Starting user profile retrieval process...&quot;</span><span class="p">)</span>
        <span class="n">profile_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_user_profile</span><span class="p">(</span><span class="n">TG_API_ID</span><span class="p">,</span> <span class="n">TG_API_HASH</span><span class="p">,</span> <span class="n">PHONE</span><span class="p">,</span> <span class="n">BOT_USERNAME</span><span class="p">,</span> <span class="n">SESSION_FILE</span><span class="p">,</span> <span class="n">proxy_to_use</span><span class="p">)</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;User profile retrieval process completed&quot;</span><span class="p">)</span>
        
        <span class="n">format_profile_result</span><span class="p">(</span><span class="n">profile_result</span><span class="p">)</span>
        <span class="k">return</span>
    
    <span class="c1"># Use the search query from arguments</span>
    <span class="n">message_to_send</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">search</span>
    <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using search query: </span><span class="si">{</span><span class="n">message_to_send</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">debug_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Search query length: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">message_to_send</span><span class="p">)</span><span class="si">}</span><span class="s2"> characters&quot;</span><span class="p">)</span>

    <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;Starting message sending process...&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">proxy_to_use</span><span class="p">:</span>
        <span class="n">info_print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connecting via proxy: </span><span class="si">{</span><span class="n">proxy_to_use</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">info_print</span><span class="p">(</span><span class="s2">&quot;Connecting directly (no proxy)&quot;</span><span class="p">)</span>

    <span class="c1"># Pass search-limit to send_message_to_bot if specified</span>
    <span class="n">search_limit</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">search_limit</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">search_limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">send_result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">send_message_to_bot</span><span class="p">(</span>
        <span class="n">TG_API_ID</span><span class="p">,</span> <span class="n">TG_API_HASH</span><span class="p">,</span> <span class="n">PHONE</span><span class="p">,</span> <span class="n">BOT_USERNAME</span><span class="p">,</span> <span class="n">message_to_send</span><span class="p">,</span> <span class="n">SESSION_FILE</span><span class="p">,</span> <span class="n">proxy_to_use</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">search_limit</span>
    <span class="p">)</span>
    <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;Message sending process completed&quot;</span><span class="p">)</span>
    
    <span class="n">format_result</span><span class="p">(</span><span class="n">send_result</span><span class="p">)</span>
    
    <span class="c1"># Handle button clicks after search results</span>
    <span class="k">if</span> <span class="n">send_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ok&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">send_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bot_reply&quot;</span><span class="p">):</span>
        <span class="k">await</span> <span class="n">process_callback_buttons</span><span class="p">(</span><span class="n">send_result</span><span class="p">[</span><span class="s2">&quot;bot_reply&quot;</span><span class="p">],</span> <span class="n">proxy_to_use</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">debug_print</span><span class="p">(</span><span class="s2">&quot;No valid bot reply to process for button clicks&quot;</span><span class="p">)</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023-2026, Duc A. Hoang.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>